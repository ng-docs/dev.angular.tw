{"id":"guide/service-worker-communications","title":"與 Service Worker 通訊","contents":"<div class=\"content\">\n  <h1 id=\"service-worker-communication\" data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"1ovwrtsbwtuidl6m4atizx0ih\">與 Service Worker 通訊<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#service-worker-communication\"><i class=\"material-icons\">link</i></a></h1>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"63q73dcyovfih3r9qbgkuvqba\">啟用服務工作者支援不僅僅是註冊服務工作者；它還提供可以用來與服務工作者互動並控制應用程式快取的服務。</p>\n<h2 id=\"prerequisites\" data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"e44b21uig1fakj5vcfuvz1bdu\">前提條件<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#prerequisites\"><i class=\"material-icons\">link</i></a></h2>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"3xq8keqzpcinu80uje7xu3rbf\">對下列知識有基本的瞭解：</p>\n<ul>\n<li data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"c2rijcglaqp3k5gzb2q1thcdr\"><a href=\"guide/service-worker-getting-started\">Service Worker 快速上手</a>。</li>\n</ul>\n<h2 id=\"swupdate-service\" data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"eks0azqz0vyr2la4zfbtos7gt\"><code><a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a></code> 服務<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#swupdate-service\"><i class=\"material-icons\">link</i></a></h2>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"895glfrb17yvtlv7gmafixv88\"><code><a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a></code> 服務讓你能訪問一些事件，這些事件會指出 Service Worker 何時發現並安裝了可用的更新</p>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"c8sxkvkfcf80yfzsupgcvnqx4\"><code><a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a></code> 服務支援四個獨立的操作：</p>\n<ul>\n<li data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"bj1omotujd2iev8zcobrr8g8g\">當在服務器上<em>檢測到</em>新版本、已安裝並可本地使用或安裝失敗時獲得通知</li>\n<li data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"btklji99jyppkf6l7v4j88gek\">要求 Service Worker 檢查伺服器上是否有更新。</li>\n<li data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"7kzy4i3ii2a0h74pxec8u75ec\">要求 Service Worker 為當前標籤頁啟用應用的最新版本</li>\n</ul>\n<h3 id=\"version-updates\" data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"43bbcswvupxp65jclq9u7c8h\">版本更新<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#version-updates\"><i class=\"material-icons\">link</i></a></h3>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"8z3ay8rlofawv0bfa7f1x58g\"><code>versionUpdates</code> 是 <code><a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a></code> 的一個 <code>Observable</code> 屬性，並且會發出四種事件型別：</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\" data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"83ew77hqwxy9jnfn8ivgnfi9y\">事件型別</th>\n<th align=\"left\" data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"3prlgfrx5eo2xqncnnob4crxu\">詳情</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"left\"><code><a href=\"api/service-worker/VersionDetectedEvent\" class=\"code-anchor\">VersionDetectedEvent</a></code></td>\n<td align=\"left\" data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"ls6m4q7zon819ceagdw5foct\">當服務工作者在服務器上檢測到應用的新版本並即將開始下載時發出。</td>\n</tr>\n<tr>\n<td align=\"left\"><code><a href=\"api/service-worker/NoNewVersionDetectedEvent\" class=\"code-anchor\">NoNewVersionDetectedEvent</a></code></td>\n<td align=\"left\" data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"bo346pa8qr8vntyqfhkpl0vlq\">當服務工作者檢查伺服器上的應用版本並未發現新版本時發出。</td>\n</tr>\n<tr>\n<td align=\"left\"><code><a href=\"api/service-worker/VersionReadyEvent\" class=\"code-anchor\">VersionReadyEvent</a></code></td>\n<td align=\"left\" data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"ml98u0w9226w7enestefmd1c\">當應用程式的新版本可供用戶端啟用時發出。 可用於通知使用者有可用更新或提示他們重新整理頁面。</td>\n</tr>\n<tr>\n<td align=\"left\"><code><a href=\"api/service-worker/VersionInstallationFailedEvent\" class=\"code-anchor\">VersionInstallationFailedEvent</a></code></td>\n<td align=\"left\" data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"edlf6qfttb5nk9viyo5f34xrj\">當安裝新版本失敗時發出。 可用於日誌記錄/監控目的。</td>\n</tr>\n</tbody>\n</table>\n<code-example header=\"log-update.service.ts\" path=\"service-worker-getting-started/src/app/log-update.service.ts\" region=\"sw-update\">\n@<a href=\"api/core/Injectable\" class=\"code-anchor\">Injectable</a>({providedIn: 'root'})\nexport class LogUpdateService {\n\n  constructor(updates: <a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a>) {\n    updates.versionUpdates.subscribe(evt =&gt; {\n      switch (evt.type) {\n        case 'VERSION_DETECTED':\n          console.log(`Downloading new app version: ${evt.version.hash}`);\n          break;\n        case 'VERSION_READY':\n          console.log(`Current app version: ${evt.currentVersion.hash}`);\n          console.log(`New app version ready for use: ${evt.latestVersion.hash}`);\n          break;\n        case 'VERSION_INSTALLATION_FAILED':\n          console.log(`Failed to install app version '${evt.version.hash}': ${evt.error}`);\n          break;\n      }\n    });\n  }\n}\n\n</code-example>\n<h3 id=\"checking-for-updates\" data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"br7lytwh2mmd44y1dbrfrfrbm\">檢查更新<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#checking-for-updates\"><i class=\"material-icons\">link</i></a></h3>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"7cgjqiri6c5q4f7b2u3cvo03p\">可以要求 Service Worker 檢查是否有任何更新已經發布到了伺服器上。Service Worker 會在初始化和每次導向請求（也就是使用者導向到應用中的另一個地址）時檢查更新。不過，如果你的站點更新非常頻繁，或者需要按計劃進行更新，你可能會選擇手動檢查更新。</p>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"eqxqfrgt6wk0zkwxv71wfporm\">透過呼叫 <code>checkForUpdate()</code> 方法來實現：</p>\n<code-example header=\"check-for-update.service.ts\" path=\"service-worker-getting-started/src/app/check-for-update.service.ts\">\nimport { <a href=\"api/core/ApplicationRef\" class=\"code-anchor\">ApplicationRef</a>, <a href=\"api/core/Injectable\" class=\"code-anchor\">Injectable</a> } from '@angular/core';\nimport { <a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a> } from '@angular/service-worker';\nimport { concat, interval } from 'rxjs';\nimport { first } from 'rxjs/operators';\n\n@<a href=\"api/core/Injectable\" class=\"code-anchor\">Injectable</a>({providedIn: 'root'})\nexport class CheckForUpdateService {\n\n  constructor(appRef: <a href=\"api/core/ApplicationRef\" class=\"code-anchor\">ApplicationRef</a>, updates: <a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a>) {\n    // Allow the app to stabilize first, before starting\n    // polling for updates with `interval()`.\n    const appIsStable$ = appRef.isStable.pipe(first(isStable =&gt; isStable === true));\n    const everySixHours$ = interval(6 * 60 * 60 * 1000);\n    const everySixHoursOnceAppIsStable$ = concat(appIsStable$, everySixHours$);\n\n    everySixHoursOnceAppIsStable$.subscribe(<a href=\"api/platform-browser/animations/async\" class=\"code-anchor\">async</a> () =&gt; {\n      try {\n        const updateFound = await updates.checkForUpdate();\n        console.log(updateFound ? 'A new version is available.' : 'Already on the latest version.');\n      } catch (err) {\n        console.error('Failed to check for updates:', err);\n      }\n    });\n  }\n}\n\n\n</code-example>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"b9d8ys7r2ku82gmgyimtssxqc\">該方法回傳一個用來表示檢查更新已經成功完成的 <code>Promise&lt;boolean&gt;</code>。這種檢查可能會失敗，它會導致此 <code>Promise</code> 被拒絕（reject）。</p>\n<div class=\"alert is-important\">\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"6a0ohkhtovo1htpgxuvsuji8g\">為了避免對頁面的初始渲染產生負面影響，預設情況下，Angular 服務工作者服務在註冊 ServiceWorker 指令碼之前等待應用程式穩定的時間長達30秒。 不斷輪詢更新，例如使用\n<a href=\"https://developer.mozilla.org/docs/Web/API/WindowOrWorkerGlobalScope/setInterval\">setInterval()</a>或 RxJS的\n<a href=\"https://rxjs.dev/api/index/function/interval\">interval()</a>，會阻止應用程式穩定，並且直到達到30秒的上限，ServiceWorker 指令碼才會向瀏覽器註冊。</p>\n<div class=\"alert is-helpful\">\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"ch8mfghdsexdblquholv0ie3e\"><strong>注意</strong>：<br>\n應用中所執行的各種輪詢都會阻止它達到穩定態。欲知詳情，參閱 <a href=\"api/core/ApplicationRef#isStable\">isStable</a> 文件。</p>\n</div>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"59n0wdezy0hceclajldh3xiiv\">可以透過在開始輪詢更新之前先等應用達到穩定態來消除這種延遲，如上述例子所示。另外，你還可以為 ServiceWorker 定義不一樣的 <a href=\"api/service-worker/SwRegistrationOptions#registrationStrategy\">註冊策略</a>。</p>\n</div>\n<h3 id=\"updating-to-the-latest-version\" data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"6uakk7yr0psl3m27onmqr7tj1\">升級到最新版本<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#updating-to-the-latest-version\"><i class=\"material-icons\">link</i></a></h3>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"9sq3nztzoz1d1pvcfrg7tomha\">你可以透過在新版本就緒後立即重新載入頁面來將現有頁籤更新到最新版本。為避免中斷使用者的進度，一般來說最好提示使用者並讓他們確認可以重新載入頁面並更新到最新版本：</p>\n<code-example header=\"prompt-update.service.ts\" path=\"service-worker-getting-started/src/app/prompt-update.service.ts\" region=\"sw-version-ready\">\n@<a href=\"api/core/Injectable\" class=\"code-anchor\">Injectable</a>({providedIn: 'root'})\nexport class PromptUpdateService {\n\n  constructor(swUpdate: <a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a>) {\n    swUpdate.versionUpdates\n        .pipe(filter((evt): evt is <a href=\"api/service-worker/VersionReadyEvent\" class=\"code-anchor\">VersionReadyEvent</a> =&gt; evt.type === 'VERSION_READY'))\n        .subscribe(evt =&gt; {\n          if (promptUser(evt)) {\n            // Reload the page to update to the latest version.\n            document.location.reload();\n          }\n        });\n  }\n\n}\n\n</code-example>\n<div class=\"alert is-important\">\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"45hwew8e1tjfj9xyqluiwlu1z\">呼叫\n<a href=\"api/service-worker/SwUpdate#activateUpdate\"><code>SwUpdate#activateUpdate</code></a>可更新標籤至最新版本而無需重新載入頁面，但可能會破壞應用程式。</p>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"bq32byv0l2ntfbxpreegbq1xg\">用不重新載入的方式更新可以建立一個<a href=\"guide/glossary#app-shell\">應用外殼</a>與其它頁面資源（如<a href=\"guide/glossary#lazy-loading\">延遲載入區塊</a>）不對應的版本，因為檔案名在不同版本之間可能發生變化。</p>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"6dkewm3gpr2emirrdoy6ijyi9\">如果你確信對於你的特定用例，這種情況是安全的，你可以只用 <code>activateUpdate()</code>。</p>\n</div>\n<h3 id=\"handling-an-unrecoverable-state\" data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"1mcushj1a5m9bft1zxj8gtnsv\">處理不可恢復的狀態<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#handling-an-unrecoverable-state\"><i class=\"material-icons\">link</i></a></h3>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"bclhvimq0gw2z5fntxyydrma3\">在某些情況下，Service Worker 用來為用戶端提供服務的應用版本可能處於損壞狀態，如果不重新載入整個頁面，則無法恢復該狀態。</p>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"cvqxtkpv55gz65evfq9k5h0x8\">比如，設想以下情形：</p>\n<ul>\n<li>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"4itn6208xtm6zqthg6e9tk35o\">使用者首次開啟該應用，Service Worker 會快取該應用的最新版本。假設應用要快取的資源套件括 <code>index.html</code>、<code>main.&lt;main-hash-1&gt;.js</code> 和 <code>lazy-chunk.&lt;lazy-hash-1&gt;.js</code>。</p>\n</li>\n<li>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"e1jg94blk7kidx8jya9e567mr\">使用者關閉該應用程式，並且有一段時間沒有開啟它。</p>\n</li>\n<li>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"es9msmu8i4cffz0rep991vzrf\">一段時間後，會將新版本的應用程式部署到伺服器。新版本中包含檔案 <code>index.html</code>、<code>main.&lt;main-hash-2&gt;.js</code> 和 <code>lazy-chunk.&lt;lazy-hash-2&gt;.js</code>。</p>\n<div class=\"alert is-helpful\">\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"aj6070ao1ot4d8shkkjzuknuw\"><strong>注意</strong>：<br>\n雜湊值現在已經不同了，因為檔案的內容已經改變）。伺服器上不再提供舊版本。</p>\n</div>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"a48468qfsg5bbdiqum7ex1q6f\">舊版本在服務器上不再可用。</p>\n</li>\n<li>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"akkustp2bw4nr4f6finwesiwz\">同時，使用者的瀏覽器決定從其快取中清退 <code>lazy-chunk.&lt;lazy-hash-1&gt;.js</code> 瀏覽器可能決定從快取中清退特定（或所有）資源，以便回收磁碟空間。</p>\n</li>\n<li>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"8wt34lxuwcv9w5zt0t2l9how2\">使用者再次開啟本應用。此時，Service Worker 將提供它所知的最新版本，當然，實際上對我們是舊版本（<code>index.html</code> 和 <code>main.&lt;main-hash-1&gt;.js</code>）。</p>\n</li>\n<li>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"a4qewpliybiqa2rzigei49jd2\">在稍後的某個時刻，該應用程式請求惰性捆綁包 <code>lazy-chunk.&lt;lazy-hash-1&gt;.js</code>。</p>\n</li>\n<li>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"bjmie96bwm03ks24mblmwwta1\">Service Worker 無法在快取中找到該資產（請記住瀏覽器已經將其清退了）。它也無法從伺服器上獲取它（因為伺服器現在只有較新版本的 <code>lazy-chunk.&lt;lazy-hash-2&gt;.js</code>）。</p>\n</li>\n</ul>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"cbs12odna0sxqs6udutj5qg66\">在上述情況下，Service Worker 將無法提供通常會被快取的資產。該特定的應用程式版本已損壞，並且無法在不重新載入頁面的情況下修復用戶端的狀態。在這種情況下，Service Worker 會通過傳送 <code><a href=\"api/service-worker/UnrecoverableStateEvent\" class=\"code-anchor\">UnrecoverableStateEvent</a></code> 事件來通知用戶端。可以訂閱 <code><a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a>#unrecoverable</code> 以得到通知並處理這些錯誤。</p>\n<code-example header=\"handle-unrecoverable-state.service.ts\" path=\"service-worker-getting-started/src/app/handle-unrecoverable-state.service.ts\" region=\"sw-unrecoverable-state\">\n@<a href=\"api/core/Injectable\" class=\"code-anchor\">Injectable</a>({providedIn: 'root'})\nexport class HandleUnrecoverableStateService {\n  constructor(updates: <a href=\"api/service-worker/SwUpdate\" class=\"code-anchor\">SwUpdate</a>) {\n    updates.unrecoverable.subscribe(event =&gt; {\n      notifyUser(\n        'An error occurred that we cannot recover from:\\n' +\n        event.reason +\n        '\\n\\nPlease reload the page.'\n      );\n    });\n  }\n}\n\n</code-example>\n<h2 id=\"more-on-angular-service-workers\" data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"e9jl51v338pdg88lkv1cl8f1i\">關於 Angular Service Worker 的更多訊息<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/service-worker-communications#more-on-angular-service-workers\"><i class=\"material-icons\">link</i></a></h2>\n<p data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"1oolgylns9kaynftarwog49tq\">你可能還對下列內容感興趣：</p>\n<ul>\n<li data-ng_translator_product=\"100\" data-ng_translator_ref_id=\"53swk0yxrhfk9vwssqxhoeq0i\"><a href=\"guide/service-worker-notifications\">Service Worker 通知</a></li>\n</ul>\n<!-- links -->\n<!-- external links -->\n<!-- end links -->\n\n  <div class=\"reviewed\">最後複查時間：Mon Feb 28 2022</div>\n</div>\n\n\n<!-- links to this doc:\n - api/service-worker/NoNewVersionDetectedEvent\n - api/service-worker/SwUpdate\n - api/service-worker/UnrecoverableStateEvent\n - api/service-worker/VersionDetectedEvent\n - api/service-worker/VersionInstallationFailedEvent\n - api/service-worker/VersionReadyEvent\n - guide/service-worker-devops\n - guide/service-worker-getting-started\n - guide/service-worker-intro\n-->\n<!-- links from this doc:\n - api/core/ApplicationRef\n - api/core/ApplicationRef#isStable\n - api/core/Injectable\n - api/platform-browser/animations/async\n - api/service-worker/NoNewVersionDetectedEvent\n - api/service-worker/SwRegistrationOptions#registrationStrategy\n - api/service-worker/SwUpdate\n - api/service-worker/SwUpdate#activateUpdate\n - api/service-worker/UnrecoverableStateEvent\n - api/service-worker/VersionDetectedEvent\n - api/service-worker/VersionInstallationFailedEvent\n - api/service-worker/VersionReadyEvent\n - guide/glossary#app-shell\n - guide/glossary#lazy-loading\n - guide/service-worker-communications#checking-for-updates\n - guide/service-worker-communications#handling-an-unrecoverable-state\n - guide/service-worker-communications#more-on-angular-service-workers\n - guide/service-worker-communications#prerequisites\n - guide/service-worker-communications#service-worker-communication\n - guide/service-worker-communications#swupdate-service\n - guide/service-worker-communications#updating-to-the-latest-version\n - guide/service-worker-communications#version-updates\n - guide/service-worker-getting-started\n - guide/service-worker-notifications\n - https://developer.mozilla.org/docs/Web/API/WindowOrWorkerGlobalScope/setInterval\n - https://rxjs.dev/api/index/function/interval\n-->"}