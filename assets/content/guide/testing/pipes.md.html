<header class="docs-header">
      <docs-breadcrumb></docs-breadcrumb>

      
  <!-- Page title -->
  <div class="docs-page-title">
    <h1 tabindex="-1" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="d2ymw98ugrj0bw4ej7m4vgkf8">测试管道</h1>
    <a class="docs-github-links" target="_blank" href="https://github.com/angular/angular/edit/main/adev/src/content/guide/testing/pipes.md" title="Edit this page" aria-label="Edit this page">
      <!-- Pencil -->
      <docs-icon role="presentation">edit</docs-icon>
    </a>
  </div>
    </header>
    <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="6hrxfbtuknknsw99eevh1fmgl">你可以在没有 Angular 测试工具的情况下<a href="guide/pipes">测试管道</a>。</p>

  <h2 id="testing-the-titlecasepipe">
    <a href="#testing-the-titlecasepipe" class="docs-anchor" tabindex="-1" aria-label="Link to Testing the <code>TitleCasePipe</code>" data-ng_translator_product="100" data-ng_translator_ref_id="9hedea8vtdis7g8qajiars374">测试 
<code>TitleCasePipe</code></a>
  </h2>
  <p data-ng_translator_product="100" data-ng_translator_ref_id="44jvtcpa3ni9digwg7qvv5jgn">一个管道类有一个方法 
<code>transform</code>，它将输入值转换为输出值。 
<code>transform</code> 的实现很少与 DOM 交互。 大多数管道除了 
<code>@Pipe</code> 元数据和一个接口外，不依赖于 Angular。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="2f4di95t0jabjxt7t5ocu1cps">考虑一个 
<code>TitleCasePipe</code>，它将每个单词的首字母大写。 这是一个使用正则表达式的实现。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/shared/title-case.pipe.ts" header="app/shared/title-case.pipe.ts">
    <div class="docs-code-header"><h3>app/shared/title-case.pipe.ts</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {Pipe, PipeTransform} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">@Pipe({<span class="hljs-type">name</span>: <span class="hljs-string">'titlecase'</span>, standalone: <span class="hljs-keyword">true</span>, pure: <span class="hljs-keyword">true</span>})</div><div class="hljs-ln-line"><span class="hljs-comment">/** Transform to Title Case: uppercase the first letter of the words in a string. */</span></div><div class="hljs-ln-line">export <span class="hljs-keyword">class</span> TitleCasePipe implements PipeTransform {</div><div class="hljs-ln-line">  <span class="hljs-keyword">transform</span>(<span class="hljs-keyword">input</span>: string): string {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">input</span>.length === <span class="hljs-number">0</span></div><div class="hljs-ln-line">      ? <span class="hljs-string">''</span></div><div class="hljs-ln-line">      : <span class="hljs-keyword">input</span>.replace(/\w\S*/g, (txt) =&gt; txt[<span class="hljs-number">0</span>].toUpperCase() + txt.<span class="hljs-keyword">slice</span>(<span class="hljs-number">1</span>).toLowerCase());</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="64osqp3hrhq44i9c6fejc0d7x">任何使用正则表达式的东西都值得彻底测试。使用简单的 Jasmine 来探索预期的案例和边缘情况。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/shared/title-case.pipe.spec.ts" visiblelines="2,3,4,5,6,7,8,9,10,11,12,13,14,26" header="app/shared/title-case.pipe.spec.ts">
    <div class="docs-code-header"><h3>app/shared/title-case.pipe.spec.ts</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {TitleCasePipe} <span class="hljs-keyword">from</span> <span class="hljs-string">'./title-case.pipe'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">describe(<span class="hljs-string">'TitleCasePipe'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-regexp">//</span> This pipe <span class="hljs-keyword">is</span> a pure, stateless function so <span class="hljs-literal">no</span> need <span class="hljs-keyword">for</span> BeforeEach</div><div class="hljs-ln-line">  const pipe = <span class="hljs-keyword">new</span> TitleCasePipe();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it(<span class="hljs-string">'transforms "abc" to "Abc"'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    expect(pipe.transform(<span class="hljs-string">'abc'</span>)).toBe(<span class="hljs-string">'Abc'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it(<span class="hljs-string">'transforms "abc def" to "Abc Def"'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    expect(pipe.transform(<span class="hljs-string">'abc def'</span>)).toBe(<span class="hljs-string">'Abc Def'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-regexp">//</span> ... more tests ...</div><div class="hljs-ln-line">  it(<span class="hljs-string">'leaves "Abc Def" unchanged'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    expect(pipe.transform(<span class="hljs-string">'Abc Def'</span>)).toBe(<span class="hljs-string">'Abc Def'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it(<span class="hljs-string">'transforms "abc-def" to "Abc-def"'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    expect(pipe.transform(<span class="hljs-string">'abc-def'</span>)).toBe(<span class="hljs-string">'Abc-def'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it(<span class="hljs-string">'transforms "   abc   def" to "   Abc   Def" (preserves spaces) '</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    expect(pipe.transform(<span class="hljs-string">'   abc   def'</span>)).toBe(<span class="hljs-string">'   Abc   Def'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
  <h2 id="writing-dom-tests-to-support-a-pipe-test">
    <a href="#writing-dom-tests-to-support-a-pipe-test" class="docs-anchor" tabindex="-1" aria-label="Link to Writing DOM tests to support a pipe test" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="9sdo0o7rhjy78xut0teh3jw0l">编写 DOM 测试以支持管道测试</a>
  </h2>
  <p data-ng_translator_product="100" data-ng_translator_ref_id="f35wfgxrvzwvyghh4jqjiu8of">这些是管道的 
<em>独立</em>测试。 它们无法判断 
<code>TitleCasePipe</code> 在应用组件中是否正常工作。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="1pqgnklmt2rjs9c0bvp3po8of">考虑添加这样的组件测试：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/hero/hero-detail.component.spec.ts" visiblelines="160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177" header="app/hero/hero-detail.component.spec.ts (pipe test)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="c400fti5l85x8luiwbzfa9ps">app/hero/hero-detail.component.spec.ts（管道测试）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpClient</span>, <span class="hljs-title class_">HttpHandler</span>, provideHttpClient} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpTestingController</span>, provideHttpClientTesting} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, <span class="hljs-title class_">TestBed</span>, tick} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {provideRouter, <span class="hljs-title class_">Router</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">RouterTestingHarness</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {asyncData, click} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {sharedImports} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/shared'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroListComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-list.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Testing Vars //////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">harness</span>: <span class="hljs-title class_">RouterTestingHarness</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">page</span>: <span class="hljs-title class_">Page</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Tests //////</span></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'HeroDetailComponent'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with HeroModule setup'</span>, heroModuleSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when override its provided HeroDetailService'</span>, overrideSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with FormsModule setup'</span>, formsModuleSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with SharedModule setup'</span>, sharedModuleSetup);</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">///////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">const</span> testHero = <span class="hljs-title function_">getTestHeroes</span>()[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">overrideSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroDetailServiceSpy</span> {</div><div class="hljs-ln-line">    <span class="hljs-attr">testHero</span>: <span class="hljs-title class_">Hero</span> = {...testHero};</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">/* emit cloned test hero */</span></div><div class="hljs-ln-line">    getHero = jasmine</div><div class="hljs-ln-line">      .<span class="hljs-title function_">createSpy</span>(<span class="hljs-string">'getHero'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-property">and</span>.<span class="hljs-title function_">callFake</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, <span class="hljs-variable language_">this</span>.<span class="hljs-property">testHero</span>)));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">/* emit clone of test hero, with changes merged in */</span></div><div class="hljs-ln-line">    saveHero = jasmine</div><div class="hljs-ln-line">      .<span class="hljs-title function_">createSpy</span>(<span class="hljs-string">'saveHero'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-property">and</span>.<span class="hljs-title function_">callFake</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">testHero</span>, hero)));</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">HeroListComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroListComponent</span>},</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>},</div><div class="hljs-ln-line">          ]),</div><div class="hljs-ln-line">          <span class="hljs-title class_">HttpClient</span>,</div><div class="hljs-ln-line">          <span class="hljs-title class_">HttpHandler</span>,</div><div class="hljs-ln-line">          <span class="hljs-comment">// HeroDetailService at this level is IRRELEVANT!</span></div><div class="hljs-ln-line">          {<span class="hljs-attr">provide</span>: <span class="hljs-title class_">HeroDetailService</span>, <span class="hljs-attr">useValue</span>: {}},</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    )</div><div class="hljs-ln-line">      .<span class="hljs-title function_">overrideComponent</span>(<span class="hljs-title class_">HeroDetailComponent</span>, {</div><div class="hljs-ln-line">        <span class="hljs-attr">set</span>: {<span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">HeroDetailService</span>, <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">HeroDetailServiceSpy</span>}]},</div><div class="hljs-ln-line">      })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">hdsSpy</span>: <span class="hljs-title class_">HeroDetailServiceSpy</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">    component = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${testHero.id}</span>`</span>, <span class="hljs-title class_">HeroDetailComponent</span>);</div><div class="hljs-ln-line">    page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>();</div><div class="hljs-ln-line">    <span class="hljs-comment">// get the component's injected HeroDetailServiceSpy</span></div><div class="hljs-ln-line">    hdsSpy = harness.<span class="hljs-property">routeDebugElement</span>!.<span class="hljs-property">injector</span>.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">HeroDetailService</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should have called `getHero`'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">getHero</span>.<span class="hljs-property">calls</span>.<span class="hljs-title function_">count</span>())</div><div class="hljs-ln-line">      .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getHero called once'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'getHero called once'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display stub hero's name"</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should save stub hero change'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> origName = hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>;</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> newName = <span class="hljs-string">'New Name'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    page.<span class="hljs-property">nameInput</span>.<span class="hljs-property">value</span> = newName;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    page.<span class="hljs-property">nameInput</span>.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'input'</span>)); <span class="hljs-comment">// tell Angular</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(component.<span class="hljs-property">hero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'component hero has new name'</span>).<span class="hljs-title function_">toBe</span>(newName);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'service hero unchanged before save'</span>).<span class="hljs-title function_">toBe</span>(origName);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">saveHero</span>.<span class="hljs-property">calls</span>.<span class="hljs-title function_">count</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'saveHero called once'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// wait for async save to complete</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'service hero has new name after save'</span>).<span class="hljs-title function_">toBe</span>(newName);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes'</span>);</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////////////////////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {getTestHeroes} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/testing/test-hero.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">const</span> firstHero = <span class="hljs-title function_">getTestHeroes</span>()[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">heroModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">HeroListComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>},</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroListComponent</span>},</div><div class="hljs-ln-line">          ]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when navigate to existing hero'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">expectedHero</span>: <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      expectedHero = firstHero;</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display that hero's name"</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should navigate when click cancel'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">cancelBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${expectedHero.id}</span>`</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should save when click save but not navigate immediately'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>({<span class="hljs-attr">method</span>: <span class="hljs-string">'PUT'</span>, <span class="hljs-attr">url</span>: <span class="hljs-string">'api/heroes'</span>}));</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes/41'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should navigate when click save and save resolves'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// wait for async save to complete</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes/41'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should convert hero name to Title Case'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// get the name's input and display elements from the DOM</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">hostElement</span>: <span class="hljs-title class_">HTMLElement</span> = harness.<span class="hljs-property">routeNativeElement</span>!;</div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">nameInput</span>: <span class="hljs-title class_">HTMLInputElement</span> = hostElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'input'</span>)!;</div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">nameDisplay</span>: <span class="hljs-title class_">HTMLElement</span> = hostElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'span'</span>)!;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// simulate user entering a new name into the input box</span></div><div class="hljs-ln-line">      nameInput.<span class="hljs-property">value</span> = <span class="hljs-string">'quick BROWN  fOx'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// Dispatch a DOM event so that Angular learns of input value change.</span></div><div class="hljs-ln-line">      nameInput.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'input'</span>));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// Tell Angular to update the display binding through the title pipe</span></div><div class="hljs-ln-line">      harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(nameDisplay.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'Quick Brown  Fox'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when navigate to non-existent hero id'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(<span class="hljs-number">999</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should try to navigate back to hero list'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/////////////////////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">FormsModule</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/forms'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TitleCasePipe</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/title-case.pipe'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appConfig} <span class="hljs-keyword">from</span> <span class="hljs-string">'../app.config'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">formsModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">FormsModule</span>, <span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">TitleCasePipe</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}]),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display 1st hero's name"</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedHero = firstHero;</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">///////////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sharedModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, sharedImports],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display 1st hero's name"</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedHero = firstHero;</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/////////// Helpers /////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/** Create the HeroDetailComponent, initialize it, set test variables  */</span></div><div class="hljs-ln-line"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createComponent</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {</div><div class="hljs-ln-line">  harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">  component = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${id}</span>`</span>, <span class="hljs-title class_">HeroDetailComponent</span>);</div><div class="hljs-ln-line">  page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> request = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>(<span class="hljs-string">`api/heroes/?id=<span class="hljs-subst">${id}</span>`</span>);</div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> hero = <span class="hljs-title function_">getTestHeroes</span>().<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">h</span>) =&gt;</span> h.<span class="hljs-property">id</span> === <span class="hljs-title class_">Number</span>(id));</div><div class="hljs-ln-line">  request.<span class="hljs-title function_">flush</span>(hero ? [hero] : []);</div><div class="hljs-ln-line">  harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Page</span> {</div><div class="hljs-ln-line">  <span class="hljs-comment">// getter properties wait to query the DOM until called.</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">buttons</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">queryAll</span>&lt;<span class="hljs-title class_">HTMLButtonElement</span>&gt;(<span class="hljs-string">'button'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">saveBtn</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buttons</span>[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">cancelBtn</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buttons</span>[<span class="hljs-number">1</span>];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">nameDisplay</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>&lt;<span class="hljs-title class_">HTMLElement</span>&gt;(<span class="hljs-string">'span'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">nameInput</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>&lt;<span class="hljs-title class_">HTMLInputElement</span>&gt;(<span class="hljs-string">'input'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">//// query helpers ////</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> query&lt;T&gt;(<span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>): T {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelector</span>(selector)! <span class="hljs-keyword">as</span> T;</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> queryAll&lt;T&gt;(<span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>): T[] {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelectorAll</span>(selector) <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span> <span class="hljs-keyword">as</span> T[];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>