<header class="docs-header">
      <docs-breadcrumb></docs-breadcrumb>

      
  <!-- Page title -->
  <div class="docs-page-title">
    <h1 tabindex="-1" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="a5jpibp6n1zq28ouc6cp4r5kw">组件测试场景</h1>
    <a class="docs-github-links" target="_blank" href="https://github.com/angular/angular/edit/main/adev/src/content/guide/testing/components-scenarios.md" title="Edit this page" aria-label="Edit this page">
      <!-- Pencil -->
      <docs-icon role="presentation">edit</docs-icon>
    </a>
  </div>
    </header>
    <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="ak09en2cgla03f6r1qkq5f1z1">本指南探讨了一些常见的组件测试用例。</p>

  <h2 id="component-binding">
    <a href="#component-binding" class="docs-anchor" tabindex="-1" aria-label="Link to Component binding" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="f0asb3p38hvlasskxr2g0unas">组件绑定</a>
  </h2>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="erfedx5mtoy0pzf6al5o407n6">在范例应用中，<code>BannerComponent</code> 在 HTML 模板中展示了静态的标题文本。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="4xt4akepqvsnnuh33ekb25imk">在少许更改之后，<code>BannerComponent</code> 就会通过绑定组件的 <code>title</code> 属性来渲染动态标题。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/banner/banner.component.ts" visiblelines="2,3,4,5,6,7,8,9,10" header="app/banner/banner.component.ts">
    <div class="docs-code-header"><h3>app/banner/banner.component.ts</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {Component} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">@Component({</div><div class="hljs-ln-line">  standalone: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">  selector: <span class="hljs-string">'app-banner'</span>,</div><div class="hljs-ln-line">  template: <span class="hljs-string">'&lt;h1&gt;{{title}}&lt;/h1&gt;'</span>,</div><div class="hljs-ln-line">  styles: [<span class="hljs-string">'h1 { color: green; font-size: 350%}'</span>],</div><div class="hljs-ln-line">})</div><div class="hljs-ln-line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BannerComponent</span> {</div><div class="hljs-ln-line">  title = <span class="hljs-string">'Test Tour of Heroes'</span>;</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="1iloqyl55ypown3lm3s1skia8">尽管这很小，但你还是决定要添加一个测试来确认该组件实际显示的是你认为合适的内容。</p>

  <h3 id="query-for-the-h1">
    <a href="#query-for-the-h1" class="docs-anchor" tabindex="-1" aria-label="Link to Query for the <code><h1></code>" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="44kzpueoxej3fhdoockdsu98r">查询 <code>&lt;h1&gt;</code> 元素</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="9up2flg02aeljodm0j6j4hjyx">你将编写一系列测试来检查 <code>&lt;h1&gt;</code> 元素中包裹的 <em>title</em> 属性插值绑定。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="dje2f7dkplza23h52yyethiuy">你可以修改 <code>beforeEach</code> 以找到带有标准 HTML <code>querySelector</code> 的元素，并把它赋值给 <code>h1</code> 变量。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/banner/banner.component.spec.ts" visiblelines="5,6,7,8,9,10,11,12,13,14,15,16" header="app/banner/banner.component.spec.ts (setup)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="d7771gw3uuoupbveb3urvgprw">app/banner/banner.component.spec.ts（设置）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {ComponentFixture, TestBed} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {BannerComponent} <span class="hljs-keyword">from</span> <span class="hljs-string">'./banner.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">describe(<span class="hljs-string">'BannerComponent (inline template)'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">  let component: BannerComponent;</div><div class="hljs-ln-line">  let fixture: ComponentFixture&lt;BannerComponent&gt;;</div><div class="hljs-ln-line">  let h1: HTMLElement;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  beforeEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    TestBed.configureTestingModule({</div><div class="hljs-ln-line">      imports: [BannerComponent],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    fixture = TestBed.createComponent(BannerComponent);</div><div class="hljs-ln-line">    component = fixture.componentInstance; <span class="hljs-regexp">//</span> BannerComponent test instance</div><div class="hljs-ln-line">    h1 = fixture.nativeElement.querySelector(<span class="hljs-string">'h1'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it(<span class="hljs-string">'no title in the DOM after createComponent()'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    expect(h1.textContent).toEqual(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it(<span class="hljs-string">'should display original title'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    fixture.detectChanges();</div><div class="hljs-ln-line">    expect(h1.textContent).toContain(component.title);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it(<span class="hljs-string">'should display original title after detectChanges()'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    fixture.detectChanges();</div><div class="hljs-ln-line">    expect(h1.textContent).toContain(component.title);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it(<span class="hljs-string">'should display a different test title'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    component.title = <span class="hljs-string">'Test Title'</span>;</div><div class="hljs-ln-line">    fixture.detectChanges();</div><div class="hljs-ln-line">    expect(h1.textContent).toContain(<span class="hljs-string">'Test Title'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
  <h3 id="createcomponent-does-not-bind-data">
    <a href="#createcomponent-does-not-bind-data" class="docs-anchor" tabindex="-1" aria-label="Link to <code>createComponent()</code> does not bind data" data-ng_translator_product="100" data-ng_translator_ref_id="aebt1fht2lmaw41c2obewyt7t"><code>createComponent()</code> 不绑定数据</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="2f851s9zxzckdoswjaxpco0sg">对于你的第一个测试，你希望屏幕上显示默认的 <code>title</code>。你的直觉就是编写一个能立即检查 <code>&lt;h1&gt;</code> 的测试，就像这样：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/banner/banner.component.spec.ts" visiblelines="22,24,25">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {ComponentFixture, TestBed} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {BannerComponent} <span class="hljs-keyword">from</span> <span class="hljs-string">'./banner.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">describe(<span class="hljs-string">'BannerComponent (inline template)'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">  let component: BannerComponent;</div><div class="hljs-ln-line">  let fixture: ComponentFixture&lt;BannerComponent&gt;;</div><div class="hljs-ln-line">  let h1: HTMLElement;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  beforeEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    TestBed.configureTestingModule({</div><div class="hljs-ln-line">      imports: [BannerComponent],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    fixture = TestBed.createComponent(BannerComponent);</div><div class="hljs-ln-line">    component = fixture.componentInstance; <span class="hljs-regexp">//</span> BannerComponent test instance</div><div class="hljs-ln-line">    h1 = fixture.nativeElement.querySelector(<span class="hljs-string">'h1'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it(<span class="hljs-string">'no title in the DOM after createComponent()'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    expect(h1.textContent).toEqual(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it(<span class="hljs-string">'should display original title'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    fixture.detectChanges();</div><div class="hljs-ln-line">    expect(h1.textContent).toContain(component.title);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it(<span class="hljs-string">'should display original title after detectChanges()'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    fixture.detectChanges();</div><div class="hljs-ln-line">    expect(h1.textContent).toContain(component.title);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it(<span class="hljs-string">'should display a different test title'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    component.title = <span class="hljs-string">'Test Title'</span>;</div><div class="hljs-ln-line">    fixture.detectChanges();</div><div class="hljs-ln-line">    expect(h1.textContent).toContain(<span class="hljs-string">'Test Title'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="2dqpzcuuu30mwevl5n2wbl0nv"><em>那个测试失败</em>了：</p>
<div class="docs-code">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line">expected <span class="hljs-string">''</span> to contain <span class="hljs-string">'Test Tour of Heroes'</span>.</div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="422huc53i246yaaem1j9lm5br"><strong>当 Angular 执行变更检测</strong>时就会发生绑定。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="66bmb3sbnidi9g9c9dwqg8vhu">在生产环境中，当 Angular 创建一个组件，或者用户输入按键，或者异步活动（比如 AJAX）完成时，就会自动进行变更检测。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="diwe8eojg5qlilq97n6t9m9ua">该 <code>TestBed.createComponent</code> <em>不会</em>触发变化检测，修改后的测试可以证实这一点：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/banner/banner.component.spec.ts" visiblelines="18,19,20">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {ComponentFixture, TestBed} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {BannerComponent} <span class="hljs-keyword">from</span> <span class="hljs-string">'./banner.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">describe(<span class="hljs-string">'BannerComponent (inline template)'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">  let component: BannerComponent;</div><div class="hljs-ln-line">  let fixture: ComponentFixture&lt;BannerComponent&gt;;</div><div class="hljs-ln-line">  let h1: HTMLElement;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  beforeEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    TestBed.configureTestingModule({</div><div class="hljs-ln-line">      imports: [BannerComponent],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    fixture = TestBed.createComponent(BannerComponent);</div><div class="hljs-ln-line">    component = fixture.componentInstance; <span class="hljs-regexp">//</span> BannerComponent test instance</div><div class="hljs-ln-line">    h1 = fixture.nativeElement.querySelector(<span class="hljs-string">'h1'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it(<span class="hljs-string">'no title in the DOM after createComponent()'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    expect(h1.textContent).toEqual(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it(<span class="hljs-string">'should display original title'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    fixture.detectChanges();</div><div class="hljs-ln-line">    expect(h1.textContent).toContain(component.title);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it(<span class="hljs-string">'should display original title after detectChanges()'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    fixture.detectChanges();</div><div class="hljs-ln-line">    expect(h1.textContent).toContain(component.title);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it(<span class="hljs-string">'should display a different test title'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    component.title = <span class="hljs-string">'Test Title'</span>;</div><div class="hljs-ln-line">    fixture.detectChanges();</div><div class="hljs-ln-line">    expect(h1.textContent).toContain(<span class="hljs-string">'Test Title'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
  <h3 id="detectchanges">
    <a href="#detectchanges" class="docs-anchor" tabindex="-1" aria-label="Link to <code>detectChanges()</code>"><code>detectChanges()</code></a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_ref_id="47voqrlgeex1fme5wq98ja6jm">你必须通过调用 
<code>fixture.detectChanges()</code> 告诉 
<code>TestBed</code> 执行数据绑定。 只有这样 
<code>&lt;h1&gt;</code> 才会有预期的标题。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/banner/banner.component.spec.ts" visiblelines="27,28,29,30">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {ComponentFixture, TestBed} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {BannerComponent} <span class="hljs-keyword">from</span> <span class="hljs-string">'./banner.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">describe(<span class="hljs-string">'BannerComponent (inline template)'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">  let component: BannerComponent;</div><div class="hljs-ln-line">  let fixture: ComponentFixture&lt;BannerComponent&gt;;</div><div class="hljs-ln-line">  let h1: HTMLElement;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  beforeEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    TestBed.configureTestingModule({</div><div class="hljs-ln-line">      imports: [BannerComponent],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    fixture = TestBed.createComponent(BannerComponent);</div><div class="hljs-ln-line">    component = fixture.componentInstance; <span class="hljs-regexp">//</span> BannerComponent test instance</div><div class="hljs-ln-line">    h1 = fixture.nativeElement.querySelector(<span class="hljs-string">'h1'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it(<span class="hljs-string">'no title in the DOM after createComponent()'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    expect(h1.textContent).toEqual(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it(<span class="hljs-string">'should display original title'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    fixture.detectChanges();</div><div class="hljs-ln-line">    expect(h1.textContent).toContain(component.title);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it(<span class="hljs-string">'should display original title after detectChanges()'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    fixture.detectChanges();</div><div class="hljs-ln-line">    expect(h1.textContent).toContain(component.title);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it(<span class="hljs-string">'should display a different test title'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    component.title = <span class="hljs-string">'Test Title'</span>;</div><div class="hljs-ln-line">    fixture.detectChanges();</div><div class="hljs-ln-line">    expect(h1.textContent).toContain(<span class="hljs-string">'Test Title'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="8653b1zbfwc7o7kh84ynb1198">延迟变更检测是有意为之且有用的。 它给予测试者在<em> Angular 启动数据绑定和调用 
<a href="guide/components/lifecycle">生命周期钩子</a> 之前</em>检查和改变组件状态的机会。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="46hf55079ndq85x7vg8elnxrx">这是另一个测试，它会在调用 <code>fixture.detectChanges()</code> <em>之前</em>改变组件的 <code>title</code> 属性。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/banner/banner.component.spec.ts" visiblelines="32,33,34,35,36">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {ComponentFixture, TestBed} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {BannerComponent} <span class="hljs-keyword">from</span> <span class="hljs-string">'./banner.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">describe(<span class="hljs-string">'BannerComponent (inline template)'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">  let component: BannerComponent;</div><div class="hljs-ln-line">  let fixture: ComponentFixture&lt;BannerComponent&gt;;</div><div class="hljs-ln-line">  let h1: HTMLElement;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  beforeEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    TestBed.configureTestingModule({</div><div class="hljs-ln-line">      imports: [BannerComponent],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    fixture = TestBed.createComponent(BannerComponent);</div><div class="hljs-ln-line">    component = fixture.componentInstance; <span class="hljs-regexp">//</span> BannerComponent test instance</div><div class="hljs-ln-line">    h1 = fixture.nativeElement.querySelector(<span class="hljs-string">'h1'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it(<span class="hljs-string">'no title in the DOM after createComponent()'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    expect(h1.textContent).toEqual(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it(<span class="hljs-string">'should display original title'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    fixture.detectChanges();</div><div class="hljs-ln-line">    expect(h1.textContent).toContain(component.title);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it(<span class="hljs-string">'should display original title after detectChanges()'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    fixture.detectChanges();</div><div class="hljs-ln-line">    expect(h1.textContent).toContain(component.title);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it(<span class="hljs-string">'should display a different test title'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    component.title = <span class="hljs-string">'Test Title'</span>;</div><div class="hljs-ln-line">    fixture.detectChanges();</div><div class="hljs-ln-line">    expect(h1.textContent).toContain(<span class="hljs-string">'Test Title'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
  <h3 id="automatic-change-detection">
    <a href="#automatic-change-detection" class="docs-anchor" tabindex="-1" aria-label="Link to Automatic change detection" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="d9dphvlbvnlcqv7ql0p7bc2zr">自动变更检测</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="67kw3f10c7etrll6slzlv28f6"><code>BannerComponent</code> 测试会经常调用 <code>detectChanges</code>。一些测试人员更喜欢让 Angular 测试环境自动运行变更检测。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="a8pb1u4ebdtiomfshtxmrx4lh">通过配置 
<code>TestBed</code> 使用 
<code>ComponentFixtureAutoDetect</code> 提供者来实现这一点。 首先从测试实用库中导入它：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/banner/banner.component.detect-changes.spec.ts" visiblelines="0" header="app/banner/banner.component.detect-changes.spec.ts (import)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="2dv838tqc1fdhu3gfvt9fm2ij">app/banner/banner.component.detect-changes.spec.ts（导入）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">ComponentFixtureAutoDetect</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">ComponentFixture</span>, <span class="hljs-title class_">TestBed</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">BannerComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./banner.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'BannerComponent (AutoChangeDetect)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">comp</span>: <span class="hljs-title class_">BannerComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">BannerComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">h1</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">BannerComponent</span>],</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">ComponentFixtureAutoDetect</span>, <span class="hljs-attr">useValue</span>: <span class="hljs-literal">true</span>}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">BannerComponent</span>);</div><div class="hljs-ln-line">    comp = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line">    h1 = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'h1'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display original title'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// Hooray! No `fixture.detectChanges()` needed</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(h1.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(comp.<span class="hljs-property">title</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should still see original title after comp.title change'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> oldTitle = comp.<span class="hljs-property">title</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">title</span> = <span class="hljs-string">'Test Title'</span>;</div><div class="hljs-ln-line">    <span class="hljs-comment">// Displayed title is old because Angular didn't hear the change :(</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(h1.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(oldTitle);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display updated title after detectChanges'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    comp.<span class="hljs-property">title</span> = <span class="hljs-string">'Test Title'</span>;</div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// detect changes explicitly</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(h1.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(comp.<span class="hljs-property">title</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="f3xbom95bbm35awdgyvuopd3u">然后把它添加到测试模块配置的 <code>providers</code> 中：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/banner/banner.component.detect-changes.spec.ts" visiblelines="11,12,13,14" header="app/banner/banner.component.detect-changes.spec.ts (AutoDetect)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="dxmvaoc8m71a0u5juayxvoc4w">app/banner/banner.component.detect-changes.spec.ts（AutoDetect）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">ComponentFixtureAutoDetect</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">ComponentFixture</span>, <span class="hljs-title class_">TestBed</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">BannerComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./banner.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'BannerComponent (AutoChangeDetect)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">comp</span>: <span class="hljs-title class_">BannerComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">BannerComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">h1</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">BannerComponent</span>],</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">ComponentFixtureAutoDetect</span>, <span class="hljs-attr">useValue</span>: <span class="hljs-literal">true</span>}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">BannerComponent</span>);</div><div class="hljs-ln-line">    comp = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line">    h1 = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'h1'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display original title'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// Hooray! No `fixture.detectChanges()` needed</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(h1.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(comp.<span class="hljs-property">title</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should still see original title after comp.title change'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> oldTitle = comp.<span class="hljs-property">title</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">title</span> = <span class="hljs-string">'Test Title'</span>;</div><div class="hljs-ln-line">    <span class="hljs-comment">// Displayed title is old because Angular didn't hear the change :(</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(h1.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(oldTitle);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display updated title after detectChanges'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    comp.<span class="hljs-property">title</span> = <span class="hljs-string">'Test Title'</span>;</div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// detect changes explicitly</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(h1.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(comp.<span class="hljs-property">title</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="eu7pt1x656xdovf9quymkcrw4">这里有三个测试来说明自动变更检测是如何工作的。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/banner/banner.component.detect-changes.spec.ts" visiblelines="20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36" header="app/banner/banner.component.detect-changes.spec.ts (AutoDetect Tests)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="9md6geg33elma6nhge1nsqluv">app/banner/banner.component.detect-changes.spec.ts（AutoDetect 测试）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">ComponentFixtureAutoDetect</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">ComponentFixture</span>, <span class="hljs-title class_">TestBed</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">BannerComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./banner.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'BannerComponent (AutoChangeDetect)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">comp</span>: <span class="hljs-title class_">BannerComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">BannerComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">h1</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">BannerComponent</span>],</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">ComponentFixtureAutoDetect</span>, <span class="hljs-attr">useValue</span>: <span class="hljs-literal">true</span>}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">BannerComponent</span>);</div><div class="hljs-ln-line">    comp = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line">    h1 = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'h1'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display original title'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// Hooray! No `fixture.detectChanges()` needed</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(h1.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(comp.<span class="hljs-property">title</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should still see original title after comp.title change'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> oldTitle = comp.<span class="hljs-property">title</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">title</span> = <span class="hljs-string">'Test Title'</span>;</div><div class="hljs-ln-line">    <span class="hljs-comment">// Displayed title is old because Angular didn't hear the change :(</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(h1.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(oldTitle);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display updated title after detectChanges'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    comp.<span class="hljs-property">title</span> = <span class="hljs-string">'Test Title'</span>;</div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// detect changes explicitly</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(h1.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(comp.<span class="hljs-property">title</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="be5qqigl841bsssz3greu05ff">第一个测试显示了自动变更检测的优点。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="8agj1c39uxth60zqtgq8492jl">第二个和第三个测试揭示了一个重要的限制。 Angular 测试环境 
<em>不知道</em> 测试改变了组件的 
<code>title</code>。 
<code>ComponentFixtureAutoDetect</code> 服务响应 
<em>异步活动</em>，如 promise 求解、定时器和 DOM 事件。 但组件属性的直接同步更新是不可见的。 测试必须手动调用 
<code>fixture.detectChanges()</code> 以触发另一个变更检测周期。</p>

    <div class="docs-alert docs-alert-helpful">
    <p data-ng_translator_product="100" data-ng_translator_ref_id="9q98y11lvum3k4mdf3rki65h0"><strong>有用：</strong> 本指南中的示例<em>始终</em><em>显式调用</em> 
<code>detectChanges()</code>，而不是去猜测测试夹具何时会或不会进行变更检测。 多次调用 
<code>detectChanges()</code> 并不会造成任何危害，即使这样做并非绝对必要。</p>

    </div>
    
  <h3 id="change-an-input-value-with-dispatchevent">
    <a href="#change-an-input-value-with-dispatchevent" class="docs-anchor" tabindex="-1" aria-label="Link to Change an input value with <code>dispatchEvent()</code>" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="4fw79hwe97bzhokivsexr5qbf">使用  <code>dispatchEvent()</code> 改变输入框的值</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="2r0rzwasaj3ue69uzd2e9g427">要模拟用户输入，你可以找到 input 元素并设置它的 <code>value</code> 属性。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="bucusr3q99wcxkxfijsy6zeqr">你会调用 <code>fixture.detectChanges()</code> 来触发 Angular 的变更检测。但还有一个重要的中间步骤。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="5i0oozs2salh77nhrccxwq16q">Angular 并不知道你为 input 设置过 <code>value</code> 属性。在通过调用 <code>dispatchEvent()</code> 分发 <code>input</code> 事件之前，它不会读取该属性。<em>紧接着</em>你就调用了 <code>detectChanges()</code>。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="esidsmwffl3td2l6t9h9nisei">下列例子说明了正确的顺序。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/hero/hero-detail.component.spec.ts" visiblelines="160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177" header="app/hero/hero-detail.component.spec.ts (pipe test)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="c400fti5l85x8luiwbzfa9ps">app/hero/hero-detail.component.spec.ts（管道测试）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpClient</span>, <span class="hljs-title class_">HttpHandler</span>, provideHttpClient} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpTestingController</span>, provideHttpClientTesting} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, <span class="hljs-title class_">TestBed</span>, tick} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {provideRouter, <span class="hljs-title class_">Router</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">RouterTestingHarness</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {asyncData, click} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {sharedImports} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/shared'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroListComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-list.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Testing Vars //////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">harness</span>: <span class="hljs-title class_">RouterTestingHarness</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">page</span>: <span class="hljs-title class_">Page</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Tests //////</span></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'HeroDetailComponent'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with HeroModule setup'</span>, heroModuleSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when override its provided HeroDetailService'</span>, overrideSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with FormsModule setup'</span>, formsModuleSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with SharedModule setup'</span>, sharedModuleSetup);</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">///////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">const</span> testHero = <span class="hljs-title function_">getTestHeroes</span>()[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">overrideSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroDetailServiceSpy</span> {</div><div class="hljs-ln-line">    <span class="hljs-attr">testHero</span>: <span class="hljs-title class_">Hero</span> = {...testHero};</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">/* emit cloned test hero */</span></div><div class="hljs-ln-line">    getHero = jasmine</div><div class="hljs-ln-line">      .<span class="hljs-title function_">createSpy</span>(<span class="hljs-string">'getHero'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-property">and</span>.<span class="hljs-title function_">callFake</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, <span class="hljs-variable language_">this</span>.<span class="hljs-property">testHero</span>)));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">/* emit clone of test hero, with changes merged in */</span></div><div class="hljs-ln-line">    saveHero = jasmine</div><div class="hljs-ln-line">      .<span class="hljs-title function_">createSpy</span>(<span class="hljs-string">'saveHero'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-property">and</span>.<span class="hljs-title function_">callFake</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">testHero</span>, hero)));</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">HeroListComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroListComponent</span>},</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>},</div><div class="hljs-ln-line">          ]),</div><div class="hljs-ln-line">          <span class="hljs-title class_">HttpClient</span>,</div><div class="hljs-ln-line">          <span class="hljs-title class_">HttpHandler</span>,</div><div class="hljs-ln-line">          <span class="hljs-comment">// HeroDetailService at this level is IRRELEVANT!</span></div><div class="hljs-ln-line">          {<span class="hljs-attr">provide</span>: <span class="hljs-title class_">HeroDetailService</span>, <span class="hljs-attr">useValue</span>: {}},</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    )</div><div class="hljs-ln-line">      .<span class="hljs-title function_">overrideComponent</span>(<span class="hljs-title class_">HeroDetailComponent</span>, {</div><div class="hljs-ln-line">        <span class="hljs-attr">set</span>: {<span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">HeroDetailService</span>, <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">HeroDetailServiceSpy</span>}]},</div><div class="hljs-ln-line">      })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">hdsSpy</span>: <span class="hljs-title class_">HeroDetailServiceSpy</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">    component = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${testHero.id}</span>`</span>, <span class="hljs-title class_">HeroDetailComponent</span>);</div><div class="hljs-ln-line">    page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>();</div><div class="hljs-ln-line">    <span class="hljs-comment">// get the component's injected HeroDetailServiceSpy</span></div><div class="hljs-ln-line">    hdsSpy = harness.<span class="hljs-property">routeDebugElement</span>!.<span class="hljs-property">injector</span>.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">HeroDetailService</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should have called `getHero`'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">getHero</span>.<span class="hljs-property">calls</span>.<span class="hljs-title function_">count</span>())</div><div class="hljs-ln-line">      .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getHero called once'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'getHero called once'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display stub hero's name"</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should save stub hero change'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> origName = hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>;</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> newName = <span class="hljs-string">'New Name'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    page.<span class="hljs-property">nameInput</span>.<span class="hljs-property">value</span> = newName;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    page.<span class="hljs-property">nameInput</span>.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'input'</span>)); <span class="hljs-comment">// tell Angular</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(component.<span class="hljs-property">hero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'component hero has new name'</span>).<span class="hljs-title function_">toBe</span>(newName);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'service hero unchanged before save'</span>).<span class="hljs-title function_">toBe</span>(origName);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">saveHero</span>.<span class="hljs-property">calls</span>.<span class="hljs-title function_">count</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'saveHero called once'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// wait for async save to complete</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'service hero has new name after save'</span>).<span class="hljs-title function_">toBe</span>(newName);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes'</span>);</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////////////////////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {getTestHeroes} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/testing/test-hero.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">const</span> firstHero = <span class="hljs-title function_">getTestHeroes</span>()[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">heroModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">HeroListComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>},</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroListComponent</span>},</div><div class="hljs-ln-line">          ]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when navigate to existing hero'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">expectedHero</span>: <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      expectedHero = firstHero;</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display that hero's name"</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should navigate when click cancel'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">cancelBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${expectedHero.id}</span>`</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should save when click save but not navigate immediately'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>({<span class="hljs-attr">method</span>: <span class="hljs-string">'PUT'</span>, <span class="hljs-attr">url</span>: <span class="hljs-string">'api/heroes'</span>}));</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes/41'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should navigate when click save and save resolves'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// wait for async save to complete</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes/41'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should convert hero name to Title Case'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// get the name's input and display elements from the DOM</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">hostElement</span>: <span class="hljs-title class_">HTMLElement</span> = harness.<span class="hljs-property">routeNativeElement</span>!;</div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">nameInput</span>: <span class="hljs-title class_">HTMLInputElement</span> = hostElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'input'</span>)!;</div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">nameDisplay</span>: <span class="hljs-title class_">HTMLElement</span> = hostElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'span'</span>)!;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// simulate user entering a new name into the input box</span></div><div class="hljs-ln-line">      nameInput.<span class="hljs-property">value</span> = <span class="hljs-string">'quick BROWN  fOx'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// Dispatch a DOM event so that Angular learns of input value change.</span></div><div class="hljs-ln-line">      nameInput.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'input'</span>));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// Tell Angular to update the display binding through the title pipe</span></div><div class="hljs-ln-line">      harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(nameDisplay.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'Quick Brown  Fox'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when navigate to non-existent hero id'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(<span class="hljs-number">999</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should try to navigate back to hero list'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/////////////////////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">FormsModule</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/forms'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TitleCasePipe</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/title-case.pipe'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appConfig} <span class="hljs-keyword">from</span> <span class="hljs-string">'../app.config'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">formsModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">FormsModule</span>, <span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">TitleCasePipe</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}]),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display 1st hero's name"</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedHero = firstHero;</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">///////////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sharedModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, sharedImports],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display 1st hero's name"</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedHero = firstHero;</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/////////// Helpers /////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/** Create the HeroDetailComponent, initialize it, set test variables  */</span></div><div class="hljs-ln-line"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createComponent</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {</div><div class="hljs-ln-line">  harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">  component = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${id}</span>`</span>, <span class="hljs-title class_">HeroDetailComponent</span>);</div><div class="hljs-ln-line">  page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> request = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>(<span class="hljs-string">`api/heroes/?id=<span class="hljs-subst">${id}</span>`</span>);</div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> hero = <span class="hljs-title function_">getTestHeroes</span>().<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">h</span>) =&gt;</span> h.<span class="hljs-property">id</span> === <span class="hljs-title class_">Number</span>(id));</div><div class="hljs-ln-line">  request.<span class="hljs-title function_">flush</span>(hero ? [hero] : []);</div><div class="hljs-ln-line">  harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Page</span> {</div><div class="hljs-ln-line">  <span class="hljs-comment">// getter properties wait to query the DOM until called.</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">buttons</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">queryAll</span>&lt;<span class="hljs-title class_">HTMLButtonElement</span>&gt;(<span class="hljs-string">'button'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">saveBtn</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buttons</span>[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">cancelBtn</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buttons</span>[<span class="hljs-number">1</span>];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">nameDisplay</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>&lt;<span class="hljs-title class_">HTMLElement</span>&gt;(<span class="hljs-string">'span'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">nameInput</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>&lt;<span class="hljs-title class_">HTMLInputElement</span>&gt;(<span class="hljs-string">'input'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">//// query helpers ////</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> query&lt;T&gt;(<span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>): T {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelector</span>(selector)! <span class="hljs-keyword">as</span> T;</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> queryAll&lt;T&gt;(<span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>): T[] {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelectorAll</span>(selector) <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span> <span class="hljs-keyword">as</span> T[];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
  <h2 id="component-with-external-files">
    <a href="#component-with-external-files" class="docs-anchor" tabindex="-1" aria-label="Link to Component with external files" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="2tupz2zj58o18z446ljjyvnee">具有外部文件的组件</a>
  </h2>
  <p data-ng_translator_product="100" data-ng_translator_ref_id="4d1jcafgq02as5ypsp9innm5x">前面的 
<code>BannerComponent</code> 使用了<em>内联模板</em>和<em>内联 CSS </em>进行定义，分别在 
<code>@Component.template</code> 和 
<code>@Component.styles</code> 属性中指定。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="cddst60pmwyf2anh1d2ao1lzu">许多组件使用 
<code>@Component.templateUrl</code> 和 
<code>@Component.styleUrls</code> 属性指定 
<em>外部模板</em> 和 
<em>外部 CSS</em>，如下面的 
<code>BannerComponent</code> 变体所示。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/banner/banner-external.component.ts" visiblelines="2,3,4,5,6,7" header="app/banner/banner-external.component.ts (metadata)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="aj4tjjs81ps7etdipm1mcwh2o">app/banner/banner-external.component.ts（元数据）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {Component} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">@Component({</div><div class="hljs-ln-line">  standalone: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">  selector: <span class="hljs-string">'app-banner'</span>,</div><div class="hljs-ln-line">  templateUrl: <span class="hljs-string">'./banner-external.component.html'</span>,</div><div class="hljs-ln-line">  styleUrls: [<span class="hljs-string">'./banner-external.component.css'</span>],</div><div class="hljs-ln-line">})</div><div class="hljs-ln-line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BannerComponent</span> {</div><div class="hljs-ln-line">  title = <span class="hljs-string">'Test Tour of Heroes'</span>;</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="41nllu3k4zs2wf2vsgpkq16f6">这个语法告诉 Angular 编译器要在组件编译时读取外部文件。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="2qgalt4ugkfnt4ugwbc1ppb14">当运行 <code>ng test</code> 命令时，这不是问题，因为它会<em>在运行测试之前编译应用</em>。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="dsiwk09r50q14roaczbreeas1">然而，如果在 
<strong>非 CLI 环境</strong> 中运行这个组件的测试，可能会失败。 例如，如果在 web 编码环境（如 
<a href="https://plnkr.co" target="_blank">plunker</a>）中运行 
<code>BannerComponent</code> 的测试，你会看到这样的消息：</p>
<div class="docs-code shell">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line">Error: This test module uses the component BannerComponent</div><div class="hljs-ln-line">which is using a "templateUrl" or "styleUrls", but they were never compiled.</div><div class="hljs-ln-line">Please call "TestBed.compileComponents" before your test.</div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="26h08hhi9go7cwn71uv517toa">当运行环境<em>在测试过程中</em>编译源码时，你会收到此测试失败信息。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="3hrh1elp9x1bm1mkaad4w7hd4">要解决这个问题，请按照下面的 
<a href="#calling-compilecomponents">调用 compileComponents</a> 部分中的说明调用 
<code>compileComponents()</code>。</p>

  <h2 id="component-with-a-dependency">
    <a href="#component-with-a-dependency" class="docs-anchor" tabindex="-1" aria-label="Link to Component with a dependency" data-ng_translator_product="100" data-ng_translator_ref_id="9gc7b5p3txeu55fqumg6fbmqt">具有依赖项的组件</a>
  </h2>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="50nquo5snywxvj44c3c0fyazg">组件通常都有服务依赖。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="c4ul77bqmn0vikkz1ohjljmbx"><code>WelcomeComponent</code> 会向登录用户显示一条欢迎信息。它可以基于注入进来的 <code>UserService</code> 的一个属性了解到用户是谁：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/welcome/welcome.component.ts" header="app/welcome/welcome.component.ts">
    <div class="docs-code-header"><h3>app/welcome/welcome.component.ts</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Component</span>, <span class="hljs-title class_">OnInit</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">UserService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/user.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-meta">@Component</span>({</div><div class="hljs-ln-line">  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">selector</span>: <span class="hljs-string">'app-welcome'</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">template</span>: <span class="hljs-string">'&lt;h3 class="welcome"&gt;&lt;i&gt;{{welcome}}&lt;/i&gt;&lt;/h3&gt;'</span>,</div><div class="hljs-ln-line">})</div><div class="hljs-ln-line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WelcomeComponent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OnInit</span> {</div><div class="hljs-ln-line">  welcome = <span class="hljs-string">''</span>;</div><div class="hljs-ln-line">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> userService: UserService</span>) {}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">ngOnInit</span>(): <span class="hljs-built_in">void</span> {</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">welcome</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-property">isLoggedIn</span></div><div class="hljs-ln-line">      ? <span class="hljs-string">'Welcome, '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-property">user</span>.<span class="hljs-property">name</span></div><div class="hljs-ln-line">      : <span class="hljs-string">'Please log in.'</span>;</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="5d5igk6x4lvuxmn3q84kys0t1"><code>WelcomeComponent</code> 拥有与该服务交互的决策逻辑，该逻辑让这个组件值得测试。这是 spec 文件的测试模块配置：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/welcome/welcome.component.spec.ts" visiblelines="57,58,59,60,61,62" header="app/welcome/welcome.component.spec.ts">
    <div class="docs-code-header"><h3>app/welcome/welcome.component.spec.ts</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">ComponentFixture</span>, inject, <span class="hljs-title class_">TestBed</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">UserService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/user.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">WelcomeComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./welcome.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MockUserService</span> {</div><div class="hljs-ln-line">  isLoggedIn = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">  user = {<span class="hljs-attr">name</span>: <span class="hljs-string">'Test User'</span>};</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'WelcomeComponent (class only)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">comp</span>: <span class="hljs-title class_">WelcomeComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">userService</span>: <span class="hljs-title class_">UserService</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-comment">// provide the component-under-test and dependent service</span></div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">WelcomeComponent</span>, {<span class="hljs-attr">provide</span>: <span class="hljs-title class_">UserService</span>, <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">MockUserService</span>}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-comment">// inject both the component and the dependent service.</span></div><div class="hljs-ln-line">    comp = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">WelcomeComponent</span>);</div><div class="hljs-ln-line">    userService = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">UserService</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should not have welcome message after construction'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(comp.<span class="hljs-property">welcome</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should welcome logged in user after Angular calls ngOnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    comp.<span class="hljs-title function_">ngOnInit</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(comp.<span class="hljs-property">welcome</span>).<span class="hljs-title function_">toContain</span>(userService.<span class="hljs-property">user</span>.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should ask user to log in if not logged in after ngOnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    userService.<span class="hljs-property">isLoggedIn</span> = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-title function_">ngOnInit</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(comp.<span class="hljs-property">welcome</span>).<span class="hljs-property">not</span>.<span class="hljs-title function_">toContain</span>(userService.<span class="hljs-property">user</span>.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(comp.<span class="hljs-property">welcome</span>).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'log in'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'WelcomeComponent'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">comp</span>: <span class="hljs-title class_">WelcomeComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">WelcomeComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">componentUserService</span>: <span class="hljs-title class_">UserService</span>; <span class="hljs-comment">// the actually injected service</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">userService</span>: <span class="hljs-title class_">UserService</span>; <span class="hljs-comment">// the TestBed injected service</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">el</span>: <span class="hljs-title class_">HTMLElement</span>; <span class="hljs-comment">// the DOM element with the welcome message</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">userServiceStub</span>: <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">UserService</span>&gt;;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// stub UserService for test purposes</span></div><div class="hljs-ln-line">    userServiceStub = {</div><div class="hljs-ln-line">      <span class="hljs-attr">isLoggedIn</span>: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">      <span class="hljs-attr">user</span>: {<span class="hljs-attr">name</span>: <span class="hljs-string">'Test User'</span>},</div><div class="hljs-ln-line">    };</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">WelcomeComponent</span>],</div><div class="hljs-ln-line">      <span class="hljs-comment">// providers: [ UserService ],  // NO! Don't provide the real service!</span></div><div class="hljs-ln-line">      <span class="hljs-comment">// Provide a test-double instead</span></div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">UserService</span>, <span class="hljs-attr">useValue</span>: userServiceStub}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">WelcomeComponent</span>);</div><div class="hljs-ln-line">    comp = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// UserService actually injected into the component</span></div><div class="hljs-ln-line">    userService = fixture.<span class="hljs-property">debugElement</span>.<span class="hljs-property">injector</span>.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">UserService</span>);</div><div class="hljs-ln-line">    componentUserService = userService;</div><div class="hljs-ln-line">    <span class="hljs-comment">// UserService from the root injector</span></div><div class="hljs-ln-line">    userService = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">UserService</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">//  get the "welcome" element by CSS selector (e.g., by class name)</span></div><div class="hljs-ln-line">    el = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.welcome'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should welcome the user'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> content = el.<span class="hljs-property">textContent</span>;</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(content).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'"Welcome ..."'</span>).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Welcome'</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(content).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'expected name'</span>).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Test User'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should welcome "Bubba"'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    userService.<span class="hljs-property">user</span>.<span class="hljs-property">name</span> = <span class="hljs-string">'Bubba'</span>; <span class="hljs-comment">// welcome message hasn't been shown yet</span></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(el.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Bubba'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should request login if not logged in'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    userService.<span class="hljs-property">isLoggedIn</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// welcome message hasn't been shown yet</span></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> content = el.<span class="hljs-property">textContent</span>;</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(content).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'not welcomed'</span>).<span class="hljs-property">not</span>.<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Welcome'</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(content)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'"log in"'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/log in/i</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should inject the component's UserService instance"</span>, <span class="hljs-title function_">inject</span>(</div><div class="hljs-ln-line">    [<span class="hljs-title class_">UserService</span>],</div><div class="hljs-ln-line">    <span class="hljs-function">(<span class="hljs-params">service: UserService</span>) =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(service).<span class="hljs-title function_">toBe</span>(componentUserService);</div><div class="hljs-ln-line">    },</div><div class="hljs-ln-line">  ));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'TestBed and Component UserService should be the same'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(userService).<span class="hljs-title function_">toBe</span>(componentUserService);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="130pyhgnwn5c40bkg40dnid12">这次，除了声明<em>被测组件外</em>，该配置还在 <code>providers</code> 列表中加入了 <code>UserService</code> 提供者。但它不是真正的 <code>UserService</code>。</p>

  <h3 id="provide-service-test-doubles">
    <a href="#provide-service-test-doubles" class="docs-anchor" tabindex="-1" aria-label="Link to Provide service test doubles" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="1w4q8bm5nr807s5qarba8g1kj">为服务提供测试替身</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="6dlaxuh01y0fo41rcjt90lzbq"><em>待测组件</em>不必注入真正的服务。事实上，如果它们是测试替身，比如 stubs，fakes，spies 或 mocks，通常会更好。该测试规约的目的是测试组件，而不是服务，使用真正的服务可能会遇到麻烦。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="frroue5e7u7cb9s2eyczbpun">注入真正的 <code>UserService</code> 可能是个噩梦。真正的服务可能要求用户提供登录凭据，并尝试访问认证服务器。这些行为可能难以拦截。为它创建并注册一个测试专用版来代替真正的 <code>UserService</code> 要容易得多，也更安全。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="1v9fdptud33pt9541zq0t5hn">这个特定的测试套件提供了 <code>UserService</code> 的最小化模拟，它满足了 <code>WelcomeComponent</code> 及其测试的需求：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/welcome/welcome.component.spec.ts" visiblelines="48,49,52,53,54,55" header="app/welcome/welcome.component.spec.ts">
    <div class="docs-code-header"><h3>app/welcome/welcome.component.spec.ts</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">ComponentFixture</span>, inject, <span class="hljs-title class_">TestBed</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">UserService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/user.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">WelcomeComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./welcome.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MockUserService</span> {</div><div class="hljs-ln-line">  isLoggedIn = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">  user = {<span class="hljs-attr">name</span>: <span class="hljs-string">'Test User'</span>};</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'WelcomeComponent (class only)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">comp</span>: <span class="hljs-title class_">WelcomeComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">userService</span>: <span class="hljs-title class_">UserService</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-comment">// provide the component-under-test and dependent service</span></div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">WelcomeComponent</span>, {<span class="hljs-attr">provide</span>: <span class="hljs-title class_">UserService</span>, <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">MockUserService</span>}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-comment">// inject both the component and the dependent service.</span></div><div class="hljs-ln-line">    comp = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">WelcomeComponent</span>);</div><div class="hljs-ln-line">    userService = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">UserService</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should not have welcome message after construction'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(comp.<span class="hljs-property">welcome</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should welcome logged in user after Angular calls ngOnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    comp.<span class="hljs-title function_">ngOnInit</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(comp.<span class="hljs-property">welcome</span>).<span class="hljs-title function_">toContain</span>(userService.<span class="hljs-property">user</span>.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should ask user to log in if not logged in after ngOnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    userService.<span class="hljs-property">isLoggedIn</span> = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-title function_">ngOnInit</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(comp.<span class="hljs-property">welcome</span>).<span class="hljs-property">not</span>.<span class="hljs-title function_">toContain</span>(userService.<span class="hljs-property">user</span>.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(comp.<span class="hljs-property">welcome</span>).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'log in'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'WelcomeComponent'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">comp</span>: <span class="hljs-title class_">WelcomeComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">WelcomeComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">componentUserService</span>: <span class="hljs-title class_">UserService</span>; <span class="hljs-comment">// the actually injected service</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">userService</span>: <span class="hljs-title class_">UserService</span>; <span class="hljs-comment">// the TestBed injected service</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">el</span>: <span class="hljs-title class_">HTMLElement</span>; <span class="hljs-comment">// the DOM element with the welcome message</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">userServiceStub</span>: <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">UserService</span>&gt;;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// stub UserService for test purposes</span></div><div class="hljs-ln-line">    userServiceStub = {</div><div class="hljs-ln-line">      <span class="hljs-attr">isLoggedIn</span>: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">      <span class="hljs-attr">user</span>: {<span class="hljs-attr">name</span>: <span class="hljs-string">'Test User'</span>},</div><div class="hljs-ln-line">    };</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">WelcomeComponent</span>],</div><div class="hljs-ln-line">      <span class="hljs-comment">// providers: [ UserService ],  // NO! Don't provide the real service!</span></div><div class="hljs-ln-line">      <span class="hljs-comment">// Provide a test-double instead</span></div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">UserService</span>, <span class="hljs-attr">useValue</span>: userServiceStub}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">WelcomeComponent</span>);</div><div class="hljs-ln-line">    comp = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// UserService actually injected into the component</span></div><div class="hljs-ln-line">    userService = fixture.<span class="hljs-property">debugElement</span>.<span class="hljs-property">injector</span>.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">UserService</span>);</div><div class="hljs-ln-line">    componentUserService = userService;</div><div class="hljs-ln-line">    <span class="hljs-comment">// UserService from the root injector</span></div><div class="hljs-ln-line">    userService = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">UserService</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">//  get the "welcome" element by CSS selector (e.g., by class name)</span></div><div class="hljs-ln-line">    el = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.welcome'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should welcome the user'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> content = el.<span class="hljs-property">textContent</span>;</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(content).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'"Welcome ..."'</span>).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Welcome'</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(content).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'expected name'</span>).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Test User'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should welcome "Bubba"'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    userService.<span class="hljs-property">user</span>.<span class="hljs-property">name</span> = <span class="hljs-string">'Bubba'</span>; <span class="hljs-comment">// welcome message hasn't been shown yet</span></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(el.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Bubba'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should request login if not logged in'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    userService.<span class="hljs-property">isLoggedIn</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// welcome message hasn't been shown yet</span></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> content = el.<span class="hljs-property">textContent</span>;</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(content).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'not welcomed'</span>).<span class="hljs-property">not</span>.<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Welcome'</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(content)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'"log in"'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/log in/i</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should inject the component's UserService instance"</span>, <span class="hljs-title function_">inject</span>(</div><div class="hljs-ln-line">    [<span class="hljs-title class_">UserService</span>],</div><div class="hljs-ln-line">    <span class="hljs-function">(<span class="hljs-params">service: UserService</span>) =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(service).<span class="hljs-title function_">toBe</span>(componentUserService);</div><div class="hljs-ln-line">    },</div><div class="hljs-ln-line">  ));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'TestBed and Component UserService should be the same'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(userService).<span class="hljs-title function_">toBe</span>(componentUserService);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
  <h3 id="get-injected-services">
    <a href="#get-injected-services" class="docs-anchor" tabindex="-1" aria-label="Link to Get injected services" data-ng_translator_product="100" data-ng_translator_ref_id="45778uy3p2czps47kn5uge4uw">获取注入的服务</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="m9c4d7trvxi7ktxc5qvtz855">这些测试需要访问注入到 <code>WelcomeComponent</code> 中的 <code>UserService</code> 桩。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="b8ii6mae258l2s1guoqpfno28">Angular 具有分层的注入系统。可以在多个级别上存在注入器，从由 
<code>TestBed</code> 创建的根注入器到组件树下的级联注入器。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="1g6hdlz4l36n3csx85nna9fhg">获取注入服务的最安全方法（<em><strong>始终有效</strong></em>）是<strong>从<em>待测组件</em>的注入器</strong>获取它。 组件注入器是夹具的 
<code>DebugElement</code> 的一个属性。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/welcome/welcome.component.spec.ts" visiblelines="67,68" header="WelcomeComponent's injector">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="e9et497d2z8aghhicns5c130i">WelcomeComponent 的注入器</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">ComponentFixture</span>, inject, <span class="hljs-title class_">TestBed</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">UserService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/user.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">WelcomeComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./welcome.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MockUserService</span> {</div><div class="hljs-ln-line">  isLoggedIn = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">  user = {<span class="hljs-attr">name</span>: <span class="hljs-string">'Test User'</span>};</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'WelcomeComponent (class only)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">comp</span>: <span class="hljs-title class_">WelcomeComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">userService</span>: <span class="hljs-title class_">UserService</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-comment">// provide the component-under-test and dependent service</span></div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">WelcomeComponent</span>, {<span class="hljs-attr">provide</span>: <span class="hljs-title class_">UserService</span>, <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">MockUserService</span>}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-comment">// inject both the component and the dependent service.</span></div><div class="hljs-ln-line">    comp = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">WelcomeComponent</span>);</div><div class="hljs-ln-line">    userService = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">UserService</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should not have welcome message after construction'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(comp.<span class="hljs-property">welcome</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should welcome logged in user after Angular calls ngOnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    comp.<span class="hljs-title function_">ngOnInit</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(comp.<span class="hljs-property">welcome</span>).<span class="hljs-title function_">toContain</span>(userService.<span class="hljs-property">user</span>.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should ask user to log in if not logged in after ngOnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    userService.<span class="hljs-property">isLoggedIn</span> = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-title function_">ngOnInit</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(comp.<span class="hljs-property">welcome</span>).<span class="hljs-property">not</span>.<span class="hljs-title function_">toContain</span>(userService.<span class="hljs-property">user</span>.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(comp.<span class="hljs-property">welcome</span>).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'log in'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'WelcomeComponent'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">comp</span>: <span class="hljs-title class_">WelcomeComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">WelcomeComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">componentUserService</span>: <span class="hljs-title class_">UserService</span>; <span class="hljs-comment">// the actually injected service</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">userService</span>: <span class="hljs-title class_">UserService</span>; <span class="hljs-comment">// the TestBed injected service</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">el</span>: <span class="hljs-title class_">HTMLElement</span>; <span class="hljs-comment">// the DOM element with the welcome message</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">userServiceStub</span>: <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">UserService</span>&gt;;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// stub UserService for test purposes</span></div><div class="hljs-ln-line">    userServiceStub = {</div><div class="hljs-ln-line">      <span class="hljs-attr">isLoggedIn</span>: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">      <span class="hljs-attr">user</span>: {<span class="hljs-attr">name</span>: <span class="hljs-string">'Test User'</span>},</div><div class="hljs-ln-line">    };</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">WelcomeComponent</span>],</div><div class="hljs-ln-line">      <span class="hljs-comment">// providers: [ UserService ],  // NO! Don't provide the real service!</span></div><div class="hljs-ln-line">      <span class="hljs-comment">// Provide a test-double instead</span></div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">UserService</span>, <span class="hljs-attr">useValue</span>: userServiceStub}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">WelcomeComponent</span>);</div><div class="hljs-ln-line">    comp = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// UserService actually injected into the component</span></div><div class="hljs-ln-line">    userService = fixture.<span class="hljs-property">debugElement</span>.<span class="hljs-property">injector</span>.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">UserService</span>);</div><div class="hljs-ln-line">    componentUserService = userService;</div><div class="hljs-ln-line">    <span class="hljs-comment">// UserService from the root injector</span></div><div class="hljs-ln-line">    userService = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">UserService</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">//  get the "welcome" element by CSS selector (e.g., by class name)</span></div><div class="hljs-ln-line">    el = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.welcome'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should welcome the user'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> content = el.<span class="hljs-property">textContent</span>;</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(content).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'"Welcome ..."'</span>).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Welcome'</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(content).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'expected name'</span>).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Test User'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should welcome "Bubba"'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    userService.<span class="hljs-property">user</span>.<span class="hljs-property">name</span> = <span class="hljs-string">'Bubba'</span>; <span class="hljs-comment">// welcome message hasn't been shown yet</span></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(el.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Bubba'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should request login if not logged in'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    userService.<span class="hljs-property">isLoggedIn</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// welcome message hasn't been shown yet</span></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> content = el.<span class="hljs-property">textContent</span>;</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(content).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'not welcomed'</span>).<span class="hljs-property">not</span>.<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Welcome'</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(content)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'"log in"'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/log in/i</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should inject the component's UserService instance"</span>, <span class="hljs-title function_">inject</span>(</div><div class="hljs-ln-line">    [<span class="hljs-title class_">UserService</span>],</div><div class="hljs-ln-line">    <span class="hljs-function">(<span class="hljs-params">service: UserService</span>) =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(service).<span class="hljs-title function_">toBe</span>(componentUserService);</div><div class="hljs-ln-line">    },</div><div class="hljs-ln-line">  ));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'TestBed and Component UserService should be the same'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(userService).<span class="hljs-title function_">toBe</span>(componentUserService);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
  <h3 id="testbedinject">
    <a href="#testbedinject" class="docs-anchor" tabindex="-1" aria-label="Link to <code>TestBed.inject()</code>"><code>TestBed.inject()</code></a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="bykps41qltgo5kag1c4xc2gyk">你<em>可能</em>还可以通过 <code>TestBed.inject()</code> 来从根注入器获得服务。这更容易记忆，也不那么啰嗦。但这只有当 Angular 要把根注入器中的服务实例注入测试组件时才是可行的。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="dum5381r5qlac7mhucv800jkv">在下面这个测试套件中，<code>UserService</code><em>唯一的</em>提供者是根测试模块，因此可以安全地调用 <code>TestBed.inject()</code>，如下所示：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/welcome/welcome.component.spec.ts" visiblelines="70,71" header="TestBed injector">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="1tvh4sb7dpcfeazszm2hzzmtd">TestBed 的注入器</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">ComponentFixture</span>, inject, <span class="hljs-title class_">TestBed</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">UserService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/user.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">WelcomeComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./welcome.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MockUserService</span> {</div><div class="hljs-ln-line">  isLoggedIn = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">  user = {<span class="hljs-attr">name</span>: <span class="hljs-string">'Test User'</span>};</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'WelcomeComponent (class only)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">comp</span>: <span class="hljs-title class_">WelcomeComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">userService</span>: <span class="hljs-title class_">UserService</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-comment">// provide the component-under-test and dependent service</span></div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">WelcomeComponent</span>, {<span class="hljs-attr">provide</span>: <span class="hljs-title class_">UserService</span>, <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">MockUserService</span>}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-comment">// inject both the component and the dependent service.</span></div><div class="hljs-ln-line">    comp = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">WelcomeComponent</span>);</div><div class="hljs-ln-line">    userService = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">UserService</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should not have welcome message after construction'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(comp.<span class="hljs-property">welcome</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should welcome logged in user after Angular calls ngOnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    comp.<span class="hljs-title function_">ngOnInit</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(comp.<span class="hljs-property">welcome</span>).<span class="hljs-title function_">toContain</span>(userService.<span class="hljs-property">user</span>.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should ask user to log in if not logged in after ngOnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    userService.<span class="hljs-property">isLoggedIn</span> = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-title function_">ngOnInit</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(comp.<span class="hljs-property">welcome</span>).<span class="hljs-property">not</span>.<span class="hljs-title function_">toContain</span>(userService.<span class="hljs-property">user</span>.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(comp.<span class="hljs-property">welcome</span>).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'log in'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'WelcomeComponent'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">comp</span>: <span class="hljs-title class_">WelcomeComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">WelcomeComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">componentUserService</span>: <span class="hljs-title class_">UserService</span>; <span class="hljs-comment">// the actually injected service</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">userService</span>: <span class="hljs-title class_">UserService</span>; <span class="hljs-comment">// the TestBed injected service</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">el</span>: <span class="hljs-title class_">HTMLElement</span>; <span class="hljs-comment">// the DOM element with the welcome message</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">userServiceStub</span>: <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">UserService</span>&gt;;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// stub UserService for test purposes</span></div><div class="hljs-ln-line">    userServiceStub = {</div><div class="hljs-ln-line">      <span class="hljs-attr">isLoggedIn</span>: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">      <span class="hljs-attr">user</span>: {<span class="hljs-attr">name</span>: <span class="hljs-string">'Test User'</span>},</div><div class="hljs-ln-line">    };</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">WelcomeComponent</span>],</div><div class="hljs-ln-line">      <span class="hljs-comment">// providers: [ UserService ],  // NO! Don't provide the real service!</span></div><div class="hljs-ln-line">      <span class="hljs-comment">// Provide a test-double instead</span></div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">UserService</span>, <span class="hljs-attr">useValue</span>: userServiceStub}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">WelcomeComponent</span>);</div><div class="hljs-ln-line">    comp = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// UserService actually injected into the component</span></div><div class="hljs-ln-line">    userService = fixture.<span class="hljs-property">debugElement</span>.<span class="hljs-property">injector</span>.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">UserService</span>);</div><div class="hljs-ln-line">    componentUserService = userService;</div><div class="hljs-ln-line">    <span class="hljs-comment">// UserService from the root injector</span></div><div class="hljs-ln-line">    userService = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">UserService</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">//  get the "welcome" element by CSS selector (e.g., by class name)</span></div><div class="hljs-ln-line">    el = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.welcome'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should welcome the user'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> content = el.<span class="hljs-property">textContent</span>;</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(content).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'"Welcome ..."'</span>).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Welcome'</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(content).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'expected name'</span>).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Test User'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should welcome "Bubba"'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    userService.<span class="hljs-property">user</span>.<span class="hljs-property">name</span> = <span class="hljs-string">'Bubba'</span>; <span class="hljs-comment">// welcome message hasn't been shown yet</span></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(el.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Bubba'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should request login if not logged in'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    userService.<span class="hljs-property">isLoggedIn</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// welcome message hasn't been shown yet</span></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> content = el.<span class="hljs-property">textContent</span>;</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(content).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'not welcomed'</span>).<span class="hljs-property">not</span>.<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Welcome'</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(content)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'"log in"'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/log in/i</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should inject the component's UserService instance"</span>, <span class="hljs-title function_">inject</span>(</div><div class="hljs-ln-line">    [<span class="hljs-title class_">UserService</span>],</div><div class="hljs-ln-line">    <span class="hljs-function">(<span class="hljs-params">service: UserService</span>) =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(service).<span class="hljs-title function_">toBe</span>(componentUserService);</div><div class="hljs-ln-line">    },</div><div class="hljs-ln-line">  ));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'TestBed and Component UserService should be the same'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(userService).<span class="hljs-title function_">toBe</span>(componentUserService);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
    <div class="docs-alert docs-alert-helpful">
    <p data-ng_translator_product="100" data-ng_translator_ref_id="4st31n5uyokt61f0wh54d92eu"><strong>有用：</strong> 如果 
<code>TestBed.inject()</code> 不起作用的情况，请参阅解释何时以及为何必须从组件的注入器获取服务的
<a href="#override-component-providers"><em>重写组件提供者</em></a>部分。</p>

    </div>
    
  <h3 id="final-setup-and-tests">
    <a href="#final-setup-and-tests" class="docs-anchor" tabindex="-1" aria-label="Link to Final setup and tests" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="c2jcr1xsg9s2nvsca1wo5rjso">最后的设置与测试</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="czfxhpvfhc15ugzvuek4r9anu">这里是完成的 <code>beforeEach()</code>，它使用了 <code>TestBed.inject()</code>：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/welcome/welcome.component.spec.ts" visiblelines="48,49,50,51,52,53,54,55,56,57,58,61,62,63,64,65,66,70,71,72,73,74,75" header="app/welcome/welcome.component.spec.ts">
    <div class="docs-code-header"><h3>app/welcome/welcome.component.spec.ts</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">ComponentFixture</span>, inject, <span class="hljs-title class_">TestBed</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">UserService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/user.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">WelcomeComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./welcome.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MockUserService</span> {</div><div class="hljs-ln-line">  isLoggedIn = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">  user = {<span class="hljs-attr">name</span>: <span class="hljs-string">'Test User'</span>};</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'WelcomeComponent (class only)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">comp</span>: <span class="hljs-title class_">WelcomeComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">userService</span>: <span class="hljs-title class_">UserService</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-comment">// provide the component-under-test and dependent service</span></div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">WelcomeComponent</span>, {<span class="hljs-attr">provide</span>: <span class="hljs-title class_">UserService</span>, <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">MockUserService</span>}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-comment">// inject both the component and the dependent service.</span></div><div class="hljs-ln-line">    comp = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">WelcomeComponent</span>);</div><div class="hljs-ln-line">    userService = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">UserService</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should not have welcome message after construction'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(comp.<span class="hljs-property">welcome</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should welcome logged in user after Angular calls ngOnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    comp.<span class="hljs-title function_">ngOnInit</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(comp.<span class="hljs-property">welcome</span>).<span class="hljs-title function_">toContain</span>(userService.<span class="hljs-property">user</span>.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should ask user to log in if not logged in after ngOnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    userService.<span class="hljs-property">isLoggedIn</span> = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-title function_">ngOnInit</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(comp.<span class="hljs-property">welcome</span>).<span class="hljs-property">not</span>.<span class="hljs-title function_">toContain</span>(userService.<span class="hljs-property">user</span>.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(comp.<span class="hljs-property">welcome</span>).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'log in'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'WelcomeComponent'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">comp</span>: <span class="hljs-title class_">WelcomeComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">WelcomeComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">componentUserService</span>: <span class="hljs-title class_">UserService</span>; <span class="hljs-comment">// the actually injected service</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">userService</span>: <span class="hljs-title class_">UserService</span>; <span class="hljs-comment">// the TestBed injected service</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">el</span>: <span class="hljs-title class_">HTMLElement</span>; <span class="hljs-comment">// the DOM element with the welcome message</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">userServiceStub</span>: <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">UserService</span>&gt;;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// stub UserService for test purposes</span></div><div class="hljs-ln-line">    userServiceStub = {</div><div class="hljs-ln-line">      <span class="hljs-attr">isLoggedIn</span>: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">      <span class="hljs-attr">user</span>: {<span class="hljs-attr">name</span>: <span class="hljs-string">'Test User'</span>},</div><div class="hljs-ln-line">    };</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">WelcomeComponent</span>],</div><div class="hljs-ln-line">      <span class="hljs-comment">// providers: [ UserService ],  // NO! Don't provide the real service!</span></div><div class="hljs-ln-line">      <span class="hljs-comment">// Provide a test-double instead</span></div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">UserService</span>, <span class="hljs-attr">useValue</span>: userServiceStub}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">WelcomeComponent</span>);</div><div class="hljs-ln-line">    comp = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// UserService actually injected into the component</span></div><div class="hljs-ln-line">    userService = fixture.<span class="hljs-property">debugElement</span>.<span class="hljs-property">injector</span>.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">UserService</span>);</div><div class="hljs-ln-line">    componentUserService = userService;</div><div class="hljs-ln-line">    <span class="hljs-comment">// UserService from the root injector</span></div><div class="hljs-ln-line">    userService = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">UserService</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">//  get the "welcome" element by CSS selector (e.g., by class name)</span></div><div class="hljs-ln-line">    el = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.welcome'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should welcome the user'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> content = el.<span class="hljs-property">textContent</span>;</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(content).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'"Welcome ..."'</span>).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Welcome'</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(content).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'expected name'</span>).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Test User'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should welcome "Bubba"'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    userService.<span class="hljs-property">user</span>.<span class="hljs-property">name</span> = <span class="hljs-string">'Bubba'</span>; <span class="hljs-comment">// welcome message hasn't been shown yet</span></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(el.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Bubba'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should request login if not logged in'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    userService.<span class="hljs-property">isLoggedIn</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// welcome message hasn't been shown yet</span></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> content = el.<span class="hljs-property">textContent</span>;</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(content).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'not welcomed'</span>).<span class="hljs-property">not</span>.<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Welcome'</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(content)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'"log in"'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/log in/i</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should inject the component's UserService instance"</span>, <span class="hljs-title function_">inject</span>(</div><div class="hljs-ln-line">    [<span class="hljs-title class_">UserService</span>],</div><div class="hljs-ln-line">    <span class="hljs-function">(<span class="hljs-params">service: UserService</span>) =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(service).<span class="hljs-title function_">toBe</span>(componentUserService);</div><div class="hljs-ln-line">    },</div><div class="hljs-ln-line">  ));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'TestBed and Component UserService should be the same'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(userService).<span class="hljs-title function_">toBe</span>(componentUserService);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="dlp37v1vnodhqg9bs8toz03x2">以下是一些测试：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/welcome/welcome.component.spec.ts" visiblelines="77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98" header="app/welcome/welcome.component.spec.ts">
    <div class="docs-code-header"><h3>app/welcome/welcome.component.spec.ts</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">ComponentFixture</span>, inject, <span class="hljs-title class_">TestBed</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">UserService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/user.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">WelcomeComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./welcome.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MockUserService</span> {</div><div class="hljs-ln-line">  isLoggedIn = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">  user = {<span class="hljs-attr">name</span>: <span class="hljs-string">'Test User'</span>};</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'WelcomeComponent (class only)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">comp</span>: <span class="hljs-title class_">WelcomeComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">userService</span>: <span class="hljs-title class_">UserService</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-comment">// provide the component-under-test and dependent service</span></div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">WelcomeComponent</span>, {<span class="hljs-attr">provide</span>: <span class="hljs-title class_">UserService</span>, <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">MockUserService</span>}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-comment">// inject both the component and the dependent service.</span></div><div class="hljs-ln-line">    comp = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">WelcomeComponent</span>);</div><div class="hljs-ln-line">    userService = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">UserService</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should not have welcome message after construction'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(comp.<span class="hljs-property">welcome</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should welcome logged in user after Angular calls ngOnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    comp.<span class="hljs-title function_">ngOnInit</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(comp.<span class="hljs-property">welcome</span>).<span class="hljs-title function_">toContain</span>(userService.<span class="hljs-property">user</span>.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should ask user to log in if not logged in after ngOnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    userService.<span class="hljs-property">isLoggedIn</span> = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-title function_">ngOnInit</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(comp.<span class="hljs-property">welcome</span>).<span class="hljs-property">not</span>.<span class="hljs-title function_">toContain</span>(userService.<span class="hljs-property">user</span>.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(comp.<span class="hljs-property">welcome</span>).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'log in'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'WelcomeComponent'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">comp</span>: <span class="hljs-title class_">WelcomeComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">WelcomeComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">componentUserService</span>: <span class="hljs-title class_">UserService</span>; <span class="hljs-comment">// the actually injected service</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">userService</span>: <span class="hljs-title class_">UserService</span>; <span class="hljs-comment">// the TestBed injected service</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">el</span>: <span class="hljs-title class_">HTMLElement</span>; <span class="hljs-comment">// the DOM element with the welcome message</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">userServiceStub</span>: <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">UserService</span>&gt;;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// stub UserService for test purposes</span></div><div class="hljs-ln-line">    userServiceStub = {</div><div class="hljs-ln-line">      <span class="hljs-attr">isLoggedIn</span>: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">      <span class="hljs-attr">user</span>: {<span class="hljs-attr">name</span>: <span class="hljs-string">'Test User'</span>},</div><div class="hljs-ln-line">    };</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">WelcomeComponent</span>],</div><div class="hljs-ln-line">      <span class="hljs-comment">// providers: [ UserService ],  // NO! Don't provide the real service!</span></div><div class="hljs-ln-line">      <span class="hljs-comment">// Provide a test-double instead</span></div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">UserService</span>, <span class="hljs-attr">useValue</span>: userServiceStub}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">WelcomeComponent</span>);</div><div class="hljs-ln-line">    comp = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// UserService actually injected into the component</span></div><div class="hljs-ln-line">    userService = fixture.<span class="hljs-property">debugElement</span>.<span class="hljs-property">injector</span>.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">UserService</span>);</div><div class="hljs-ln-line">    componentUserService = userService;</div><div class="hljs-ln-line">    <span class="hljs-comment">// UserService from the root injector</span></div><div class="hljs-ln-line">    userService = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">UserService</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">//  get the "welcome" element by CSS selector (e.g., by class name)</span></div><div class="hljs-ln-line">    el = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.welcome'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should welcome the user'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> content = el.<span class="hljs-property">textContent</span>;</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(content).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'"Welcome ..."'</span>).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Welcome'</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(content).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'expected name'</span>).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Test User'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should welcome "Bubba"'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    userService.<span class="hljs-property">user</span>.<span class="hljs-property">name</span> = <span class="hljs-string">'Bubba'</span>; <span class="hljs-comment">// welcome message hasn't been shown yet</span></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(el.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Bubba'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should request login if not logged in'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    userService.<span class="hljs-property">isLoggedIn</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// welcome message hasn't been shown yet</span></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> content = el.<span class="hljs-property">textContent</span>;</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(content).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'not welcomed'</span>).<span class="hljs-property">not</span>.<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Welcome'</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(content)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'"log in"'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/log in/i</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should inject the component's UserService instance"</span>, <span class="hljs-title function_">inject</span>(</div><div class="hljs-ln-line">    [<span class="hljs-title class_">UserService</span>],</div><div class="hljs-ln-line">    <span class="hljs-function">(<span class="hljs-params">service: UserService</span>) =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(service).<span class="hljs-title function_">toBe</span>(componentUserService);</div><div class="hljs-ln-line">    },</div><div class="hljs-ln-line">  ));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'TestBed and Component UserService should be the same'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(userService).<span class="hljs-title function_">toBe</span>(componentUserService);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="ab103lnr8m8r3s4yhd20qd61i">首先是一个健全性测试；它确认了桩服务 <code>UserService</code> 被调用过并能正常工作。</p>

    <div class="docs-alert docs-alert-helpful">
    <p data-ng_translator_product="100" data-ng_translator_ref_id="dv9i24c0603pnagggdabivm0t"><strong>提示：</strong>对 Jasmine 匹配器的第二个参数（例如，
<code>'预期的名称'</code>）是一个可选的失败标签。如果期望失败，Jasmine 会将此标签附加到期望失败消息上。在具有多个期望的规范中，它可以帮助澄清发生了什么问题以及哪个期望失败了。</p>

    </div>
    <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="8oztbnowfapmjh4fddh3q6xxh">当该服务返回不同的值时，其余的测试会确认该组件的逻辑。第二个测试验证了更改用户名的效果。当用户未登录时，第三个测试会检查组件是否显示了正确的消息。</p>

  <h2 id="component-with-async-service">
    <a href="#component-with-async-service" class="docs-anchor" tabindex="-1" aria-label="Link to Component with async service" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="89pawgl0p7g1f5jqz1hlsyba5">具有异步服务的组件</a>
  </h2>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="edm9ff239y53dlmyg0xhu3kh1">在这个例子中，<code>AboutComponent</code> 模板托管了一个 <code>TwainComponent</code>。<code>TwainComponent</code> 会显示马克·吐温的名言。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/twain/twain.component.ts" visiblelines="12,13,14,15,16,17,18" header="app/twain/twain.component.ts (template)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="4r3urz007kojtiwnfwe4up5w3">app/twain/twain.component.ts（模板）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Component</span>, <span class="hljs-title class_">OnInit</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">AsyncPipe</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {sharedImports} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/shared'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Observable</span>, <span class="hljs-keyword">of</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {catchError, startWith} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-meta">@Component</span>({</div><div class="hljs-ln-line">  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">selector</span>: <span class="hljs-string">'twain-quote'</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">template</span>: <span class="hljs-string">` &lt;p class="twain"&gt;</span></div><div class="hljs-ln-line">      &lt;i&gt;{{ quote | async }}&lt;/i&gt;</div><div class="hljs-ln-line">    &lt;/p&gt;</div><div class="hljs-ln-line">    &lt;button type="button" (click)="getQuote()"&gt;Next quote&lt;/button&gt;</div><div class="hljs-ln-line">    @if (errorMessage) {</div><div class="hljs-ln-line">      &lt;p class="error"&gt;{{ errorMessage }}&lt;/p&gt;</div><div class="hljs-ln-line">    }`,</div><div class="hljs-ln-line">  <span class="hljs-attr">styles</span>: [<span class="hljs-string">'.twain { font-style: italic; } .error { color: red; }'</span>],</div><div class="hljs-ln-line">  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">AsyncPipe</span>, sharedImports],</div><div class="hljs-ln-line">})</div><div class="hljs-ln-line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TwainComponent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OnInit</span> {</div><div class="hljs-ln-line">  errorMessage!: <span class="hljs-built_in">string</span>;</div><div class="hljs-ln-line">  quote!: <span class="hljs-title class_">Observable</span>&lt;<span class="hljs-built_in">string</span>&gt;;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> twainService: TwainService</span>) {}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">ngOnInit</span>(): <span class="hljs-built_in">void</span> {</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getQuote</span>();</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">getQuote</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">errorMessage</span> = <span class="hljs-string">''</span>;</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">quote</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">twainService</span>.<span class="hljs-title function_">getQuote</span>().<span class="hljs-title function_">pipe</span>(</div><div class="hljs-ln-line">      <span class="hljs-title function_">startWith</span>(<span class="hljs-string">'...'</span>),</div><div class="hljs-ln-line">      <span class="hljs-title function_">catchError</span>(<span class="hljs-function">(<span class="hljs-params">err: <span class="hljs-built_in">any</span></span>) =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-comment">// Wait a turn because errorMessage already set once this turn</span></div><div class="hljs-ln-line">        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">errorMessage</span> = err.<span class="hljs-property">message</span> || err.<span class="hljs-title function_">toString</span>()));</div><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> <span class="hljs-title function_">of</span>(<span class="hljs-string">'...'</span>); <span class="hljs-comment">// reset message to placeholder</span></div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    );</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
    <div class="docs-alert docs-alert-helpful">
    <p data-ng_translator_product="100" data-ng_translator_ref_id="edyqsdws7slkj9xccov7vjalw"><strong>提示：</strong>组件的 
<code>quote</code> 属性的值通过 
<code>AsyncPipe</code>。这意味着该属性返回一个 
<code>Promise</code> 或一个 
<code>Observable</code>。</p>

    </div>
    <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="dvoy9ncp0swpo3fhe67akgmok">在这个例子中，<code>TwainComponent.getQuote()</code> 方法告诉你 <code>quote</code> 属性会返回一个 <code>Observable</code>。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/twain/twain.component.ts" visiblelines="32,33,34,35,36,37,38,39,40,41" header="app/twain/twain.component.ts (getQuote)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="ayay76i0qowr6wn41qjvbeg4q">app/twain/twain.component.ts（getQuote）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Component</span>, <span class="hljs-title class_">OnInit</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">AsyncPipe</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {sharedImports} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/shared'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Observable</span>, <span class="hljs-keyword">of</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {catchError, startWith} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-meta">@Component</span>({</div><div class="hljs-ln-line">  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">selector</span>: <span class="hljs-string">'twain-quote'</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">template</span>: <span class="hljs-string">` &lt;p class="twain"&gt;</span></div><div class="hljs-ln-line">      &lt;i&gt;{{ quote | async }}&lt;/i&gt;</div><div class="hljs-ln-line">    &lt;/p&gt;</div><div class="hljs-ln-line">    &lt;button type="button" (click)="getQuote()"&gt;Next quote&lt;/button&gt;</div><div class="hljs-ln-line">    @if (errorMessage) {</div><div class="hljs-ln-line">      &lt;p class="error"&gt;{{ errorMessage }}&lt;/p&gt;</div><div class="hljs-ln-line">    }`,</div><div class="hljs-ln-line">  <span class="hljs-attr">styles</span>: [<span class="hljs-string">'.twain { font-style: italic; } .error { color: red; }'</span>],</div><div class="hljs-ln-line">  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">AsyncPipe</span>, sharedImports],</div><div class="hljs-ln-line">})</div><div class="hljs-ln-line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TwainComponent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OnInit</span> {</div><div class="hljs-ln-line">  errorMessage!: <span class="hljs-built_in">string</span>;</div><div class="hljs-ln-line">  quote!: <span class="hljs-title class_">Observable</span>&lt;<span class="hljs-built_in">string</span>&gt;;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> twainService: TwainService</span>) {}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">ngOnInit</span>(): <span class="hljs-built_in">void</span> {</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getQuote</span>();</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">getQuote</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">errorMessage</span> = <span class="hljs-string">''</span>;</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">quote</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">twainService</span>.<span class="hljs-title function_">getQuote</span>().<span class="hljs-title function_">pipe</span>(</div><div class="hljs-ln-line">      <span class="hljs-title function_">startWith</span>(<span class="hljs-string">'...'</span>),</div><div class="hljs-ln-line">      <span class="hljs-title function_">catchError</span>(<span class="hljs-function">(<span class="hljs-params">err: <span class="hljs-built_in">any</span></span>) =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-comment">// Wait a turn because errorMessage already set once this turn</span></div><div class="hljs-ln-line">        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">errorMessage</span> = err.<span class="hljs-property">message</span> || err.<span class="hljs-title function_">toString</span>()));</div><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> <span class="hljs-title function_">of</span>(<span class="hljs-string">'...'</span>); <span class="hljs-comment">// reset message to placeholder</span></div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    );</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="d2teug54wdj3d09zfbb0x7a8s"><code>TwainComponent</code> 从注入的 
<code>TwainService</code> 获取引用。 该组件在服务返回其第一个引用之前，使用占位符值（
<code>'...'</code>）启动返回的 
<code>Observable</code>。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="9063i5m0fs2f5n9xip7kid8rp"><code>catchError</code> 会拦截服务错误，准备一条错误信息，并在流的成功通道上返回占位值。它必须等一拍（tick）才能设置 <code>errorMessage</code>，以免在同一个变更检测周期内更新此消息两次。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="3sjgc24129i86m7ewydreookt">这些都是你想要测试的特性。</p>

  <h3 id="testing-with-a-spy">
    <a href="#testing-with-a-spy" class="docs-anchor" tabindex="-1" aria-label="Link to Testing with a spy" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="dzqjwahmrwy6h4ebjinsilcm">使用间谍（spy）进行测试</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="c34utfe2vm8zbhez8itios3jh">在测试组件时，只有该服务的公开 API 才有意义。通常，测试本身不应该调用远程服务器。它们应该模拟这样的调用。这个 <code>app/twain/twain.component.spec.ts</code> 中的环境准备工作展示了一种方法：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/twain/twain.component.spec.ts" visiblelines="24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40" header="app/twain/twain.component.spec.ts (setup)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="1kee3bhi2ah1pxb8q1b7klweb">app/twain/twain.component.spec.ts（设置）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, <span class="hljs-title class_">ComponentFixture</span>, <span class="hljs-title class_">TestBed</span>, tick, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {asyncData, asyncError} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-keyword">of</span>, throwError} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {last} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'TwainComponent'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">TwainComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">TwainComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">getQuoteSpy</span>: jasmine.<span class="hljs-property">Spy</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">quoteEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">testQuote</span>: <span class="hljs-built_in">string</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">// Helper function to get the error message element value</span></div><div class="hljs-ln-line">  <span class="hljs-comment">// An *ngIf keeps it out of the DOM until there is an error</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> <span class="hljs-title function_">errorMessage</span> = (<span class="hljs-params"></span>) =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> el = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.error'</span>);</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> el ? el.<span class="hljs-property">textContent</span> : <span class="hljs-literal">null</span>;</div><div class="hljs-ln-line">  };</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    testQuote = <span class="hljs-string">'Test Quote'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// Create a fake TwainService object with a `getQuote()` spy</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> twainService = jasmine.<span class="hljs-title function_">createSpyObj</span>(<span class="hljs-string">'TwainService'</span>, [<span class="hljs-string">'getQuote'</span>]);</div><div class="hljs-ln-line">    <span class="hljs-comment">// Make the spy return a synchronous Observable with the test data</span></div><div class="hljs-ln-line">    getQuoteSpy = twainService.<span class="hljs-property">getQuote</span>.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(<span class="hljs-title function_">of</span>(testQuote));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">TwainComponent</span>],</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">TwainService</span>, <span class="hljs-attr">useValue</span>: twainService}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">TwainComponent</span>);</div><div class="hljs-ln-line">    component = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line">    quoteEl = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.twain'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when test with synchronous observable'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should not show quote before OnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'nothing displayed'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error element'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote not yet called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">false</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// The quote would not be immediately available if the service were truly async.</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after component initialized'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// onInit()</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// sync spy result shows testQuote immediately after init</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// The error would not be immediately available if the service were truly async.</span></div><div class="hljs-ln-line">    <span class="hljs-comment">// Use `fakeAsync` because the component error calls `setTimeout`</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display error when TwainService fails'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// tell spy to return an error observable</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(<span class="hljs-title function_">throwError</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'TwainService test failure'</span>)));</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// onInit()</span></div><div class="hljs-ln-line">      <span class="hljs-comment">// sync spy errors immediately after init</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// flush the component's setTimeout()</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update errorMessage within setTimeout()</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>())</div><div class="hljs-ln-line">        .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should display error'</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/test failure/</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when test with asynchronous observable'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// Simulate delayed observable values with the `asyncData()` helper</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(<span class="hljs-title function_">asyncData</span>(testQuote));</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should not show quote before OnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'nothing displayed'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error element'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote not yet called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">false</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should still not show quote after component initialized'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">      <span class="hljs-comment">// getQuote service is async =&gt; still has not returned with quote</span></div><div class="hljs-ln-line">      <span class="hljs-comment">// so should show the start value, '...'</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (fakeAsync)'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// flush the observable to get the quote</span></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show quote'</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (waitForAsync)'</span>, <span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">whenStable</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-comment">// wait for async getQuote</span></div><div class="hljs-ln-line">        fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view with quote</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show last quote (quote done)'</span>, <span class="hljs-function">(<span class="hljs-params">done: DoneFn</span>) =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      component.<span class="hljs-property">quote</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">last</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view with quote</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">        <span class="hljs-title function_">done</span>();</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (spy done)'</span>, <span class="hljs-function">(<span class="hljs-params">done: DoneFn</span>) =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// the spy's most recent call returns the observable with the test quote</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">mostRecent</span>().<span class="hljs-property">returnValue</span>.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view with quote</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">        <span class="hljs-title function_">done</span>();</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display error when TwainService fails'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// tell spy to return an async error observable</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(asyncError&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">'TwainService test failure'</span>));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// component shows error after a setTimeout()</span></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update error message</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>())</div><div class="hljs-ln-line">        .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should display error'</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/test failure/</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="cup3iu7q744k00p8r29o1ww04">仔细看一下这个间谍。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/twain/twain.component.spec.ts" visiblelines="27,28,29,30">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, <span class="hljs-title class_">ComponentFixture</span>, <span class="hljs-title class_">TestBed</span>, tick, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {asyncData, asyncError} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-keyword">of</span>, throwError} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {last} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'TwainComponent'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">TwainComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">TwainComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">getQuoteSpy</span>: jasmine.<span class="hljs-property">Spy</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">quoteEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">testQuote</span>: <span class="hljs-built_in">string</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">// Helper function to get the error message element value</span></div><div class="hljs-ln-line">  <span class="hljs-comment">// An *ngIf keeps it out of the DOM until there is an error</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> <span class="hljs-title function_">errorMessage</span> = (<span class="hljs-params"></span>) =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> el = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.error'</span>);</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> el ? el.<span class="hljs-property">textContent</span> : <span class="hljs-literal">null</span>;</div><div class="hljs-ln-line">  };</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    testQuote = <span class="hljs-string">'Test Quote'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// Create a fake TwainService object with a `getQuote()` spy</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> twainService = jasmine.<span class="hljs-title function_">createSpyObj</span>(<span class="hljs-string">'TwainService'</span>, [<span class="hljs-string">'getQuote'</span>]);</div><div class="hljs-ln-line">    <span class="hljs-comment">// Make the spy return a synchronous Observable with the test data</span></div><div class="hljs-ln-line">    getQuoteSpy = twainService.<span class="hljs-property">getQuote</span>.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(<span class="hljs-title function_">of</span>(testQuote));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">TwainComponent</span>],</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">TwainService</span>, <span class="hljs-attr">useValue</span>: twainService}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">TwainComponent</span>);</div><div class="hljs-ln-line">    component = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line">    quoteEl = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.twain'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when test with synchronous observable'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should not show quote before OnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'nothing displayed'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error element'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote not yet called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">false</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// The quote would not be immediately available if the service were truly async.</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after component initialized'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// onInit()</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// sync spy result shows testQuote immediately after init</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// The error would not be immediately available if the service were truly async.</span></div><div class="hljs-ln-line">    <span class="hljs-comment">// Use `fakeAsync` because the component error calls `setTimeout`</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display error when TwainService fails'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// tell spy to return an error observable</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(<span class="hljs-title function_">throwError</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'TwainService test failure'</span>)));</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// onInit()</span></div><div class="hljs-ln-line">      <span class="hljs-comment">// sync spy errors immediately after init</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// flush the component's setTimeout()</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update errorMessage within setTimeout()</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>())</div><div class="hljs-ln-line">        .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should display error'</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/test failure/</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when test with asynchronous observable'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// Simulate delayed observable values with the `asyncData()` helper</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(<span class="hljs-title function_">asyncData</span>(testQuote));</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should not show quote before OnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'nothing displayed'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error element'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote not yet called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">false</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should still not show quote after component initialized'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">      <span class="hljs-comment">// getQuote service is async =&gt; still has not returned with quote</span></div><div class="hljs-ln-line">      <span class="hljs-comment">// so should show the start value, '...'</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (fakeAsync)'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// flush the observable to get the quote</span></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show quote'</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (waitForAsync)'</span>, <span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">whenStable</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-comment">// wait for async getQuote</span></div><div class="hljs-ln-line">        fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view with quote</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show last quote (quote done)'</span>, <span class="hljs-function">(<span class="hljs-params">done: DoneFn</span>) =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      component.<span class="hljs-property">quote</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">last</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view with quote</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">        <span class="hljs-title function_">done</span>();</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (spy done)'</span>, <span class="hljs-function">(<span class="hljs-params">done: DoneFn</span>) =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// the spy's most recent call returns the observable with the test quote</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">mostRecent</span>().<span class="hljs-property">returnValue</span>.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view with quote</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">        <span class="hljs-title function_">done</span>();</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display error when TwainService fails'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// tell spy to return an async error observable</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(asyncError&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">'TwainService test failure'</span>));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// component shows error after a setTimeout()</span></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update error message</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>())</div><div class="hljs-ln-line">        .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should display error'</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/test failure/</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="7z4dwzy5y9fn5akjyq18wy9pc">这个间谍的设计目标是让所有对 <code>getQuote</code> 的调用都会收到一个带有测试名言的可观察者。与真正的 <code>getQuote()</code> 方法不同，这个间谍会绕过服务器，并返回一个立即同步提供可用值的可观察者。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="5g60gwz61nrhzwgzdf0kxccc4">虽然这个 <code>Observable</code> 是同步的，但你也可以用这个间谍编写很多有用的测试。</p>

  <h3 id="synchronous-tests">
    <a href="#synchronous-tests" class="docs-anchor" tabindex="-1" aria-label="Link to Synchronous tests" data-ng_translator_product="100" data-ng_translator_ref_id="7xhnk8619g2837p7eu6z4vjwu">同步测试</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="7429epq70gbzzgay4gvwkt7i0">同步 <code>Observable</code> 的一个关键优势是，你通常可以把异步过程转换成同步测试。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/twain/twain.component.spec.ts" visiblelines="50,51,52,53,54,55,56">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, <span class="hljs-title class_">ComponentFixture</span>, <span class="hljs-title class_">TestBed</span>, tick, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {asyncData, asyncError} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-keyword">of</span>, throwError} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {last} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'TwainComponent'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">TwainComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">TwainComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">getQuoteSpy</span>: jasmine.<span class="hljs-property">Spy</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">quoteEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">testQuote</span>: <span class="hljs-built_in">string</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">// Helper function to get the error message element value</span></div><div class="hljs-ln-line">  <span class="hljs-comment">// An *ngIf keeps it out of the DOM until there is an error</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> <span class="hljs-title function_">errorMessage</span> = (<span class="hljs-params"></span>) =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> el = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.error'</span>);</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> el ? el.<span class="hljs-property">textContent</span> : <span class="hljs-literal">null</span>;</div><div class="hljs-ln-line">  };</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    testQuote = <span class="hljs-string">'Test Quote'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// Create a fake TwainService object with a `getQuote()` spy</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> twainService = jasmine.<span class="hljs-title function_">createSpyObj</span>(<span class="hljs-string">'TwainService'</span>, [<span class="hljs-string">'getQuote'</span>]);</div><div class="hljs-ln-line">    <span class="hljs-comment">// Make the spy return a synchronous Observable with the test data</span></div><div class="hljs-ln-line">    getQuoteSpy = twainService.<span class="hljs-property">getQuote</span>.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(<span class="hljs-title function_">of</span>(testQuote));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">TwainComponent</span>],</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">TwainService</span>, <span class="hljs-attr">useValue</span>: twainService}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">TwainComponent</span>);</div><div class="hljs-ln-line">    component = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line">    quoteEl = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.twain'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when test with synchronous observable'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should not show quote before OnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'nothing displayed'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error element'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote not yet called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">false</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// The quote would not be immediately available if the service were truly async.</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after component initialized'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// onInit()</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// sync spy result shows testQuote immediately after init</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// The error would not be immediately available if the service were truly async.</span></div><div class="hljs-ln-line">    <span class="hljs-comment">// Use `fakeAsync` because the component error calls `setTimeout`</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display error when TwainService fails'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// tell spy to return an error observable</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(<span class="hljs-title function_">throwError</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'TwainService test failure'</span>)));</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// onInit()</span></div><div class="hljs-ln-line">      <span class="hljs-comment">// sync spy errors immediately after init</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// flush the component's setTimeout()</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update errorMessage within setTimeout()</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>())</div><div class="hljs-ln-line">        .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should display error'</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/test failure/</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when test with asynchronous observable'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// Simulate delayed observable values with the `asyncData()` helper</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(<span class="hljs-title function_">asyncData</span>(testQuote));</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should not show quote before OnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'nothing displayed'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error element'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote not yet called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">false</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should still not show quote after component initialized'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">      <span class="hljs-comment">// getQuote service is async =&gt; still has not returned with quote</span></div><div class="hljs-ln-line">      <span class="hljs-comment">// so should show the start value, '...'</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (fakeAsync)'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// flush the observable to get the quote</span></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show quote'</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (waitForAsync)'</span>, <span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">whenStable</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-comment">// wait for async getQuote</span></div><div class="hljs-ln-line">        fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view with quote</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show last quote (quote done)'</span>, <span class="hljs-function">(<span class="hljs-params">done: DoneFn</span>) =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      component.<span class="hljs-property">quote</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">last</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view with quote</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">        <span class="hljs-title function_">done</span>();</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (spy done)'</span>, <span class="hljs-function">(<span class="hljs-params">done: DoneFn</span>) =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// the spy's most recent call returns the observable with the test quote</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">mostRecent</span>().<span class="hljs-property">returnValue</span>.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view with quote</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">        <span class="hljs-title function_">done</span>();</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display error when TwainService fails'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// tell spy to return an async error observable</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(asyncError&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">'TwainService test failure'</span>));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// component shows error after a setTimeout()</span></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update error message</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>())</div><div class="hljs-ln-line">        .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should display error'</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/test failure/</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="9cnpxwg1v8igf4a8syzuqjvfo">当间谍的结果同步返回时，<code>getQuote()</code> 方法会在第一个变更检测周期（Angular 在这里调用 <code>ngOnInit</code>）<em>后</em>立即更新屏幕上的消息。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="dbb6fqtr6lmlm5t66pmmpi08n">你在测试错误路径时就没有这么幸运了。虽然服务间谍会同步返回一个错误，但该组件方法会调用 <code>setTimeout()</code>。在值可用之前，测试必须等待 JavaScript 引擎的至少一个周期。因此，该测试必须是<em>异步的</em>。</p>

  <h3 id="async-test-with-fakeasync">
    <a href="#async-test-with-fakeasync" class="docs-anchor" tabindex="-1" aria-label="Link to Async test with <code>fakeAsync()</code>" data-ng_translator_product="100" data-ng_translator_ref_id="6iiotjfbm9v33hc6cn8aft5wn">使用 
<code>fakeAsync()</code> 的异步测试</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_ref_id="9w8qj0tuarkb56ve1xxpufv5q">要使用 
<code>fakeAsync()</code> 功能，必须在测试设置文件中导入 
<code>zone.js/testing</code>。如果使用 Angular CLI 创建项目，则 
<code>zone-testing</code> 已经在 
<code>src/test.ts</code> 中导入。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="273rfgrzqzbuurnack4vk6bgw">当该服务返回 <code>ErrorObservable</code> 时，下列测试会对其预期行为进行确认。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/twain/twain.component.spec.ts" visiblelines="60,61,62,63,64,65,66,67,68,69,70,71,72,73,74">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, <span class="hljs-title class_">ComponentFixture</span>, <span class="hljs-title class_">TestBed</span>, tick, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {asyncData, asyncError} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-keyword">of</span>, throwError} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {last} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'TwainComponent'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">TwainComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">TwainComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">getQuoteSpy</span>: jasmine.<span class="hljs-property">Spy</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">quoteEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">testQuote</span>: <span class="hljs-built_in">string</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">// Helper function to get the error message element value</span></div><div class="hljs-ln-line">  <span class="hljs-comment">// An *ngIf keeps it out of the DOM until there is an error</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> <span class="hljs-title function_">errorMessage</span> = (<span class="hljs-params"></span>) =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> el = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.error'</span>);</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> el ? el.<span class="hljs-property">textContent</span> : <span class="hljs-literal">null</span>;</div><div class="hljs-ln-line">  };</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    testQuote = <span class="hljs-string">'Test Quote'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// Create a fake TwainService object with a `getQuote()` spy</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> twainService = jasmine.<span class="hljs-title function_">createSpyObj</span>(<span class="hljs-string">'TwainService'</span>, [<span class="hljs-string">'getQuote'</span>]);</div><div class="hljs-ln-line">    <span class="hljs-comment">// Make the spy return a synchronous Observable with the test data</span></div><div class="hljs-ln-line">    getQuoteSpy = twainService.<span class="hljs-property">getQuote</span>.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(<span class="hljs-title function_">of</span>(testQuote));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">TwainComponent</span>],</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">TwainService</span>, <span class="hljs-attr">useValue</span>: twainService}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">TwainComponent</span>);</div><div class="hljs-ln-line">    component = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line">    quoteEl = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.twain'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when test with synchronous observable'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should not show quote before OnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'nothing displayed'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error element'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote not yet called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">false</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// The quote would not be immediately available if the service were truly async.</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after component initialized'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// onInit()</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// sync spy result shows testQuote immediately after init</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// The error would not be immediately available if the service were truly async.</span></div><div class="hljs-ln-line">    <span class="hljs-comment">// Use `fakeAsync` because the component error calls `setTimeout`</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display error when TwainService fails'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// tell spy to return an error observable</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(<span class="hljs-title function_">throwError</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'TwainService test failure'</span>)));</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// onInit()</span></div><div class="hljs-ln-line">      <span class="hljs-comment">// sync spy errors immediately after init</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// flush the component's setTimeout()</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update errorMessage within setTimeout()</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>())</div><div class="hljs-ln-line">        .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should display error'</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/test failure/</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when test with asynchronous observable'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// Simulate delayed observable values with the `asyncData()` helper</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(<span class="hljs-title function_">asyncData</span>(testQuote));</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should not show quote before OnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'nothing displayed'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error element'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote not yet called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">false</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should still not show quote after component initialized'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">      <span class="hljs-comment">// getQuote service is async =&gt; still has not returned with quote</span></div><div class="hljs-ln-line">      <span class="hljs-comment">// so should show the start value, '...'</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (fakeAsync)'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// flush the observable to get the quote</span></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show quote'</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (waitForAsync)'</span>, <span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">whenStable</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-comment">// wait for async getQuote</span></div><div class="hljs-ln-line">        fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view with quote</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show last quote (quote done)'</span>, <span class="hljs-function">(<span class="hljs-params">done: DoneFn</span>) =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      component.<span class="hljs-property">quote</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">last</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view with quote</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">        <span class="hljs-title function_">done</span>();</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (spy done)'</span>, <span class="hljs-function">(<span class="hljs-params">done: DoneFn</span>) =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// the spy's most recent call returns the observable with the test quote</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">mostRecent</span>().<span class="hljs-property">returnValue</span>.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view with quote</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">        <span class="hljs-title function_">done</span>();</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display error when TwainService fails'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// tell spy to return an async error observable</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(asyncError&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">'TwainService test failure'</span>));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// component shows error after a setTimeout()</span></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update error message</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>())</div><div class="hljs-ln-line">        .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should display error'</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/test failure/</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
    <div class="docs-alert docs-alert-helpful">
    <p data-ng_translator_product="100" data-ng_translator_ref_id="36m85bbsflh2pjmc82ilc4qax"><strong>提示：</strong>函数 
<code>it()</code> 接收以下形式的参数。</p>

    </div>
    <div class="docs-code">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-comment">/*test body*/</span> })</div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="cs2a3jw80xudemsbt1q470l9i">使用
<code>fakeAsync()</code>函数可以通过在特殊的
<code>fakeAsync测试区域</code>中运行测试主体，实现一种线性的编码风格。 测试主体看起来是同步的。 没有嵌套语法（比如
<code>Promise.then()</code>）来打断控制流。</p>

    <div class="docs-alert docs-alert-helpful">
    <p data-ng_translator_product="100" data-ng_translator_ref_id="yoabv6negpn7kidbm3bb3874"><strong>提示：</strong>限制：如果测试主体发起
<code>XMLHttpRequest</code>（XHR）调用，
<code>fakeAsync()</code>函数将无法正常工作。 测试中很少使用XHR调用，但如果需要调用XHR，请查看
<a href="#waitForAsync"><code>waitForAsync()</code></a>部分。</p>

    </div>
    
  <h3 id="the-tick-function">
    <a href="#the-tick-function" class="docs-anchor" tabindex="-1" aria-label="Link to The <code>tick()</code> function" data-ng_translator_product="100" data-ng_translator_ref_id="8u3p0svje9b07txozroup0vhb">此 
<code>tick()</code> 函数</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_ref_id="3lo7hr4qd6qjt72sd5qnrauu5">你必须调用
<a href="api/core/testing/tick">tick()</a>来推进虚拟时钟。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="7cf10z9mc2ad73aow6e22f7b9">调用
<a href="api/core/testing/tick">tick()</a>模拟时间的流逝，直到所有待处理的异步活动完成。 在这种情况下，它等待错误处理程序的
<code>setTimeout()</code>。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="eitre8pgrwt4gn630b4410kf3"><a href="api/core/testing/tick">tick()</a>函数接受
<code>millis</code>和
<code>tickOptions</code>作为参数。
<code>millis</code>参数指定虚拟时钟推进多少，并在未提供时默认为
<code>0</code>。 例如，如果在
<code>fakeAsync()</code>测试中有一个
<code>setTimeout(fn, 100)</code>，你需要使用
<code>tick(100)</code>来触发fn回调。 可选的
<code>tickOptions</code>参数具有一个名为
<code>processNewMacroTasksSynchronously</code>的属性。
<code>processNewMacroTasksSynchronously</code>属性表示在推进时是否调用新生成的宏任务，默认为
<code>true</code>。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/demo/async-helper.spec.ts" visiblelines="88,89,90,91,92,93,94,95">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, tick, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {interval, <span class="hljs-keyword">of</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {delay, take} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">describe(<span class="hljs-string">'Angular async helper'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">  describe(<span class="hljs-string">'async'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    let actuallyDone = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    beforeEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      actuallyDone = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    afterEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      expect(actuallyDone).withContext(<span class="hljs-string">'actuallyDone should be true'</span>).toBe(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run normal test'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run normal async test'</span>, <span class="hljs-function"><span class="hljs-params">(done: DoneFn)</span> =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">        done();</div><div class="hljs-ln-line">      }, <span class="hljs-number">0</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with task'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      }, <span class="hljs-number">0</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with task'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const id = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">        <span class="hljs-built_in">clearInterval</span>(id);</div><div class="hljs-ln-line">      }, <span class="hljs-number">100</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with successful promise'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const p = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">(resolve)</span> =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">10</span>);</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">      p.<span class="hljs-keyword">then</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with failed promise'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const p = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">(resolve, reject)</span> =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-built_in">setTimeout</span>(reject, <span class="hljs-number">10</span>);</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">      p.<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-regexp">//</span> Use done. Can also use <span class="hljs-keyword">async</span> <span class="hljs-keyword">or</span> fakeAsync.</div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with successful delayed Observable'</span>, <span class="hljs-function"><span class="hljs-params">(done: DoneFn)</span> =&gt;</span> {</div><div class="hljs-ln-line">      const source = <span class="hljs-keyword">of</span>(<span class="hljs-literal">true</span>).pipe(delay(<span class="hljs-number">10</span>));</div><div class="hljs-ln-line">      source.subscribe({</div><div class="hljs-ln-line">        next: <span class="hljs-function"><span class="hljs-params">(val)</span> =&gt;</span> (actuallyDone = <span class="hljs-literal">true</span>),</div><div class="hljs-ln-line">        error: <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span> fail(err),</div><div class="hljs-ln-line">        complete: done,</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with successful delayed Observable'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const source = <span class="hljs-keyword">of</span>(<span class="hljs-literal">true</span>).pipe(delay(<span class="hljs-number">10</span>));</div><div class="hljs-ln-line">      source.subscribe({</div><div class="hljs-ln-line">        next: <span class="hljs-function"><span class="hljs-params">(val)</span> =&gt;</span> (actuallyDone = <span class="hljs-literal">true</span>),</div><div class="hljs-ln-line">        error: <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span> fail(err),</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with successful delayed Observable'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const source = <span class="hljs-keyword">of</span>(<span class="hljs-literal">true</span>).pipe(delay(<span class="hljs-number">10</span>));</div><div class="hljs-ln-line">      source.subscribe({</div><div class="hljs-ln-line">        next: <span class="hljs-function"><span class="hljs-params">(val)</span> =&gt;</span> (actuallyDone = <span class="hljs-literal">true</span>),</div><div class="hljs-ln-line">        error: <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span> fail(err),</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      tick(<span class="hljs-number">10</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  describe(<span class="hljs-string">'fakeAsync'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run timeout callback with delay after call tick with millis'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      let called = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        called = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      }, <span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      tick(<span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      expect(called).toBe(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run new macro task callback with delay after call tick with millis'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      function nestedTimer(cb: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> any): <span class="hljs-keyword">void</span> {</div><div class="hljs-ln-line">        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> cb()));</div><div class="hljs-ln-line">      }</div><div class="hljs-ln-line">      const callback = jasmine.createSpy(<span class="hljs-string">'callback'</span>);</div><div class="hljs-ln-line">      nestedTimer(callback);</div><div class="hljs-ln-line">      expect(callback).<span class="hljs-keyword">not</span>.toHaveBeenCalled();</div><div class="hljs-ln-line">      tick(<span class="hljs-number">0</span>);</div><div class="hljs-ln-line">      <span class="hljs-regexp">//</span> the nested timeout will also be triggered</div><div class="hljs-ln-line">      expect(callback).toHaveBeenCalled();</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should not run new macro task callback with delay after call tick with millis'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      function nestedTimer(cb: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> any): <span class="hljs-keyword">void</span> {</div><div class="hljs-ln-line">        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> cb()));</div><div class="hljs-ln-line">      }</div><div class="hljs-ln-line">      const callback = jasmine.createSpy(<span class="hljs-string">'callback'</span>);</div><div class="hljs-ln-line">      nestedTimer(callback);</div><div class="hljs-ln-line">      expect(callback).<span class="hljs-keyword">not</span>.toHaveBeenCalled();</div><div class="hljs-ln-line">      tick(<span class="hljs-number">0</span>, {processNewMacroTasksSynchronously: <span class="hljs-literal">false</span>});</div><div class="hljs-ln-line">      <span class="hljs-regexp">//</span> the nested timeout will <span class="hljs-keyword">not</span> be triggered</div><div class="hljs-ln-line">      expect(callback).<span class="hljs-keyword">not</span>.toHaveBeenCalled();</div><div class="hljs-ln-line">      tick(<span class="hljs-number">0</span>);</div><div class="hljs-ln-line">      expect(callback).toHaveBeenCalled();</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should get Date diff correctly in fakeAsync'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const start = <span class="hljs-built_in">Date</span>.now();</div><div class="hljs-ln-line">      tick(<span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      const end = <span class="hljs-built_in">Date</span>.now();</div><div class="hljs-ln-line">      expect(end - start).toBe(<span class="hljs-number">100</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should get Date diff correctly in fakeAsync with rxjs scheduler'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-regexp">//</span> need to add `<span class="language-javascript"><span class="hljs-keyword">import</span> <span class="hljs-string">'zone.js/plugins/zone-patch-rxjs-fake-async'</span></span></div><div class="hljs-ln-line">      <span class="hljs-comment">// to patch rxjs scheduler</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">let</span> result = <span class="hljs-string">''</span>;</div><div class="hljs-ln-line">      <span class="hljs-title function_">of</span>(<span class="hljs-string">'hello'</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">delay</span>(<span class="hljs-number">1000</span>))</div><div class="hljs-ln-line">        .<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">v</span>) =&gt;</span> {</div><div class="hljs-ln-line">          result = v;</div><div class="hljs-ln-line">        });</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(result).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(<span class="hljs-number">1000</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(result).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'hello'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> start = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>();</div><div class="hljs-ln-line">      <span class="hljs-keyword">let</span> dateDiff = <span class="hljs-number">0</span>;</div><div class="hljs-ln-line">      <span class="hljs-title function_">interval</span>(<span class="hljs-number">1000</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">take</span>(<span class="hljs-number">2</span>))</div><div class="hljs-ln-line">        .<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> (dateDiff = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>() - start));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(<span class="hljs-number">1000</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(dateDiff).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1000</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(<span class="hljs-number">1000</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(dateDiff).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">2000</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'use jasmine.clock()'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// need to config __zone_symbol__fakeAsyncPatchLock flag</span></div><div class="hljs-ln-line">    <span class="hljs-comment">// before loading zone.js/testing</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      jasmine.<span class="hljs-title function_">clock</span>().<span class="hljs-title function_">install</span>();</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-title function_">afterEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      jasmine.<span class="hljs-title function_">clock</span>().<span class="hljs-title function_">uninstall</span>();</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should auto enter fakeAsync'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// is in fakeAsync now, don't need to call fakeAsync(testFn)</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">let</span> called = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        called = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      }, <span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      jasmine.<span class="hljs-title function_">clock</span>().<span class="hljs-title function_">tick</span>(<span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(called).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'test jsonp'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">jsonp</span>(<span class="hljs-params">url: string, callback: () =&gt; <span class="hljs-keyword">void</span></span>) {</div><div class="hljs-ln-line">      <span class="hljs-comment">// do a jsonp call which is not zone aware</span></div><div class="hljs-ln-line">    }</div><div class="hljs-ln-line">    <span class="hljs-comment">// need to config __zone_symbol__supportWaitUnResolvedChainedPromise flag</span></div><div class="hljs-ln-line">    <span class="hljs-comment">// before loading zone.js/testing</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should wait until promise.then is called'</span>, <span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-keyword">let</span> finished = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">      <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt;(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-title function_">jsonp</span>(<span class="hljs-string">'localhost:8080/jsonp'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">          <span class="hljs-comment">// success callback and resolve the promise</span></div><div class="hljs-ln-line">          finished = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">          <span class="hljs-title function_">res</span>();</div><div class="hljs-ln-line">        });</div><div class="hljs-ln-line">      }).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-comment">// async will wait until promise.then is called</span></div><div class="hljs-ln-line">        <span class="hljs-comment">// if __zone_symbol__supportWaitUnResolvedChainedPromise is set</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(finished).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="3a9ycqfx1o2ecaywriuot4nd8"><a href="api/core/testing/tick">tick()</a>函数是Angular测试工具之一，你可以通过
<code>TestBed</code>导入。 它是
<code>fakeAsync()</code>的伴侣，只能在
<code>fakeAsync()</code>主体内调用。</p>

  <h3 id="tickoptions">
    <a href="#tickoptions" class="docs-anchor" tabindex="-1" aria-label="Link to tickOptions">tickOptions</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_ref_id="2nmyqk7qex0khwefjbndaw2u6">在这个示例中，有一个新的宏任务，嵌套的
<code>setTimeout</code>函数。默认情况下，当
<code>tick</code>是setTimeout时，
<code>outside</code>和
<code>nested</code>都将被触发。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/demo/async-helper.spec.ts" visiblelines="97,98,99,100,101,102,103,104,105,106,107">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, tick, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {interval, <span class="hljs-keyword">of</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {delay, take} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">describe(<span class="hljs-string">'Angular async helper'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">  describe(<span class="hljs-string">'async'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    let actuallyDone = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    beforeEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      actuallyDone = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    afterEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      expect(actuallyDone).withContext(<span class="hljs-string">'actuallyDone should be true'</span>).toBe(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run normal test'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run normal async test'</span>, <span class="hljs-function"><span class="hljs-params">(done: DoneFn)</span> =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">        done();</div><div class="hljs-ln-line">      }, <span class="hljs-number">0</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with task'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      }, <span class="hljs-number">0</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with task'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const id = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">        <span class="hljs-built_in">clearInterval</span>(id);</div><div class="hljs-ln-line">      }, <span class="hljs-number">100</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with successful promise'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const p = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">(resolve)</span> =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">10</span>);</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">      p.<span class="hljs-keyword">then</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with failed promise'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const p = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">(resolve, reject)</span> =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-built_in">setTimeout</span>(reject, <span class="hljs-number">10</span>);</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">      p.<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-regexp">//</span> Use done. Can also use <span class="hljs-keyword">async</span> <span class="hljs-keyword">or</span> fakeAsync.</div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with successful delayed Observable'</span>, <span class="hljs-function"><span class="hljs-params">(done: DoneFn)</span> =&gt;</span> {</div><div class="hljs-ln-line">      const source = <span class="hljs-keyword">of</span>(<span class="hljs-literal">true</span>).pipe(delay(<span class="hljs-number">10</span>));</div><div class="hljs-ln-line">      source.subscribe({</div><div class="hljs-ln-line">        next: <span class="hljs-function"><span class="hljs-params">(val)</span> =&gt;</span> (actuallyDone = <span class="hljs-literal">true</span>),</div><div class="hljs-ln-line">        error: <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span> fail(err),</div><div class="hljs-ln-line">        complete: done,</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with successful delayed Observable'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const source = <span class="hljs-keyword">of</span>(<span class="hljs-literal">true</span>).pipe(delay(<span class="hljs-number">10</span>));</div><div class="hljs-ln-line">      source.subscribe({</div><div class="hljs-ln-line">        next: <span class="hljs-function"><span class="hljs-params">(val)</span> =&gt;</span> (actuallyDone = <span class="hljs-literal">true</span>),</div><div class="hljs-ln-line">        error: <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span> fail(err),</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with successful delayed Observable'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const source = <span class="hljs-keyword">of</span>(<span class="hljs-literal">true</span>).pipe(delay(<span class="hljs-number">10</span>));</div><div class="hljs-ln-line">      source.subscribe({</div><div class="hljs-ln-line">        next: <span class="hljs-function"><span class="hljs-params">(val)</span> =&gt;</span> (actuallyDone = <span class="hljs-literal">true</span>),</div><div class="hljs-ln-line">        error: <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span> fail(err),</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      tick(<span class="hljs-number">10</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  describe(<span class="hljs-string">'fakeAsync'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run timeout callback with delay after call tick with millis'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      let called = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        called = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      }, <span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      tick(<span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      expect(called).toBe(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run new macro task callback with delay after call tick with millis'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      function nestedTimer(cb: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> any): <span class="hljs-keyword">void</span> {</div><div class="hljs-ln-line">        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> cb()));</div><div class="hljs-ln-line">      }</div><div class="hljs-ln-line">      const callback = jasmine.createSpy(<span class="hljs-string">'callback'</span>);</div><div class="hljs-ln-line">      nestedTimer(callback);</div><div class="hljs-ln-line">      expect(callback).<span class="hljs-keyword">not</span>.toHaveBeenCalled();</div><div class="hljs-ln-line">      tick(<span class="hljs-number">0</span>);</div><div class="hljs-ln-line">      <span class="hljs-regexp">//</span> the nested timeout will also be triggered</div><div class="hljs-ln-line">      expect(callback).toHaveBeenCalled();</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should not run new macro task callback with delay after call tick with millis'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      function nestedTimer(cb: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> any): <span class="hljs-keyword">void</span> {</div><div class="hljs-ln-line">        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> cb()));</div><div class="hljs-ln-line">      }</div><div class="hljs-ln-line">      const callback = jasmine.createSpy(<span class="hljs-string">'callback'</span>);</div><div class="hljs-ln-line">      nestedTimer(callback);</div><div class="hljs-ln-line">      expect(callback).<span class="hljs-keyword">not</span>.toHaveBeenCalled();</div><div class="hljs-ln-line">      tick(<span class="hljs-number">0</span>, {processNewMacroTasksSynchronously: <span class="hljs-literal">false</span>});</div><div class="hljs-ln-line">      <span class="hljs-regexp">//</span> the nested timeout will <span class="hljs-keyword">not</span> be triggered</div><div class="hljs-ln-line">      expect(callback).<span class="hljs-keyword">not</span>.toHaveBeenCalled();</div><div class="hljs-ln-line">      tick(<span class="hljs-number">0</span>);</div><div class="hljs-ln-line">      expect(callback).toHaveBeenCalled();</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should get Date diff correctly in fakeAsync'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const start = <span class="hljs-built_in">Date</span>.now();</div><div class="hljs-ln-line">      tick(<span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      const end = <span class="hljs-built_in">Date</span>.now();</div><div class="hljs-ln-line">      expect(end - start).toBe(<span class="hljs-number">100</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should get Date diff correctly in fakeAsync with rxjs scheduler'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-regexp">//</span> need to add `<span class="language-javascript"><span class="hljs-keyword">import</span> <span class="hljs-string">'zone.js/plugins/zone-patch-rxjs-fake-async'</span></span></div><div class="hljs-ln-line">      <span class="hljs-comment">// to patch rxjs scheduler</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">let</span> result = <span class="hljs-string">''</span>;</div><div class="hljs-ln-line">      <span class="hljs-title function_">of</span>(<span class="hljs-string">'hello'</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">delay</span>(<span class="hljs-number">1000</span>))</div><div class="hljs-ln-line">        .<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">v</span>) =&gt;</span> {</div><div class="hljs-ln-line">          result = v;</div><div class="hljs-ln-line">        });</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(result).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(<span class="hljs-number">1000</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(result).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'hello'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> start = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>();</div><div class="hljs-ln-line">      <span class="hljs-keyword">let</span> dateDiff = <span class="hljs-number">0</span>;</div><div class="hljs-ln-line">      <span class="hljs-title function_">interval</span>(<span class="hljs-number">1000</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">take</span>(<span class="hljs-number">2</span>))</div><div class="hljs-ln-line">        .<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> (dateDiff = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>() - start));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(<span class="hljs-number">1000</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(dateDiff).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1000</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(<span class="hljs-number">1000</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(dateDiff).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">2000</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'use jasmine.clock()'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// need to config __zone_symbol__fakeAsyncPatchLock flag</span></div><div class="hljs-ln-line">    <span class="hljs-comment">// before loading zone.js/testing</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      jasmine.<span class="hljs-title function_">clock</span>().<span class="hljs-title function_">install</span>();</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-title function_">afterEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      jasmine.<span class="hljs-title function_">clock</span>().<span class="hljs-title function_">uninstall</span>();</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should auto enter fakeAsync'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// is in fakeAsync now, don't need to call fakeAsync(testFn)</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">let</span> called = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        called = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      }, <span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      jasmine.<span class="hljs-title function_">clock</span>().<span class="hljs-title function_">tick</span>(<span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(called).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'test jsonp'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">jsonp</span>(<span class="hljs-params">url: string, callback: () =&gt; <span class="hljs-keyword">void</span></span>) {</div><div class="hljs-ln-line">      <span class="hljs-comment">// do a jsonp call which is not zone aware</span></div><div class="hljs-ln-line">    }</div><div class="hljs-ln-line">    <span class="hljs-comment">// need to config __zone_symbol__supportWaitUnResolvedChainedPromise flag</span></div><div class="hljs-ln-line">    <span class="hljs-comment">// before loading zone.js/testing</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should wait until promise.then is called'</span>, <span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-keyword">let</span> finished = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">      <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt;(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-title function_">jsonp</span>(<span class="hljs-string">'localhost:8080/jsonp'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">          <span class="hljs-comment">// success callback and resolve the promise</span></div><div class="hljs-ln-line">          finished = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">          <span class="hljs-title function_">res</span>();</div><div class="hljs-ln-line">        });</div><div class="hljs-ln-line">      }).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-comment">// async will wait until promise.then is called</span></div><div class="hljs-ln-line">        <span class="hljs-comment">// if __zone_symbol__supportWaitUnResolvedChainedPromise is set</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(finished).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="5ybfzgaye66keyzd8aqenusm6">在某些情况下，你不希望在推进时触发新的宏任务。你可以使用
<code>tick(millis, {processNewMacroTasksSynchronously: false})</code>来阻止调用新的宏任务。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/demo/async-helper.spec.ts" visiblelines="109,110,111,112,113,114,115,116,117,118,119,120,121">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, tick, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {interval, <span class="hljs-keyword">of</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {delay, take} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">describe(<span class="hljs-string">'Angular async helper'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">  describe(<span class="hljs-string">'async'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    let actuallyDone = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    beforeEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      actuallyDone = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    afterEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      expect(actuallyDone).withContext(<span class="hljs-string">'actuallyDone should be true'</span>).toBe(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run normal test'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run normal async test'</span>, <span class="hljs-function"><span class="hljs-params">(done: DoneFn)</span> =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">        done();</div><div class="hljs-ln-line">      }, <span class="hljs-number">0</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with task'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      }, <span class="hljs-number">0</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with task'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const id = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">        <span class="hljs-built_in">clearInterval</span>(id);</div><div class="hljs-ln-line">      }, <span class="hljs-number">100</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with successful promise'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const p = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">(resolve)</span> =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">10</span>);</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">      p.<span class="hljs-keyword">then</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with failed promise'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const p = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">(resolve, reject)</span> =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-built_in">setTimeout</span>(reject, <span class="hljs-number">10</span>);</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">      p.<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-regexp">//</span> Use done. Can also use <span class="hljs-keyword">async</span> <span class="hljs-keyword">or</span> fakeAsync.</div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with successful delayed Observable'</span>, <span class="hljs-function"><span class="hljs-params">(done: DoneFn)</span> =&gt;</span> {</div><div class="hljs-ln-line">      const source = <span class="hljs-keyword">of</span>(<span class="hljs-literal">true</span>).pipe(delay(<span class="hljs-number">10</span>));</div><div class="hljs-ln-line">      source.subscribe({</div><div class="hljs-ln-line">        next: <span class="hljs-function"><span class="hljs-params">(val)</span> =&gt;</span> (actuallyDone = <span class="hljs-literal">true</span>),</div><div class="hljs-ln-line">        error: <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span> fail(err),</div><div class="hljs-ln-line">        complete: done,</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with successful delayed Observable'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const source = <span class="hljs-keyword">of</span>(<span class="hljs-literal">true</span>).pipe(delay(<span class="hljs-number">10</span>));</div><div class="hljs-ln-line">      source.subscribe({</div><div class="hljs-ln-line">        next: <span class="hljs-function"><span class="hljs-params">(val)</span> =&gt;</span> (actuallyDone = <span class="hljs-literal">true</span>),</div><div class="hljs-ln-line">        error: <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span> fail(err),</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with successful delayed Observable'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const source = <span class="hljs-keyword">of</span>(<span class="hljs-literal">true</span>).pipe(delay(<span class="hljs-number">10</span>));</div><div class="hljs-ln-line">      source.subscribe({</div><div class="hljs-ln-line">        next: <span class="hljs-function"><span class="hljs-params">(val)</span> =&gt;</span> (actuallyDone = <span class="hljs-literal">true</span>),</div><div class="hljs-ln-line">        error: <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span> fail(err),</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      tick(<span class="hljs-number">10</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  describe(<span class="hljs-string">'fakeAsync'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run timeout callback with delay after call tick with millis'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      let called = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        called = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      }, <span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      tick(<span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      expect(called).toBe(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run new macro task callback with delay after call tick with millis'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      function nestedTimer(cb: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> any): <span class="hljs-keyword">void</span> {</div><div class="hljs-ln-line">        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> cb()));</div><div class="hljs-ln-line">      }</div><div class="hljs-ln-line">      const callback = jasmine.createSpy(<span class="hljs-string">'callback'</span>);</div><div class="hljs-ln-line">      nestedTimer(callback);</div><div class="hljs-ln-line">      expect(callback).<span class="hljs-keyword">not</span>.toHaveBeenCalled();</div><div class="hljs-ln-line">      tick(<span class="hljs-number">0</span>);</div><div class="hljs-ln-line">      <span class="hljs-regexp">//</span> the nested timeout will also be triggered</div><div class="hljs-ln-line">      expect(callback).toHaveBeenCalled();</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should not run new macro task callback with delay after call tick with millis'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      function nestedTimer(cb: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> any): <span class="hljs-keyword">void</span> {</div><div class="hljs-ln-line">        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> cb()));</div><div class="hljs-ln-line">      }</div><div class="hljs-ln-line">      const callback = jasmine.createSpy(<span class="hljs-string">'callback'</span>);</div><div class="hljs-ln-line">      nestedTimer(callback);</div><div class="hljs-ln-line">      expect(callback).<span class="hljs-keyword">not</span>.toHaveBeenCalled();</div><div class="hljs-ln-line">      tick(<span class="hljs-number">0</span>, {processNewMacroTasksSynchronously: <span class="hljs-literal">false</span>});</div><div class="hljs-ln-line">      <span class="hljs-regexp">//</span> the nested timeout will <span class="hljs-keyword">not</span> be triggered</div><div class="hljs-ln-line">      expect(callback).<span class="hljs-keyword">not</span>.toHaveBeenCalled();</div><div class="hljs-ln-line">      tick(<span class="hljs-number">0</span>);</div><div class="hljs-ln-line">      expect(callback).toHaveBeenCalled();</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should get Date diff correctly in fakeAsync'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const start = <span class="hljs-built_in">Date</span>.now();</div><div class="hljs-ln-line">      tick(<span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      const end = <span class="hljs-built_in">Date</span>.now();</div><div class="hljs-ln-line">      expect(end - start).toBe(<span class="hljs-number">100</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should get Date diff correctly in fakeAsync with rxjs scheduler'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-regexp">//</span> need to add `<span class="language-javascript"><span class="hljs-keyword">import</span> <span class="hljs-string">'zone.js/plugins/zone-patch-rxjs-fake-async'</span></span></div><div class="hljs-ln-line">      <span class="hljs-comment">// to patch rxjs scheduler</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">let</span> result = <span class="hljs-string">''</span>;</div><div class="hljs-ln-line">      <span class="hljs-title function_">of</span>(<span class="hljs-string">'hello'</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">delay</span>(<span class="hljs-number">1000</span>))</div><div class="hljs-ln-line">        .<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">v</span>) =&gt;</span> {</div><div class="hljs-ln-line">          result = v;</div><div class="hljs-ln-line">        });</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(result).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(<span class="hljs-number">1000</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(result).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'hello'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> start = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>();</div><div class="hljs-ln-line">      <span class="hljs-keyword">let</span> dateDiff = <span class="hljs-number">0</span>;</div><div class="hljs-ln-line">      <span class="hljs-title function_">interval</span>(<span class="hljs-number">1000</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">take</span>(<span class="hljs-number">2</span>))</div><div class="hljs-ln-line">        .<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> (dateDiff = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>() - start));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(<span class="hljs-number">1000</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(dateDiff).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1000</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(<span class="hljs-number">1000</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(dateDiff).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">2000</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'use jasmine.clock()'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// need to config __zone_symbol__fakeAsyncPatchLock flag</span></div><div class="hljs-ln-line">    <span class="hljs-comment">// before loading zone.js/testing</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      jasmine.<span class="hljs-title function_">clock</span>().<span class="hljs-title function_">install</span>();</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-title function_">afterEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      jasmine.<span class="hljs-title function_">clock</span>().<span class="hljs-title function_">uninstall</span>();</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should auto enter fakeAsync'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// is in fakeAsync now, don't need to call fakeAsync(testFn)</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">let</span> called = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        called = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      }, <span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      jasmine.<span class="hljs-title function_">clock</span>().<span class="hljs-title function_">tick</span>(<span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(called).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'test jsonp'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">jsonp</span>(<span class="hljs-params">url: string, callback: () =&gt; <span class="hljs-keyword">void</span></span>) {</div><div class="hljs-ln-line">      <span class="hljs-comment">// do a jsonp call which is not zone aware</span></div><div class="hljs-ln-line">    }</div><div class="hljs-ln-line">    <span class="hljs-comment">// need to config __zone_symbol__supportWaitUnResolvedChainedPromise flag</span></div><div class="hljs-ln-line">    <span class="hljs-comment">// before loading zone.js/testing</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should wait until promise.then is called'</span>, <span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-keyword">let</span> finished = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">      <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt;(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-title function_">jsonp</span>(<span class="hljs-string">'localhost:8080/jsonp'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">          <span class="hljs-comment">// success callback and resolve the promise</span></div><div class="hljs-ln-line">          finished = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">          <span class="hljs-title function_">res</span>();</div><div class="hljs-ln-line">        });</div><div class="hljs-ln-line">      }).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-comment">// async will wait until promise.then is called</span></div><div class="hljs-ln-line">        <span class="hljs-comment">// if __zone_symbol__supportWaitUnResolvedChainedPromise is set</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(finished).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
  <h3 id="comparing-dates-inside-fakeasync">
    <a href="#comparing-dates-inside-fakeasync" class="docs-anchor" tabindex="-1" aria-label="Link to Comparing dates inside fakeAsync()" data-ng_translator_product="100" data-ng_translator_ref_id="g4kka005dy2nvsa1m151s6ih">在fakeAsync()内部比较日期</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_ref_id="8inkkqsq4ff7r206o65untdy"><code>fakeAsync()</code>模拟时间的流逝，使你可以在
<code>fakeAsync()</code>内部计算日期之间的差异。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/demo/async-helper.spec.ts" visiblelines="123,124,125,126,127,128">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, tick, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {interval, <span class="hljs-keyword">of</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {delay, take} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">describe(<span class="hljs-string">'Angular async helper'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">  describe(<span class="hljs-string">'async'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    let actuallyDone = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    beforeEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      actuallyDone = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    afterEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      expect(actuallyDone).withContext(<span class="hljs-string">'actuallyDone should be true'</span>).toBe(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run normal test'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run normal async test'</span>, <span class="hljs-function"><span class="hljs-params">(done: DoneFn)</span> =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">        done();</div><div class="hljs-ln-line">      }, <span class="hljs-number">0</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with task'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      }, <span class="hljs-number">0</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with task'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const id = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">        <span class="hljs-built_in">clearInterval</span>(id);</div><div class="hljs-ln-line">      }, <span class="hljs-number">100</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with successful promise'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const p = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">(resolve)</span> =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">10</span>);</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">      p.<span class="hljs-keyword">then</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with failed promise'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const p = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">(resolve, reject)</span> =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-built_in">setTimeout</span>(reject, <span class="hljs-number">10</span>);</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">      p.<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-regexp">//</span> Use done. Can also use <span class="hljs-keyword">async</span> <span class="hljs-keyword">or</span> fakeAsync.</div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with successful delayed Observable'</span>, <span class="hljs-function"><span class="hljs-params">(done: DoneFn)</span> =&gt;</span> {</div><div class="hljs-ln-line">      const source = <span class="hljs-keyword">of</span>(<span class="hljs-literal">true</span>).pipe(delay(<span class="hljs-number">10</span>));</div><div class="hljs-ln-line">      source.subscribe({</div><div class="hljs-ln-line">        next: <span class="hljs-function"><span class="hljs-params">(val)</span> =&gt;</span> (actuallyDone = <span class="hljs-literal">true</span>),</div><div class="hljs-ln-line">        error: <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span> fail(err),</div><div class="hljs-ln-line">        complete: done,</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with successful delayed Observable'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const source = <span class="hljs-keyword">of</span>(<span class="hljs-literal">true</span>).pipe(delay(<span class="hljs-number">10</span>));</div><div class="hljs-ln-line">      source.subscribe({</div><div class="hljs-ln-line">        next: <span class="hljs-function"><span class="hljs-params">(val)</span> =&gt;</span> (actuallyDone = <span class="hljs-literal">true</span>),</div><div class="hljs-ln-line">        error: <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span> fail(err),</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with successful delayed Observable'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const source = <span class="hljs-keyword">of</span>(<span class="hljs-literal">true</span>).pipe(delay(<span class="hljs-number">10</span>));</div><div class="hljs-ln-line">      source.subscribe({</div><div class="hljs-ln-line">        next: <span class="hljs-function"><span class="hljs-params">(val)</span> =&gt;</span> (actuallyDone = <span class="hljs-literal">true</span>),</div><div class="hljs-ln-line">        error: <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span> fail(err),</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      tick(<span class="hljs-number">10</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  describe(<span class="hljs-string">'fakeAsync'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run timeout callback with delay after call tick with millis'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      let called = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        called = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      }, <span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      tick(<span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      expect(called).toBe(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run new macro task callback with delay after call tick with millis'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      function nestedTimer(cb: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> any): <span class="hljs-keyword">void</span> {</div><div class="hljs-ln-line">        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> cb()));</div><div class="hljs-ln-line">      }</div><div class="hljs-ln-line">      const callback = jasmine.createSpy(<span class="hljs-string">'callback'</span>);</div><div class="hljs-ln-line">      nestedTimer(callback);</div><div class="hljs-ln-line">      expect(callback).<span class="hljs-keyword">not</span>.toHaveBeenCalled();</div><div class="hljs-ln-line">      tick(<span class="hljs-number">0</span>);</div><div class="hljs-ln-line">      <span class="hljs-regexp">//</span> the nested timeout will also be triggered</div><div class="hljs-ln-line">      expect(callback).toHaveBeenCalled();</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should not run new macro task callback with delay after call tick with millis'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      function nestedTimer(cb: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> any): <span class="hljs-keyword">void</span> {</div><div class="hljs-ln-line">        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> cb()));</div><div class="hljs-ln-line">      }</div><div class="hljs-ln-line">      const callback = jasmine.createSpy(<span class="hljs-string">'callback'</span>);</div><div class="hljs-ln-line">      nestedTimer(callback);</div><div class="hljs-ln-line">      expect(callback).<span class="hljs-keyword">not</span>.toHaveBeenCalled();</div><div class="hljs-ln-line">      tick(<span class="hljs-number">0</span>, {processNewMacroTasksSynchronously: <span class="hljs-literal">false</span>});</div><div class="hljs-ln-line">      <span class="hljs-regexp">//</span> the nested timeout will <span class="hljs-keyword">not</span> be triggered</div><div class="hljs-ln-line">      expect(callback).<span class="hljs-keyword">not</span>.toHaveBeenCalled();</div><div class="hljs-ln-line">      tick(<span class="hljs-number">0</span>);</div><div class="hljs-ln-line">      expect(callback).toHaveBeenCalled();</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should get Date diff correctly in fakeAsync'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const start = <span class="hljs-built_in">Date</span>.now();</div><div class="hljs-ln-line">      tick(<span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      const end = <span class="hljs-built_in">Date</span>.now();</div><div class="hljs-ln-line">      expect(end - start).toBe(<span class="hljs-number">100</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should get Date diff correctly in fakeAsync with rxjs scheduler'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-regexp">//</span> need to add `<span class="language-javascript"><span class="hljs-keyword">import</span> <span class="hljs-string">'zone.js/plugins/zone-patch-rxjs-fake-async'</span></span></div><div class="hljs-ln-line">      <span class="hljs-comment">// to patch rxjs scheduler</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">let</span> result = <span class="hljs-string">''</span>;</div><div class="hljs-ln-line">      <span class="hljs-title function_">of</span>(<span class="hljs-string">'hello'</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">delay</span>(<span class="hljs-number">1000</span>))</div><div class="hljs-ln-line">        .<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">v</span>) =&gt;</span> {</div><div class="hljs-ln-line">          result = v;</div><div class="hljs-ln-line">        });</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(result).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(<span class="hljs-number">1000</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(result).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'hello'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> start = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>();</div><div class="hljs-ln-line">      <span class="hljs-keyword">let</span> dateDiff = <span class="hljs-number">0</span>;</div><div class="hljs-ln-line">      <span class="hljs-title function_">interval</span>(<span class="hljs-number">1000</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">take</span>(<span class="hljs-number">2</span>))</div><div class="hljs-ln-line">        .<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> (dateDiff = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>() - start));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(<span class="hljs-number">1000</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(dateDiff).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1000</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(<span class="hljs-number">1000</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(dateDiff).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">2000</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'use jasmine.clock()'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// need to config __zone_symbol__fakeAsyncPatchLock flag</span></div><div class="hljs-ln-line">    <span class="hljs-comment">// before loading zone.js/testing</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      jasmine.<span class="hljs-title function_">clock</span>().<span class="hljs-title function_">install</span>();</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-title function_">afterEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      jasmine.<span class="hljs-title function_">clock</span>().<span class="hljs-title function_">uninstall</span>();</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should auto enter fakeAsync'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// is in fakeAsync now, don't need to call fakeAsync(testFn)</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">let</span> called = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        called = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      }, <span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      jasmine.<span class="hljs-title function_">clock</span>().<span class="hljs-title function_">tick</span>(<span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(called).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'test jsonp'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">jsonp</span>(<span class="hljs-params">url: string, callback: () =&gt; <span class="hljs-keyword">void</span></span>) {</div><div class="hljs-ln-line">      <span class="hljs-comment">// do a jsonp call which is not zone aware</span></div><div class="hljs-ln-line">    }</div><div class="hljs-ln-line">    <span class="hljs-comment">// need to config __zone_symbol__supportWaitUnResolvedChainedPromise flag</span></div><div class="hljs-ln-line">    <span class="hljs-comment">// before loading zone.js/testing</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should wait until promise.then is called'</span>, <span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-keyword">let</span> finished = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">      <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt;(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-title function_">jsonp</span>(<span class="hljs-string">'localhost:8080/jsonp'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">          <span class="hljs-comment">// success callback and resolve the promise</span></div><div class="hljs-ln-line">          finished = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">          <span class="hljs-title function_">res</span>();</div><div class="hljs-ln-line">        });</div><div class="hljs-ln-line">      }).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-comment">// async will wait until promise.then is called</span></div><div class="hljs-ln-line">        <span class="hljs-comment">// if __zone_symbol__supportWaitUnResolvedChainedPromise is set</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(finished).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
  <h3 id="jasmineclock-with-fakeasync">
    <a href="#jasmineclock-with-fakeasync" class="docs-anchor" tabindex="-1" aria-label="Link to jasmine.clock with fakeAsync()" data-ng_translator_product="100" data-ng_translator_ref_id="5g9x0bmh096pma20bwg37ofsm">jasmine.clock与fakeAsync()</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_ref_id="86gum5nuc1ddyj54c7j8prv7">Jasmine还提供了一个
<code>clock</code>功能来模拟日期。 当在
<code>fakeAsync()</code>方法内部调用
<code>jasmine.clock().install()</code>后，Angular会自动运行测试，直到调用
<code>jasmine.clock().uninstall()</code>。 如果嵌套，不需要
<code>fakeAsync()</code>，并且会抛出错误。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="2bdsyejyk6s39519zmf3zm816">默认情况下，此功能处于禁用状态。要启用它，请在导入 <code>zone-testing</code> 之前先设置全局标志。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="6ox5hfhpvb7fr2df65xihu4bm">如果你使用的是 Angular CLI，请在 <code>src/test.ts</code> 中配置这个标志。</p>
<div class="docs-code">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line">[<span class="hljs-variable language_">window</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>](<span class="hljs-string">'__zone_symbol__fakeAsyncPatchLock'</span>) = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> <span class="hljs-string">'zone.js/testing'</span>;</div></code>
    </pre>
  </div><div class="docs-code" path="adev/src/content/examples/testing/src/app/demo/async-helper.spec.ts" visiblelines="156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, tick, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {interval, <span class="hljs-keyword">of</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {delay, take} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">describe(<span class="hljs-string">'Angular async helper'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">  describe(<span class="hljs-string">'async'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    let actuallyDone = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    beforeEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      actuallyDone = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    afterEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      expect(actuallyDone).withContext(<span class="hljs-string">'actuallyDone should be true'</span>).toBe(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run normal test'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run normal async test'</span>, <span class="hljs-function"><span class="hljs-params">(done: DoneFn)</span> =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">        done();</div><div class="hljs-ln-line">      }, <span class="hljs-number">0</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with task'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      }, <span class="hljs-number">0</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with task'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const id = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">        <span class="hljs-built_in">clearInterval</span>(id);</div><div class="hljs-ln-line">      }, <span class="hljs-number">100</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with successful promise'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const p = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">(resolve)</span> =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">10</span>);</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">      p.<span class="hljs-keyword">then</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with failed promise'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const p = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">(resolve, reject)</span> =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-built_in">setTimeout</span>(reject, <span class="hljs-number">10</span>);</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">      p.<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-regexp">//</span> Use done. Can also use <span class="hljs-keyword">async</span> <span class="hljs-keyword">or</span> fakeAsync.</div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with successful delayed Observable'</span>, <span class="hljs-function"><span class="hljs-params">(done: DoneFn)</span> =&gt;</span> {</div><div class="hljs-ln-line">      const source = <span class="hljs-keyword">of</span>(<span class="hljs-literal">true</span>).pipe(delay(<span class="hljs-number">10</span>));</div><div class="hljs-ln-line">      source.subscribe({</div><div class="hljs-ln-line">        next: <span class="hljs-function"><span class="hljs-params">(val)</span> =&gt;</span> (actuallyDone = <span class="hljs-literal">true</span>),</div><div class="hljs-ln-line">        error: <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span> fail(err),</div><div class="hljs-ln-line">        complete: done,</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with successful delayed Observable'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const source = <span class="hljs-keyword">of</span>(<span class="hljs-literal">true</span>).pipe(delay(<span class="hljs-number">10</span>));</div><div class="hljs-ln-line">      source.subscribe({</div><div class="hljs-ln-line">        next: <span class="hljs-function"><span class="hljs-params">(val)</span> =&gt;</span> (actuallyDone = <span class="hljs-literal">true</span>),</div><div class="hljs-ln-line">        error: <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span> fail(err),</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with successful delayed Observable'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const source = <span class="hljs-keyword">of</span>(<span class="hljs-literal">true</span>).pipe(delay(<span class="hljs-number">10</span>));</div><div class="hljs-ln-line">      source.subscribe({</div><div class="hljs-ln-line">        next: <span class="hljs-function"><span class="hljs-params">(val)</span> =&gt;</span> (actuallyDone = <span class="hljs-literal">true</span>),</div><div class="hljs-ln-line">        error: <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span> fail(err),</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      tick(<span class="hljs-number">10</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  describe(<span class="hljs-string">'fakeAsync'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run timeout callback with delay after call tick with millis'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      let called = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        called = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      }, <span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      tick(<span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      expect(called).toBe(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run new macro task callback with delay after call tick with millis'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      function nestedTimer(cb: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> any): <span class="hljs-keyword">void</span> {</div><div class="hljs-ln-line">        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> cb()));</div><div class="hljs-ln-line">      }</div><div class="hljs-ln-line">      const callback = jasmine.createSpy(<span class="hljs-string">'callback'</span>);</div><div class="hljs-ln-line">      nestedTimer(callback);</div><div class="hljs-ln-line">      expect(callback).<span class="hljs-keyword">not</span>.toHaveBeenCalled();</div><div class="hljs-ln-line">      tick(<span class="hljs-number">0</span>);</div><div class="hljs-ln-line">      <span class="hljs-regexp">//</span> the nested timeout will also be triggered</div><div class="hljs-ln-line">      expect(callback).toHaveBeenCalled();</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should not run new macro task callback with delay after call tick with millis'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      function nestedTimer(cb: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> any): <span class="hljs-keyword">void</span> {</div><div class="hljs-ln-line">        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> cb()));</div><div class="hljs-ln-line">      }</div><div class="hljs-ln-line">      const callback = jasmine.createSpy(<span class="hljs-string">'callback'</span>);</div><div class="hljs-ln-line">      nestedTimer(callback);</div><div class="hljs-ln-line">      expect(callback).<span class="hljs-keyword">not</span>.toHaveBeenCalled();</div><div class="hljs-ln-line">      tick(<span class="hljs-number">0</span>, {processNewMacroTasksSynchronously: <span class="hljs-literal">false</span>});</div><div class="hljs-ln-line">      <span class="hljs-regexp">//</span> the nested timeout will <span class="hljs-keyword">not</span> be triggered</div><div class="hljs-ln-line">      expect(callback).<span class="hljs-keyword">not</span>.toHaveBeenCalled();</div><div class="hljs-ln-line">      tick(<span class="hljs-number">0</span>);</div><div class="hljs-ln-line">      expect(callback).toHaveBeenCalled();</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should get Date diff correctly in fakeAsync'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const start = <span class="hljs-built_in">Date</span>.now();</div><div class="hljs-ln-line">      tick(<span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      const end = <span class="hljs-built_in">Date</span>.now();</div><div class="hljs-ln-line">      expect(end - start).toBe(<span class="hljs-number">100</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should get Date diff correctly in fakeAsync with rxjs scheduler'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-regexp">//</span> need to add `<span class="language-javascript"><span class="hljs-keyword">import</span> <span class="hljs-string">'zone.js/plugins/zone-patch-rxjs-fake-async'</span></span></div><div class="hljs-ln-line">      <span class="hljs-comment">// to patch rxjs scheduler</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">let</span> result = <span class="hljs-string">''</span>;</div><div class="hljs-ln-line">      <span class="hljs-title function_">of</span>(<span class="hljs-string">'hello'</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">delay</span>(<span class="hljs-number">1000</span>))</div><div class="hljs-ln-line">        .<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">v</span>) =&gt;</span> {</div><div class="hljs-ln-line">          result = v;</div><div class="hljs-ln-line">        });</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(result).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(<span class="hljs-number">1000</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(result).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'hello'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> start = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>();</div><div class="hljs-ln-line">      <span class="hljs-keyword">let</span> dateDiff = <span class="hljs-number">0</span>;</div><div class="hljs-ln-line">      <span class="hljs-title function_">interval</span>(<span class="hljs-number">1000</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">take</span>(<span class="hljs-number">2</span>))</div><div class="hljs-ln-line">        .<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> (dateDiff = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>() - start));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(<span class="hljs-number">1000</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(dateDiff).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1000</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(<span class="hljs-number">1000</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(dateDiff).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">2000</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'use jasmine.clock()'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// need to config __zone_symbol__fakeAsyncPatchLock flag</span></div><div class="hljs-ln-line">    <span class="hljs-comment">// before loading zone.js/testing</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      jasmine.<span class="hljs-title function_">clock</span>().<span class="hljs-title function_">install</span>();</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-title function_">afterEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      jasmine.<span class="hljs-title function_">clock</span>().<span class="hljs-title function_">uninstall</span>();</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should auto enter fakeAsync'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// is in fakeAsync now, don't need to call fakeAsync(testFn)</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">let</span> called = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        called = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      }, <span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      jasmine.<span class="hljs-title function_">clock</span>().<span class="hljs-title function_">tick</span>(<span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(called).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'test jsonp'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">jsonp</span>(<span class="hljs-params">url: string, callback: () =&gt; <span class="hljs-keyword">void</span></span>) {</div><div class="hljs-ln-line">      <span class="hljs-comment">// do a jsonp call which is not zone aware</span></div><div class="hljs-ln-line">    }</div><div class="hljs-ln-line">    <span class="hljs-comment">// need to config __zone_symbol__supportWaitUnResolvedChainedPromise flag</span></div><div class="hljs-ln-line">    <span class="hljs-comment">// before loading zone.js/testing</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should wait until promise.then is called'</span>, <span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-keyword">let</span> finished = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">      <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt;(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-title function_">jsonp</span>(<span class="hljs-string">'localhost:8080/jsonp'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">          <span class="hljs-comment">// success callback and resolve the promise</span></div><div class="hljs-ln-line">          finished = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">          <span class="hljs-title function_">res</span>();</div><div class="hljs-ln-line">        });</div><div class="hljs-ln-line">      }).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-comment">// async will wait until promise.then is called</span></div><div class="hljs-ln-line">        <span class="hljs-comment">// if __zone_symbol__supportWaitUnResolvedChainedPromise is set</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(finished).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
  <h3 id="using-the-rxjs-scheduler-inside-fakeasync">
    <a href="#using-the-rxjs-scheduler-inside-fakeasync" class="docs-anchor" tabindex="-1" aria-label="Link to Using the RxJS scheduler inside fakeAsync()" data-ng_translator_product="100" data-ng_translator_ref_id="bljxy8bpr4niesixrxkrnumxq">在fakeAsync()内部使用RxJS调度器</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_ref_id="c8o2a7hlugw23iil330376xc9">你也可以在
<code>fakeAsync()</code>中使用RxJS调度器，就像使用
<code>setTimeout()</code>或
<code>setInterval()</code>一样，但你需要导入
<code>zone.js/plugins/zone-patch-rxjs-fake-async</code>来修补RxJS调度器。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/demo/async-helper.spec.ts" visiblelines="130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, tick, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {interval, <span class="hljs-keyword">of</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {delay, take} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">describe(<span class="hljs-string">'Angular async helper'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">  describe(<span class="hljs-string">'async'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    let actuallyDone = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    beforeEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      actuallyDone = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    afterEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      expect(actuallyDone).withContext(<span class="hljs-string">'actuallyDone should be true'</span>).toBe(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run normal test'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run normal async test'</span>, <span class="hljs-function"><span class="hljs-params">(done: DoneFn)</span> =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">        done();</div><div class="hljs-ln-line">      }, <span class="hljs-number">0</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with task'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      }, <span class="hljs-number">0</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with task'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const id = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">        <span class="hljs-built_in">clearInterval</span>(id);</div><div class="hljs-ln-line">      }, <span class="hljs-number">100</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with successful promise'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const p = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">(resolve)</span> =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">10</span>);</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">      p.<span class="hljs-keyword">then</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with failed promise'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const p = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">(resolve, reject)</span> =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-built_in">setTimeout</span>(reject, <span class="hljs-number">10</span>);</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">      p.<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        actuallyDone = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-regexp">//</span> Use done. Can also use <span class="hljs-keyword">async</span> <span class="hljs-keyword">or</span> fakeAsync.</div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with successful delayed Observable'</span>, <span class="hljs-function"><span class="hljs-params">(done: DoneFn)</span> =&gt;</span> {</div><div class="hljs-ln-line">      const source = <span class="hljs-keyword">of</span>(<span class="hljs-literal">true</span>).pipe(delay(<span class="hljs-number">10</span>));</div><div class="hljs-ln-line">      source.subscribe({</div><div class="hljs-ln-line">        next: <span class="hljs-function"><span class="hljs-params">(val)</span> =&gt;</span> (actuallyDone = <span class="hljs-literal">true</span>),</div><div class="hljs-ln-line">        error: <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span> fail(err),</div><div class="hljs-ln-line">        complete: done,</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with successful delayed Observable'</span>, waitForAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const source = <span class="hljs-keyword">of</span>(<span class="hljs-literal">true</span>).pipe(delay(<span class="hljs-number">10</span>));</div><div class="hljs-ln-line">      source.subscribe({</div><div class="hljs-ln-line">        next: <span class="hljs-function"><span class="hljs-params">(val)</span> =&gt;</span> (actuallyDone = <span class="hljs-literal">true</span>),</div><div class="hljs-ln-line">        error: <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span> fail(err),</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run async test with successful delayed Observable'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const source = <span class="hljs-keyword">of</span>(<span class="hljs-literal">true</span>).pipe(delay(<span class="hljs-number">10</span>));</div><div class="hljs-ln-line">      source.subscribe({</div><div class="hljs-ln-line">        next: <span class="hljs-function"><span class="hljs-params">(val)</span> =&gt;</span> (actuallyDone = <span class="hljs-literal">true</span>),</div><div class="hljs-ln-line">        error: <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span> fail(err),</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      tick(<span class="hljs-number">10</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  describe(<span class="hljs-string">'fakeAsync'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run timeout callback with delay after call tick with millis'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      let called = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">        called = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      }, <span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      tick(<span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      expect(called).toBe(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should run new macro task callback with delay after call tick with millis'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      function nestedTimer(cb: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> any): <span class="hljs-keyword">void</span> {</div><div class="hljs-ln-line">        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> cb()));</div><div class="hljs-ln-line">      }</div><div class="hljs-ln-line">      const callback = jasmine.createSpy(<span class="hljs-string">'callback'</span>);</div><div class="hljs-ln-line">      nestedTimer(callback);</div><div class="hljs-ln-line">      expect(callback).<span class="hljs-keyword">not</span>.toHaveBeenCalled();</div><div class="hljs-ln-line">      tick(<span class="hljs-number">0</span>);</div><div class="hljs-ln-line">      <span class="hljs-regexp">//</span> the nested timeout will also be triggered</div><div class="hljs-ln-line">      expect(callback).toHaveBeenCalled();</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should not run new macro task callback with delay after call tick with millis'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      function nestedTimer(cb: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> any): <span class="hljs-keyword">void</span> {</div><div class="hljs-ln-line">        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> cb()));</div><div class="hljs-ln-line">      }</div><div class="hljs-ln-line">      const callback = jasmine.createSpy(<span class="hljs-string">'callback'</span>);</div><div class="hljs-ln-line">      nestedTimer(callback);</div><div class="hljs-ln-line">      expect(callback).<span class="hljs-keyword">not</span>.toHaveBeenCalled();</div><div class="hljs-ln-line">      tick(<span class="hljs-number">0</span>, {processNewMacroTasksSynchronously: <span class="hljs-literal">false</span>});</div><div class="hljs-ln-line">      <span class="hljs-regexp">//</span> the nested timeout will <span class="hljs-keyword">not</span> be triggered</div><div class="hljs-ln-line">      expect(callback).<span class="hljs-keyword">not</span>.toHaveBeenCalled();</div><div class="hljs-ln-line">      tick(<span class="hljs-number">0</span>);</div><div class="hljs-ln-line">      expect(callback).toHaveBeenCalled();</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should get Date diff correctly in fakeAsync'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      const start = <span class="hljs-built_in">Date</span>.now();</div><div class="hljs-ln-line">      tick(<span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      const end = <span class="hljs-built_in">Date</span>.now();</div><div class="hljs-ln-line">      expect(end - start).toBe(<span class="hljs-number">100</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should get Date diff correctly in fakeAsync with rxjs scheduler'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-regexp">//</span> need to add `<span class="language-javascript"><span class="hljs-keyword">import</span> <span class="hljs-string">'zone.js/plugins/zone-patch-rxjs-fake-async'</span></span></div><div class="hljs-ln-line">      <span class="hljs-comment">// to patch rxjs scheduler</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">let</span> result = <span class="hljs-string">''</span>;</div><div class="hljs-ln-line">      <span class="hljs-title function_">of</span>(<span class="hljs-string">'hello'</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">delay</span>(<span class="hljs-number">1000</span>))</div><div class="hljs-ln-line">        .<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">v</span>) =&gt;</span> {</div><div class="hljs-ln-line">          result = v;</div><div class="hljs-ln-line">        });</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(result).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(<span class="hljs-number">1000</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(result).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'hello'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> start = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>();</div><div class="hljs-ln-line">      <span class="hljs-keyword">let</span> dateDiff = <span class="hljs-number">0</span>;</div><div class="hljs-ln-line">      <span class="hljs-title function_">interval</span>(<span class="hljs-number">1000</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">take</span>(<span class="hljs-number">2</span>))</div><div class="hljs-ln-line">        .<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> (dateDiff = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>() - start));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(<span class="hljs-number">1000</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(dateDiff).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1000</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(<span class="hljs-number">1000</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(dateDiff).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">2000</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'use jasmine.clock()'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// need to config __zone_symbol__fakeAsyncPatchLock flag</span></div><div class="hljs-ln-line">    <span class="hljs-comment">// before loading zone.js/testing</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      jasmine.<span class="hljs-title function_">clock</span>().<span class="hljs-title function_">install</span>();</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-title function_">afterEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      jasmine.<span class="hljs-title function_">clock</span>().<span class="hljs-title function_">uninstall</span>();</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should auto enter fakeAsync'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// is in fakeAsync now, don't need to call fakeAsync(testFn)</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">let</span> called = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        called = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">      }, <span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      jasmine.<span class="hljs-title function_">clock</span>().<span class="hljs-title function_">tick</span>(<span class="hljs-number">100</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(called).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'test jsonp'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">jsonp</span>(<span class="hljs-params">url: string, callback: () =&gt; <span class="hljs-keyword">void</span></span>) {</div><div class="hljs-ln-line">      <span class="hljs-comment">// do a jsonp call which is not zone aware</span></div><div class="hljs-ln-line">    }</div><div class="hljs-ln-line">    <span class="hljs-comment">// need to config __zone_symbol__supportWaitUnResolvedChainedPromise flag</span></div><div class="hljs-ln-line">    <span class="hljs-comment">// before loading zone.js/testing</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should wait until promise.then is called'</span>, <span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-keyword">let</span> finished = <span class="hljs-literal">false</span>;</div><div class="hljs-ln-line">      <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt;(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-title function_">jsonp</span>(<span class="hljs-string">'localhost:8080/jsonp'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">          <span class="hljs-comment">// success callback and resolve the promise</span></div><div class="hljs-ln-line">          finished = <span class="hljs-literal">true</span>;</div><div class="hljs-ln-line">          <span class="hljs-title function_">res</span>();</div><div class="hljs-ln-line">        });</div><div class="hljs-ln-line">      }).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-comment">// async will wait until promise.then is called</span></div><div class="hljs-ln-line">        <span class="hljs-comment">// if __zone_symbol__supportWaitUnResolvedChainedPromise is set</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(finished).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
  <h3 id="support-more-macrotasks">
    <a href="#support-more-macrotasks" class="docs-anchor" tabindex="-1" aria-label="Link to Support more macroTasks" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="a6khmypguz3a7ivj0dq5xcw6u">支持更多的 macroTasks</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_ref_id="10rw7ao0jlk0xuuctl7h6pkpn">默认情况下，
<code>fakeAsync()</code>支持以下宏任务。</p>

  <ul class="docs-list">
    <li><code>setTimeout</code></li>
<li><code>setInterval</code></li>
<li><code>requestAnimationFrame</code></li>
<li><code>webkitRequestAnimationFrame</code></li>
<li><code>mozRequestAnimationFrame</code></li>

  </ul>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="5dvicvj9y6i0o4mui72kvz6az">如果你运行其他宏任务，比如 <code>HTMLCanvasElement.toBlob()</code>，就会抛出 <em>"Unknown macroTask scheduled in fake async test"</em> 错误。</p>
<div class="docs-code-multifile">
    <div class="docs-code" path="adev/src/content/examples/testing/src/app/shared/canvas.component.spec.ts" visiblelines="0,1,2,3,4,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29" header="src/app/shared/canvas.component.spec.ts (failing)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="7ofg0bfg9nfmj8483txz1y514">src/app/shared/canvas.component.spec.ts（失败）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, TestBed, tick} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {CanvasComponent} <span class="hljs-keyword">from</span> <span class="hljs-string">'./canvas.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">describe(<span class="hljs-string">'CanvasComponent'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">  beforeEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    (window <span class="hljs-keyword">as</span> any).__zone_symbol__FakeAsyncTestMacroTask = [</div><div class="hljs-ln-line">      {</div><div class="hljs-ln-line">        source: <span class="hljs-string">'HTMLCanvasElement.toBlob'</span>,</div><div class="hljs-ln-line">        callbackArgs: [{size: <span class="hljs-number">200</span>}],</div><div class="hljs-ln-line">      },</div><div class="hljs-ln-line">    ];</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">  beforeEach(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> TestBed.configureTestingModule({</div><div class="hljs-ln-line">      imports: [CanvasComponent],</div><div class="hljs-ln-line">    }).compileComponents();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it(<span class="hljs-string">'should be able to generate blob data from canvas'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    const fixture = TestBed.createComponent(CanvasComponent);</div><div class="hljs-ln-line">    const canvasComp = fixture.componentInstance;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture.detectChanges();</div><div class="hljs-ln-line">    expect(canvasComp.blobSize).toBe(<span class="hljs-number">0</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    tick();</div><div class="hljs-ln-line">    expect(canvasComp.blobSize).toBeGreaterThan(<span class="hljs-number">0</span>);</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><div class="docs-code" path="adev/src/content/examples/testing/src/app/shared/canvas.component.ts" visiblelines="4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27" header="src/app/shared/canvas.component.ts">
    <div class="docs-code-header"><h3>src/app/shared/canvas.component.ts</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-comment">// Import patch to make async `HTMLCanvasElement` methods (such as `.toBlob()`) Zone.js-aware.</span></div><div class="hljs-ln-line"><span class="hljs-comment">// Either import in `polyfills.ts` (if used in more than one places in the app) or in the component</span></div><div class="hljs-ln-line"><span class="hljs-comment">// file using `HTMLCanvasElement` (if it is only used in a single file).</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> <span class="hljs-string">'zone.js/plugins/zone-patch-canvas'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Component</span>, <span class="hljs-title class_">AfterViewInit</span>, <span class="hljs-title class_">ViewChild</span>, <span class="hljs-title class_">ElementRef</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-meta">@Component</span>({</div><div class="hljs-ln-line">  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">selector</span>: <span class="hljs-string">'sample-canvas'</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">template</span>: <span class="hljs-string">'&lt;canvas #sampleCanvas width="200" height="200"&gt;&lt;/canvas&gt;'</span>,</div><div class="hljs-ln-line">})</div><div class="hljs-ln-line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CanvasComponent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AfterViewInit</span> {</div><div class="hljs-ln-line">  blobSize = <span class="hljs-number">0</span>;</div><div class="hljs-ln-line">  <span class="hljs-meta">@ViewChild</span>(<span class="hljs-string">'sampleCanvas'</span>) sampleCanvas!: <span class="hljs-title class_">ElementRef</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">ngAfterViewInit</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> <span class="hljs-attr">canvas</span>: <span class="hljs-title class_">HTMLCanvasElement</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">sampleCanvas</span>.<span class="hljs-property">nativeElement</span>;</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> context = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>)!;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    context.<span class="hljs-title function_">clearRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">200</span>, <span class="hljs-number">200</span>);</div><div class="hljs-ln-line">    context.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'#FF1122'</span>;</div><div class="hljs-ln-line">    context.<span class="hljs-title function_">fillRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">200</span>, <span class="hljs-number">200</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    canvas.<span class="hljs-title function_">toBlob</span>(<span class="hljs-function">(<span class="hljs-params">blob</span>) =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-variable language_">this</span>.<span class="hljs-property">blobSize</span> = blob?.<span class="hljs-property">size</span> ?? <span class="hljs-number">0</span>;</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
    </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="ulqjpkhw7tlpcqa6m2884qnz">如果你想支持这种情况，就要在 <code>beforeEach()</code> 定义你要支持的宏任务。比如：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/shared/canvas.component.spec.ts" visiblelines="5,6,7,8,9,10,11,12" header="src/app/shared/canvas.component.spec.ts (excerpt)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="99nvzu2msag7fmecr4zbpvobd">src/app/shared/canvas.component.spec.ts（节选）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, TestBed, tick} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {CanvasComponent} <span class="hljs-keyword">from</span> <span class="hljs-string">'./canvas.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">describe(<span class="hljs-string">'CanvasComponent'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">  beforeEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    (window <span class="hljs-keyword">as</span> any).__zone_symbol__FakeAsyncTestMacroTask = [</div><div class="hljs-ln-line">      {</div><div class="hljs-ln-line">        source: <span class="hljs-string">'HTMLCanvasElement.toBlob'</span>,</div><div class="hljs-ln-line">        callbackArgs: [{size: <span class="hljs-number">200</span>}],</div><div class="hljs-ln-line">      },</div><div class="hljs-ln-line">    ];</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">  beforeEach(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> TestBed.configureTestingModule({</div><div class="hljs-ln-line">      imports: [CanvasComponent],</div><div class="hljs-ln-line">    }).compileComponents();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it(<span class="hljs-string">'should be able to generate blob data from canvas'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    const fixture = TestBed.createComponent(CanvasComponent);</div><div class="hljs-ln-line">    const canvasComp = fixture.componentInstance;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture.detectChanges();</div><div class="hljs-ln-line">    expect(canvasComp.blobSize).toBe(<span class="hljs-number">0</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    tick();</div><div class="hljs-ln-line">    expect(canvasComp.blobSize).toBeGreaterThan(<span class="hljs-number">0</span>);</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
    <div class="docs-alert docs-alert-helpful">
    <p data-ng_translator_product="100" data-ng_translator_ref_id="c5qbbre9nv3urb6m3d3n1tu0n"><strong>帮助：</strong>为了使你的应用中的
<code>&lt;canvas&gt;</code>元素具有 Zone.js 感知能力，你需要在
<code>polyfills.ts</code>或使用
<code>&lt;canvas&gt;</code>的特定文件中导入
<code>zone-patch-canvas</code>补丁：</p>

    </div>
    <div class="docs-code" path="adev/src/content/examples/testing/src/app/shared/canvas.component.ts" visiblelines="0,1,2,3" header="src/polyfills.ts or src/app/shared/canvas.component.ts">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="dbro7jaw64jp2f03pjzkyh5i0">src/polyfills.ts 或 src/app/shared/canvas.component.ts</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-comment">// Import patch to make async `HTMLCanvasElement` methods (such as `.toBlob()`) Zone.js-aware.</span></div><div class="hljs-ln-line"><span class="hljs-comment">// Either import in `polyfills.ts` (if used in more than one places in the app) or in the component</span></div><div class="hljs-ln-line"><span class="hljs-comment">// file using `HTMLCanvasElement` (if it is only used in a single file).</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> <span class="hljs-string">'zone.js/plugins/zone-patch-canvas'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Component</span>, <span class="hljs-title class_">AfterViewInit</span>, <span class="hljs-title class_">ViewChild</span>, <span class="hljs-title class_">ElementRef</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-meta">@Component</span>({</div><div class="hljs-ln-line">  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">selector</span>: <span class="hljs-string">'sample-canvas'</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">template</span>: <span class="hljs-string">'&lt;canvas #sampleCanvas width="200" height="200"&gt;&lt;/canvas&gt;'</span>,</div><div class="hljs-ln-line">})</div><div class="hljs-ln-line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CanvasComponent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AfterViewInit</span> {</div><div class="hljs-ln-line">  blobSize = <span class="hljs-number">0</span>;</div><div class="hljs-ln-line">  <span class="hljs-meta">@ViewChild</span>(<span class="hljs-string">'sampleCanvas'</span>) sampleCanvas!: <span class="hljs-title class_">ElementRef</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">ngAfterViewInit</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> <span class="hljs-attr">canvas</span>: <span class="hljs-title class_">HTMLCanvasElement</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">sampleCanvas</span>.<span class="hljs-property">nativeElement</span>;</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> context = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>)!;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    context.<span class="hljs-title function_">clearRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">200</span>, <span class="hljs-number">200</span>);</div><div class="hljs-ln-line">    context.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'#FF1122'</span>;</div><div class="hljs-ln-line">    context.<span class="hljs-title function_">fillRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">200</span>, <span class="hljs-number">200</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    canvas.<span class="hljs-title function_">toBlob</span>(<span class="hljs-function">(<span class="hljs-params">blob</span>) =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-variable language_">this</span>.<span class="hljs-property">blobSize</span> = blob?.<span class="hljs-property">size</span> ?? <span class="hljs-number">0</span>;</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
  <h3 id="async-observables">
    <a href="#async-observables" class="docs-anchor" tabindex="-1" aria-label="Link to Async observables" data-ng_translator_product="100" data-ng_translator_ref_id="a2syrkvav0rjr6ltkb6y9qp8x">异步可观察者</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="6bp7zynw5cwjcqzvzy13yp4gw">你可能已经对前面这些测试的测试覆盖率感到满意。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="1ajz0d0yxcxxbv6tu0t4p3gc1">但是，你可能也会为另一个事实感到不安：真实的服务并不是这样工作的。真实的服务会向远程服务器发送请求。服务器需要一定的时间才能做出响应，并且其响应体肯定不会像前面两个测试中一样是立即可用的。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="29r8tnt11rzgv6s8ytr54foob">如果能像下面这样从 <code>getQuote()</code> 间谍中返回一个<em>异步的</em>可观察者，你的测试就会更真实地反映现实世界。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/twain/twain.component.spec.ts" visiblelines="79,80">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, <span class="hljs-title class_">ComponentFixture</span>, <span class="hljs-title class_">TestBed</span>, tick, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {asyncData, asyncError} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-keyword">of</span>, throwError} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {last} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'TwainComponent'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">TwainComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">TwainComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">getQuoteSpy</span>: jasmine.<span class="hljs-property">Spy</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">quoteEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">testQuote</span>: <span class="hljs-built_in">string</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">// Helper function to get the error message element value</span></div><div class="hljs-ln-line">  <span class="hljs-comment">// An *ngIf keeps it out of the DOM until there is an error</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> <span class="hljs-title function_">errorMessage</span> = (<span class="hljs-params"></span>) =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> el = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.error'</span>);</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> el ? el.<span class="hljs-property">textContent</span> : <span class="hljs-literal">null</span>;</div><div class="hljs-ln-line">  };</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    testQuote = <span class="hljs-string">'Test Quote'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// Create a fake TwainService object with a `getQuote()` spy</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> twainService = jasmine.<span class="hljs-title function_">createSpyObj</span>(<span class="hljs-string">'TwainService'</span>, [<span class="hljs-string">'getQuote'</span>]);</div><div class="hljs-ln-line">    <span class="hljs-comment">// Make the spy return a synchronous Observable with the test data</span></div><div class="hljs-ln-line">    getQuoteSpy = twainService.<span class="hljs-property">getQuote</span>.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(<span class="hljs-title function_">of</span>(testQuote));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">TwainComponent</span>],</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">TwainService</span>, <span class="hljs-attr">useValue</span>: twainService}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">TwainComponent</span>);</div><div class="hljs-ln-line">    component = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line">    quoteEl = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.twain'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when test with synchronous observable'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should not show quote before OnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'nothing displayed'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error element'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote not yet called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">false</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// The quote would not be immediately available if the service were truly async.</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after component initialized'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// onInit()</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// sync spy result shows testQuote immediately after init</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// The error would not be immediately available if the service were truly async.</span></div><div class="hljs-ln-line">    <span class="hljs-comment">// Use `fakeAsync` because the component error calls `setTimeout`</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display error when TwainService fails'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// tell spy to return an error observable</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(<span class="hljs-title function_">throwError</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'TwainService test failure'</span>)));</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// onInit()</span></div><div class="hljs-ln-line">      <span class="hljs-comment">// sync spy errors immediately after init</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// flush the component's setTimeout()</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update errorMessage within setTimeout()</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>())</div><div class="hljs-ln-line">        .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should display error'</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/test failure/</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when test with asynchronous observable'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// Simulate delayed observable values with the `asyncData()` helper</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(<span class="hljs-title function_">asyncData</span>(testQuote));</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should not show quote before OnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'nothing displayed'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error element'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote not yet called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">false</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should still not show quote after component initialized'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">      <span class="hljs-comment">// getQuote service is async =&gt; still has not returned with quote</span></div><div class="hljs-ln-line">      <span class="hljs-comment">// so should show the start value, '...'</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (fakeAsync)'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// flush the observable to get the quote</span></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show quote'</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (waitForAsync)'</span>, <span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">whenStable</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-comment">// wait for async getQuote</span></div><div class="hljs-ln-line">        fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view with quote</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show last quote (quote done)'</span>, <span class="hljs-function">(<span class="hljs-params">done: DoneFn</span>) =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      component.<span class="hljs-property">quote</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">last</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view with quote</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">        <span class="hljs-title function_">done</span>();</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (spy done)'</span>, <span class="hljs-function">(<span class="hljs-params">done: DoneFn</span>) =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// the spy's most recent call returns the observable with the test quote</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">mostRecent</span>().<span class="hljs-property">returnValue</span>.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view with quote</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">        <span class="hljs-title function_">done</span>();</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display error when TwainService fails'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// tell spy to return an async error observable</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(asyncError&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">'TwainService test failure'</span>));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// component shows error after a setTimeout()</span></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update error message</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>())</div><div class="hljs-ln-line">        .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should display error'</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/test failure/</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
  <h3 id="async-observable-helpers">
    <a href="#async-observable-helpers" class="docs-anchor" tabindex="-1" aria-label="Link to Async observable helpers" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="13lyh42xwxbspib1hohkfirxk">异步可观察者测试助手</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="2zrpte3sxg68xsj39az8bwvc6">异步可观察者可以由测试助手 <code>asyncData</code> 生成。测试助手 <code>asyncData</code> 是一个你必须自行编写的工具函数，当然也可以从下面的范例代码中复制它。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/testing/async-observable-helpers.ts" visiblelines="14,15,16,17,18,19,20" header="testing/async-observable-helpers.ts">
    <div class="docs-code-header"><h3>testing/async-observable-helpers.ts</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-comment">/*</span></div><div class="hljs-ln-line"> * Mock async observables that return asynchronously.</div><div class="hljs-ln-line"> * The observable either emits once and completes or errors.</div><div class="hljs-ln-line"> *</div><div class="hljs-ln-line"> * Must call `tick()` when test with `fakeAsync()`.</div><div class="hljs-ln-line"> *</div><div class="hljs-ln-line"> * THE FOLLOWING DON'T WORK</div><div class="hljs-ln-line"> * Using `of().delay()` triggers TestBed errors;</div><div class="hljs-ln-line"> * see https://github.com/angular/angular/issues/10127 .</div><div class="hljs-ln-line"> *</div><div class="hljs-ln-line"> * Using `asap` scheduler - as in `of(value, asap)` - doesn't work either.</div><div class="hljs-ln-line"> */</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {defer} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/**</span></div><div class="hljs-ln-line"> * Create async observable that emits-once and completes</div><div class="hljs-ln-line"> * after a JS engine turn</div><div class="hljs-ln-line"> */</div><div class="hljs-ln-line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> asyncData&lt;T&gt;(data: T) {</div><div class="hljs-ln-line">  <span class="hljs-keyword">return</span> defer(() =&gt; <span class="hljs-built_in">Promise</span>.resolve(data));</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/**</span></div><div class="hljs-ln-line"> * Create async observable error that errors</div><div class="hljs-ln-line"> * after a JS engine turn</div><div class="hljs-ln-line"> */</div><div class="hljs-ln-line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> asyncError&lt;T&gt;(errorObject: any) {</div><div class="hljs-ln-line">  <span class="hljs-keyword">return</span> defer(() =&gt; <span class="hljs-built_in">Promise</span>.reject(errorObject));</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="c5luofchbkwheg6cfi8r19tbj">这个助手返回的可观察者会在 JavaScript 引擎的下一个周期中发送 <code>data</code> 值。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="5aurax4jlnvg84i1l79in7d8z"><a href="http://reactivex.io/documentation/operators/defer.html" target="_blank">RxJS <code>defer()</code> 操作符</a>返回一个可观察者。它接受一个返回承诺或可观察者的工厂函数。当有订阅者订阅
<em>defer</em>的可观察者时，它会将订阅者添加到使用该工厂函数创建的新可观察者中。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="dys3i14dnby2170wuchbrd8he"><code>defer()</code>操作符将
<code>Promise.resolve()</code>转换为一个新的可观察者，类似于
<code>HttpClient</code>，发出一次并完成。订阅者在接收数据值后会取消订阅。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="3kkjegr84wd0vb2uq6r9qtfg6">还有一个类似的用来生成异步错误的测试助手。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/testing/async-observable-helpers.ts" visiblelines="22,23,24,25,26,27,28">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-comment">/*</span></div><div class="hljs-ln-line"> * Mock async observables that return asynchronously.</div><div class="hljs-ln-line"> * The observable either emits once and completes or errors.</div><div class="hljs-ln-line"> *</div><div class="hljs-ln-line"> * Must call `tick()` when test with `fakeAsync()`.</div><div class="hljs-ln-line"> *</div><div class="hljs-ln-line"> * THE FOLLOWING DON'T WORK</div><div class="hljs-ln-line"> * Using `of().delay()` triggers TestBed errors;</div><div class="hljs-ln-line"> * see https://github.com/angular/angular/issues/10127 .</div><div class="hljs-ln-line"> *</div><div class="hljs-ln-line"> * Using `asap` scheduler - as in `of(value, asap)` - doesn't work either.</div><div class="hljs-ln-line"> */</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {defer} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/**</span></div><div class="hljs-ln-line"> * Create async observable that emits-once and completes</div><div class="hljs-ln-line"> * after a JS engine turn</div><div class="hljs-ln-line"> */</div><div class="hljs-ln-line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> asyncData&lt;T&gt;(data: T) {</div><div class="hljs-ln-line">  <span class="hljs-keyword">return</span> defer(() =&gt; <span class="hljs-built_in">Promise</span>.resolve(data));</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/**</span></div><div class="hljs-ln-line"> * Create async observable error that errors</div><div class="hljs-ln-line"> * after a JS engine turn</div><div class="hljs-ln-line"> */</div><div class="hljs-ln-line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> asyncError&lt;T&gt;(errorObject: any) {</div><div class="hljs-ln-line">  <span class="hljs-keyword">return</span> defer(() =&gt; <span class="hljs-built_in">Promise</span>.reject(errorObject));</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
  <h3 id="more-async-tests">
    <a href="#more-async-tests" class="docs-anchor" tabindex="-1" aria-label="Link to More async tests" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="e3pu8whi5ta5n9eelcvb0sajf">更多异步测试</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="4khdyf4pknb628ht42x55hbii">现在，<code>getQuote()</code> 间谍正在返回异步可观察者，你的大多数测试都必须是异步的。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="7pog2x0l25f58qdok5gdtexv2">这里是一个使用
<code>fakeAsync()</code>测试的示例，展示了你在真实世界中期望的数据流。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/twain/twain.component.spec.ts" visiblelines="98,99,100,101,102,103,104,105,106,107">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, <span class="hljs-title class_">ComponentFixture</span>, <span class="hljs-title class_">TestBed</span>, tick, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {asyncData, asyncError} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-keyword">of</span>, throwError} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {last} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'TwainComponent'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">TwainComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">TwainComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">getQuoteSpy</span>: jasmine.<span class="hljs-property">Spy</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">quoteEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">testQuote</span>: <span class="hljs-built_in">string</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">// Helper function to get the error message element value</span></div><div class="hljs-ln-line">  <span class="hljs-comment">// An *ngIf keeps it out of the DOM until there is an error</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> <span class="hljs-title function_">errorMessage</span> = (<span class="hljs-params"></span>) =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> el = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.error'</span>);</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> el ? el.<span class="hljs-property">textContent</span> : <span class="hljs-literal">null</span>;</div><div class="hljs-ln-line">  };</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    testQuote = <span class="hljs-string">'Test Quote'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// Create a fake TwainService object with a `getQuote()` spy</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> twainService = jasmine.<span class="hljs-title function_">createSpyObj</span>(<span class="hljs-string">'TwainService'</span>, [<span class="hljs-string">'getQuote'</span>]);</div><div class="hljs-ln-line">    <span class="hljs-comment">// Make the spy return a synchronous Observable with the test data</span></div><div class="hljs-ln-line">    getQuoteSpy = twainService.<span class="hljs-property">getQuote</span>.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(<span class="hljs-title function_">of</span>(testQuote));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">TwainComponent</span>],</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">TwainService</span>, <span class="hljs-attr">useValue</span>: twainService}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">TwainComponent</span>);</div><div class="hljs-ln-line">    component = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line">    quoteEl = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.twain'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when test with synchronous observable'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should not show quote before OnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'nothing displayed'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error element'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote not yet called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">false</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// The quote would not be immediately available if the service were truly async.</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after component initialized'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// onInit()</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// sync spy result shows testQuote immediately after init</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// The error would not be immediately available if the service were truly async.</span></div><div class="hljs-ln-line">    <span class="hljs-comment">// Use `fakeAsync` because the component error calls `setTimeout`</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display error when TwainService fails'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// tell spy to return an error observable</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(<span class="hljs-title function_">throwError</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'TwainService test failure'</span>)));</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// onInit()</span></div><div class="hljs-ln-line">      <span class="hljs-comment">// sync spy errors immediately after init</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// flush the component's setTimeout()</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update errorMessage within setTimeout()</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>())</div><div class="hljs-ln-line">        .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should display error'</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/test failure/</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when test with asynchronous observable'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// Simulate delayed observable values with the `asyncData()` helper</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(<span class="hljs-title function_">asyncData</span>(testQuote));</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should not show quote before OnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'nothing displayed'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error element'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote not yet called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">false</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should still not show quote after component initialized'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">      <span class="hljs-comment">// getQuote service is async =&gt; still has not returned with quote</span></div><div class="hljs-ln-line">      <span class="hljs-comment">// so should show the start value, '...'</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (fakeAsync)'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// flush the observable to get the quote</span></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show quote'</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (waitForAsync)'</span>, <span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">whenStable</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-comment">// wait for async getQuote</span></div><div class="hljs-ln-line">        fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view with quote</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show last quote (quote done)'</span>, <span class="hljs-function">(<span class="hljs-params">done: DoneFn</span>) =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      component.<span class="hljs-property">quote</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">last</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view with quote</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">        <span class="hljs-title function_">done</span>();</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (spy done)'</span>, <span class="hljs-function">(<span class="hljs-params">done: DoneFn</span>) =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// the spy's most recent call returns the observable with the test quote</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">mostRecent</span>().<span class="hljs-property">returnValue</span>.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view with quote</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">        <span class="hljs-title function_">done</span>();</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display error when TwainService fails'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// tell spy to return an async error observable</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(asyncError&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">'TwainService test failure'</span>));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// component shows error after a setTimeout()</span></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update error message</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>())</div><div class="hljs-ln-line">        .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should display error'</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/test failure/</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="4fy3pycuvzczlf72cayhiphcg">注意，quote 元素会在 <code>ngOnInit()</code> 之后显示占位符 <code>'...'</code>。因为第一句名言尚未到来。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="dvgdxiu38d2cco0dpiq95d8p4">要清除可观察者中的第一个引用，你需要调用
<a href="api/core/testing/tick">tick()</a>。然后调用
<code>detectChanges()</code>告诉 Angular 更新屏幕。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="1xutq7f545hf4fff66b9zql41">然后，你可以断言 quote 元素是否显示了预期的文本。</p>

  <h3 id="async-test-with-waitforasync">
    <a href="#async-test-with-waitforasync" class="docs-anchor" tabindex="-1" aria-label="Link to Async test with <code>waitForAsync()</code>" data-ng_translator_product="100" data-ng_translator_ref_id="2bvay2zshfnng431kcvv2zzlb">使用 
<code>waitForAsync()</code> 的异步测试</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_ref_id="a2k3q23ihizjqm8r3mfzqtcts">要使用
<code>waitForAsync()</code>功能，你必须在测试设置文件中导入
<code>zone.js/testing</code>。如果你使用 Angular CLI 创建项目，
<code>zone-testing</code>已经在
<code>src/test.ts</code>中导入。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="vbrebtlczgymbdewhf0zygbt">这是之前使用
<code>fakeAsync()</code>测试，用
<code>waitForAsync()</code>实用程序重写的示例。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/twain/twain.component.spec.ts" visiblelines="109,110,111,112,113,114,115,116,117,118,119">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, <span class="hljs-title class_">ComponentFixture</span>, <span class="hljs-title class_">TestBed</span>, tick, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {asyncData, asyncError} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-keyword">of</span>, throwError} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {last} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'TwainComponent'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">TwainComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">TwainComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">getQuoteSpy</span>: jasmine.<span class="hljs-property">Spy</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">quoteEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">testQuote</span>: <span class="hljs-built_in">string</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">// Helper function to get the error message element value</span></div><div class="hljs-ln-line">  <span class="hljs-comment">// An *ngIf keeps it out of the DOM until there is an error</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> <span class="hljs-title function_">errorMessage</span> = (<span class="hljs-params"></span>) =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> el = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.error'</span>);</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> el ? el.<span class="hljs-property">textContent</span> : <span class="hljs-literal">null</span>;</div><div class="hljs-ln-line">  };</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    testQuote = <span class="hljs-string">'Test Quote'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// Create a fake TwainService object with a `getQuote()` spy</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> twainService = jasmine.<span class="hljs-title function_">createSpyObj</span>(<span class="hljs-string">'TwainService'</span>, [<span class="hljs-string">'getQuote'</span>]);</div><div class="hljs-ln-line">    <span class="hljs-comment">// Make the spy return a synchronous Observable with the test data</span></div><div class="hljs-ln-line">    getQuoteSpy = twainService.<span class="hljs-property">getQuote</span>.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(<span class="hljs-title function_">of</span>(testQuote));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">TwainComponent</span>],</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">TwainService</span>, <span class="hljs-attr">useValue</span>: twainService}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">TwainComponent</span>);</div><div class="hljs-ln-line">    component = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line">    quoteEl = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.twain'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when test with synchronous observable'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should not show quote before OnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'nothing displayed'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error element'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote not yet called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">false</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// The quote would not be immediately available if the service were truly async.</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after component initialized'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// onInit()</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// sync spy result shows testQuote immediately after init</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// The error would not be immediately available if the service were truly async.</span></div><div class="hljs-ln-line">    <span class="hljs-comment">// Use `fakeAsync` because the component error calls `setTimeout`</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display error when TwainService fails'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// tell spy to return an error observable</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(<span class="hljs-title function_">throwError</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'TwainService test failure'</span>)));</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// onInit()</span></div><div class="hljs-ln-line">      <span class="hljs-comment">// sync spy errors immediately after init</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// flush the component's setTimeout()</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update errorMessage within setTimeout()</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>())</div><div class="hljs-ln-line">        .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should display error'</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/test failure/</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when test with asynchronous observable'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// Simulate delayed observable values with the `asyncData()` helper</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(<span class="hljs-title function_">asyncData</span>(testQuote));</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should not show quote before OnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'nothing displayed'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error element'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote not yet called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">false</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should still not show quote after component initialized'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">      <span class="hljs-comment">// getQuote service is async =&gt; still has not returned with quote</span></div><div class="hljs-ln-line">      <span class="hljs-comment">// so should show the start value, '...'</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (fakeAsync)'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// flush the observable to get the quote</span></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show quote'</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (waitForAsync)'</span>, <span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">whenStable</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-comment">// wait for async getQuote</span></div><div class="hljs-ln-line">        fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view with quote</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show last quote (quote done)'</span>, <span class="hljs-function">(<span class="hljs-params">done: DoneFn</span>) =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      component.<span class="hljs-property">quote</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">last</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view with quote</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">        <span class="hljs-title function_">done</span>();</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (spy done)'</span>, <span class="hljs-function">(<span class="hljs-params">done: DoneFn</span>) =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// the spy's most recent call returns the observable with the test quote</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">mostRecent</span>().<span class="hljs-property">returnValue</span>.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view with quote</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">        <span class="hljs-title function_">done</span>();</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display error when TwainService fails'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// tell spy to return an async error observable</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(asyncError&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">'TwainService test failure'</span>));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// component shows error after a setTimeout()</span></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update error message</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>())</div><div class="hljs-ln-line">        .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should display error'</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/test failure/</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="25qzgx4lkwl26u7sg9sqs4rnv"><code>waitForAsync()</code> 工具通过安排测试人员的代码在一个特殊的<em>异步测试 Zone</em> 中运行来隐藏一些异步样板代码。 你无需将 Jasmine 的 
<code>done()</code> 传递到测试中并调用 
<code>done()</code>，因为在 Promise 或可观察者回调中它是 
<code>undefined</code>。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="4putogow5fkddnw9fdvdt7uj4">但是，可以通过调用 <code>fixture.whenStable()</code> 函数来揭示本测试的异步性，因为该函数打破了线性的控制流。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="4x8uhir500z1rxrjez3hctbzw">在
<code>waitForAsync()</code>中使用
<code>intervalTimer()</code>（例如
<code>setInterval()</code>）时，记得在测试后使用
<code>clearInterval()</code>取消计时器，否则
<code>waitForAsync()</code>永远不会结束。</p>

  <h3 id="whenstable">
    <a href="#whenstable" class="docs-anchor" tabindex="-1" aria-label="Link to <code>whenStable</code>"><code>whenStable</code></a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_ref_id="5ml23jlhym4az0fx7go6etsru">测试必须等待
<code>getQuote()</code>可观察者发出下一个引用。而不是调用
<a href="api/core/testing/tick">tick()</a>，它调用
<code>fixture.whenStable()</code>。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="9k05fc0yjlmrkv7bxgqufv1q7"><code>fixture.whenStable()</code> 返回一个 Promise，它会在 JavaScript 引擎的任务队列变空时解析。在这个例子中，当可观察者发出第一句名言时，任务队列就会变为空。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="1np0agztt9j7o8casmbh6o7ff">测试会在该 Promise 的回调中继续进行，它会调用 <code>detectChanges()</code> 来用期望的文本更新 quote 元素。</p>

  <h3 id="jasmine-done">
    <a href="#jasmine-done" class="docs-anchor" tabindex="-1" aria-label="Link to Jasmine <code>done()</code>">Jasmine <code>done()</code></a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_ref_id="5p20bbzv6lk90xz7fr320tit"><code>waitForAsync()</code> 和 
<code>fakeAsync()</code> 函数大大简化了 Angular 的异步测试，但你仍然可以退回到传统技术，并传递一个接受 
<a href="https://jasmine.github.io/2.0/introduction.html#section-Asynchronous_Support" target="_blank"><code>done</code> 回调</a>的函数。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="cpddwhqzudmctfpg9dqd847t4">在
<code>waitForAsync()</code>或
<code>fakeAsync()</code>函数中不能调用
<code>done()</code>，因为
<code>done 参数</code>是
<code>undefined</code>。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="blmq3nau4h5odsdrg6t41id2t">现在，你要自己负责串联各种 Promise、处理错误，并在适当的时机调用 <code>done()</code>。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="2hcqdtih60axncevegdg9ubq5">使用
<code>done()</code>编写测试函数比使用
<code>waitForAsync()</code>和
<code>fakeAsync()</code>更繁琐，但在代码涉及
<code>intervalTimer()</code>（如
<code>setInterval</code>）时，有时是必要的。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="auovp3e6hnbdtavitqqgudds9">这里是上一个测试的另外两种版本，用 <code>done()</code> 编写。第一个订阅了通过组件的 <code>quote</code> 属性暴露给模板的 <code>Observable</code>。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/twain/twain.component.spec.ts" visiblelines="121,122,123,124,125,126,127,128,129,130">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, <span class="hljs-title class_">ComponentFixture</span>, <span class="hljs-title class_">TestBed</span>, tick, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {asyncData, asyncError} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-keyword">of</span>, throwError} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {last} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'TwainComponent'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">TwainComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">TwainComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">getQuoteSpy</span>: jasmine.<span class="hljs-property">Spy</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">quoteEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">testQuote</span>: <span class="hljs-built_in">string</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">// Helper function to get the error message element value</span></div><div class="hljs-ln-line">  <span class="hljs-comment">// An *ngIf keeps it out of the DOM until there is an error</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> <span class="hljs-title function_">errorMessage</span> = (<span class="hljs-params"></span>) =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> el = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.error'</span>);</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> el ? el.<span class="hljs-property">textContent</span> : <span class="hljs-literal">null</span>;</div><div class="hljs-ln-line">  };</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    testQuote = <span class="hljs-string">'Test Quote'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// Create a fake TwainService object with a `getQuote()` spy</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> twainService = jasmine.<span class="hljs-title function_">createSpyObj</span>(<span class="hljs-string">'TwainService'</span>, [<span class="hljs-string">'getQuote'</span>]);</div><div class="hljs-ln-line">    <span class="hljs-comment">// Make the spy return a synchronous Observable with the test data</span></div><div class="hljs-ln-line">    getQuoteSpy = twainService.<span class="hljs-property">getQuote</span>.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(<span class="hljs-title function_">of</span>(testQuote));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">TwainComponent</span>],</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">TwainService</span>, <span class="hljs-attr">useValue</span>: twainService}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">TwainComponent</span>);</div><div class="hljs-ln-line">    component = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line">    quoteEl = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.twain'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when test with synchronous observable'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should not show quote before OnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'nothing displayed'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error element'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote not yet called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">false</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// The quote would not be immediately available if the service were truly async.</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after component initialized'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// onInit()</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// sync spy result shows testQuote immediately after init</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// The error would not be immediately available if the service were truly async.</span></div><div class="hljs-ln-line">    <span class="hljs-comment">// Use `fakeAsync` because the component error calls `setTimeout`</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display error when TwainService fails'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// tell spy to return an error observable</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(<span class="hljs-title function_">throwError</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'TwainService test failure'</span>)));</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// onInit()</span></div><div class="hljs-ln-line">      <span class="hljs-comment">// sync spy errors immediately after init</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// flush the component's setTimeout()</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update errorMessage within setTimeout()</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>())</div><div class="hljs-ln-line">        .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should display error'</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/test failure/</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when test with asynchronous observable'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// Simulate delayed observable values with the `asyncData()` helper</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(<span class="hljs-title function_">asyncData</span>(testQuote));</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should not show quote before OnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'nothing displayed'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error element'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote not yet called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">false</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should still not show quote after component initialized'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">      <span class="hljs-comment">// getQuote service is async =&gt; still has not returned with quote</span></div><div class="hljs-ln-line">      <span class="hljs-comment">// so should show the start value, '...'</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (fakeAsync)'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// flush the observable to get the quote</span></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show quote'</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (waitForAsync)'</span>, <span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">whenStable</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-comment">// wait for async getQuote</span></div><div class="hljs-ln-line">        fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view with quote</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show last quote (quote done)'</span>, <span class="hljs-function">(<span class="hljs-params">done: DoneFn</span>) =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      component.<span class="hljs-property">quote</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">last</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view with quote</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">        <span class="hljs-title function_">done</span>();</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (spy done)'</span>, <span class="hljs-function">(<span class="hljs-params">done: DoneFn</span>) =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// the spy's most recent call returns the observable with the test quote</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">mostRecent</span>().<span class="hljs-property">returnValue</span>.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view with quote</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">        <span class="hljs-title function_">done</span>();</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display error when TwainService fails'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// tell spy to return an async error observable</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(asyncError&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">'TwainService test failure'</span>));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// component shows error after a setTimeout()</span></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update error message</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>())</div><div class="hljs-ln-line">        .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should display error'</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/test failure/</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="6i0cqhvq0u5hg79e8obxyievj">RxJS 的 <code>last()</code> 操作符会在完成之前发出可观察者的最后一个值，它同样是测试名言。<code>subscribe</code> 回调会调用 <code>detectChanges()</code> 来使用测试名言刷新的 quote 元素，方法与之前的测试一样。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="ico8eene3fg5twehgzndk0q8">在某些测试中，你可能更关心注入的服务方法是如何被调的以及它返回了什么值，而不是屏幕显示的内容。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="ax2e5koho8inrmsrqpffb0ica">服务间谍，比如伪 <code>TwainService</code> 上的 <code>qetQuote()</code> 间谍，可以给你那些信息，并对视图的状态做出断言。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/twain/twain.component.spec.ts" visiblelines="132,133,134,135,136,137,138,139,140,141,142">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, <span class="hljs-title class_">ComponentFixture</span>, <span class="hljs-title class_">TestBed</span>, tick, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {asyncData, asyncError} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-keyword">of</span>, throwError} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {last} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'TwainComponent'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">TwainComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">TwainComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">getQuoteSpy</span>: jasmine.<span class="hljs-property">Spy</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">quoteEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">testQuote</span>: <span class="hljs-built_in">string</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">// Helper function to get the error message element value</span></div><div class="hljs-ln-line">  <span class="hljs-comment">// An *ngIf keeps it out of the DOM until there is an error</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> <span class="hljs-title function_">errorMessage</span> = (<span class="hljs-params"></span>) =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> el = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.error'</span>);</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> el ? el.<span class="hljs-property">textContent</span> : <span class="hljs-literal">null</span>;</div><div class="hljs-ln-line">  };</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    testQuote = <span class="hljs-string">'Test Quote'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// Create a fake TwainService object with a `getQuote()` spy</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> twainService = jasmine.<span class="hljs-title function_">createSpyObj</span>(<span class="hljs-string">'TwainService'</span>, [<span class="hljs-string">'getQuote'</span>]);</div><div class="hljs-ln-line">    <span class="hljs-comment">// Make the spy return a synchronous Observable with the test data</span></div><div class="hljs-ln-line">    getQuoteSpy = twainService.<span class="hljs-property">getQuote</span>.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(<span class="hljs-title function_">of</span>(testQuote));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">TwainComponent</span>],</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">TwainService</span>, <span class="hljs-attr">useValue</span>: twainService}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">TwainComponent</span>);</div><div class="hljs-ln-line">    component = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line">    quoteEl = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.twain'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when test with synchronous observable'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should not show quote before OnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'nothing displayed'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error element'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote not yet called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">false</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// The quote would not be immediately available if the service were truly async.</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after component initialized'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// onInit()</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// sync spy result shows testQuote immediately after init</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// The error would not be immediately available if the service were truly async.</span></div><div class="hljs-ln-line">    <span class="hljs-comment">// Use `fakeAsync` because the component error calls `setTimeout`</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display error when TwainService fails'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// tell spy to return an error observable</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(<span class="hljs-title function_">throwError</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'TwainService test failure'</span>)));</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// onInit()</span></div><div class="hljs-ln-line">      <span class="hljs-comment">// sync spy errors immediately after init</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// flush the component's setTimeout()</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update errorMessage within setTimeout()</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>())</div><div class="hljs-ln-line">        .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should display error'</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/test failure/</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when test with asynchronous observable'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// Simulate delayed observable values with the `asyncData()` helper</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(<span class="hljs-title function_">asyncData</span>(testQuote));</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should not show quote before OnInit'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'nothing displayed'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error element'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote not yet called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">false</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should still not show quote after component initialized'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">      <span class="hljs-comment">// getQuote service is async =&gt; still has not returned with quote</span></div><div class="hljs-ln-line">      <span class="hljs-comment">// so should show the start value, '...'</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">any</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getQuote called'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (fakeAsync)'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// flush the observable to get the quote</span></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show quote'</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (waitForAsync)'</span>, <span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">whenStable</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        <span class="hljs-comment">// wait for async getQuote</span></div><div class="hljs-ln-line">        fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view with quote</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show last quote (quote done)'</span>, <span class="hljs-function">(<span class="hljs-params">done: DoneFn</span>) =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      component.<span class="hljs-property">quote</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">last</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view with quote</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">        <span class="hljs-title function_">done</span>();</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (spy done)'</span>, <span class="hljs-function">(<span class="hljs-params">done: DoneFn</span>) =&gt;</span> {</div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// the spy's most recent call returns the observable with the test quote</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">calls</span>.<span class="hljs-title function_">mostRecent</span>().<span class="hljs-property">returnValue</span>.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">        fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view with quote</span></div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">        <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">        <span class="hljs-title function_">done</span>();</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display error when TwainService fails'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// tell spy to return an async error observable</span></div><div class="hljs-ln-line">      getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(asyncError&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">'TwainService test failure'</span>));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// component shows error after a setTimeout()</span></div><div class="hljs-ln-line">      fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update error message</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>())</div><div class="hljs-ln-line">        .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should display error'</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/test failure/</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
  <h2 id="component-marble-tests">
    <a href="#component-marble-tests" class="docs-anchor" tabindex="-1" aria-label="Link to Component marble tests" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="2flqz2rbktkr322r731gly6ne">组件的弹珠测试</a>
  </h2>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="egvxaj2v8u2gudffcs7082u33">前面的 <code>TwainComponent</code> 测试通过 <code>asyncData</code> 和 <code>asyncError</code> 工具函数模拟了一个来自 <code>TwainService</code> 的异步响应体可观察者。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="5pcfofecuusi0itmoasnbcwzf">你可以自己编写这些简短易用的函数。不幸的是，对于很多常见的场景来说，它们太简单了。可观察者经常会发送很多次，可能是在经过一段显著的延迟之后。组件可以用重叠的值序列和错误序列来协调多个可观察者。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="c6np6gcrgxwp4fkcklnb8enpl"><strong>RxJS marble 测试</strong> 是测试可观察者场景（无论简单还是复杂）的好方法。你可能见过 
<a href="https://rxmarbles.com" target="_blank">marble 图</a>，它们阐明了可观察者的工作原理。Marble 测试使用类似的 marble 语言来指定测试中的可观察者流和期望。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="35pcad5gldcesffko6f1lxjky">下面的例子用弹珠测试再次实现了 <code>TwainComponent</code> 中的两个测试。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="f02hgkdt38eeoal5awvc0ez2i">首先安装 npm 包 <code>jasmine-marbles</code>。然后导入你需要的符号。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/twain/twain.component.marbles.spec.ts" visiblelines="2" header="app/twain/twain.component.marbles.spec.ts (import marbles)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="1n95iqlvwzha17kp7hwp8dhhd">app/twain/twain.component.marbles.spec.ts（导入 marbles）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, <span class="hljs-title class_">ComponentFixture</span>, <span class="hljs-title class_">TestBed</span>, tick} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {cold, getTestScheduler} <span class="hljs-keyword">from</span> <span class="hljs-string">'jasmine-marbles'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'TwainComponent (marbles)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">TwainComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">TwainComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">getQuoteSpy</span>: jasmine.<span class="hljs-property">Spy</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">quoteEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">testQuote</span>: <span class="hljs-built_in">string</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">// Helper function to get the error message element value</span></div><div class="hljs-ln-line">  <span class="hljs-comment">// An *ngIf keeps it out of the DOM until there is an error</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> <span class="hljs-title function_">errorMessage</span> = (<span class="hljs-params"></span>) =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> el = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.error'</span>);</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> el ? el.<span class="hljs-property">textContent</span> : <span class="hljs-literal">null</span>;</div><div class="hljs-ln-line">  };</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// Create a fake TwainService object with a `getQuote()` spy</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> twainService = jasmine.<span class="hljs-title function_">createSpyObj</span>(<span class="hljs-string">'TwainService'</span>, [<span class="hljs-string">'getQuote'</span>]);</div><div class="hljs-ln-line">    getQuoteSpy = twainService.<span class="hljs-property">getQuote</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">TwainComponent</span>],</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">TwainService</span>, <span class="hljs-attr">useValue</span>: twainService}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">TwainComponent</span>);</div><div class="hljs-ln-line">    component = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line">    quoteEl = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.twain'</span>);</div><div class="hljs-ln-line">    testQuote = <span class="hljs-string">'Test Quote'</span>;</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">// A synchronous test that simulates async behavior</span></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (marbles)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// observable test quote value and complete(), after delay</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> q$ = <span class="hljs-title function_">cold</span>(<span class="hljs-string">'---x|'</span>, {<span class="hljs-attr">x</span>: testQuote});</div><div class="hljs-ln-line">    getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(q$);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">getTestScheduler</span>().<span class="hljs-title function_">flush</span>(); <span class="hljs-comment">// flush the observables</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show quote'</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">// Still need fakeAsync() because of component's setTimeout()</span></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display error when TwainService fails'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// observable error after delay</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> q$ = <span class="hljs-title function_">cold</span>(<span class="hljs-string">'---#|'</span>, <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'TwainService test failure'</span>));</div><div class="hljs-ln-line">    getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(q$);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">getTestScheduler</span>().<span class="hljs-title function_">flush</span>(); <span class="hljs-comment">// flush the observables</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// component shows error after a setTimeout()</span></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update error message</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>())</div><div class="hljs-ln-line">      .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should display error'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/test failure/</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="ahzb4teblmwe85f8qx216j1pt">获取名言的完整测试方法如下：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/twain/twain.component.marbles.spec.ts" visiblelines="38,39,40,41,42,43,44,45,46,47,48,49,50,51,52">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, <span class="hljs-title class_">ComponentFixture</span>, <span class="hljs-title class_">TestBed</span>, tick} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {cold, getTestScheduler} <span class="hljs-keyword">from</span> <span class="hljs-string">'jasmine-marbles'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'TwainComponent (marbles)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">TwainComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">TwainComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">getQuoteSpy</span>: jasmine.<span class="hljs-property">Spy</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">quoteEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">testQuote</span>: <span class="hljs-built_in">string</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">// Helper function to get the error message element value</span></div><div class="hljs-ln-line">  <span class="hljs-comment">// An *ngIf keeps it out of the DOM until there is an error</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> <span class="hljs-title function_">errorMessage</span> = (<span class="hljs-params"></span>) =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> el = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.error'</span>);</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> el ? el.<span class="hljs-property">textContent</span> : <span class="hljs-literal">null</span>;</div><div class="hljs-ln-line">  };</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// Create a fake TwainService object with a `getQuote()` spy</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> twainService = jasmine.<span class="hljs-title function_">createSpyObj</span>(<span class="hljs-string">'TwainService'</span>, [<span class="hljs-string">'getQuote'</span>]);</div><div class="hljs-ln-line">    getQuoteSpy = twainService.<span class="hljs-property">getQuote</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">TwainComponent</span>],</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">TwainService</span>, <span class="hljs-attr">useValue</span>: twainService}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">TwainComponent</span>);</div><div class="hljs-ln-line">    component = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line">    quoteEl = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.twain'</span>);</div><div class="hljs-ln-line">    testQuote = <span class="hljs-string">'Test Quote'</span>;</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">// A synchronous test that simulates async behavior</span></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (marbles)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// observable test quote value and complete(), after delay</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> q$ = <span class="hljs-title function_">cold</span>(<span class="hljs-string">'---x|'</span>, {<span class="hljs-attr">x</span>: testQuote});</div><div class="hljs-ln-line">    getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(q$);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">getTestScheduler</span>().<span class="hljs-title function_">flush</span>(); <span class="hljs-comment">// flush the observables</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show quote'</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">// Still need fakeAsync() because of component's setTimeout()</span></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display error when TwainService fails'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// observable error after delay</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> q$ = <span class="hljs-title function_">cold</span>(<span class="hljs-string">'---#|'</span>, <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'TwainService test failure'</span>));</div><div class="hljs-ln-line">    getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(q$);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">getTestScheduler</span>().<span class="hljs-title function_">flush</span>(); <span class="hljs-comment">// flush the observables</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// component shows error after a setTimeout()</span></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update error message</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>())</div><div class="hljs-ln-line">      .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should display error'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/test failure/</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="3bb8lfwu0x8w4mc0bcugffe2a">注意，Jasmine 测试是同步的。没有 
<code>fakeAsync()</code>。Marble 测试使用测试调度器来模拟同步测试中的时间流逝。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="5ebexon31tj79pa6hijax0h2y">Marble 测试的美妙之处在于可观察者流的视觉定义。此测试定义了一个 
<a href="#cold-observable"><em>冷</em> 可观察者</a>，它等待三个 
<a href="#marble-frame">帧</a>（
<code>---</code>），发出一个值（
<code>x</code>），并完成（
<code>|</code>）。在第二个参数中，你将值标记（
<code>x</code>）映射到发出的值（
<code>testQuote</code>）。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/twain/twain.component.marbles.spec.ts" visiblelines="40">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, <span class="hljs-title class_">ComponentFixture</span>, <span class="hljs-title class_">TestBed</span>, tick} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {cold, getTestScheduler} <span class="hljs-keyword">from</span> <span class="hljs-string">'jasmine-marbles'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'TwainComponent (marbles)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">TwainComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">TwainComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">getQuoteSpy</span>: jasmine.<span class="hljs-property">Spy</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">quoteEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">testQuote</span>: <span class="hljs-built_in">string</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">// Helper function to get the error message element value</span></div><div class="hljs-ln-line">  <span class="hljs-comment">// An *ngIf keeps it out of the DOM until there is an error</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> <span class="hljs-title function_">errorMessage</span> = (<span class="hljs-params"></span>) =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> el = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.error'</span>);</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> el ? el.<span class="hljs-property">textContent</span> : <span class="hljs-literal">null</span>;</div><div class="hljs-ln-line">  };</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// Create a fake TwainService object with a `getQuote()` spy</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> twainService = jasmine.<span class="hljs-title function_">createSpyObj</span>(<span class="hljs-string">'TwainService'</span>, [<span class="hljs-string">'getQuote'</span>]);</div><div class="hljs-ln-line">    getQuoteSpy = twainService.<span class="hljs-property">getQuote</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">TwainComponent</span>],</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">TwainService</span>, <span class="hljs-attr">useValue</span>: twainService}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">TwainComponent</span>);</div><div class="hljs-ln-line">    component = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line">    quoteEl = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.twain'</span>);</div><div class="hljs-ln-line">    testQuote = <span class="hljs-string">'Test Quote'</span>;</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">// A synchronous test that simulates async behavior</span></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (marbles)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// observable test quote value and complete(), after delay</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> q$ = <span class="hljs-title function_">cold</span>(<span class="hljs-string">'---x|'</span>, {<span class="hljs-attr">x</span>: testQuote});</div><div class="hljs-ln-line">    getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(q$);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">getTestScheduler</span>().<span class="hljs-title function_">flush</span>(); <span class="hljs-comment">// flush the observables</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show quote'</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">// Still need fakeAsync() because of component's setTimeout()</span></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display error when TwainService fails'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// observable error after delay</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> q$ = <span class="hljs-title function_">cold</span>(<span class="hljs-string">'---#|'</span>, <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'TwainService test failure'</span>));</div><div class="hljs-ln-line">    getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(q$);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">getTestScheduler</span>().<span class="hljs-title function_">flush</span>(); <span class="hljs-comment">// flush the observables</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// component shows error after a setTimeout()</span></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update error message</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>())</div><div class="hljs-ln-line">      .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should display error'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/test failure/</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="2yo7gngw3es3p52ovd7cye0h0">这个弹珠库会构造出相应的可观察者，测试程序把它用作 <code>getQuote</code> 间谍的返回值。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="9gqye8hvke21h1y4wfji72rbn">当你准备好激活弹珠的可观察者时，就告诉 <code>TestScheduler</code> 把它准备好的任务队列<em>刷新</em>一下。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/twain/twain.component.marbles.spec.ts" visiblelines="46">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, <span class="hljs-title class_">ComponentFixture</span>, <span class="hljs-title class_">TestBed</span>, tick} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {cold, getTestScheduler} <span class="hljs-keyword">from</span> <span class="hljs-string">'jasmine-marbles'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'TwainComponent (marbles)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">TwainComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">TwainComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">getQuoteSpy</span>: jasmine.<span class="hljs-property">Spy</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">quoteEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">testQuote</span>: <span class="hljs-built_in">string</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">// Helper function to get the error message element value</span></div><div class="hljs-ln-line">  <span class="hljs-comment">// An *ngIf keeps it out of the DOM until there is an error</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> <span class="hljs-title function_">errorMessage</span> = (<span class="hljs-params"></span>) =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> el = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.error'</span>);</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> el ? el.<span class="hljs-property">textContent</span> : <span class="hljs-literal">null</span>;</div><div class="hljs-ln-line">  };</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// Create a fake TwainService object with a `getQuote()` spy</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> twainService = jasmine.<span class="hljs-title function_">createSpyObj</span>(<span class="hljs-string">'TwainService'</span>, [<span class="hljs-string">'getQuote'</span>]);</div><div class="hljs-ln-line">    getQuoteSpy = twainService.<span class="hljs-property">getQuote</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">TwainComponent</span>],</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">TwainService</span>, <span class="hljs-attr">useValue</span>: twainService}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">TwainComponent</span>);</div><div class="hljs-ln-line">    component = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line">    quoteEl = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.twain'</span>);</div><div class="hljs-ln-line">    testQuote = <span class="hljs-string">'Test Quote'</span>;</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">// A synchronous test that simulates async behavior</span></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (marbles)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// observable test quote value and complete(), after delay</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> q$ = <span class="hljs-title function_">cold</span>(<span class="hljs-string">'---x|'</span>, {<span class="hljs-attr">x</span>: testQuote});</div><div class="hljs-ln-line">    getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(q$);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">getTestScheduler</span>().<span class="hljs-title function_">flush</span>(); <span class="hljs-comment">// flush the observables</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show quote'</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">// Still need fakeAsync() because of component's setTimeout()</span></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display error when TwainService fails'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// observable error after delay</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> q$ = <span class="hljs-title function_">cold</span>(<span class="hljs-string">'---#|'</span>, <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'TwainService test failure'</span>));</div><div class="hljs-ln-line">    getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(q$);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">getTestScheduler</span>().<span class="hljs-title function_">flush</span>(); <span class="hljs-comment">// flush the observables</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// component shows error after a setTimeout()</span></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update error message</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>())</div><div class="hljs-ln-line">      .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should display error'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/test failure/</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="8kpsx36dro4xxqkykd4gbkjv6">这一步的作用类似于之前 
<code>fakeAsync()</code> 和 
<code>waitForAsync()</code> 示例中的 
<a href="api/core/testing/tick">tick()</a> 和 
<code>whenStable()</code>。测试的其余部分与那些示例相同。</p>

  <h3 id="marble-error-testing">
    <a href="#marble-error-testing" class="docs-anchor" tabindex="-1" aria-label="Link to Marble error testing" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="7n6xe9d8jwwgicoxiy7xqu6fi">弹珠错误测试</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="72isgvfkcedhgs20qqvuuysln">下面是 <code>getQuote()</code> 错误测试的弹珠测试版。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/twain/twain.component.marbles.spec.ts" visiblelines="55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, <span class="hljs-title class_">ComponentFixture</span>, <span class="hljs-title class_">TestBed</span>, tick} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {cold, getTestScheduler} <span class="hljs-keyword">from</span> <span class="hljs-string">'jasmine-marbles'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'TwainComponent (marbles)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">TwainComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">TwainComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">getQuoteSpy</span>: jasmine.<span class="hljs-property">Spy</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">quoteEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">testQuote</span>: <span class="hljs-built_in">string</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">// Helper function to get the error message element value</span></div><div class="hljs-ln-line">  <span class="hljs-comment">// An *ngIf keeps it out of the DOM until there is an error</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> <span class="hljs-title function_">errorMessage</span> = (<span class="hljs-params"></span>) =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> el = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.error'</span>);</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> el ? el.<span class="hljs-property">textContent</span> : <span class="hljs-literal">null</span>;</div><div class="hljs-ln-line">  };</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// Create a fake TwainService object with a `getQuote()` spy</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> twainService = jasmine.<span class="hljs-title function_">createSpyObj</span>(<span class="hljs-string">'TwainService'</span>, [<span class="hljs-string">'getQuote'</span>]);</div><div class="hljs-ln-line">    getQuoteSpy = twainService.<span class="hljs-property">getQuote</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">TwainComponent</span>],</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">TwainService</span>, <span class="hljs-attr">useValue</span>: twainService}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">TwainComponent</span>);</div><div class="hljs-ln-line">    component = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line">    quoteEl = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.twain'</span>);</div><div class="hljs-ln-line">    testQuote = <span class="hljs-string">'Test Quote'</span>;</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">// A synchronous test that simulates async behavior</span></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (marbles)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// observable test quote value and complete(), after delay</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> q$ = <span class="hljs-title function_">cold</span>(<span class="hljs-string">'---x|'</span>, {<span class="hljs-attr">x</span>: testQuote});</div><div class="hljs-ln-line">    getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(q$);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">getTestScheduler</span>().<span class="hljs-title function_">flush</span>(); <span class="hljs-comment">// flush the observables</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show quote'</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">// Still need fakeAsync() because of component's setTimeout()</span></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display error when TwainService fails'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// observable error after delay</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> q$ = <span class="hljs-title function_">cold</span>(<span class="hljs-string">'---#|'</span>, <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'TwainService test failure'</span>));</div><div class="hljs-ln-line">    getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(q$);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">getTestScheduler</span>().<span class="hljs-title function_">flush</span>(); <span class="hljs-comment">// flush the observables</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// component shows error after a setTimeout()</span></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update error message</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>())</div><div class="hljs-ln-line">      .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should display error'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/test failure/</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="7exdhb26pc4ssm84fj3mz5y6s">这仍然是一个异步测试，调用 
<code>fakeAsync()</code> 和 
<a href="api/core/testing/tick">tick()</a>，因为组件本身在处理错误时调用 
<code>setTimeout()</code>。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="m5udc7cf180y73roer1vkcy3">看看这个弹珠的可观察定义。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/twain/twain.component.marbles.spec.ts" visiblelines="57">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, <span class="hljs-title class_">ComponentFixture</span>, <span class="hljs-title class_">TestBed</span>, tick} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {cold, getTestScheduler} <span class="hljs-keyword">from</span> <span class="hljs-string">'jasmine-marbles'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TwainComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./twain.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'TwainComponent (marbles)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">TwainComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">TwainComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">getQuoteSpy</span>: jasmine.<span class="hljs-property">Spy</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">quoteEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">testQuote</span>: <span class="hljs-built_in">string</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">// Helper function to get the error message element value</span></div><div class="hljs-ln-line">  <span class="hljs-comment">// An *ngIf keeps it out of the DOM until there is an error</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> <span class="hljs-title function_">errorMessage</span> = (<span class="hljs-params"></span>) =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> el = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.error'</span>);</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> el ? el.<span class="hljs-property">textContent</span> : <span class="hljs-literal">null</span>;</div><div class="hljs-ln-line">  };</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// Create a fake TwainService object with a `getQuote()` spy</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> twainService = jasmine.<span class="hljs-title function_">createSpyObj</span>(<span class="hljs-string">'TwainService'</span>, [<span class="hljs-string">'getQuote'</span>]);</div><div class="hljs-ln-line">    getQuoteSpy = twainService.<span class="hljs-property">getQuote</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">TwainComponent</span>],</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">TwainService</span>, <span class="hljs-attr">useValue</span>: twainService}],</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">TwainComponent</span>);</div><div class="hljs-ln-line">    component = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line">    quoteEl = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.twain'</span>);</div><div class="hljs-ln-line">    testQuote = <span class="hljs-string">'Test Quote'</span>;</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">// A synchronous test that simulates async behavior</span></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should show quote after getQuote (marbles)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// observable test quote value and complete(), after delay</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> q$ = <span class="hljs-title function_">cold</span>(<span class="hljs-string">'---x|'</span>, {<span class="hljs-attr">x</span>: testQuote});</div><div class="hljs-ln-line">    getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(q$);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">getTestScheduler</span>().<span class="hljs-title function_">flush</span>(); <span class="hljs-comment">// flush the observables</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update view</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show quote'</span>).<span class="hljs-title function_">toBe</span>(testQuote);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should not show error'</span>).<span class="hljs-title function_">toBeNull</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">// Still need fakeAsync() because of component's setTimeout()</span></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display error when TwainService fails'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// observable error after delay</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> q$ = <span class="hljs-title function_">cold</span>(<span class="hljs-string">'---#|'</span>, <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'TwainService test failure'</span>));</div><div class="hljs-ln-line">    getQuoteSpy.<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(q$);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// ngOnInit()</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">getTestScheduler</span>().<span class="hljs-title function_">flush</span>(); <span class="hljs-comment">// flush the observables</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// component shows error after a setTimeout()</span></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// update error message</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">errorMessage</span>())</div><div class="hljs-ln-line">      .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should display error'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/test failure/</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(quoteEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should show placeholder'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'...'</span>);</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="43tib88dxe9sdqiefn1vmahk8">这是一个<em>冷</em>可观察者，等待三帧，然后发出一个错误，井号（<code>#</code>）标出了在第三个参数中指定错误的发生时间。第二个参数为 null，因为该可观察者永远不会发出值。</p>

  <h3 id="learn-about-marble-testing">
    <a href="#learn-about-marble-testing" class="docs-anchor" tabindex="-1" aria-label="Link to Learn about marble testing" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="2a2c7dfw6lfhfjd7o4n5zwdw7">了解弹珠测试</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="1hlvvnvmqzp3f7z0pqefdgodj"><em>弹珠帧</em>是测试时间线上的虚拟单位。每个符号（<code>-</code>，<code>x</code>，<code>|</code>，<code>#</code>）都表示经过了一帧。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="btwwj5dap0fxnszjldfvr1is3"><em>冷</em>可观察者在你订阅它之前不会产生值。你的大多数应用中可观察者都是冷的。所有的 <a href="guide/http"><em>HttpClient</em></a> 方法返回的都是冷可观察者。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="a1ev4vn8d9py8w9rlbytdczbx">而<em>热的</em>可观察者在订阅它<em>之前</em>就已经在生成了这些值。用来报告路由器活动的 <a href="api/router/Router#events"><code>Router.events</code></a> 可观察者就是一种<em>热</em>可观察者。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="ue8btf3mhe1kmo04hk2yyzvn">RxJS marble 测试是一个丰富的主题，超出了本指南的范围。可以从 
<a href="https://rxjs.dev/guide/testing/marble-testing" target="_blank">官方文档</a> 开始在网上学习。</p>

  <h2 id="component-with-inputs-and-outputs">
    <a href="#component-with-inputs-and-outputs" class="docs-anchor" tabindex="-1" aria-label="Link to Component with inputs and outputs" data-ng_translator_product="100" data-ng_translator_ref_id="6akltf74dkxr2nmj7g3zripof">具有输入和输出属性的组件</a>
  </h2>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="aahkeczgvqe66xi2moaexymy2">具有输入和输出属性的组件通常会出现在宿主组件的视图模板中。宿主使用属性绑定来设置输入属性，并使用事件绑定来监听输出属性引发的事件。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="1hx0jgd2ywi97x99pqc5lpysx">本测试的目标是验证这些绑定是否如预期般工作。这些测试应该设置输入值并监听输出事件。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="acfwvlxhw8304giw7perl0adx"><code>DashboardHeroComponent</code> 是这类组件的一个小例子。它会显示由 <code>DashboardComponent</code> 提供的一个英雄。点击这个英雄就会告诉 <code>DashboardComponent</code>，用户已经选择了此英雄。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="a31limhqwwj3hsibg7nkghqb7"><code>DashboardHeroComponent</code> 会像这样内嵌在 <code>DashboardComponent</code> 模板中的：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/dashboard/dashboard.component.html" visiblelines="3,4,5,6,7,8,9,10" header="app/dashboard/dashboard.component.html (excerpt)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="2e8ytuh9oqvbec2hntfxfswhc">app/dashboard/dashboard.component.html（摘录）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">highlight</span>&gt;</span></span><span class="hljs-template-variable">{{ <span class="hljs-name">title</span> }}</span><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"grid grid-pad"</span>&gt;</span></div><div class="hljs-ln-line">  @for (hero of heroes; track hero) {</div><div class="hljs-ln-line">    <span class="hljs-tag">&lt;<span class="hljs-name">dashboard-hero</span></span></div><div class="hljs-ln-line">      <span class="hljs-attr">class</span>=<span class="hljs-string">"col-1-4"</span></div><div class="hljs-ln-line">      [<span class="hljs-attr">hero</span>]=<span class="hljs-string">"hero"</span></div><div class="hljs-ln-line">      (<span class="hljs-attr">selected</span>)=<span class="hljs-string">"gotoDetail($event)"</span></div><div class="hljs-ln-line">    &gt;</div><div class="hljs-ln-line">    <span class="hljs-tag">&lt;/<span class="hljs-name">dashboard-hero</span>&gt;</span></div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="273qa1dzjcainucopgj715w9e"><code>DashboardHeroComponent</code> 出现在 
<code>*ngFor</code> 重复器中，设置每个组件的 
<code>hero</code> 输入属性为循环值，并监听组件的 
<code>selected</code> 事件。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="8iuphrpgspoxeic7iudpmq98e">这里是组件的完整定义：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/dashboard/dashboard-hero.component.ts" visiblelines="5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22" header="app/dashboard/dashboard-hero.component.ts (component)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="3f878b5k4b2d0hv8erf3gy6rm">app/dashboard/dashboard-hero.component.ts（组件）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {Component, EventEmitter, Input, Output} from <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {UpperCasePipe} from <span class="hljs-string">'@angular/common'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {Hero} from <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-meta">@Component({</span></div><div class="hljs-ln-line">  standalone: true,</div><div class="hljs-ln-line">  selector: <span class="hljs-string">'dashboard-hero'</span>,</div><div class="hljs-ln-line">  template: `</div><div class="hljs-ln-line">    &lt;button type=<span class="hljs-string">"button"</span> (click)=<span class="hljs-string">"click()"</span> class=<span class="hljs-string">"hero"</span>&gt;</div><div class="hljs-ln-line">      {{ hero.name | uppercase }}</div><div class="hljs-ln-line">    &lt;/button&gt;</div><div class="hljs-ln-line">  `,</div><div class="hljs-ln-line">  styleUrls: [<span class="hljs-string">'./dashboard-hero.component.css'</span>],</div><div class="hljs-ln-line">  imports: [UpperCasePipe],</div><div class="hljs-ln-line">})</div><div class="hljs-ln-line">export <span class="hljs-keyword">class</span> <span class="hljs-title class_">DashboardHeroComponent</span> {</div><div class="hljs-ln-line">  <span class="hljs-meta">@Input()</span> hero!: Hero;</div><div class="hljs-ln-line">  <span class="hljs-meta">@Output()</span> selected = new EventEmitter&lt;Hero&gt;();</div><div class="hljs-ln-line">  click() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">this</span>.selected.emit(<span class="hljs-keyword">this</span>.hero);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="da1qy45zna391vdzo5g6hz6l3">在测试一个组件时，像这样简单的场景没什么内在价值，但值得了解它。你可以继续尝试这些方法：</p>

  <ul class="docs-list">
    <li data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="2zw4mcquoy3dninubu80dy65u">用 <code>DashboardComponent</code> 来测试它。</li>
<li data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="dwjqc304k7lr4a0gsp8yf7mmt">把它作为一个独立的组件进行测试。</li>
<li data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="9z0danrblvrqr555ocpc92fd4">用 <code>DashboardComponent</code> 的一个替代品来测试它。</li>

  </ul>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="2daf0y5s8yvr6zeeaxlxwa0p1">快速看一眼 <code>DashboardComponent</code> 构造函数就知道不建议采用第一种方法：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/dashboard/dashboard.component.ts" visiblelines="19,20,21,22" header="app/dashboard/dashboard.component.ts (constructor)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="d4u143wp10fujdywikiyn4s2">app/dashboard/dashboard.component.ts（构造函数）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Component</span>, <span class="hljs-title class_">OnInit</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Router</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {sharedImports} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/shared'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">DashboardHeroComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./dashboard-hero.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-meta">@Component</span>({</div><div class="hljs-ln-line">  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">selector</span>: <span class="hljs-string">'app-dashboard'</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">templateUrl</span>: <span class="hljs-string">'./dashboard.component.html'</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">styleUrls</span>: [<span class="hljs-string">'./dashboard.component.css'</span>],</div><div class="hljs-ln-line">  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>, sharedImports],</div><div class="hljs-ln-line">})</div><div class="hljs-ln-line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DashboardComponent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OnInit</span> {</div><div class="hljs-ln-line">  <span class="hljs-attr">heroes</span>: <span class="hljs-title class_">Hero</span>[] = [];</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span></div><div class="hljs-ln-line">    <span class="hljs-keyword">private</span> router: Router,</div><div class="hljs-ln-line">    <span class="hljs-keyword">private</span> heroService: HeroService,</div><div class="hljs-ln-line">  ) {}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">ngOnInit</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">heroService</span>.<span class="hljs-title function_">getHeroes</span>().<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">heroes</span>) =&gt;</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">heroes</span> = heroes.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>)));</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">gotoDetail</span>(<span class="hljs-params">hero: Hero</span>) {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> url = <span class="hljs-string">`/heroes/<span class="hljs-subst">${hero.id}</span>`</span>;</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">router</span>.<span class="hljs-title function_">navigateByUrl</span>(url);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">title</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> cnt = <span class="hljs-variable language_">this</span>.<span class="hljs-property">heroes</span>.<span class="hljs-property">length</span>;</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> cnt === <span class="hljs-number">0</span> ? <span class="hljs-string">'No Heroes'</span> : cnt === <span class="hljs-number">1</span> ? <span class="hljs-string">'Top Hero'</span> : <span class="hljs-string">`Top <span class="hljs-subst">${cnt}</span> Heroes`</span>;</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="51q1biw4uj1cpmtsnva1hu85o"><code>DashboardComponent</code> 依赖于 Angular 的路由器和 <code>HeroService</code>。你可能不得不用测试替身来代替它们，这有很多工作。路由器看上去特别有挑战性。</p>

    <div class="docs-alert docs-alert-helpful">
    <p data-ng_translator_product="100" data-ng_translator_ref_id="2g5ydttb2q2j19y8he5aa6pt5"><strong>有用的提示：</strong> 
<a href="#routing-component">以下讨论</a> 涉及测试需要路由器的组件。</p>

    </div>
    <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="cbz43fd7iiytv6ekhzz5kht9i">当前的目标是测试 <code>DashboardHeroComponent</code>，而不是 <code>DashboardComponent</code>，所以试试第二个和第三个选项。</p>

  <h3 id="test-dashboardherocomponent-stand-alone">
    <a href="#test-dashboardherocomponent-stand-alone" class="docs-anchor" tabindex="-1" aria-label="Link to Test <code>DashboardHeroComponent</code> stand-alone" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="8wq1b88co1sl5tho6ypzo59wg">单独测试 <code>DashboardHeroComponent</code></a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="d9ucpbe0i5au54cvoq2ujv1f0">这里是 spec 文件中环境设置部分的内容。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/dashboard/dashboard-hero.component.spec.ts" visiblelines="32,33,34,35,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54" header="app/dashboard/dashboard-hero.component.spec.ts (setup)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="7bpqpjprpv0945ewwv0ae72ly">app/dashboard/dashboard-hero.component.spec.ts（设置）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">DebugElement</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">ComponentFixture</span>, <span class="hljs-title class_">TestBed</span>, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">By</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/platform-browser'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {first} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {addMatchers, click} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appProviders} <span class="hljs-keyword">from</span> <span class="hljs-string">'../app.config'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">DashboardHeroComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./dashboard-hero.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">beforeEach</span>(addMatchers);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent class only'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'raises the selected event when clicked'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> comp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DashboardHeroComponent</span>();</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> <span class="hljs-attr">hero</span>: <span class="hljs-title class_">Hero</span> = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test'</span>};</div><div class="hljs-ln-line">    comp.<span class="hljs-property">hero</span> = hero;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">selectedHero: Hero</span>) =&gt;</span> <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(hero));</div><div class="hljs-ln-line">    comp.<span class="hljs-title function_">click</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent when tested directly'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">comp</span>: <span class="hljs-title class_">DashboardHeroComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">expectedHero</span>: <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">DashboardHeroComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroDe</span>: <span class="hljs-title class_">DebugElement</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: appProviders,</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>],</div><div class="hljs-ln-line">    })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">DashboardHeroComponent</span>);</div><div class="hljs-ln-line">    comp = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// find the hero's DebugElement and element</span></div><div class="hljs-ln-line">    heroDe = fixture.<span class="hljs-property">debugElement</span>.<span class="hljs-title function_">query</span>(<span class="hljs-title class_">By</span>.<span class="hljs-title function_">css</span>(<span class="hljs-string">'.hero'</span>));</div><div class="hljs-ln-line">    heroEl = heroDe.<span class="hljs-property">nativeElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// mock the hero supplied by the parent component</span></div><div class="hljs-ln-line">    expectedHero = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test Name'</span>};</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// simulate the parent setting the input property with that hero</span></div><div class="hljs-ln-line">    comp.<span class="hljs-property">hero</span> = expectedHero;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// trigger initial data binding</span></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display hero name in uppercase'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedPipedName = expectedHero.<span class="hljs-property">name</span>.<span class="hljs-title function_">toUpperCase</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(heroEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(expectedPipedName);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (triggerEventHandler)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    heroDe.<span class="hljs-title function_">triggerEventHandler</span>(<span class="hljs-string">'click'</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (element.click)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    heroEl.<span class="hljs-title function_">click</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (click helper with DebugElement)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroDe); <span class="hljs-comment">// click helper with DebugElement</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (click helper with native element)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroEl); <span class="hljs-comment">// click helper with native element</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">//////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent when inside a test host'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">testHost</span>: <span class="hljs-title class_">TestHostComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">TestHostComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: appProviders,</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>, <span class="hljs-title class_">TestHostComponent</span>],</div><div class="hljs-ln-line">    })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// create TestHostComponent instead of DashboardHeroComponent</span></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">TestHostComponent</span>);</div><div class="hljs-ln-line">    testHost = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line">    heroEl = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.hero'</span>);</div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// trigger initial data binding</span></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display hero name'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedPipedName = testHost.<span class="hljs-property">hero</span>.<span class="hljs-property">name</span>.<span class="hljs-title function_">toUpperCase</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(heroEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(expectedPipedName);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroEl);</div><div class="hljs-ln-line">    <span class="hljs-comment">// selected hero should be the same data bound hero</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(testHost.<span class="hljs-property">selectedHero</span>).<span class="hljs-title function_">toBe</span>(testHost.<span class="hljs-property">hero</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Test Host Component //////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Component</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-meta">@Component</span>({</div><div class="hljs-ln-line">  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>],</div><div class="hljs-ln-line">  <span class="hljs-attr">template</span>: <span class="hljs-string">` &lt;dashboard-hero [hero]="hero" (selected)="onSelected($event)"&gt; &lt;/dashboard-hero&gt;`</span>,</div><div class="hljs-ln-line">})</div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TestHostComponent</span> {</div><div class="hljs-ln-line">  <span class="hljs-attr">hero</span>: <span class="hljs-title class_">Hero</span> = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test Name'</span>};</div><div class="hljs-ln-line">  <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">  <span class="hljs-title function_">onSelected</span>(<span class="hljs-params">hero: Hero</span>) {</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedHero</span> = hero;</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="1tlnik787nvutnvi5rihaj2x1">注意这些设置代码如何把一个测试英雄（<code>expectedHero</code>）赋值给组件的 <code>hero</code> 属性的，它模仿了 <code>DashboardComponent</code> 在其复写器中通过属性绑定来设置它的方式。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="bhbxawydf079bm3cuvpsix68p">下面的测试验证了英雄名是通过绑定传播到模板的。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/dashboard/dashboard-hero.component.spec.ts" visiblelines="57,58,59,60">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">DebugElement</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">ComponentFixture</span>, <span class="hljs-title class_">TestBed</span>, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">By</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/platform-browser'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {first} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {addMatchers, click} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appProviders} <span class="hljs-keyword">from</span> <span class="hljs-string">'../app.config'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">DashboardHeroComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./dashboard-hero.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">beforeEach</span>(addMatchers);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent class only'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'raises the selected event when clicked'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> comp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DashboardHeroComponent</span>();</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> <span class="hljs-attr">hero</span>: <span class="hljs-title class_">Hero</span> = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test'</span>};</div><div class="hljs-ln-line">    comp.<span class="hljs-property">hero</span> = hero;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">selectedHero: Hero</span>) =&gt;</span> <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(hero));</div><div class="hljs-ln-line">    comp.<span class="hljs-title function_">click</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent when tested directly'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">comp</span>: <span class="hljs-title class_">DashboardHeroComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">expectedHero</span>: <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">DashboardHeroComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroDe</span>: <span class="hljs-title class_">DebugElement</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: appProviders,</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>],</div><div class="hljs-ln-line">    })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">DashboardHeroComponent</span>);</div><div class="hljs-ln-line">    comp = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// find the hero's DebugElement and element</span></div><div class="hljs-ln-line">    heroDe = fixture.<span class="hljs-property">debugElement</span>.<span class="hljs-title function_">query</span>(<span class="hljs-title class_">By</span>.<span class="hljs-title function_">css</span>(<span class="hljs-string">'.hero'</span>));</div><div class="hljs-ln-line">    heroEl = heroDe.<span class="hljs-property">nativeElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// mock the hero supplied by the parent component</span></div><div class="hljs-ln-line">    expectedHero = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test Name'</span>};</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// simulate the parent setting the input property with that hero</span></div><div class="hljs-ln-line">    comp.<span class="hljs-property">hero</span> = expectedHero;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// trigger initial data binding</span></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display hero name in uppercase'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedPipedName = expectedHero.<span class="hljs-property">name</span>.<span class="hljs-title function_">toUpperCase</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(heroEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(expectedPipedName);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (triggerEventHandler)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    heroDe.<span class="hljs-title function_">triggerEventHandler</span>(<span class="hljs-string">'click'</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (element.click)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    heroEl.<span class="hljs-title function_">click</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (click helper with DebugElement)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroDe); <span class="hljs-comment">// click helper with DebugElement</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (click helper with native element)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroEl); <span class="hljs-comment">// click helper with native element</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">//////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent when inside a test host'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">testHost</span>: <span class="hljs-title class_">TestHostComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">TestHostComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: appProviders,</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>, <span class="hljs-title class_">TestHostComponent</span>],</div><div class="hljs-ln-line">    })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// create TestHostComponent instead of DashboardHeroComponent</span></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">TestHostComponent</span>);</div><div class="hljs-ln-line">    testHost = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line">    heroEl = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.hero'</span>);</div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// trigger initial data binding</span></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display hero name'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedPipedName = testHost.<span class="hljs-property">hero</span>.<span class="hljs-property">name</span>.<span class="hljs-title function_">toUpperCase</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(heroEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(expectedPipedName);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroEl);</div><div class="hljs-ln-line">    <span class="hljs-comment">// selected hero should be the same data bound hero</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(testHost.<span class="hljs-property">selectedHero</span>).<span class="hljs-title function_">toBe</span>(testHost.<span class="hljs-property">hero</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Test Host Component //////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Component</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-meta">@Component</span>({</div><div class="hljs-ln-line">  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>],</div><div class="hljs-ln-line">  <span class="hljs-attr">template</span>: <span class="hljs-string">` &lt;dashboard-hero [hero]="hero" (selected)="onSelected($event)"&gt; &lt;/dashboard-hero&gt;`</span>,</div><div class="hljs-ln-line">})</div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TestHostComponent</span> {</div><div class="hljs-ln-line">  <span class="hljs-attr">hero</span>: <span class="hljs-title class_">Hero</span> = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test Name'</span>};</div><div class="hljs-ln-line">  <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">  <span class="hljs-title function_">onSelected</span>(<span class="hljs-params">hero: Hero</span>) {</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedHero</span> = hero;</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="7l6816hn8jyvjedwi91zsp1jp">因为
<a href="#dashboard-hero-component">模板</a>通过 Angular 的 
<code>UpperCasePipe</code> 传递英雄名字，测试必须匹配该元素值与大写的名字。</p>

    <div class="docs-alert docs-alert-helpful">
    <p data-ng_translator_product="100" data-ng_translator_ref_id="e4ntsgsjmkp35xklhth0bng3l"><strong>提示：</strong>这个小测试展示了 Angular 测试如何验证组件的视觉表现——这是
<a href="guide/testing/components-basics#component-class-testing">组件类测试</a>无法做到的——且成本低，不用诉诸于更慢、更复杂的端到端测试。</p>

    </div>
    
  <h3 id="clicking">
    <a href="#clicking" class="docs-anchor" tabindex="-1" aria-label="Link to Clicking" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="3xzyzhgy3ao0qjsswmxwjfnz0">点击</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="8niqxzg9qg6k46cg8lrx7xu9k">单击该英雄应该会让一个宿主组件（可能是 <code>DashboardComponent</code>）监听到 <code>selected</code> 事件。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/dashboard/dashboard-hero.component.spec.ts" visiblelines="62,63,64,65,66,67,68">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">DebugElement</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">ComponentFixture</span>, <span class="hljs-title class_">TestBed</span>, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">By</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/platform-browser'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {first} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {addMatchers, click} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appProviders} <span class="hljs-keyword">from</span> <span class="hljs-string">'../app.config'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">DashboardHeroComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./dashboard-hero.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">beforeEach</span>(addMatchers);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent class only'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'raises the selected event when clicked'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> comp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DashboardHeroComponent</span>();</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> <span class="hljs-attr">hero</span>: <span class="hljs-title class_">Hero</span> = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test'</span>};</div><div class="hljs-ln-line">    comp.<span class="hljs-property">hero</span> = hero;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">selectedHero: Hero</span>) =&gt;</span> <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(hero));</div><div class="hljs-ln-line">    comp.<span class="hljs-title function_">click</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent when tested directly'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">comp</span>: <span class="hljs-title class_">DashboardHeroComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">expectedHero</span>: <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">DashboardHeroComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroDe</span>: <span class="hljs-title class_">DebugElement</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: appProviders,</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>],</div><div class="hljs-ln-line">    })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">DashboardHeroComponent</span>);</div><div class="hljs-ln-line">    comp = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// find the hero's DebugElement and element</span></div><div class="hljs-ln-line">    heroDe = fixture.<span class="hljs-property">debugElement</span>.<span class="hljs-title function_">query</span>(<span class="hljs-title class_">By</span>.<span class="hljs-title function_">css</span>(<span class="hljs-string">'.hero'</span>));</div><div class="hljs-ln-line">    heroEl = heroDe.<span class="hljs-property">nativeElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// mock the hero supplied by the parent component</span></div><div class="hljs-ln-line">    expectedHero = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test Name'</span>};</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// simulate the parent setting the input property with that hero</span></div><div class="hljs-ln-line">    comp.<span class="hljs-property">hero</span> = expectedHero;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// trigger initial data binding</span></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display hero name in uppercase'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedPipedName = expectedHero.<span class="hljs-property">name</span>.<span class="hljs-title function_">toUpperCase</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(heroEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(expectedPipedName);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (triggerEventHandler)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    heroDe.<span class="hljs-title function_">triggerEventHandler</span>(<span class="hljs-string">'click'</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (element.click)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    heroEl.<span class="hljs-title function_">click</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (click helper with DebugElement)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroDe); <span class="hljs-comment">// click helper with DebugElement</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (click helper with native element)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroEl); <span class="hljs-comment">// click helper with native element</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">//////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent when inside a test host'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">testHost</span>: <span class="hljs-title class_">TestHostComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">TestHostComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: appProviders,</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>, <span class="hljs-title class_">TestHostComponent</span>],</div><div class="hljs-ln-line">    })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// create TestHostComponent instead of DashboardHeroComponent</span></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">TestHostComponent</span>);</div><div class="hljs-ln-line">    testHost = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line">    heroEl = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.hero'</span>);</div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// trigger initial data binding</span></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display hero name'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedPipedName = testHost.<span class="hljs-property">hero</span>.<span class="hljs-property">name</span>.<span class="hljs-title function_">toUpperCase</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(heroEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(expectedPipedName);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroEl);</div><div class="hljs-ln-line">    <span class="hljs-comment">// selected hero should be the same data bound hero</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(testHost.<span class="hljs-property">selectedHero</span>).<span class="hljs-title function_">toBe</span>(testHost.<span class="hljs-property">hero</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Test Host Component //////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Component</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-meta">@Component</span>({</div><div class="hljs-ln-line">  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>],</div><div class="hljs-ln-line">  <span class="hljs-attr">template</span>: <span class="hljs-string">` &lt;dashboard-hero [hero]="hero" (selected)="onSelected($event)"&gt; &lt;/dashboard-hero&gt;`</span>,</div><div class="hljs-ln-line">})</div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TestHostComponent</span> {</div><div class="hljs-ln-line">  <span class="hljs-attr">hero</span>: <span class="hljs-title class_">Hero</span> = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test Name'</span>};</div><div class="hljs-ln-line">  <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">  <span class="hljs-title function_">onSelected</span>(<span class="hljs-params">hero: Hero</span>) {</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedHero</span> = hero;</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="7e2rtpfahjmtutaceghc6p4gg">组件的 
<code>selected</code> 属性返回一个 
<code>EventEmitter</code>，对于消费者来说看起来像一个 RxJS 同步 
<code>Observable</code>。 测试代码<em>显式地</em>订阅它，而<em>宿主组件</em>隐式地订阅它。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="4qz5na1mf0jj7gmtzeolaca6r">当组件的行为符合预期时，单击此英雄的元素就会告诉组件的 <code>selected</code> 属性发出了一个 <code>hero</code> 对象。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="a6mrm2xwtjftqy75bkk26dfmt">该测试通过对 <code>selected</code> 的订阅来检测该事件。</p>

  <h3 id="triggereventhandler">
    <a href="#triggereventhandler" class="docs-anchor" tabindex="-1" aria-label="Link to <code>triggerEventHandler</code>"><code>triggerEventHandler</code></a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_ref_id="5k6upvnhxlzh08fbbv9rabldq">前一个测试中的 
<code>heroDe</code> 是一个 
<code>DebugElement</code>，表示英雄的 
<code>&lt;div&gt;</code>。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="dhr74g9pzokzkyddaunuflmpg">它具有抽象与本地元素交互的 Angular 属性和方法。 此测试调用 
<code>DebugElement.triggerEventHandler</code> 并传递 "click" 事件名称。 "click" 事件绑定通过调用 
<code>DashboardHeroComponent.click()</code> 进行响应。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="dlppoouihcpcbszrlyioskd6d">Angular 的 
<code>DebugElement.triggerEventHandler</code> 可以通过<em>事件名称</em>触发<em>任何数据绑定事件</em>。 第二个参数是传递给处理器的事件对象。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="cmfn670w9psrj9cixjnxwuidd">该测试触发了一个 “click” 事件。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/dashboard/dashboard-hero.component.spec.ts" visiblelines="66">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">DebugElement</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">ComponentFixture</span>, <span class="hljs-title class_">TestBed</span>, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">By</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/platform-browser'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {first} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {addMatchers, click} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appProviders} <span class="hljs-keyword">from</span> <span class="hljs-string">'../app.config'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">DashboardHeroComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./dashboard-hero.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">beforeEach</span>(addMatchers);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent class only'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'raises the selected event when clicked'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> comp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DashboardHeroComponent</span>();</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> <span class="hljs-attr">hero</span>: <span class="hljs-title class_">Hero</span> = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test'</span>};</div><div class="hljs-ln-line">    comp.<span class="hljs-property">hero</span> = hero;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">selectedHero: Hero</span>) =&gt;</span> <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(hero));</div><div class="hljs-ln-line">    comp.<span class="hljs-title function_">click</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent when tested directly'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">comp</span>: <span class="hljs-title class_">DashboardHeroComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">expectedHero</span>: <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">DashboardHeroComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroDe</span>: <span class="hljs-title class_">DebugElement</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: appProviders,</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>],</div><div class="hljs-ln-line">    })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">DashboardHeroComponent</span>);</div><div class="hljs-ln-line">    comp = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// find the hero's DebugElement and element</span></div><div class="hljs-ln-line">    heroDe = fixture.<span class="hljs-property">debugElement</span>.<span class="hljs-title function_">query</span>(<span class="hljs-title class_">By</span>.<span class="hljs-title function_">css</span>(<span class="hljs-string">'.hero'</span>));</div><div class="hljs-ln-line">    heroEl = heroDe.<span class="hljs-property">nativeElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// mock the hero supplied by the parent component</span></div><div class="hljs-ln-line">    expectedHero = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test Name'</span>};</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// simulate the parent setting the input property with that hero</span></div><div class="hljs-ln-line">    comp.<span class="hljs-property">hero</span> = expectedHero;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// trigger initial data binding</span></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display hero name in uppercase'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedPipedName = expectedHero.<span class="hljs-property">name</span>.<span class="hljs-title function_">toUpperCase</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(heroEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(expectedPipedName);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (triggerEventHandler)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    heroDe.<span class="hljs-title function_">triggerEventHandler</span>(<span class="hljs-string">'click'</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (element.click)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    heroEl.<span class="hljs-title function_">click</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (click helper with DebugElement)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroDe); <span class="hljs-comment">// click helper with DebugElement</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (click helper with native element)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroEl); <span class="hljs-comment">// click helper with native element</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">//////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent when inside a test host'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">testHost</span>: <span class="hljs-title class_">TestHostComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">TestHostComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: appProviders,</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>, <span class="hljs-title class_">TestHostComponent</span>],</div><div class="hljs-ln-line">    })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// create TestHostComponent instead of DashboardHeroComponent</span></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">TestHostComponent</span>);</div><div class="hljs-ln-line">    testHost = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line">    heroEl = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.hero'</span>);</div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// trigger initial data binding</span></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display hero name'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedPipedName = testHost.<span class="hljs-property">hero</span>.<span class="hljs-property">name</span>.<span class="hljs-title function_">toUpperCase</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(heroEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(expectedPipedName);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroEl);</div><div class="hljs-ln-line">    <span class="hljs-comment">// selected hero should be the same data bound hero</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(testHost.<span class="hljs-property">selectedHero</span>).<span class="hljs-title function_">toBe</span>(testHost.<span class="hljs-property">hero</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Test Host Component //////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Component</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-meta">@Component</span>({</div><div class="hljs-ln-line">  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>],</div><div class="hljs-ln-line">  <span class="hljs-attr">template</span>: <span class="hljs-string">` &lt;dashboard-hero [hero]="hero" (selected)="onSelected($event)"&gt; &lt;/dashboard-hero&gt;`</span>,</div><div class="hljs-ln-line">})</div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TestHostComponent</span> {</div><div class="hljs-ln-line">  <span class="hljs-attr">hero</span>: <span class="hljs-title class_">Hero</span> = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test Name'</span>};</div><div class="hljs-ln-line">  <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">  <span class="hljs-title function_">onSelected</span>(<span class="hljs-params">hero: Hero</span>) {</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedHero</span> = hero;</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="68s6klqmouuxwkk5x2bgsm38i">在这里，测试程序假设运行时间的事件处理器（组件的 <code>click()</code> 方法）不关心事件对象。</p>

    <div class="docs-alert docs-alert-helpful">
    <p data-ng_translator_product="100" data-ng_translator_ref_id="cdygvq3hare2zixd2eo4nux4a"><strong>提示：</strong>其他处理程序不那么宽容。例如，
<code>RouterLink</code> 指令期望一个包含 
<code>button</code> 属性的对象，该属性标识在点击期间是否按下了鼠标按钮。如果事件对象缺失，
<code>RouterLink</code> 指令会抛出错误。</p>

    </div>
    
  <h3 id="click-the-element">
    <a href="#click-the-element" class="docs-anchor" tabindex="-1" aria-label="Link to Click the element" data-ng_translator_product="100" data-ng_translator_ref_id="7y6e4w4w8rkf5d29p98b3gn0r">点击该元素</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="dz63du0423sp1zvau7uob0adu">下面这个测试改为调用原生元素自己的 <code>click()</code> 方法，它对于<em>这个组件</em>来说相当完美。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/dashboard/dashboard-hero.component.spec.ts" visiblelines="70,71,72,73,74,75,76">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">DebugElement</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">ComponentFixture</span>, <span class="hljs-title class_">TestBed</span>, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">By</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/platform-browser'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {first} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {addMatchers, click} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appProviders} <span class="hljs-keyword">from</span> <span class="hljs-string">'../app.config'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">DashboardHeroComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./dashboard-hero.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">beforeEach</span>(addMatchers);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent class only'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'raises the selected event when clicked'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> comp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DashboardHeroComponent</span>();</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> <span class="hljs-attr">hero</span>: <span class="hljs-title class_">Hero</span> = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test'</span>};</div><div class="hljs-ln-line">    comp.<span class="hljs-property">hero</span> = hero;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">selectedHero: Hero</span>) =&gt;</span> <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(hero));</div><div class="hljs-ln-line">    comp.<span class="hljs-title function_">click</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent when tested directly'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">comp</span>: <span class="hljs-title class_">DashboardHeroComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">expectedHero</span>: <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">DashboardHeroComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroDe</span>: <span class="hljs-title class_">DebugElement</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: appProviders,</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>],</div><div class="hljs-ln-line">    })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">DashboardHeroComponent</span>);</div><div class="hljs-ln-line">    comp = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// find the hero's DebugElement and element</span></div><div class="hljs-ln-line">    heroDe = fixture.<span class="hljs-property">debugElement</span>.<span class="hljs-title function_">query</span>(<span class="hljs-title class_">By</span>.<span class="hljs-title function_">css</span>(<span class="hljs-string">'.hero'</span>));</div><div class="hljs-ln-line">    heroEl = heroDe.<span class="hljs-property">nativeElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// mock the hero supplied by the parent component</span></div><div class="hljs-ln-line">    expectedHero = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test Name'</span>};</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// simulate the parent setting the input property with that hero</span></div><div class="hljs-ln-line">    comp.<span class="hljs-property">hero</span> = expectedHero;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// trigger initial data binding</span></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display hero name in uppercase'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedPipedName = expectedHero.<span class="hljs-property">name</span>.<span class="hljs-title function_">toUpperCase</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(heroEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(expectedPipedName);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (triggerEventHandler)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    heroDe.<span class="hljs-title function_">triggerEventHandler</span>(<span class="hljs-string">'click'</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (element.click)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    heroEl.<span class="hljs-title function_">click</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (click helper with DebugElement)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroDe); <span class="hljs-comment">// click helper with DebugElement</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (click helper with native element)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroEl); <span class="hljs-comment">// click helper with native element</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">//////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent when inside a test host'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">testHost</span>: <span class="hljs-title class_">TestHostComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">TestHostComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: appProviders,</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>, <span class="hljs-title class_">TestHostComponent</span>],</div><div class="hljs-ln-line">    })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// create TestHostComponent instead of DashboardHeroComponent</span></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">TestHostComponent</span>);</div><div class="hljs-ln-line">    testHost = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line">    heroEl = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.hero'</span>);</div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// trigger initial data binding</span></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display hero name'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedPipedName = testHost.<span class="hljs-property">hero</span>.<span class="hljs-property">name</span>.<span class="hljs-title function_">toUpperCase</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(heroEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(expectedPipedName);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroEl);</div><div class="hljs-ln-line">    <span class="hljs-comment">// selected hero should be the same data bound hero</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(testHost.<span class="hljs-property">selectedHero</span>).<span class="hljs-title function_">toBe</span>(testHost.<span class="hljs-property">hero</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Test Host Component //////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Component</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-meta">@Component</span>({</div><div class="hljs-ln-line">  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>],</div><div class="hljs-ln-line">  <span class="hljs-attr">template</span>: <span class="hljs-string">` &lt;dashboard-hero [hero]="hero" (selected)="onSelected($event)"&gt; &lt;/dashboard-hero&gt;`</span>,</div><div class="hljs-ln-line">})</div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TestHostComponent</span> {</div><div class="hljs-ln-line">  <span class="hljs-attr">hero</span>: <span class="hljs-title class_">Hero</span> = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test Name'</span>};</div><div class="hljs-ln-line">  <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">  <span class="hljs-title function_">onSelected</span>(<span class="hljs-params">hero: Hero</span>) {</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedHero</span> = hero;</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
  <h3 id="click-helper">
    <a href="#click-helper" class="docs-anchor" tabindex="-1" aria-label="Link to <code>click()</code> helper" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="aif2jhvpda4oimvqlgcdhr5z4"><code>click()</code> 帮助器</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="4aqbfipdljftyc329w5k5y05b">点击按钮、链接或者任意 HTML 元素是很常见的测试任务。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="68iq7o40h99t7dlmta93jqyhe">把<em>点击事件</em>的处理过程包装到如下的 <code>click()</code> 辅助函数中，可以让这项任务更一致、更简单：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/testing/index.ts" visiblelines="15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31" header="testing/index.ts (click helper)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="cqrsvhhsgr5k07ih035yq2u1y">testing/index.ts（点击辅助函数）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {DebugElement} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {ComponentFixture, tick} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'./async-observable-helpers'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'./jasmine-matchers'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-regexp">////</span>/ Short utilities <span class="hljs-regexp">////</span>/</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/** Wait a tick, then detect changes */</span></div><div class="hljs-ln-line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> advance(f: ComponentFixture&lt;any&gt;): <span class="hljs-literal">void</span> {</div><div class="hljs-ln-line">  tick();</div><div class="hljs-ln-line">  f.detectChanges();</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-regexp">// See https://</span>developer.mozilla.org/en-US/docs/Web/API/MouseEvent/button</div><div class="hljs-ln-line"><span class="hljs-comment">/** Button events to pass to `DebugElement.triggerEventHandler` for RouterLink event handler */</span></div><div class="hljs-ln-line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> ButtonClickEvents = {</div><div class="hljs-ln-line">  left: {button: <span class="hljs-number">0</span>},</div><div class="hljs-ln-line">  right: {button: <span class="hljs-number">2</span>},</div><div class="hljs-ln-line">};</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/** Simulate element click. Defaults to mouse left-button click event. */</span></div><div class="hljs-ln-line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> click(</div><div class="hljs-ln-line">  el: DebugElement | HTMLElement,</div><div class="hljs-ln-line">  eventObj: any = ButtonClickEvents.left,</div><div class="hljs-ln-line">): <span class="hljs-literal">void</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">if</span> (el <span class="hljs-keyword">instanceof</span> HTMLElement) {</div><div class="hljs-ln-line">    el.click();</div><div class="hljs-ln-line">  } <span class="hljs-keyword">else</span> {</div><div class="hljs-ln-line">    el.triggerEventHandler(<span class="hljs-string">'click'</span>, eventObj);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="tn6rs2ujpbfyeq3sby9d0xz4">第一个参数是
<em>要点击的元素</em>。如果你愿意，可以传递一个自定义事件对象作为第二个参数。默认是一个部分的
<a href="https://developer.mozilla.org/docs/Web/API/MouseEvent/button" target="_blank">左键鼠标事件对象</a>，被包括 
<code>RouterLink</code> 指令在内的许多处理程序接受。</p>

    <div class="docs-alert docs-alert-important">
    <p data-ng_translator_product="100" data-ng_translator_ref_id="2tnmvtanad2v7dkl547tpf49r"><strong>重要：</strong> 
<code>click()</code> 辅助函数
<strong>不是</strong> Angular 测试工具之一。它是
<em>本指南示例代码</em>中定义的函数。所有示例测试都使用它。如果你喜欢它，可以将其添加到自己的辅助函数集合中。</p>

    </div>
    <p data-ng_translator_product="100" data-ng_translator_ref_id="dj3pfjwvn51x7so63un6fl749">这是前面的测试，使用点击辅助函数重写。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/dashboard/dashboard-hero.component.spec.ts" visiblelines="78,79,80,81,82,83,84,85" header="app/dashboard/dashboard-hero.component.spec.ts (test with click helper)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="9ur5urirgp3gtoys0koh8cvu">app/dashboard/dashboard-hero.component.spec.ts（带点击辅助函数的测试）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">DebugElement</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">ComponentFixture</span>, <span class="hljs-title class_">TestBed</span>, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">By</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/platform-browser'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {first} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {addMatchers, click} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appProviders} <span class="hljs-keyword">from</span> <span class="hljs-string">'../app.config'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">DashboardHeroComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./dashboard-hero.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">beforeEach</span>(addMatchers);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent class only'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'raises the selected event when clicked'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> comp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DashboardHeroComponent</span>();</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> <span class="hljs-attr">hero</span>: <span class="hljs-title class_">Hero</span> = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test'</span>};</div><div class="hljs-ln-line">    comp.<span class="hljs-property">hero</span> = hero;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">selectedHero: Hero</span>) =&gt;</span> <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(hero));</div><div class="hljs-ln-line">    comp.<span class="hljs-title function_">click</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent when tested directly'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">comp</span>: <span class="hljs-title class_">DashboardHeroComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">expectedHero</span>: <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">DashboardHeroComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroDe</span>: <span class="hljs-title class_">DebugElement</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: appProviders,</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>],</div><div class="hljs-ln-line">    })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">DashboardHeroComponent</span>);</div><div class="hljs-ln-line">    comp = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// find the hero's DebugElement and element</span></div><div class="hljs-ln-line">    heroDe = fixture.<span class="hljs-property">debugElement</span>.<span class="hljs-title function_">query</span>(<span class="hljs-title class_">By</span>.<span class="hljs-title function_">css</span>(<span class="hljs-string">'.hero'</span>));</div><div class="hljs-ln-line">    heroEl = heroDe.<span class="hljs-property">nativeElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// mock the hero supplied by the parent component</span></div><div class="hljs-ln-line">    expectedHero = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test Name'</span>};</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// simulate the parent setting the input property with that hero</span></div><div class="hljs-ln-line">    comp.<span class="hljs-property">hero</span> = expectedHero;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// trigger initial data binding</span></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display hero name in uppercase'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedPipedName = expectedHero.<span class="hljs-property">name</span>.<span class="hljs-title function_">toUpperCase</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(heroEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(expectedPipedName);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (triggerEventHandler)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    heroDe.<span class="hljs-title function_">triggerEventHandler</span>(<span class="hljs-string">'click'</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (element.click)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    heroEl.<span class="hljs-title function_">click</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (click helper with DebugElement)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroDe); <span class="hljs-comment">// click helper with DebugElement</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (click helper with native element)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroEl); <span class="hljs-comment">// click helper with native element</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">//////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent when inside a test host'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">testHost</span>: <span class="hljs-title class_">TestHostComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">TestHostComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: appProviders,</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>, <span class="hljs-title class_">TestHostComponent</span>],</div><div class="hljs-ln-line">    })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// create TestHostComponent instead of DashboardHeroComponent</span></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">TestHostComponent</span>);</div><div class="hljs-ln-line">    testHost = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line">    heroEl = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.hero'</span>);</div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// trigger initial data binding</span></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display hero name'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedPipedName = testHost.<span class="hljs-property">hero</span>.<span class="hljs-property">name</span>.<span class="hljs-title function_">toUpperCase</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(heroEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(expectedPipedName);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroEl);</div><div class="hljs-ln-line">    <span class="hljs-comment">// selected hero should be the same data bound hero</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(testHost.<span class="hljs-property">selectedHero</span>).<span class="hljs-title function_">toBe</span>(testHost.<span class="hljs-property">hero</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Test Host Component //////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Component</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-meta">@Component</span>({</div><div class="hljs-ln-line">  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>],</div><div class="hljs-ln-line">  <span class="hljs-attr">template</span>: <span class="hljs-string">` &lt;dashboard-hero [hero]="hero" (selected)="onSelected($event)"&gt; &lt;/dashboard-hero&gt;`</span>,</div><div class="hljs-ln-line">})</div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TestHostComponent</span> {</div><div class="hljs-ln-line">  <span class="hljs-attr">hero</span>: <span class="hljs-title class_">Hero</span> = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test Name'</span>};</div><div class="hljs-ln-line">  <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">  <span class="hljs-title function_">onSelected</span>(<span class="hljs-params">hero: Hero</span>) {</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedHero</span> = hero;</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
  <h2 id="component-inside-a-test-host">
    <a href="#component-inside-a-test-host" class="docs-anchor" tabindex="-1" aria-label="Link to Component inside a test host" data-ng_translator_product="100" data-ng_translator_ref_id="d5o8ljbojifmr4s6e99zljc9e">位于测试宿主中的组件</a>
  </h2>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="cv7i0kkpmseyl6t7x3qnhpz22">前面的这些测试都是自己扮演宿主元素 <code>DashboardComponent</code> 的角色。但是当 <code>DashboardHeroComponent</code> 真的绑定到某个宿主元素时还能正常工作吗？</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="8cqnfttphlvjzf92ur6ua4vno">你可以使用实际的 
<code>DashboardComponent</code> 进行测试。但这样做可能需要大量设置，尤其是当其模板包含 
<code>*ngFor</code> 重复器、其他组件、布局 HTML、额外绑定、构造函数注入多个服务，并立即开始与这些服务交互时。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="cfxhty0gg3eri0rnfywmhmjxm">想出这么多需要努力排除的干扰，只是为了证明一点 —— 可以造出这样一个令人满意的<em>测试宿主</em>：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/dashboard/dashboard-hero.component.spec.ts" visiblelines="135,136,137,138,139,140,141,142,143,144,145,146" header="app/dashboard/dashboard-hero.component.spec.ts (test host)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="1ue2v94xgsjpvhmlcv6otldt6">app/dashboard/dashboard-hero.component.spec.ts（测试宿主）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">DebugElement</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">ComponentFixture</span>, <span class="hljs-title class_">TestBed</span>, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">By</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/platform-browser'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {first} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {addMatchers, click} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appProviders} <span class="hljs-keyword">from</span> <span class="hljs-string">'../app.config'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">DashboardHeroComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./dashboard-hero.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">beforeEach</span>(addMatchers);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent class only'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'raises the selected event when clicked'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> comp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DashboardHeroComponent</span>();</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> <span class="hljs-attr">hero</span>: <span class="hljs-title class_">Hero</span> = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test'</span>};</div><div class="hljs-ln-line">    comp.<span class="hljs-property">hero</span> = hero;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">selectedHero: Hero</span>) =&gt;</span> <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(hero));</div><div class="hljs-ln-line">    comp.<span class="hljs-title function_">click</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent when tested directly'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">comp</span>: <span class="hljs-title class_">DashboardHeroComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">expectedHero</span>: <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">DashboardHeroComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroDe</span>: <span class="hljs-title class_">DebugElement</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: appProviders,</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>],</div><div class="hljs-ln-line">    })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">DashboardHeroComponent</span>);</div><div class="hljs-ln-line">    comp = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// find the hero's DebugElement and element</span></div><div class="hljs-ln-line">    heroDe = fixture.<span class="hljs-property">debugElement</span>.<span class="hljs-title function_">query</span>(<span class="hljs-title class_">By</span>.<span class="hljs-title function_">css</span>(<span class="hljs-string">'.hero'</span>));</div><div class="hljs-ln-line">    heroEl = heroDe.<span class="hljs-property">nativeElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// mock the hero supplied by the parent component</span></div><div class="hljs-ln-line">    expectedHero = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test Name'</span>};</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// simulate the parent setting the input property with that hero</span></div><div class="hljs-ln-line">    comp.<span class="hljs-property">hero</span> = expectedHero;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// trigger initial data binding</span></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display hero name in uppercase'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedPipedName = expectedHero.<span class="hljs-property">name</span>.<span class="hljs-title function_">toUpperCase</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(heroEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(expectedPipedName);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (triggerEventHandler)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    heroDe.<span class="hljs-title function_">triggerEventHandler</span>(<span class="hljs-string">'click'</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (element.click)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    heroEl.<span class="hljs-title function_">click</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (click helper with DebugElement)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroDe); <span class="hljs-comment">// click helper with DebugElement</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (click helper with native element)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroEl); <span class="hljs-comment">// click helper with native element</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">//////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent when inside a test host'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">testHost</span>: <span class="hljs-title class_">TestHostComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">TestHostComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: appProviders,</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>, <span class="hljs-title class_">TestHostComponent</span>],</div><div class="hljs-ln-line">    })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// create TestHostComponent instead of DashboardHeroComponent</span></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">TestHostComponent</span>);</div><div class="hljs-ln-line">    testHost = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line">    heroEl = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.hero'</span>);</div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// trigger initial data binding</span></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display hero name'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedPipedName = testHost.<span class="hljs-property">hero</span>.<span class="hljs-property">name</span>.<span class="hljs-title function_">toUpperCase</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(heroEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(expectedPipedName);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroEl);</div><div class="hljs-ln-line">    <span class="hljs-comment">// selected hero should be the same data bound hero</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(testHost.<span class="hljs-property">selectedHero</span>).<span class="hljs-title function_">toBe</span>(testHost.<span class="hljs-property">hero</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Test Host Component //////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Component</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-meta">@Component</span>({</div><div class="hljs-ln-line">  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>],</div><div class="hljs-ln-line">  <span class="hljs-attr">template</span>: <span class="hljs-string">` &lt;dashboard-hero [hero]="hero" (selected)="onSelected($event)"&gt; &lt;/dashboard-hero&gt;`</span>,</div><div class="hljs-ln-line">})</div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TestHostComponent</span> {</div><div class="hljs-ln-line">  <span class="hljs-attr">hero</span>: <span class="hljs-title class_">Hero</span> = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test Name'</span>};</div><div class="hljs-ln-line">  <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">  <span class="hljs-title function_">onSelected</span>(<span class="hljs-params">hero: Hero</span>) {</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedHero</span> = hero;</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="6h6ntrxz07s91mfrf5h51ag80">这个测试宿主绑定到 
<code>DashboardHeroComponent</code>，就像 
<code>DashboardComponent</code> 会那样，但没有 
<code>Router</code>、
<code>HeroService</code> 或 
<code>*ngFor</code> 重复器的干扰。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="5supqa8fgis1d4p97t5nrbyeo">这个测试宿主使用其测试用的英雄设置了组件的输入属性 <code>hero</code>。它使用 <code>onSelected</code> 事件处理器绑定了组件的 <code>selected</code> 事件，其中把事件中发出的英雄记录到了 <code>selectedHero</code> 属性中。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="erja8a5shvuxp3c8tpkeacdpi">稍后，这个测试就可以轻松检查 <code>selectedHero</code> 以验证 <code>DashboardHeroComponent.selected</code> 事件确实发出了所期望的英雄。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="351dk5uiyfvr7jbv9hhhfzjhv"><code>test-host</code> 测试的设置与独立测试的设置类似：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/dashboard/dashboard-hero.component.spec.ts" visiblelines="105,106,107,108,113,114,115,116,117" header="app/dashboard/dashboard-hero.component.spec.ts (test host setup)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="ccz676btdf7q9gpj9xwzf5m2o">app/dashboard/dashboard-hero.component.spec.ts（测试宿主设置）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">DebugElement</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">ComponentFixture</span>, <span class="hljs-title class_">TestBed</span>, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">By</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/platform-browser'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {first} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {addMatchers, click} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appProviders} <span class="hljs-keyword">from</span> <span class="hljs-string">'../app.config'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">DashboardHeroComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./dashboard-hero.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">beforeEach</span>(addMatchers);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent class only'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'raises the selected event when clicked'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> comp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DashboardHeroComponent</span>();</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> <span class="hljs-attr">hero</span>: <span class="hljs-title class_">Hero</span> = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test'</span>};</div><div class="hljs-ln-line">    comp.<span class="hljs-property">hero</span> = hero;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">selectedHero: Hero</span>) =&gt;</span> <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(hero));</div><div class="hljs-ln-line">    comp.<span class="hljs-title function_">click</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent when tested directly'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">comp</span>: <span class="hljs-title class_">DashboardHeroComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">expectedHero</span>: <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">DashboardHeroComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroDe</span>: <span class="hljs-title class_">DebugElement</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: appProviders,</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>],</div><div class="hljs-ln-line">    })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">DashboardHeroComponent</span>);</div><div class="hljs-ln-line">    comp = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// find the hero's DebugElement and element</span></div><div class="hljs-ln-line">    heroDe = fixture.<span class="hljs-property">debugElement</span>.<span class="hljs-title function_">query</span>(<span class="hljs-title class_">By</span>.<span class="hljs-title function_">css</span>(<span class="hljs-string">'.hero'</span>));</div><div class="hljs-ln-line">    heroEl = heroDe.<span class="hljs-property">nativeElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// mock the hero supplied by the parent component</span></div><div class="hljs-ln-line">    expectedHero = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test Name'</span>};</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// simulate the parent setting the input property with that hero</span></div><div class="hljs-ln-line">    comp.<span class="hljs-property">hero</span> = expectedHero;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// trigger initial data binding</span></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display hero name in uppercase'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedPipedName = expectedHero.<span class="hljs-property">name</span>.<span class="hljs-title function_">toUpperCase</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(heroEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(expectedPipedName);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (triggerEventHandler)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    heroDe.<span class="hljs-title function_">triggerEventHandler</span>(<span class="hljs-string">'click'</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (element.click)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    heroEl.<span class="hljs-title function_">click</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (click helper with DebugElement)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroDe); <span class="hljs-comment">// click helper with DebugElement</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (click helper with native element)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroEl); <span class="hljs-comment">// click helper with native element</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">//////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent when inside a test host'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">testHost</span>: <span class="hljs-title class_">TestHostComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">TestHostComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: appProviders,</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>, <span class="hljs-title class_">TestHostComponent</span>],</div><div class="hljs-ln-line">    })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// create TestHostComponent instead of DashboardHeroComponent</span></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">TestHostComponent</span>);</div><div class="hljs-ln-line">    testHost = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line">    heroEl = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.hero'</span>);</div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// trigger initial data binding</span></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display hero name'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedPipedName = testHost.<span class="hljs-property">hero</span>.<span class="hljs-property">name</span>.<span class="hljs-title function_">toUpperCase</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(heroEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(expectedPipedName);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroEl);</div><div class="hljs-ln-line">    <span class="hljs-comment">// selected hero should be the same data bound hero</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(testHost.<span class="hljs-property">selectedHero</span>).<span class="hljs-title function_">toBe</span>(testHost.<span class="hljs-property">hero</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Test Host Component //////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Component</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-meta">@Component</span>({</div><div class="hljs-ln-line">  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>],</div><div class="hljs-ln-line">  <span class="hljs-attr">template</span>: <span class="hljs-string">` &lt;dashboard-hero [hero]="hero" (selected)="onSelected($event)"&gt; &lt;/dashboard-hero&gt;`</span>,</div><div class="hljs-ln-line">})</div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TestHostComponent</span> {</div><div class="hljs-ln-line">  <span class="hljs-attr">hero</span>: <span class="hljs-title class_">Hero</span> = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test Name'</span>};</div><div class="hljs-ln-line">  <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">  <span class="hljs-title function_">onSelected</span>(<span class="hljs-params">hero: Hero</span>) {</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedHero</span> = hero;</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="2jfbtwpmyvq9rt3ckck3jt0mr">这个测试模块的配置信息有三个重要的不同点：</p>

  <ul class="docs-list">
    <li data-ng_translator_product="100" data-ng_translator_ref_id="5rae7zv6g9qtme1wonzo7cjzl">它<em>声明</em>了 
<code>DashboardHeroComponent</code> 和 
<code>TestHostComponent</code></li>
<li data-ng_translator_product="100" data-ng_translator_ref_id="63riq2qpe5fg1azmmrs48crps">它<em>创建</em>了 
<code>TestHostComponent</code> 而不是 
<code>DashboardHeroComponent</code></li>
<li data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="ecimwegy6rhzj0bh9z3j70inz"><code>TestHostComponent</code> 通过绑定机制设置了 <code>DashboardHeroComponent.hero</code>。</li>

  </ul>
  <p data-ng_translator_product="100" data-ng_translator_ref_id="e0nhj58wmzffeiwx5fl9e9yek"><code>createComponent</code> 返回一个持有 
<code>TestHostComponent</code> 实例的 
<code>fixture</code>，而不是 
<code>DashboardHeroComponent</code> 的实例。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="3qw0dewurmhn36gf1oqy4g567">当然，创建 <code>TestHostComponent</code> 有创建 <code>DashboardHeroComponent</code> 的副作用，因为后者出现在前者的模板中。英雄元素（<code>heroEl</code>）的查询语句仍然可以在测试 DOM 中找到它，尽管元素树比以前更深。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="7zxbrdygjmsirjboyh9sh9103">这些测试本身和它们的孤立版本几乎相同：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/dashboard/dashboard-hero.component.spec.ts" visiblelines="120,121,122,123,124,125,126,127,128,129" header="app/dashboard/dashboard-hero.component.spec.ts (test-host)">
    <div class="docs-code-header"><h3>app/dashboard/dashboard-hero.component.spec.ts (test-host)</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">DebugElement</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">ComponentFixture</span>, <span class="hljs-title class_">TestBed</span>, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">By</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/platform-browser'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {first} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {addMatchers, click} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appProviders} <span class="hljs-keyword">from</span> <span class="hljs-string">'../app.config'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">DashboardHeroComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./dashboard-hero.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">beforeEach</span>(addMatchers);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent class only'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'raises the selected event when clicked'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> comp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DashboardHeroComponent</span>();</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> <span class="hljs-attr">hero</span>: <span class="hljs-title class_">Hero</span> = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test'</span>};</div><div class="hljs-ln-line">    comp.<span class="hljs-property">hero</span> = hero;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">selectedHero: Hero</span>) =&gt;</span> <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(hero));</div><div class="hljs-ln-line">    comp.<span class="hljs-title function_">click</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent when tested directly'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">comp</span>: <span class="hljs-title class_">DashboardHeroComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">expectedHero</span>: <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">DashboardHeroComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroDe</span>: <span class="hljs-title class_">DebugElement</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: appProviders,</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>],</div><div class="hljs-ln-line">    })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">DashboardHeroComponent</span>);</div><div class="hljs-ln-line">    comp = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// find the hero's DebugElement and element</span></div><div class="hljs-ln-line">    heroDe = fixture.<span class="hljs-property">debugElement</span>.<span class="hljs-title function_">query</span>(<span class="hljs-title class_">By</span>.<span class="hljs-title function_">css</span>(<span class="hljs-string">'.hero'</span>));</div><div class="hljs-ln-line">    heroEl = heroDe.<span class="hljs-property">nativeElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// mock the hero supplied by the parent component</span></div><div class="hljs-ln-line">    expectedHero = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test Name'</span>};</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// simulate the parent setting the input property with that hero</span></div><div class="hljs-ln-line">    comp.<span class="hljs-property">hero</span> = expectedHero;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// trigger initial data binding</span></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display hero name in uppercase'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedPipedName = expectedHero.<span class="hljs-property">name</span>.<span class="hljs-title function_">toUpperCase</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(heroEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(expectedPipedName);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (triggerEventHandler)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    heroDe.<span class="hljs-title function_">triggerEventHandler</span>(<span class="hljs-string">'click'</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (element.click)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    heroEl.<span class="hljs-title function_">click</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (click helper with DebugElement)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroDe); <span class="hljs-comment">// click helper with DebugElement</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (click helper with native element)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroEl); <span class="hljs-comment">// click helper with native element</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">//////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent when inside a test host'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">testHost</span>: <span class="hljs-title class_">TestHostComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">TestHostComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: appProviders,</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>, <span class="hljs-title class_">TestHostComponent</span>],</div><div class="hljs-ln-line">    })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// create TestHostComponent instead of DashboardHeroComponent</span></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">TestHostComponent</span>);</div><div class="hljs-ln-line">    testHost = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line">    heroEl = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.hero'</span>);</div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// trigger initial data binding</span></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display hero name'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedPipedName = testHost.<span class="hljs-property">hero</span>.<span class="hljs-property">name</span>.<span class="hljs-title function_">toUpperCase</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(heroEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(expectedPipedName);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroEl);</div><div class="hljs-ln-line">    <span class="hljs-comment">// selected hero should be the same data bound hero</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(testHost.<span class="hljs-property">selectedHero</span>).<span class="hljs-title function_">toBe</span>(testHost.<span class="hljs-property">hero</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Test Host Component //////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Component</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-meta">@Component</span>({</div><div class="hljs-ln-line">  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>],</div><div class="hljs-ln-line">  <span class="hljs-attr">template</span>: <span class="hljs-string">` &lt;dashboard-hero [hero]="hero" (selected)="onSelected($event)"&gt; &lt;/dashboard-hero&gt;`</span>,</div><div class="hljs-ln-line">})</div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TestHostComponent</span> {</div><div class="hljs-ln-line">  <span class="hljs-attr">hero</span>: <span class="hljs-title class_">Hero</span> = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test Name'</span>};</div><div class="hljs-ln-line">  <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">  <span class="hljs-title function_">onSelected</span>(<span class="hljs-params">hero: Hero</span>) {</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedHero</span> = hero;</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="2cxz6e9kheiq6yshgc27mty8b">只有 selected 事件的测试不一样。它确保被选择的 <code>DashboardHeroComponent</code> 英雄确实通过事件绑定被传递到宿主组件。</p>

  <h2 id="routing-component">
    <a href="#routing-component" class="docs-anchor" tabindex="-1" aria-label="Link to Routing component" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="9u7mq4pbjyv40jwu8gjh18zum">路由组件</a>
  </h2>
  <p data-ng_translator_product="100" data-ng_translator_ref_id="b0jdtng4qm7c0qwg3gch8dbr5"><em>路由组件</em>是告诉 
<code>Router</code> 导航到另一个组件的组件。 
<code>DashboardComponent</code> 是一个
<em>路由组件</em>，因为用户可以通过点击仪表板上的一个
<em>英雄按钮</em>来导航到 
<code>HeroDetailComponent</code>。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="741lp0em5ovt97zry4k8xjlht">路由相当复杂。 测试 
<code>DashboardComponent</code> 看起来很艰难，部分原因是它涉及到 
<code>Router</code>，它和 
<code>HeroService</code> 一起被注入。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/dashboard/dashboard.component.ts" visiblelines="19,20,21,22" header="app/dashboard/dashboard.component.ts (constructor)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="d4u143wp10fujdywikiyn4s2">app/dashboard/dashboard.component.ts（构造函数）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Component</span>, <span class="hljs-title class_">OnInit</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Router</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {sharedImports} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/shared'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">DashboardHeroComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./dashboard-hero.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-meta">@Component</span>({</div><div class="hljs-ln-line">  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">selector</span>: <span class="hljs-string">'app-dashboard'</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">templateUrl</span>: <span class="hljs-string">'./dashboard.component.html'</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">styleUrls</span>: [<span class="hljs-string">'./dashboard.component.css'</span>],</div><div class="hljs-ln-line">  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>, sharedImports],</div><div class="hljs-ln-line">})</div><div class="hljs-ln-line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DashboardComponent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OnInit</span> {</div><div class="hljs-ln-line">  <span class="hljs-attr">heroes</span>: <span class="hljs-title class_">Hero</span>[] = [];</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span></div><div class="hljs-ln-line">    <span class="hljs-keyword">private</span> router: Router,</div><div class="hljs-ln-line">    <span class="hljs-keyword">private</span> heroService: HeroService,</div><div class="hljs-ln-line">  ) {}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">ngOnInit</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">heroService</span>.<span class="hljs-title function_">getHeroes</span>().<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">heroes</span>) =&gt;</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">heroes</span> = heroes.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>)));</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">gotoDetail</span>(<span class="hljs-params">hero: Hero</span>) {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> url = <span class="hljs-string">`/heroes/<span class="hljs-subst">${hero.id}</span>`</span>;</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">router</span>.<span class="hljs-title function_">navigateByUrl</span>(url);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">title</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> cnt = <span class="hljs-variable language_">this</span>.<span class="hljs-property">heroes</span>.<span class="hljs-property">length</span>;</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> cnt === <span class="hljs-number">0</span> ? <span class="hljs-string">'No Heroes'</span> : cnt === <span class="hljs-number">1</span> ? <span class="hljs-string">'Top Hero'</span> : <span class="hljs-string">`Top <span class="hljs-subst">${cnt}</span> Heroes`</span>;</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><div class="docs-code" path="adev/src/content/examples/testing/src/app/dashboard/dashboard.component.ts" visiblelines="28,29,30,31" header="app/dashboard/dashboard.component.ts (goToDetail)">
    <div class="docs-code-header"><h3>app/dashboard/dashboard.component.ts (goToDetail)</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Component</span>, <span class="hljs-title class_">OnInit</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Router</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {sharedImports} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/shared'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">DashboardHeroComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./dashboard-hero.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-meta">@Component</span>({</div><div class="hljs-ln-line">  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">selector</span>: <span class="hljs-string">'app-dashboard'</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">templateUrl</span>: <span class="hljs-string">'./dashboard.component.html'</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">styleUrls</span>: [<span class="hljs-string">'./dashboard.component.css'</span>],</div><div class="hljs-ln-line">  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>, sharedImports],</div><div class="hljs-ln-line">})</div><div class="hljs-ln-line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DashboardComponent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OnInit</span> {</div><div class="hljs-ln-line">  <span class="hljs-attr">heroes</span>: <span class="hljs-title class_">Hero</span>[] = [];</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span></div><div class="hljs-ln-line">    <span class="hljs-keyword">private</span> router: Router,</div><div class="hljs-ln-line">    <span class="hljs-keyword">private</span> heroService: HeroService,</div><div class="hljs-ln-line">  ) {}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">ngOnInit</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">heroService</span>.<span class="hljs-title function_">getHeroes</span>().<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">heroes</span>) =&gt;</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">heroes</span> = heroes.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>)));</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">gotoDetail</span>(<span class="hljs-params">hero: Hero</span>) {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> url = <span class="hljs-string">`/heroes/<span class="hljs-subst">${hero.id}</span>`</span>;</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">router</span>.<span class="hljs-title function_">navigateByUrl</span>(url);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">title</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> cnt = <span class="hljs-variable language_">this</span>.<span class="hljs-property">heroes</span>.<span class="hljs-property">length</span>;</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> cnt === <span class="hljs-number">0</span> ? <span class="hljs-string">'No Heroes'</span> : cnt === <span class="hljs-number">1</span> ? <span class="hljs-string">'Top Hero'</span> : <span class="hljs-string">`Top <span class="hljs-subst">${cnt}</span> Heroes`</span>;</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="apjl2mfdfkproi9zoeztrptqp">Angular 提供了一些测试助手来减少样板代码并更有效地测试依赖于 Router 和 HttpClient 的代码。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/dashboard/dashboard.component.spec.ts" visiblelines="68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84" header="app/dashboard/dashboard.component.spec.ts">
    <div class="docs-code-header"><h3>app/dashboard/dashboard.component.spec.ts</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {provideHttpClient} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpTestingController</span>, provideHttpClientTesting} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-variable constant_">NO_ERRORS_SCHEMA</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TestBed</span>, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">By</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/platform-browser'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">NavigationEnd</span>, provideRouter, <span class="hljs-title class_">Router</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">RouterTestingHarness</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {firstValueFrom} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {filter} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {addMatchers, click} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {getTestHeroes} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/testing/test-heroes'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">DashboardComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./dashboard.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appConfig} <span class="hljs-keyword">from</span> <span class="hljs-string">'../app.config'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../hero/hero-detail.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">beforeEach</span>(addMatchers);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">comp</span>: <span class="hljs-title class_">DashboardComponent</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">harness</span>: <span class="hljs-title class_">RouterTestingHarness</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////////  Deep  ////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardComponent (deep)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">compileAndCreate</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">tests</span>(clickForDeep);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">function</span> <span class="hljs-title function_">clickForDeep</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">    <span class="hljs-comment">// get first &lt;div class="hero"&gt;</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> <span class="hljs-attr">heroEl</span>: <span class="hljs-title class_">HTMLElement</span> = harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.hero'</span>)!;</div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroEl);</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-title function_">firstValueFrom</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">events</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> e <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">NavigationEnd</span>)),</div><div class="hljs-ln-line">    );</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////////  Shallow ////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardComponent (shallow)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardComponent</span>, <span class="hljs-title class_">HeroDetailComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [<span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}])],</div><div class="hljs-ln-line">        <span class="hljs-attr">schemas</span>: [<span class="hljs-variable constant_">NO_ERRORS_SCHEMA</span>],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    );</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">compileAndCreate</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">tests</span>(clickForShallow);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">function</span> <span class="hljs-title function_">clickForShallow</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">    <span class="hljs-comment">// get first &lt;dashboard-hero&gt; DebugElement</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> heroDe = harness.<span class="hljs-property">routeDebugElement</span>!.<span class="hljs-title function_">query</span>(<span class="hljs-title class_">By</span>.<span class="hljs-title function_">css</span>(<span class="hljs-string">'dashboard-hero'</span>));</div><div class="hljs-ln-line">    heroDe.<span class="hljs-title function_">triggerEventHandler</span>(<span class="hljs-string">'selected'</span>, comp.<span class="hljs-property">heroes</span>[<span class="hljs-number">0</span>]);</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>();</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/** Add TestBed providers, compile, and create DashboardComponent */</span></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">compileAndCreate</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'**'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">DashboardComponent</span>}]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title class_">HeroService</span>,</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    )</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>()</div><div class="hljs-ln-line">      .<span class="hljs-title function_">then</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">        harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">        comp = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">'/'</span>, <span class="hljs-title class_">DashboardComponent</span>);</div><div class="hljs-ln-line">        <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>(<span class="hljs-string">'api/heroes'</span>).<span class="hljs-title function_">flush</span>(<span class="hljs-title function_">getTestHeroes</span>());</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/**</span></div><div class="hljs-ln-line"> * The (almost) same tests for both.</div><div class="hljs-ln-line"> * Only change: the way that the first hero is clicked</div><div class="hljs-ln-line"> */</div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">tests</span>(<span class="hljs-params">heroClick: () =&gt; <span class="hljs-built_in">Promise</span>&lt;unknown&gt;</span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'after get dashboard heroes'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">router</span>: <span class="hljs-title class_">Router</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// Trigger component so it gets heroes and binds to them</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      router = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>);</div><div class="hljs-ln-line">      harness.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// runs ngOnInit -&gt; getHeroes</span></div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should HAVE heroes'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(comp.<span class="hljs-property">heroes</span>.<span class="hljs-property">length</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should have heroes after service promise resolves'</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">toBeGreaterThan</span>(<span class="hljs-number">0</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should DISPLAY heroes'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// Find and examine the displayed heroes</span></div><div class="hljs-ln-line">      <span class="hljs-comment">// Look for them in the DOM by css class</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> heroes = harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'dashboard-hero'</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(heroes.<span class="hljs-property">length</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should display 4 heroes'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">4</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should tell navigate when hero clicked'</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">heroClick</span>(); <span class="hljs-comment">// trigger click on first inner &lt;div class="hero"&gt;</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// expecting to navigate to id of the component's first hero</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> id = comp.<span class="hljs-property">heroes</span>[<span class="hljs-number">0</span>].<span class="hljs-property">id</span>;</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should nav to HeroDetail for first hero'</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${id}</span>`</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="aayupyjnkwj7ghgzy56yba92p">下面这个测试会点击正在显示的英雄，并确认我们正在导航到所期望的 URL。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/dashboard/dashboard.component.spec.ts" visiblelines="115,116,117,118,119,120,121,122,123" header="app/dashboard/dashboard.component.spec.ts (navigate test)">
    <div class="docs-code-header"><h3>app/dashboard/dashboard.component.spec.ts (navigate test)</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {provideHttpClient} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpTestingController</span>, provideHttpClientTesting} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-variable constant_">NO_ERRORS_SCHEMA</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TestBed</span>, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">By</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/platform-browser'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">NavigationEnd</span>, provideRouter, <span class="hljs-title class_">Router</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">RouterTestingHarness</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {firstValueFrom} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {filter} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {addMatchers, click} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {getTestHeroes} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/testing/test-heroes'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">DashboardComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./dashboard.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appConfig} <span class="hljs-keyword">from</span> <span class="hljs-string">'../app.config'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../hero/hero-detail.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">beforeEach</span>(addMatchers);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">comp</span>: <span class="hljs-title class_">DashboardComponent</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">harness</span>: <span class="hljs-title class_">RouterTestingHarness</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////////  Deep  ////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardComponent (deep)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">compileAndCreate</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">tests</span>(clickForDeep);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">function</span> <span class="hljs-title function_">clickForDeep</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">    <span class="hljs-comment">// get first &lt;div class="hero"&gt;</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> <span class="hljs-attr">heroEl</span>: <span class="hljs-title class_">HTMLElement</span> = harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.hero'</span>)!;</div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroEl);</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-title function_">firstValueFrom</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">events</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> e <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">NavigationEnd</span>)),</div><div class="hljs-ln-line">    );</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////////  Shallow ////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardComponent (shallow)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardComponent</span>, <span class="hljs-title class_">HeroDetailComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [<span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}])],</div><div class="hljs-ln-line">        <span class="hljs-attr">schemas</span>: [<span class="hljs-variable constant_">NO_ERRORS_SCHEMA</span>],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    );</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">compileAndCreate</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">tests</span>(clickForShallow);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">function</span> <span class="hljs-title function_">clickForShallow</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">    <span class="hljs-comment">// get first &lt;dashboard-hero&gt; DebugElement</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> heroDe = harness.<span class="hljs-property">routeDebugElement</span>!.<span class="hljs-title function_">query</span>(<span class="hljs-title class_">By</span>.<span class="hljs-title function_">css</span>(<span class="hljs-string">'dashboard-hero'</span>));</div><div class="hljs-ln-line">    heroDe.<span class="hljs-title function_">triggerEventHandler</span>(<span class="hljs-string">'selected'</span>, comp.<span class="hljs-property">heroes</span>[<span class="hljs-number">0</span>]);</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>();</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/** Add TestBed providers, compile, and create DashboardComponent */</span></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">compileAndCreate</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'**'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">DashboardComponent</span>}]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title class_">HeroService</span>,</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    )</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>()</div><div class="hljs-ln-line">      .<span class="hljs-title function_">then</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">        harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">        comp = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">'/'</span>, <span class="hljs-title class_">DashboardComponent</span>);</div><div class="hljs-ln-line">        <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>(<span class="hljs-string">'api/heroes'</span>).<span class="hljs-title function_">flush</span>(<span class="hljs-title function_">getTestHeroes</span>());</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/**</span></div><div class="hljs-ln-line"> * The (almost) same tests for both.</div><div class="hljs-ln-line"> * Only change: the way that the first hero is clicked</div><div class="hljs-ln-line"> */</div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">tests</span>(<span class="hljs-params">heroClick: () =&gt; <span class="hljs-built_in">Promise</span>&lt;unknown&gt;</span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'after get dashboard heroes'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">router</span>: <span class="hljs-title class_">Router</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// Trigger component so it gets heroes and binds to them</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      router = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>);</div><div class="hljs-ln-line">      harness.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// runs ngOnInit -&gt; getHeroes</span></div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should HAVE heroes'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(comp.<span class="hljs-property">heroes</span>.<span class="hljs-property">length</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should have heroes after service promise resolves'</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">toBeGreaterThan</span>(<span class="hljs-number">0</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should DISPLAY heroes'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// Find and examine the displayed heroes</span></div><div class="hljs-ln-line">      <span class="hljs-comment">// Look for them in the DOM by css class</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> heroes = harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'dashboard-hero'</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(heroes.<span class="hljs-property">length</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should display 4 heroes'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">4</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should tell navigate when hero clicked'</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">heroClick</span>(); <span class="hljs-comment">// trigger click on first inner &lt;div class="hero"&gt;</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// expecting to navigate to id of the component's first hero</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> id = comp.<span class="hljs-property">heroes</span>[<span class="hljs-number">0</span>].<span class="hljs-property">id</span>;</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'should nav to HeroDetail for first hero'</span>)</div><div class="hljs-ln-line">        .<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${id}</span>`</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
  <h2 id="routed-components">
    <a href="#routed-components" class="docs-anchor" tabindex="-1" aria-label="Link to Routed components" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="ca0qb793u28asb2pr12abrcat">路由目标组件</a>
  </h2>
  <p data-ng_translator_product="100" data-ng_translator_ref_id="8b3rfe5xfp2qo9lvqx47f2004"><em>被路由的组件</em>是 
<code>Router</code> 导航的目的地。 它可能更难以测试，特别是当路由到该组件
<em>包含参数</em>时。 
<code>HeroDetailComponent</code> 就是这样一个
<em>被路由的组件</em>。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="7tnh4hmbddf1ip88rfzal9wni">当用户点击一个
<em>仪表板</em>英雄时，
<code>DashboardComponent</code> 告诉 
<code>Router</code> 导航到 
<code>heroes/:id</code>。 
<code>:id</code> 是一个路由参数，其值是要编辑的英雄的 
<code>id</code>。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="di0xremlb83bpt8porplzm1z8"><code>Router</code> 将该 URL 匹配到 
<code>HeroDetailComponent</code> 的路由。 它创建一个包含路由信息的 
<code>ActivatedRoute</code> 对象，并将其注入到新的 
<code>HeroDetailComponent</code> 实例中。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="b9lk3m1abbsp03d1o8dnz0gab">下面是 <code>HeroDetailComponent</code> 的构造函数：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/hero/hero-detail.component.ts" visiblelines="17,18,19,20,21" header="app/hero/hero-detail.component.ts (constructor)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="9iaihckl3ccjh2ebq8ct0aj3r">app/hero/hero-detail.component.ts (构造函数)</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Component</span>, <span class="hljs-title class_">OnInit</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">ActivatedRoute</span>, <span class="hljs-title class_">Router</span>, <span class="hljs-title class_">RouterLink</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {sharedImports} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/shared'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-meta">@Component</span>({</div><div class="hljs-ln-line">  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">selector</span>: <span class="hljs-string">'app-hero-detail'</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">templateUrl</span>: <span class="hljs-string">'./hero-detail.component.html'</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">styleUrls</span>: [<span class="hljs-string">'./hero-detail.component.css'</span>],</div><div class="hljs-ln-line">  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">HeroDetailService</span>],</div><div class="hljs-ln-line">  <span class="hljs-attr">imports</span>: [sharedImports, <span class="hljs-title class_">RouterLink</span>],</div><div class="hljs-ln-line">})</div><div class="hljs-ln-line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroDetailComponent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OnInit</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span></div><div class="hljs-ln-line">    <span class="hljs-keyword">private</span> heroDetailService: HeroDetailService,</div><div class="hljs-ln-line">    <span class="hljs-keyword">private</span> route: ActivatedRoute,</div><div class="hljs-ln-line">    <span class="hljs-keyword">private</span> router: Router,</div><div class="hljs-ln-line">  ) {}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  hero!: <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">ngOnInit</span>(): <span class="hljs-built_in">void</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// get hero when `id` param changes</span></div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">route</span>.<span class="hljs-property">paramMap</span>.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">pmap</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getHero</span>(pmap.<span class="hljs-title function_">get</span>(<span class="hljs-string">'id'</span>)));</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> <span class="hljs-title function_">getHero</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>): <span class="hljs-built_in">void</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// when no id or id===0, create new blank hero</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> (!id) {</div><div class="hljs-ln-line">      <span class="hljs-variable language_">this</span>.<span class="hljs-property">hero</span> = {<span class="hljs-attr">id</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">''</span>} <span class="hljs-keyword">as</span> <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line">      <span class="hljs-keyword">return</span>;</div><div class="hljs-ln-line">    }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">heroDetailService</span>.<span class="hljs-title function_">getHero</span>(id).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero</span>) =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-keyword">if</span> (hero) {</div><div class="hljs-ln-line">        <span class="hljs-variable language_">this</span>.<span class="hljs-property">hero</span> = hero;</div><div class="hljs-ln-line">      } <span class="hljs-keyword">else</span> {</div><div class="hljs-ln-line">        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">gotoList</span>(); <span class="hljs-comment">// id not found; navigate to list</span></div><div class="hljs-ln-line">      }</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">save</span>(): <span class="hljs-built_in">void</span> {</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">heroDetailService</span>.<span class="hljs-title function_">saveHero</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">hero</span>).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">gotoList</span>());</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">cancel</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">gotoList</span>();</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">gotoList</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">router</span>.<span class="hljs-title function_">navigate</span>([<span class="hljs-string">'../'</span>], {<span class="hljs-attr">relativeTo</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">route</span>});</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="7eirxfuvsdae5bu66d54rezba"><code>HeroDetail</code> 组件需要 
<code>id</code> 参数，以便使用 
<code>HeroDetailService</code> 获取相应的英雄。 该组件必须从 
<code>ActivatedRoute.paramMap</code> 属性（这是一个 
<code>Observable</code>）中获取 
<code>id</code>。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="bdvaqanrncdl2nihc8efwtgc6">它不能直接引用 
<code>ActivatedRoute.paramMap</code> 的 
<code>id</code> 属性。 该组件必须
<em>订阅</em> 
<code>ActivatedRoute.paramMap</code> 可观察者，并准备好在其生命周期内 
<code>id</code> 会发生改变。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/hero/hero-detail.component.ts" visiblelines="25,26,27,28" header="app/hero/hero-detail.component.ts (ngOnInit)">
    <div class="docs-code-header"><h3>app/hero/hero-detail.component.ts (ngOnInit)</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Component</span>, <span class="hljs-title class_">OnInit</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">ActivatedRoute</span>, <span class="hljs-title class_">Router</span>, <span class="hljs-title class_">RouterLink</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {sharedImports} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/shared'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-meta">@Component</span>({</div><div class="hljs-ln-line">  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">selector</span>: <span class="hljs-string">'app-hero-detail'</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">templateUrl</span>: <span class="hljs-string">'./hero-detail.component.html'</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">styleUrls</span>: [<span class="hljs-string">'./hero-detail.component.css'</span>],</div><div class="hljs-ln-line">  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">HeroDetailService</span>],</div><div class="hljs-ln-line">  <span class="hljs-attr">imports</span>: [sharedImports, <span class="hljs-title class_">RouterLink</span>],</div><div class="hljs-ln-line">})</div><div class="hljs-ln-line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroDetailComponent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OnInit</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span></div><div class="hljs-ln-line">    <span class="hljs-keyword">private</span> heroDetailService: HeroDetailService,</div><div class="hljs-ln-line">    <span class="hljs-keyword">private</span> route: ActivatedRoute,</div><div class="hljs-ln-line">    <span class="hljs-keyword">private</span> router: Router,</div><div class="hljs-ln-line">  ) {}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  hero!: <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">ngOnInit</span>(): <span class="hljs-built_in">void</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// get hero when `id` param changes</span></div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">route</span>.<span class="hljs-property">paramMap</span>.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">pmap</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getHero</span>(pmap.<span class="hljs-title function_">get</span>(<span class="hljs-string">'id'</span>)));</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> <span class="hljs-title function_">getHero</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>): <span class="hljs-built_in">void</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// when no id or id===0, create new blank hero</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> (!id) {</div><div class="hljs-ln-line">      <span class="hljs-variable language_">this</span>.<span class="hljs-property">hero</span> = {<span class="hljs-attr">id</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">''</span>} <span class="hljs-keyword">as</span> <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line">      <span class="hljs-keyword">return</span>;</div><div class="hljs-ln-line">    }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">heroDetailService</span>.<span class="hljs-title function_">getHero</span>(id).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero</span>) =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-keyword">if</span> (hero) {</div><div class="hljs-ln-line">        <span class="hljs-variable language_">this</span>.<span class="hljs-property">hero</span> = hero;</div><div class="hljs-ln-line">      } <span class="hljs-keyword">else</span> {</div><div class="hljs-ln-line">        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">gotoList</span>(); <span class="hljs-comment">// id not found; navigate to list</span></div><div class="hljs-ln-line">      }</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">save</span>(): <span class="hljs-built_in">void</span> {</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">heroDetailService</span>.<span class="hljs-title function_">saveHero</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">hero</span>).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">gotoList</span>());</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">cancel</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">gotoList</span>();</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">gotoList</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">router</span>.<span class="hljs-title function_">navigate</span>([<span class="hljs-string">'../'</span>], {<span class="hljs-attr">relativeTo</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">route</span>});</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="34a9aq4xsq8s5mq1crriyg3jz">通过导航到不同的路由，测试可以探查 <code>HeroDetailComponent</code> 是如何对不同的 <code>id</code> 参数值做出响应的。</p>

  <h3 id="testing-with-the-routertestingharness">
    <a href="#testing-with-the-routertestingharness" class="docs-anchor" tabindex="-1" aria-label="Link to Testing with the <code>RouterTestingHarness</code>" data-ng_translator_product="100" data-ng_translator_ref_id="8oat8h2r35cix21k959pob6k2">使用 
<code>RouterTestingHarness</code> 进行测试</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="2374t2d9s5zfixbfdxu1lrspv">下面的测试程序是演示组件在被观察的 <code>id</code> 指向现有英雄时的行为：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/hero/hero-detail.component.spec.ts" visiblelines="132,133,134,135,136,137,138,139,140,141" header="app/hero/hero-detail.component.spec.ts (existing id)">
    <div class="docs-code-header"><h3>app/hero/hero-detail.component.spec.ts (existing id)</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpClient</span>, <span class="hljs-title class_">HttpHandler</span>, provideHttpClient} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpTestingController</span>, provideHttpClientTesting} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, <span class="hljs-title class_">TestBed</span>, tick} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {provideRouter, <span class="hljs-title class_">Router</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">RouterTestingHarness</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {asyncData, click} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {sharedImports} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/shared'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroListComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-list.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Testing Vars //////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">harness</span>: <span class="hljs-title class_">RouterTestingHarness</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">page</span>: <span class="hljs-title class_">Page</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Tests //////</span></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'HeroDetailComponent'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with HeroModule setup'</span>, heroModuleSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when override its provided HeroDetailService'</span>, overrideSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with FormsModule setup'</span>, formsModuleSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with SharedModule setup'</span>, sharedModuleSetup);</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">///////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">const</span> testHero = <span class="hljs-title function_">getTestHeroes</span>()[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">overrideSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroDetailServiceSpy</span> {</div><div class="hljs-ln-line">    <span class="hljs-attr">testHero</span>: <span class="hljs-title class_">Hero</span> = {...testHero};</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">/* emit cloned test hero */</span></div><div class="hljs-ln-line">    getHero = jasmine</div><div class="hljs-ln-line">      .<span class="hljs-title function_">createSpy</span>(<span class="hljs-string">'getHero'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-property">and</span>.<span class="hljs-title function_">callFake</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, <span class="hljs-variable language_">this</span>.<span class="hljs-property">testHero</span>)));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">/* emit clone of test hero, with changes merged in */</span></div><div class="hljs-ln-line">    saveHero = jasmine</div><div class="hljs-ln-line">      .<span class="hljs-title function_">createSpy</span>(<span class="hljs-string">'saveHero'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-property">and</span>.<span class="hljs-title function_">callFake</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">testHero</span>, hero)));</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">HeroListComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroListComponent</span>},</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>},</div><div class="hljs-ln-line">          ]),</div><div class="hljs-ln-line">          <span class="hljs-title class_">HttpClient</span>,</div><div class="hljs-ln-line">          <span class="hljs-title class_">HttpHandler</span>,</div><div class="hljs-ln-line">          <span class="hljs-comment">// HeroDetailService at this level is IRRELEVANT!</span></div><div class="hljs-ln-line">          {<span class="hljs-attr">provide</span>: <span class="hljs-title class_">HeroDetailService</span>, <span class="hljs-attr">useValue</span>: {}},</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    )</div><div class="hljs-ln-line">      .<span class="hljs-title function_">overrideComponent</span>(<span class="hljs-title class_">HeroDetailComponent</span>, {</div><div class="hljs-ln-line">        <span class="hljs-attr">set</span>: {<span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">HeroDetailService</span>, <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">HeroDetailServiceSpy</span>}]},</div><div class="hljs-ln-line">      })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">hdsSpy</span>: <span class="hljs-title class_">HeroDetailServiceSpy</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">    component = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${testHero.id}</span>`</span>, <span class="hljs-title class_">HeroDetailComponent</span>);</div><div class="hljs-ln-line">    page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>();</div><div class="hljs-ln-line">    <span class="hljs-comment">// get the component's injected HeroDetailServiceSpy</span></div><div class="hljs-ln-line">    hdsSpy = harness.<span class="hljs-property">routeDebugElement</span>!.<span class="hljs-property">injector</span>.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">HeroDetailService</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should have called `getHero`'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">getHero</span>.<span class="hljs-property">calls</span>.<span class="hljs-title function_">count</span>())</div><div class="hljs-ln-line">      .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getHero called once'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'getHero called once'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display stub hero's name"</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should save stub hero change'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> origName = hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>;</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> newName = <span class="hljs-string">'New Name'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    page.<span class="hljs-property">nameInput</span>.<span class="hljs-property">value</span> = newName;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    page.<span class="hljs-property">nameInput</span>.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'input'</span>)); <span class="hljs-comment">// tell Angular</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(component.<span class="hljs-property">hero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'component hero has new name'</span>).<span class="hljs-title function_">toBe</span>(newName);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'service hero unchanged before save'</span>).<span class="hljs-title function_">toBe</span>(origName);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">saveHero</span>.<span class="hljs-property">calls</span>.<span class="hljs-title function_">count</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'saveHero called once'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// wait for async save to complete</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'service hero has new name after save'</span>).<span class="hljs-title function_">toBe</span>(newName);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes'</span>);</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////////////////////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {getTestHeroes} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/testing/test-hero.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">const</span> firstHero = <span class="hljs-title function_">getTestHeroes</span>()[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">heroModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">HeroListComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>},</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroListComponent</span>},</div><div class="hljs-ln-line">          ]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when navigate to existing hero'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">expectedHero</span>: <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      expectedHero = firstHero;</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display that hero's name"</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should navigate when click cancel'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">cancelBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${expectedHero.id}</span>`</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should save when click save but not navigate immediately'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>({<span class="hljs-attr">method</span>: <span class="hljs-string">'PUT'</span>, <span class="hljs-attr">url</span>: <span class="hljs-string">'api/heroes'</span>}));</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes/41'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should navigate when click save and save resolves'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// wait for async save to complete</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes/41'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should convert hero name to Title Case'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// get the name's input and display elements from the DOM</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">hostElement</span>: <span class="hljs-title class_">HTMLElement</span> = harness.<span class="hljs-property">routeNativeElement</span>!;</div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">nameInput</span>: <span class="hljs-title class_">HTMLInputElement</span> = hostElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'input'</span>)!;</div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">nameDisplay</span>: <span class="hljs-title class_">HTMLElement</span> = hostElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'span'</span>)!;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// simulate user entering a new name into the input box</span></div><div class="hljs-ln-line">      nameInput.<span class="hljs-property">value</span> = <span class="hljs-string">'quick BROWN  fOx'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// Dispatch a DOM event so that Angular learns of input value change.</span></div><div class="hljs-ln-line">      nameInput.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'input'</span>));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// Tell Angular to update the display binding through the title pipe</span></div><div class="hljs-ln-line">      harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(nameDisplay.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'Quick Brown  Fox'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when navigate to non-existent hero id'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(<span class="hljs-number">999</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should try to navigate back to hero list'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/////////////////////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">FormsModule</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/forms'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TitleCasePipe</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/title-case.pipe'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appConfig} <span class="hljs-keyword">from</span> <span class="hljs-string">'../app.config'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">formsModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">FormsModule</span>, <span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">TitleCasePipe</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}]),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display 1st hero's name"</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedHero = firstHero;</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">///////////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sharedModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, sharedImports],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display 1st hero's name"</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedHero = firstHero;</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/////////// Helpers /////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/** Create the HeroDetailComponent, initialize it, set test variables  */</span></div><div class="hljs-ln-line"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createComponent</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {</div><div class="hljs-ln-line">  harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">  component = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${id}</span>`</span>, <span class="hljs-title class_">HeroDetailComponent</span>);</div><div class="hljs-ln-line">  page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> request = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>(<span class="hljs-string">`api/heroes/?id=<span class="hljs-subst">${id}</span>`</span>);</div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> hero = <span class="hljs-title function_">getTestHeroes</span>().<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">h</span>) =&gt;</span> h.<span class="hljs-property">id</span> === <span class="hljs-title class_">Number</span>(id));</div><div class="hljs-ln-line">  request.<span class="hljs-title function_">flush</span>(hero ? [hero] : []);</div><div class="hljs-ln-line">  harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Page</span> {</div><div class="hljs-ln-line">  <span class="hljs-comment">// getter properties wait to query the DOM until called.</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">buttons</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">queryAll</span>&lt;<span class="hljs-title class_">HTMLButtonElement</span>&gt;(<span class="hljs-string">'button'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">saveBtn</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buttons</span>[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">cancelBtn</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buttons</span>[<span class="hljs-number">1</span>];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">nameDisplay</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>&lt;<span class="hljs-title class_">HTMLElement</span>&gt;(<span class="hljs-string">'span'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">nameInput</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>&lt;<span class="hljs-title class_">HTMLInputElement</span>&gt;(<span class="hljs-string">'input'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">//// query helpers ////</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> query&lt;T&gt;(<span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>): T {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelector</span>(selector)! <span class="hljs-keyword">as</span> T;</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> queryAll&lt;T&gt;(<span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>): T[] {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelectorAll</span>(selector) <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span> <span class="hljs-keyword">as</span> T[];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
    <div class="docs-alert docs-alert-helpful">
    <p data-ng_translator_product="100" data-ng_translator_ref_id="8hz4tqc4hofhmqaw655xa0dj0"><strong>提示：</strong>在接下来的部分中，将讨论 
<code>createComponent()</code> 方法和 
<code>page</code> 对象。 暂时依靠你的直觉。</p>

    </div>
    <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="35s151lkbccxpzrhi65adxj2u">当找不到 <code>id</code> 的时候，组件应该重新路由到 <code>HeroListComponent</code>。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="301s6xyyv73d7yiggr2ymxky2">测试套件设置提供了与上面
<a href="#routing-component">描述的</a>相同的路由工具。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="ctw509cw2ylaocv2gryy70nh1">这个测试中会期待该组件尝试导航到 <code>HeroListComponent</code>。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/hero/hero-detail.component.spec.ts" visiblelines="180,181,182,183,184,185,186,187,188" header="app/hero/hero-detail.component.spec.ts (bad id)">
    <div class="docs-code-header"><h3>app/hero/hero-detail.component.spec.ts (bad id)</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpClient</span>, <span class="hljs-title class_">HttpHandler</span>, provideHttpClient} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpTestingController</span>, provideHttpClientTesting} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, <span class="hljs-title class_">TestBed</span>, tick} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {provideRouter, <span class="hljs-title class_">Router</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">RouterTestingHarness</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {asyncData, click} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {sharedImports} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/shared'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroListComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-list.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Testing Vars //////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">harness</span>: <span class="hljs-title class_">RouterTestingHarness</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">page</span>: <span class="hljs-title class_">Page</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Tests //////</span></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'HeroDetailComponent'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with HeroModule setup'</span>, heroModuleSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when override its provided HeroDetailService'</span>, overrideSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with FormsModule setup'</span>, formsModuleSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with SharedModule setup'</span>, sharedModuleSetup);</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">///////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">const</span> testHero = <span class="hljs-title function_">getTestHeroes</span>()[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">overrideSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroDetailServiceSpy</span> {</div><div class="hljs-ln-line">    <span class="hljs-attr">testHero</span>: <span class="hljs-title class_">Hero</span> = {...testHero};</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">/* emit cloned test hero */</span></div><div class="hljs-ln-line">    getHero = jasmine</div><div class="hljs-ln-line">      .<span class="hljs-title function_">createSpy</span>(<span class="hljs-string">'getHero'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-property">and</span>.<span class="hljs-title function_">callFake</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, <span class="hljs-variable language_">this</span>.<span class="hljs-property">testHero</span>)));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">/* emit clone of test hero, with changes merged in */</span></div><div class="hljs-ln-line">    saveHero = jasmine</div><div class="hljs-ln-line">      .<span class="hljs-title function_">createSpy</span>(<span class="hljs-string">'saveHero'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-property">and</span>.<span class="hljs-title function_">callFake</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">testHero</span>, hero)));</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">HeroListComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroListComponent</span>},</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>},</div><div class="hljs-ln-line">          ]),</div><div class="hljs-ln-line">          <span class="hljs-title class_">HttpClient</span>,</div><div class="hljs-ln-line">          <span class="hljs-title class_">HttpHandler</span>,</div><div class="hljs-ln-line">          <span class="hljs-comment">// HeroDetailService at this level is IRRELEVANT!</span></div><div class="hljs-ln-line">          {<span class="hljs-attr">provide</span>: <span class="hljs-title class_">HeroDetailService</span>, <span class="hljs-attr">useValue</span>: {}},</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    )</div><div class="hljs-ln-line">      .<span class="hljs-title function_">overrideComponent</span>(<span class="hljs-title class_">HeroDetailComponent</span>, {</div><div class="hljs-ln-line">        <span class="hljs-attr">set</span>: {<span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">HeroDetailService</span>, <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">HeroDetailServiceSpy</span>}]},</div><div class="hljs-ln-line">      })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">hdsSpy</span>: <span class="hljs-title class_">HeroDetailServiceSpy</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">    component = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${testHero.id}</span>`</span>, <span class="hljs-title class_">HeroDetailComponent</span>);</div><div class="hljs-ln-line">    page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>();</div><div class="hljs-ln-line">    <span class="hljs-comment">// get the component's injected HeroDetailServiceSpy</span></div><div class="hljs-ln-line">    hdsSpy = harness.<span class="hljs-property">routeDebugElement</span>!.<span class="hljs-property">injector</span>.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">HeroDetailService</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should have called `getHero`'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">getHero</span>.<span class="hljs-property">calls</span>.<span class="hljs-title function_">count</span>())</div><div class="hljs-ln-line">      .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getHero called once'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'getHero called once'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display stub hero's name"</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should save stub hero change'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> origName = hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>;</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> newName = <span class="hljs-string">'New Name'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    page.<span class="hljs-property">nameInput</span>.<span class="hljs-property">value</span> = newName;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    page.<span class="hljs-property">nameInput</span>.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'input'</span>)); <span class="hljs-comment">// tell Angular</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(component.<span class="hljs-property">hero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'component hero has new name'</span>).<span class="hljs-title function_">toBe</span>(newName);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'service hero unchanged before save'</span>).<span class="hljs-title function_">toBe</span>(origName);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">saveHero</span>.<span class="hljs-property">calls</span>.<span class="hljs-title function_">count</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'saveHero called once'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// wait for async save to complete</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'service hero has new name after save'</span>).<span class="hljs-title function_">toBe</span>(newName);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes'</span>);</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////////////////////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {getTestHeroes} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/testing/test-hero.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">const</span> firstHero = <span class="hljs-title function_">getTestHeroes</span>()[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">heroModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">HeroListComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>},</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroListComponent</span>},</div><div class="hljs-ln-line">          ]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when navigate to existing hero'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">expectedHero</span>: <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      expectedHero = firstHero;</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display that hero's name"</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should navigate when click cancel'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">cancelBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${expectedHero.id}</span>`</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should save when click save but not navigate immediately'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>({<span class="hljs-attr">method</span>: <span class="hljs-string">'PUT'</span>, <span class="hljs-attr">url</span>: <span class="hljs-string">'api/heroes'</span>}));</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes/41'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should navigate when click save and save resolves'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// wait for async save to complete</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes/41'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should convert hero name to Title Case'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// get the name's input and display elements from the DOM</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">hostElement</span>: <span class="hljs-title class_">HTMLElement</span> = harness.<span class="hljs-property">routeNativeElement</span>!;</div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">nameInput</span>: <span class="hljs-title class_">HTMLInputElement</span> = hostElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'input'</span>)!;</div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">nameDisplay</span>: <span class="hljs-title class_">HTMLElement</span> = hostElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'span'</span>)!;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// simulate user entering a new name into the input box</span></div><div class="hljs-ln-line">      nameInput.<span class="hljs-property">value</span> = <span class="hljs-string">'quick BROWN  fOx'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// Dispatch a DOM event so that Angular learns of input value change.</span></div><div class="hljs-ln-line">      nameInput.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'input'</span>));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// Tell Angular to update the display binding through the title pipe</span></div><div class="hljs-ln-line">      harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(nameDisplay.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'Quick Brown  Fox'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when navigate to non-existent hero id'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(<span class="hljs-number">999</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should try to navigate back to hero list'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/////////////////////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">FormsModule</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/forms'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TitleCasePipe</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/title-case.pipe'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appConfig} <span class="hljs-keyword">from</span> <span class="hljs-string">'../app.config'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">formsModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">FormsModule</span>, <span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">TitleCasePipe</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}]),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display 1st hero's name"</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedHero = firstHero;</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">///////////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sharedModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, sharedImports],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display 1st hero's name"</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedHero = firstHero;</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/////////// Helpers /////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/** Create the HeroDetailComponent, initialize it, set test variables  */</span></div><div class="hljs-ln-line"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createComponent</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {</div><div class="hljs-ln-line">  harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">  component = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${id}</span>`</span>, <span class="hljs-title class_">HeroDetailComponent</span>);</div><div class="hljs-ln-line">  page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> request = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>(<span class="hljs-string">`api/heroes/?id=<span class="hljs-subst">${id}</span>`</span>);</div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> hero = <span class="hljs-title function_">getTestHeroes</span>().<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">h</span>) =&gt;</span> h.<span class="hljs-property">id</span> === <span class="hljs-title class_">Number</span>(id));</div><div class="hljs-ln-line">  request.<span class="hljs-title function_">flush</span>(hero ? [hero] : []);</div><div class="hljs-ln-line">  harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Page</span> {</div><div class="hljs-ln-line">  <span class="hljs-comment">// getter properties wait to query the DOM until called.</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">buttons</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">queryAll</span>&lt;<span class="hljs-title class_">HTMLButtonElement</span>&gt;(<span class="hljs-string">'button'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">saveBtn</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buttons</span>[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">cancelBtn</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buttons</span>[<span class="hljs-number">1</span>];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">nameDisplay</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>&lt;<span class="hljs-title class_">HTMLElement</span>&gt;(<span class="hljs-string">'span'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">nameInput</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>&lt;<span class="hljs-title class_">HTMLInputElement</span>&gt;(<span class="hljs-string">'input'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">//// query helpers ////</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> query&lt;T&gt;(<span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>): T {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelector</span>(selector)! <span class="hljs-keyword">as</span> T;</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> queryAll&lt;T&gt;(<span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>): T[] {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelectorAll</span>(selector) <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span> <span class="hljs-keyword">as</span> T[];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
  <h2 id="nested-component-tests">
    <a href="#nested-component-tests" class="docs-anchor" tabindex="-1" aria-label="Link to Nested component tests" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="b867kv4bibqcsucw7n6kky6hj">对嵌套组件的测试</a>
  </h2>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="80ejtb5xykj7ol81bc5jtwlt3">组件的模板中通常还会有嵌套组件，嵌套组件的模板还可能包含更多组件。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="d7qf3lcdpauhem95ozbcael1r">这棵组件树可能非常深，并且大多数时候在测试这棵树顶部的组件时，这些嵌套的组件都无关紧要。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="8fjlhvd5j26shclah9dxct7xi">例如，
<code>AppComponent</code> 显示一个带有 anchor 和其 
<code>RouterLink</code> 指令的导航栏。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/app.component.html" header="app/app.component.html">
    <div class="docs-code-header"><h3>app/app.component.html</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-tag">&lt;<span class="hljs-name">app-banner</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">app-banner</span>&gt;</span></div><div class="hljs-ln-line"><span class="hljs-tag">&lt;<span class="hljs-name">app-welcome</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">app-welcome</span>&gt;</span></div><div class="hljs-ln-line"><span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span></div><div class="hljs-ln-line">  <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">routerLink</span>=<span class="hljs-string">"/dashboard"</span>&gt;</span>Dashboard<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></div><div class="hljs-ln-line">  <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">routerLink</span>=<span class="hljs-string">"/heroes"</span>&gt;</span>Heroes<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></div><div class="hljs-ln-line">  <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">routerLink</span>=<span class="hljs-string">"/about"</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></div><div class="hljs-ln-line"><span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span></div><div class="hljs-ln-line"><span class="hljs-tag">&lt;<span class="hljs-name">router-outlet</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">router-outlet</span>&gt;</span></div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="2eb3b8bfv9sai5ag4ltln1aq3">为了验证这些链接，你不需要 
<code>Router</code> 来导航，也不需要 
<code>&lt;router-outlet&gt;</code> 来标记 
<code>Router</code> 插入 
<em>路由组件</em> 的位置。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="b0trxeu42mq5umejpr2mfn1p0">而 <code>BannerComponent</code> 和 <code>WelcomeComponent</code>（写作 <code>&lt;app-banner&gt;</code> 和 <code>&lt;app-welcome&gt;</code>）也同样风马牛不相及。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="d1hon9pp7dmo0s372bm9qbx4a">然而，任何在 DOM 中创建 
<code>AppComponent</code> 的测试也会创建这三个组件的实例，如果你让这种情况发生，就必须配置 
<code>TestBed</code> 来创建它们。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="5opi3nx71qgieyieqbsskkdhl">如果你忘记声明它们，Angular 编译器将无法识别 <code>AppComponent</code> 模板中的 
<code>&lt;app-banner&gt;</code>、
<code>&lt;app-welcome&gt;</code> 和 
<code>&lt;router-outlet&gt;</code> 标签，并会抛出错误。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="bee1eoienzsxfjz7fcv9dg1om">如果你声明的这些都是真实的组件，那么也同样要声明<em>它们</em>的嵌套组件，并要为这棵组件树中的<em>任何</em>组件提供要注入的<em>所有</em>服务。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="59aebrdhcs5i9hayt01xly9jq">如果只是想回答关于链接的一些简单问题，做这些显然就太多了。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="bq6c8rjnospe6a114xflty2aw">本节会讲减少此类准备工作的两项技术。单独使用或组合使用它们，可以让这些测试聚焦于要测试的主要组件上。</p>

  <h3 id="stubbing-unneeded-components">
    <a href="#stubbing-unneeded-components" class="docs-anchor" tabindex="-1" aria-label="Link to Stubbing unneeded components" data-ng_translator_product="100" data-ng_translator_ref_id="3xf0j58xy8pd7945d3owxi2ei">对不需要的组件提供桩（stub）</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="8p7ostyzclgvuoiz384s3kpy">这项技术中，你要为那些在测试中无关紧要的组件或指令创建和声明一些测试桩。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/app.component.spec.ts" visiblelines="9,10,11,12,13,14,15,16" header="app/app.component.spec.ts (stub declaration)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="9fh3n3slz5zt0a47u1w27abc4">app/app.component.spec.ts（模拟声明）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {Component, DebugElement, NO_ERRORS_SCHEMA} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {ComponentFixture, fakeAsync, TestBed, tick, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-keyword">By</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/platform-browser'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {provideRouter, Router, RouterLink} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {AppComponent} <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appConfig} <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.config'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {UserService} <span class="hljs-keyword">from</span> <span class="hljs-string">'./model'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">@Component({standalone: <span class="hljs-keyword">true</span>, selector: <span class="hljs-string">'app-banner'</span>, <span class="hljs-keyword">template</span>: <span class="hljs-string">''</span>})</div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> BannerStubComponent {}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">@Component({standalone: <span class="hljs-keyword">true</span>, selector: <span class="hljs-string">'router-outlet'</span>, <span class="hljs-keyword">template</span>: <span class="hljs-string">''</span>})</div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> RouterOutletStubComponent {}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">@Component({standalone: <span class="hljs-keyword">true</span>, selector: <span class="hljs-string">'app-welcome'</span>, <span class="hljs-keyword">template</span>: <span class="hljs-string">''</span>})</div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> WelcomeStubComponent {}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">let comp: AppComponent;</div><div class="hljs-ln-line">let fixture: ComponentFixture&lt;AppComponent&gt;;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">describe(<span class="hljs-string">'AppComponent &amp; TestModule'</span>, () =&gt; {</div><div class="hljs-ln-line">  beforeEach(waitForAsync(() =&gt; {</div><div class="hljs-ln-line">    TestBed.configureTestingModule(</div><div class="hljs-ln-line">      <span class="hljs-keyword">Object</span>.assign({}, appConfig, {</div><div class="hljs-ln-line">        imports: [</div><div class="hljs-ln-line">          AppComponent,</div><div class="hljs-ln-line">          BannerStubComponent,</div><div class="hljs-ln-line">          RouterLink,</div><div class="hljs-ln-line">          RouterOutletStubComponent,</div><div class="hljs-ln-line">          WelcomeStubComponent,</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">        providers: [provideRouter([]), UserService],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    )</div><div class="hljs-ln-line">      .compileComponents()</div><div class="hljs-ln-line">      .<span class="hljs-keyword">then</span>(() =&gt; {</div><div class="hljs-ln-line">        fixture = TestBed.createComponent(AppComponent);</div><div class="hljs-ln-line">        comp = fixture.componentInstance;</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">  tests();</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">//////// Testing w/ NO_ERRORS_SCHEMA //////</div><div class="hljs-ln-line">describe(<span class="hljs-string">'AppComponent &amp; NO_ERRORS_SCHEMA'</span>, () =&gt; {</div><div class="hljs-ln-line">  beforeEach(waitForAsync(() =&gt; {</div><div class="hljs-ln-line">    TestBed.configureTestingModule(</div><div class="hljs-ln-line">      <span class="hljs-keyword">Object</span>.assign({}, appConfig, {</div><div class="hljs-ln-line">        imports: [</div><div class="hljs-ln-line">          AppComponent,</div><div class="hljs-ln-line">          BannerStubComponent,</div><div class="hljs-ln-line">          RouterLink,</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">        providers: [provideRouter([]), UserService],</div><div class="hljs-ln-line">        <span class="hljs-keyword">schemas</span>: [NO_ERRORS_SCHEMA],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    )</div><div class="hljs-ln-line">      .compileComponents()</div><div class="hljs-ln-line">      .<span class="hljs-keyword">then</span>(() =&gt; {</div><div class="hljs-ln-line">        fixture = TestBed.createComponent(AppComponent);</div><div class="hljs-ln-line">        comp = fixture.componentInstance;</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">  tests();</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> tests() {</div><div class="hljs-ln-line">  let routerLinks: RouterLink[];</div><div class="hljs-ln-line">  let linkDes: DebugElement[];</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  beforeEach(() =&gt; {</div><div class="hljs-ln-line">    fixture.detectChanges(); // <span class="hljs-keyword">trigger</span> initial data binding</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    // find DebugElements <span class="hljs-keyword">with</span> an attached RouterLinkStubDirective</div><div class="hljs-ln-line">    linkDes = fixture.debugElement.queryAll(<span class="hljs-keyword">By</span>.directive(RouterLink));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    // <span class="hljs-keyword">get</span> attached link directive instances</div><div class="hljs-ln-line">    // <span class="hljs-keyword">using</span> <span class="hljs-keyword">each</span> DebugElement<span class="hljs-string">'s injector</span></div><div class="hljs-ln-line">    routerLinks = linkDes.map((de) =&gt; de.injector.get(RouterLink));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it('can instantiate the component<span class="hljs-string">', () =&gt; {</span></div><div class="hljs-ln-line">    expect(comp).not.toBeNull();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it('can <span class="hljs-keyword">get</span> RouterLinks <span class="hljs-keyword">from</span> templat<span class="hljs-string">e', () =&gt; {</span></div><div class="hljs-ln-line">    expect(routerLinks.length).withContext('should have <span class="hljs-number">3</span> routerLinks<span class="hljs-string">').toBe(3);</span></div><div class="hljs-ln-line">    expect(routerLinks[0].href).toBe('/dashboard<span class="hljs-string">');</span></div><div class="hljs-ln-line">    expect(routerLinks[1].href).toBe('/heroes<span class="hljs-string">');</span></div><div class="hljs-ln-line">    expect(routerLinks[2].href).toBe('/about<span class="hljs-string">');</span></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it('can click Heroes link <span class="hljs-keyword">in</span> templat<span class="hljs-string">e', fakeAsync(() =&gt; {</span></div><div class="hljs-ln-line">    const heroesLinkDe = linkDes[1]; // heroes link DebugElement</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    TestBed.inject(Router).resetConfig([{path: '**<span class="hljs-string">', children: []}]);</span></div><div class="hljs-ln-line">    heroesLinkDe.triggerEventHandler('click<span class="hljs-string">', {button: 0});</span></div><div class="hljs-ln-line">    tick();</div><div class="hljs-ln-line">    fixture.detectChanges();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    expect(TestBed.inject(Router).url).toBe('/heroes<span class="hljs-string">');</span></div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="zz9fqdgy67aho07tc4wekkda">这些测试桩的选择器要和其对应的真实组件一致，但其模板和类是空的。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="ck71mz8fv308nndlu1vk16p9n">然后在 
<code>TestBed</code> 配置中，与需要真实的组件、指令和管道一起声明它们。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/app.component.spec.ts" visiblelines="23,24,25,26,27,28,29,30,31,32,33,34" header="app/app.component.spec.ts (TestBed stubs)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="7e127nznyh77zp13x7s134j7v">app/app.component.spec.ts（TestBed 模拟）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {Component, DebugElement, NO_ERRORS_SCHEMA} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {ComponentFixture, fakeAsync, TestBed, tick, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-keyword">By</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/platform-browser'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {provideRouter, Router, RouterLink} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {AppComponent} <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appConfig} <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.config'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {UserService} <span class="hljs-keyword">from</span> <span class="hljs-string">'./model'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">@Component({standalone: <span class="hljs-keyword">true</span>, selector: <span class="hljs-string">'app-banner'</span>, <span class="hljs-keyword">template</span>: <span class="hljs-string">''</span>})</div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> BannerStubComponent {}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">@Component({standalone: <span class="hljs-keyword">true</span>, selector: <span class="hljs-string">'router-outlet'</span>, <span class="hljs-keyword">template</span>: <span class="hljs-string">''</span>})</div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> RouterOutletStubComponent {}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">@Component({standalone: <span class="hljs-keyword">true</span>, selector: <span class="hljs-string">'app-welcome'</span>, <span class="hljs-keyword">template</span>: <span class="hljs-string">''</span>})</div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> WelcomeStubComponent {}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">let comp: AppComponent;</div><div class="hljs-ln-line">let fixture: ComponentFixture&lt;AppComponent&gt;;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">describe(<span class="hljs-string">'AppComponent &amp; TestModule'</span>, () =&gt; {</div><div class="hljs-ln-line">  beforeEach(waitForAsync(() =&gt; {</div><div class="hljs-ln-line">    TestBed.configureTestingModule(</div><div class="hljs-ln-line">      <span class="hljs-keyword">Object</span>.assign({}, appConfig, {</div><div class="hljs-ln-line">        imports: [</div><div class="hljs-ln-line">          AppComponent,</div><div class="hljs-ln-line">          BannerStubComponent,</div><div class="hljs-ln-line">          RouterLink,</div><div class="hljs-ln-line">          RouterOutletStubComponent,</div><div class="hljs-ln-line">          WelcomeStubComponent,</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">        providers: [provideRouter([]), UserService],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    )</div><div class="hljs-ln-line">      .compileComponents()</div><div class="hljs-ln-line">      .<span class="hljs-keyword">then</span>(() =&gt; {</div><div class="hljs-ln-line">        fixture = TestBed.createComponent(AppComponent);</div><div class="hljs-ln-line">        comp = fixture.componentInstance;</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">  tests();</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">//////// Testing w/ NO_ERRORS_SCHEMA //////</div><div class="hljs-ln-line">describe(<span class="hljs-string">'AppComponent &amp; NO_ERRORS_SCHEMA'</span>, () =&gt; {</div><div class="hljs-ln-line">  beforeEach(waitForAsync(() =&gt; {</div><div class="hljs-ln-line">    TestBed.configureTestingModule(</div><div class="hljs-ln-line">      <span class="hljs-keyword">Object</span>.assign({}, appConfig, {</div><div class="hljs-ln-line">        imports: [</div><div class="hljs-ln-line">          AppComponent,</div><div class="hljs-ln-line">          BannerStubComponent,</div><div class="hljs-ln-line">          RouterLink,</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">        providers: [provideRouter([]), UserService],</div><div class="hljs-ln-line">        <span class="hljs-keyword">schemas</span>: [NO_ERRORS_SCHEMA],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    )</div><div class="hljs-ln-line">      .compileComponents()</div><div class="hljs-ln-line">      .<span class="hljs-keyword">then</span>(() =&gt; {</div><div class="hljs-ln-line">        fixture = TestBed.createComponent(AppComponent);</div><div class="hljs-ln-line">        comp = fixture.componentInstance;</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">  tests();</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> tests() {</div><div class="hljs-ln-line">  let routerLinks: RouterLink[];</div><div class="hljs-ln-line">  let linkDes: DebugElement[];</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  beforeEach(() =&gt; {</div><div class="hljs-ln-line">    fixture.detectChanges(); // <span class="hljs-keyword">trigger</span> initial data binding</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    // find DebugElements <span class="hljs-keyword">with</span> an attached RouterLinkStubDirective</div><div class="hljs-ln-line">    linkDes = fixture.debugElement.queryAll(<span class="hljs-keyword">By</span>.directive(RouterLink));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    // <span class="hljs-keyword">get</span> attached link directive instances</div><div class="hljs-ln-line">    // <span class="hljs-keyword">using</span> <span class="hljs-keyword">each</span> DebugElement<span class="hljs-string">'s injector</span></div><div class="hljs-ln-line">    routerLinks = linkDes.map((de) =&gt; de.injector.get(RouterLink));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it('can instantiate the component<span class="hljs-string">', () =&gt; {</span></div><div class="hljs-ln-line">    expect(comp).not.toBeNull();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it('can <span class="hljs-keyword">get</span> RouterLinks <span class="hljs-keyword">from</span> templat<span class="hljs-string">e', () =&gt; {</span></div><div class="hljs-ln-line">    expect(routerLinks.length).withContext('should have <span class="hljs-number">3</span> routerLinks<span class="hljs-string">').toBe(3);</span></div><div class="hljs-ln-line">    expect(routerLinks[0].href).toBe('/dashboard<span class="hljs-string">');</span></div><div class="hljs-ln-line">    expect(routerLinks[1].href).toBe('/heroes<span class="hljs-string">');</span></div><div class="hljs-ln-line">    expect(routerLinks[2].href).toBe('/about<span class="hljs-string">');</span></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it('can click Heroes link <span class="hljs-keyword">in</span> templat<span class="hljs-string">e', fakeAsync(() =&gt; {</span></div><div class="hljs-ln-line">    const heroesLinkDe = linkDes[1]; // heroes link DebugElement</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    TestBed.inject(Router).resetConfig([{path: '**<span class="hljs-string">', children: []}]);</span></div><div class="hljs-ln-line">    heroesLinkDe.triggerEventHandler('click<span class="hljs-string">', {button: 0});</span></div><div class="hljs-ln-line">    tick();</div><div class="hljs-ln-line">    fixture.detectChanges();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    expect(TestBed.inject(Router).url).toBe('/heroes<span class="hljs-string">');</span></div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="3hm7s5x7prju490spg5jb2yd9"><code>AppComponent</code> 是该测试的主角，因此当然要用它的真实版本。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="1oia9ptwsrcykit8zsdn1373m">其它都是测试桩。</p>

  <h3 id="noerrorsschema">
    <a href="#noerrorsschema" class="docs-anchor" tabindex="-1" aria-label="Link to <code>NO_ERRORS_SCHEMA</code>"><code>NO_ERRORS_SCHEMA</code></a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_ref_id="4mqirketlgm7wdgicpeb0z0jm">在第二种方法中，将 
<code>NO_ERRORS_SCHEMA</code> 添加到 
<code>TestBed.schemas</code> 元数据中。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/app.component.spec.ts" visiblelines="47,48,49,50,52,53,54,55,56,57" header="app/app.component.spec.ts (NO_ERRORS_SCHEMA)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="5fw05l9s8s6l57l4c48daqcbr">app/app.component.spec.ts（NO_ERRORS_SCHEMA）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {Component, DebugElement, NO_ERRORS_SCHEMA} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {ComponentFixture, fakeAsync, TestBed, tick, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-keyword">By</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/platform-browser'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {provideRouter, Router, RouterLink} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {AppComponent} <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appConfig} <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.config'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {UserService} <span class="hljs-keyword">from</span> <span class="hljs-string">'./model'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">@Component({standalone: <span class="hljs-keyword">true</span>, selector: <span class="hljs-string">'app-banner'</span>, <span class="hljs-keyword">template</span>: <span class="hljs-string">''</span>})</div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> BannerStubComponent {}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">@Component({standalone: <span class="hljs-keyword">true</span>, selector: <span class="hljs-string">'router-outlet'</span>, <span class="hljs-keyword">template</span>: <span class="hljs-string">''</span>})</div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> RouterOutletStubComponent {}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">@Component({standalone: <span class="hljs-keyword">true</span>, selector: <span class="hljs-string">'app-welcome'</span>, <span class="hljs-keyword">template</span>: <span class="hljs-string">''</span>})</div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> WelcomeStubComponent {}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">let comp: AppComponent;</div><div class="hljs-ln-line">let fixture: ComponentFixture&lt;AppComponent&gt;;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">describe(<span class="hljs-string">'AppComponent &amp; TestModule'</span>, () =&gt; {</div><div class="hljs-ln-line">  beforeEach(waitForAsync(() =&gt; {</div><div class="hljs-ln-line">    TestBed.configureTestingModule(</div><div class="hljs-ln-line">      <span class="hljs-keyword">Object</span>.assign({}, appConfig, {</div><div class="hljs-ln-line">        imports: [</div><div class="hljs-ln-line">          AppComponent,</div><div class="hljs-ln-line">          BannerStubComponent,</div><div class="hljs-ln-line">          RouterLink,</div><div class="hljs-ln-line">          RouterOutletStubComponent,</div><div class="hljs-ln-line">          WelcomeStubComponent,</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">        providers: [provideRouter([]), UserService],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    )</div><div class="hljs-ln-line">      .compileComponents()</div><div class="hljs-ln-line">      .<span class="hljs-keyword">then</span>(() =&gt; {</div><div class="hljs-ln-line">        fixture = TestBed.createComponent(AppComponent);</div><div class="hljs-ln-line">        comp = fixture.componentInstance;</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">  tests();</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">//////// Testing w/ NO_ERRORS_SCHEMA //////</div><div class="hljs-ln-line">describe(<span class="hljs-string">'AppComponent &amp; NO_ERRORS_SCHEMA'</span>, () =&gt; {</div><div class="hljs-ln-line">  beforeEach(waitForAsync(() =&gt; {</div><div class="hljs-ln-line">    TestBed.configureTestingModule(</div><div class="hljs-ln-line">      <span class="hljs-keyword">Object</span>.assign({}, appConfig, {</div><div class="hljs-ln-line">        imports: [</div><div class="hljs-ln-line">          AppComponent,</div><div class="hljs-ln-line">          BannerStubComponent,</div><div class="hljs-ln-line">          RouterLink,</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">        providers: [provideRouter([]), UserService],</div><div class="hljs-ln-line">        <span class="hljs-keyword">schemas</span>: [NO_ERRORS_SCHEMA],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    )</div><div class="hljs-ln-line">      .compileComponents()</div><div class="hljs-ln-line">      .<span class="hljs-keyword">then</span>(() =&gt; {</div><div class="hljs-ln-line">        fixture = TestBed.createComponent(AppComponent);</div><div class="hljs-ln-line">        comp = fixture.componentInstance;</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">  tests();</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> tests() {</div><div class="hljs-ln-line">  let routerLinks: RouterLink[];</div><div class="hljs-ln-line">  let linkDes: DebugElement[];</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  beforeEach(() =&gt; {</div><div class="hljs-ln-line">    fixture.detectChanges(); // <span class="hljs-keyword">trigger</span> initial data binding</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    // find DebugElements <span class="hljs-keyword">with</span> an attached RouterLinkStubDirective</div><div class="hljs-ln-line">    linkDes = fixture.debugElement.queryAll(<span class="hljs-keyword">By</span>.directive(RouterLink));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    // <span class="hljs-keyword">get</span> attached link directive instances</div><div class="hljs-ln-line">    // <span class="hljs-keyword">using</span> <span class="hljs-keyword">each</span> DebugElement<span class="hljs-string">'s injector</span></div><div class="hljs-ln-line">    routerLinks = linkDes.map((de) =&gt; de.injector.get(RouterLink));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it('can instantiate the component<span class="hljs-string">', () =&gt; {</span></div><div class="hljs-ln-line">    expect(comp).not.toBeNull();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it('can <span class="hljs-keyword">get</span> RouterLinks <span class="hljs-keyword">from</span> templat<span class="hljs-string">e', () =&gt; {</span></div><div class="hljs-ln-line">    expect(routerLinks.length).withContext('should have <span class="hljs-number">3</span> routerLinks<span class="hljs-string">').toBe(3);</span></div><div class="hljs-ln-line">    expect(routerLinks[0].href).toBe('/dashboard<span class="hljs-string">');</span></div><div class="hljs-ln-line">    expect(routerLinks[1].href).toBe('/heroes<span class="hljs-string">');</span></div><div class="hljs-ln-line">    expect(routerLinks[2].href).toBe('/about<span class="hljs-string">');</span></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it('can click Heroes link <span class="hljs-keyword">in</span> templat<span class="hljs-string">e', fakeAsync(() =&gt; {</span></div><div class="hljs-ln-line">    const heroesLinkDe = linkDes[1]; // heroes link DebugElement</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    TestBed.inject(Router).resetConfig([{path: '**<span class="hljs-string">', children: []}]);</span></div><div class="hljs-ln-line">    heroesLinkDe.triggerEventHandler('click<span class="hljs-string">', {button: 0});</span></div><div class="hljs-ln-line">    tick();</div><div class="hljs-ln-line">    fixture.detectChanges();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    expect(TestBed.inject(Router).url).toBe('/heroes<span class="hljs-string">');</span></div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="3niaoqxgz9mbp8vhp1o5y2cmz"><code>NO_ERRORS_SCHEMA</code> 告诉 Angular 编译器忽略未识别的元素和属性。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="9imjncb66929jhm9u5lbmi6ob">编译器识别 
<code>&lt;app-root&gt;</code> 元素和 
<code>routerLink</code> 属性，因为你在 
<code>TestBed</code> 配置中声明了相应的 
<code>AppComponent</code> 和 
<code>RouterLink</code>。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="s73w3qlwnv95lfbpg8sodqn0">但是当编译器遇到 
<code>&lt;app-banner&gt;</code>、
<code>&lt;app-welcome&gt;</code> 或 
<code>&lt;router-outlet&gt;</code> 时，不会抛出错误。它只是将它们渲染为空标签，浏览器会忽略它们。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="92rv6shqwij8w6w9rwlaw3lmt">你不用再提供桩组件了。</p>

  <h3 id="use-both-techniques-together">
    <a href="#use-both-techniques-together" class="docs-anchor" tabindex="-1" aria-label="Link to Use both techniques together" data-ng_translator_product="100" data-ng_translator_ref_id="26luscwauyhxs3fsg5ps6hgx2">同时使用这两项技术</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="eao68ejtfk32rgtovoyovku0y">这些是进行<em>浅层</em>测试要用到的技术，之所以叫浅层测试是因为只包含本测试所关心的这个组件模板中的元素。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="2waq11kxvdmhqrtqbf3fstjjx"><code>NO_ERRORS_SCHEMA</code> 方法是这两种方法中更简单的，但不要过度使用它。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="ckvzw5mpnb8hw8ki9u6a8wqwl"><code>NO_ERRORS_SCHEMA</code> 还会阻止编译器提醒你遗漏或拼写错误的组件和属性。你可能会浪费数小时追踪编译器本可以立即捕捉到的幽灵错误。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="5doxb0pn8rtlgjz6x8nz517ys"><em>桩组件</em>方式还有其它优点。虽然<em>这个</em>例子中的桩是空的，但你如果想要和它们用某种形式互动，也可以给它们一些裁剪过的模板和类。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="avciyrauanr9iwma6awupxhwc">在实践中，你可以在准备代码中组合使用这两种技术，例子如下。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/app.component.spec.ts" visiblelines="47,48,49,50,51,52,53,54,55,56,57" header="app/app.component.spec.ts (mixed setup)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="1oebuahrawvccg4g01d0y8c4s">app/app.component.spec.ts（混合设置）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {Component, DebugElement, NO_ERRORS_SCHEMA} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {ComponentFixture, fakeAsync, TestBed, tick, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-keyword">By</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/platform-browser'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {provideRouter, Router, RouterLink} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {AppComponent} <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appConfig} <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.config'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {UserService} <span class="hljs-keyword">from</span> <span class="hljs-string">'./model'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">@Component({standalone: <span class="hljs-keyword">true</span>, selector: <span class="hljs-string">'app-banner'</span>, <span class="hljs-keyword">template</span>: <span class="hljs-string">''</span>})</div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> BannerStubComponent {}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">@Component({standalone: <span class="hljs-keyword">true</span>, selector: <span class="hljs-string">'router-outlet'</span>, <span class="hljs-keyword">template</span>: <span class="hljs-string">''</span>})</div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> RouterOutletStubComponent {}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">@Component({standalone: <span class="hljs-keyword">true</span>, selector: <span class="hljs-string">'app-welcome'</span>, <span class="hljs-keyword">template</span>: <span class="hljs-string">''</span>})</div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> WelcomeStubComponent {}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">let comp: AppComponent;</div><div class="hljs-ln-line">let fixture: ComponentFixture&lt;AppComponent&gt;;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">describe(<span class="hljs-string">'AppComponent &amp; TestModule'</span>, () =&gt; {</div><div class="hljs-ln-line">  beforeEach(waitForAsync(() =&gt; {</div><div class="hljs-ln-line">    TestBed.configureTestingModule(</div><div class="hljs-ln-line">      <span class="hljs-keyword">Object</span>.assign({}, appConfig, {</div><div class="hljs-ln-line">        imports: [</div><div class="hljs-ln-line">          AppComponent,</div><div class="hljs-ln-line">          BannerStubComponent,</div><div class="hljs-ln-line">          RouterLink,</div><div class="hljs-ln-line">          RouterOutletStubComponent,</div><div class="hljs-ln-line">          WelcomeStubComponent,</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">        providers: [provideRouter([]), UserService],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    )</div><div class="hljs-ln-line">      .compileComponents()</div><div class="hljs-ln-line">      .<span class="hljs-keyword">then</span>(() =&gt; {</div><div class="hljs-ln-line">        fixture = TestBed.createComponent(AppComponent);</div><div class="hljs-ln-line">        comp = fixture.componentInstance;</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">  tests();</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">//////// Testing w/ NO_ERRORS_SCHEMA //////</div><div class="hljs-ln-line">describe(<span class="hljs-string">'AppComponent &amp; NO_ERRORS_SCHEMA'</span>, () =&gt; {</div><div class="hljs-ln-line">  beforeEach(waitForAsync(() =&gt; {</div><div class="hljs-ln-line">    TestBed.configureTestingModule(</div><div class="hljs-ln-line">      <span class="hljs-keyword">Object</span>.assign({}, appConfig, {</div><div class="hljs-ln-line">        imports: [</div><div class="hljs-ln-line">          AppComponent,</div><div class="hljs-ln-line">          BannerStubComponent,</div><div class="hljs-ln-line">          RouterLink,</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">        providers: [provideRouter([]), UserService],</div><div class="hljs-ln-line">        <span class="hljs-keyword">schemas</span>: [NO_ERRORS_SCHEMA],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    )</div><div class="hljs-ln-line">      .compileComponents()</div><div class="hljs-ln-line">      .<span class="hljs-keyword">then</span>(() =&gt; {</div><div class="hljs-ln-line">        fixture = TestBed.createComponent(AppComponent);</div><div class="hljs-ln-line">        comp = fixture.componentInstance;</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">  tests();</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> tests() {</div><div class="hljs-ln-line">  let routerLinks: RouterLink[];</div><div class="hljs-ln-line">  let linkDes: DebugElement[];</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  beforeEach(() =&gt; {</div><div class="hljs-ln-line">    fixture.detectChanges(); // <span class="hljs-keyword">trigger</span> initial data binding</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    // find DebugElements <span class="hljs-keyword">with</span> an attached RouterLinkStubDirective</div><div class="hljs-ln-line">    linkDes = fixture.debugElement.queryAll(<span class="hljs-keyword">By</span>.directive(RouterLink));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    // <span class="hljs-keyword">get</span> attached link directive instances</div><div class="hljs-ln-line">    // <span class="hljs-keyword">using</span> <span class="hljs-keyword">each</span> DebugElement<span class="hljs-string">'s injector</span></div><div class="hljs-ln-line">    routerLinks = linkDes.map((de) =&gt; de.injector.get(RouterLink));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it('can instantiate the component<span class="hljs-string">', () =&gt; {</span></div><div class="hljs-ln-line">    expect(comp).not.toBeNull();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it('can <span class="hljs-keyword">get</span> RouterLinks <span class="hljs-keyword">from</span> templat<span class="hljs-string">e', () =&gt; {</span></div><div class="hljs-ln-line">    expect(routerLinks.length).withContext('should have <span class="hljs-number">3</span> routerLinks<span class="hljs-string">').toBe(3);</span></div><div class="hljs-ln-line">    expect(routerLinks[0].href).toBe('/dashboard<span class="hljs-string">');</span></div><div class="hljs-ln-line">    expect(routerLinks[1].href).toBe('/heroes<span class="hljs-string">');</span></div><div class="hljs-ln-line">    expect(routerLinks[2].href).toBe('/about<span class="hljs-string">');</span></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it('can click Heroes link <span class="hljs-keyword">in</span> templat<span class="hljs-string">e', fakeAsync(() =&gt; {</span></div><div class="hljs-ln-line">    const heroesLinkDe = linkDes[1]; // heroes link DebugElement</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    TestBed.inject(Router).resetConfig([{path: '**<span class="hljs-string">', children: []}]);</span></div><div class="hljs-ln-line">    heroesLinkDe.triggerEventHandler('click<span class="hljs-string">', {button: 0});</span></div><div class="hljs-ln-line">    tick();</div><div class="hljs-ln-line">    fixture.detectChanges();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    expect(TestBed.inject(Router).url).toBe('/heroes<span class="hljs-string">');</span></div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="wre3uxtlr2ocz4y6uujpiwa9">Angular 编译器为 
<code>&lt;app-banner&gt;</code> 元素创建 
<code>BannerStubComponent</code>，并将 
<code>RouterLink</code> 应用于带有 
<code>routerLink</code> 属性的 anchor，但它会忽略 
<code>&lt;app-welcome&gt;</code> 和 
<code>&lt;router-outlet&gt;</code> 标签。</p>

  <h3 id="bydirective-and-injected-directives">
    <a href="#bydirective-and-injected-directives" class="docs-anchor" tabindex="-1" aria-label="Link to <code>By.directive</code> and injected directives" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="4dnqomcs6sfetld7m3znwer1z"><code>By.directive</code> 与注入的指令</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="9gpft9ec9qy1w4wrgwoc2f8m">再一步配置触发了数据绑定的初始化，获取导航链接的引用：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/app.component.spec.ts" visiblelines="71,72,73,74,75,76,77,78,79,80" header="app/app.component.spec.ts (test setup)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="47lbsocdgqiy5zojexgecgrr3">app/app.component.spec.ts（测试设置）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {Component, DebugElement, NO_ERRORS_SCHEMA} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {ComponentFixture, fakeAsync, TestBed, tick, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-keyword">By</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/platform-browser'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {provideRouter, Router, RouterLink} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {AppComponent} <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appConfig} <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.config'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {UserService} <span class="hljs-keyword">from</span> <span class="hljs-string">'./model'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">@Component({standalone: <span class="hljs-keyword">true</span>, selector: <span class="hljs-string">'app-banner'</span>, <span class="hljs-keyword">template</span>: <span class="hljs-string">''</span>})</div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> BannerStubComponent {}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">@Component({standalone: <span class="hljs-keyword">true</span>, selector: <span class="hljs-string">'router-outlet'</span>, <span class="hljs-keyword">template</span>: <span class="hljs-string">''</span>})</div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> RouterOutletStubComponent {}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">@Component({standalone: <span class="hljs-keyword">true</span>, selector: <span class="hljs-string">'app-welcome'</span>, <span class="hljs-keyword">template</span>: <span class="hljs-string">''</span>})</div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> WelcomeStubComponent {}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">let comp: AppComponent;</div><div class="hljs-ln-line">let fixture: ComponentFixture&lt;AppComponent&gt;;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">describe(<span class="hljs-string">'AppComponent &amp; TestModule'</span>, () =&gt; {</div><div class="hljs-ln-line">  beforeEach(waitForAsync(() =&gt; {</div><div class="hljs-ln-line">    TestBed.configureTestingModule(</div><div class="hljs-ln-line">      <span class="hljs-keyword">Object</span>.assign({}, appConfig, {</div><div class="hljs-ln-line">        imports: [</div><div class="hljs-ln-line">          AppComponent,</div><div class="hljs-ln-line">          BannerStubComponent,</div><div class="hljs-ln-line">          RouterLink,</div><div class="hljs-ln-line">          RouterOutletStubComponent,</div><div class="hljs-ln-line">          WelcomeStubComponent,</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">        providers: [provideRouter([]), UserService],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    )</div><div class="hljs-ln-line">      .compileComponents()</div><div class="hljs-ln-line">      .<span class="hljs-keyword">then</span>(() =&gt; {</div><div class="hljs-ln-line">        fixture = TestBed.createComponent(AppComponent);</div><div class="hljs-ln-line">        comp = fixture.componentInstance;</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">  tests();</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">//////// Testing w/ NO_ERRORS_SCHEMA //////</div><div class="hljs-ln-line">describe(<span class="hljs-string">'AppComponent &amp; NO_ERRORS_SCHEMA'</span>, () =&gt; {</div><div class="hljs-ln-line">  beforeEach(waitForAsync(() =&gt; {</div><div class="hljs-ln-line">    TestBed.configureTestingModule(</div><div class="hljs-ln-line">      <span class="hljs-keyword">Object</span>.assign({}, appConfig, {</div><div class="hljs-ln-line">        imports: [</div><div class="hljs-ln-line">          AppComponent,</div><div class="hljs-ln-line">          BannerStubComponent,</div><div class="hljs-ln-line">          RouterLink,</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">        providers: [provideRouter([]), UserService],</div><div class="hljs-ln-line">        <span class="hljs-keyword">schemas</span>: [NO_ERRORS_SCHEMA],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    )</div><div class="hljs-ln-line">      .compileComponents()</div><div class="hljs-ln-line">      .<span class="hljs-keyword">then</span>(() =&gt; {</div><div class="hljs-ln-line">        fixture = TestBed.createComponent(AppComponent);</div><div class="hljs-ln-line">        comp = fixture.componentInstance;</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">  tests();</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> tests() {</div><div class="hljs-ln-line">  let routerLinks: RouterLink[];</div><div class="hljs-ln-line">  let linkDes: DebugElement[];</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  beforeEach(() =&gt; {</div><div class="hljs-ln-line">    fixture.detectChanges(); // <span class="hljs-keyword">trigger</span> initial data binding</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    // find DebugElements <span class="hljs-keyword">with</span> an attached RouterLinkStubDirective</div><div class="hljs-ln-line">    linkDes = fixture.debugElement.queryAll(<span class="hljs-keyword">By</span>.directive(RouterLink));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    // <span class="hljs-keyword">get</span> attached link directive instances</div><div class="hljs-ln-line">    // <span class="hljs-keyword">using</span> <span class="hljs-keyword">each</span> DebugElement<span class="hljs-string">'s injector</span></div><div class="hljs-ln-line">    routerLinks = linkDes.map((de) =&gt; de.injector.get(RouterLink));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it('can instantiate the component<span class="hljs-string">', () =&gt; {</span></div><div class="hljs-ln-line">    expect(comp).not.toBeNull();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it('can <span class="hljs-keyword">get</span> RouterLinks <span class="hljs-keyword">from</span> templat<span class="hljs-string">e', () =&gt; {</span></div><div class="hljs-ln-line">    expect(routerLinks.length).withContext('should have <span class="hljs-number">3</span> routerLinks<span class="hljs-string">').toBe(3);</span></div><div class="hljs-ln-line">    expect(routerLinks[0].href).toBe('/dashboard<span class="hljs-string">');</span></div><div class="hljs-ln-line">    expect(routerLinks[1].href).toBe('/heroes<span class="hljs-string">');</span></div><div class="hljs-ln-line">    expect(routerLinks[2].href).toBe('/about<span class="hljs-string">');</span></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it('can click Heroes link <span class="hljs-keyword">in</span> templat<span class="hljs-string">e', fakeAsync(() =&gt; {</span></div><div class="hljs-ln-line">    const heroesLinkDe = linkDes[1]; // heroes link DebugElement</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    TestBed.inject(Router).resetConfig([{path: '**<span class="hljs-string">', children: []}]);</span></div><div class="hljs-ln-line">    heroesLinkDe.triggerEventHandler('click<span class="hljs-string">', {button: 0});</span></div><div class="hljs-ln-line">    tick();</div><div class="hljs-ln-line">    fixture.detectChanges();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    expect(TestBed.inject(Router).url).toBe('/heroes<span class="hljs-string">');</span></div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="3u9fdsznbwxcnxjxy6ncfdjsc">有三点特别重要：</p>

  <ul class="docs-list">
    <li data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="36vn7ez0zlzzu1qdmzu8m1b07">你可以使用 <code>By.directive</code> 来定位一个带附属指令的链接元素。</li>
<li data-ng_translator_product="100" data-ng_translator_ref_id="atvwchmi5h4s9tpta4lnuy541">查询返回匹配元素周围的 
<code>DebugElement</code> 包装器</li>
<li data-ng_translator_product="100" data-ng_translator_ref_id="4vlec2vtfzoqby8wayof0osv8">每个 
<code>DebugElement</code> 都暴露一个依赖注入器，并将特定实例的指令附着到该元素</li>

  </ul>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="6adft3lczl7lmru73jdcq4z40"><code>AppComponent</code> 中要验证的链接如下：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/app.component.html" visiblelines="2,3,4,5,6" header="app/app.component.html (navigation links)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="20it0vqtzmnrczhjpbcaob6ra">app/app.component.html（导航链接）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-tag">&lt;<span class="hljs-name">app-banner</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">app-banner</span>&gt;</span></div><div class="hljs-ln-line"><span class="hljs-tag">&lt;<span class="hljs-name">app-welcome</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">app-welcome</span>&gt;</span></div><div class="hljs-ln-line"><span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span></div><div class="hljs-ln-line">  <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">routerLink</span>=<span class="hljs-string">"/dashboard"</span>&gt;</span>Dashboard<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></div><div class="hljs-ln-line">  <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">routerLink</span>=<span class="hljs-string">"/heroes"</span>&gt;</span>Heroes<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></div><div class="hljs-ln-line">  <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">routerLink</span>=<span class="hljs-string">"/about"</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></div><div class="hljs-ln-line"><span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span></div><div class="hljs-ln-line"><span class="hljs-tag">&lt;<span class="hljs-name">router-outlet</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">router-outlet</span>&gt;</span></div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="8hlg8mqr59ad4h8capzegmw82">这里有一些测试，确认这些链接按预期连接到了 
<code>routerLink</code> 指令：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/app.component.spec.ts" visiblelines="86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102" header="app/app.component.spec.ts (selected tests)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="57hi3gjhzscc01djoqiq66szg">app/app.component.spec.ts（选定的测试）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {Component, DebugElement, NO_ERRORS_SCHEMA} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {ComponentFixture, fakeAsync, TestBed, tick, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-keyword">By</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/platform-browser'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {provideRouter, Router, RouterLink} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {AppComponent} <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appConfig} <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.config'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {UserService} <span class="hljs-keyword">from</span> <span class="hljs-string">'./model'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">@Component({standalone: <span class="hljs-keyword">true</span>, selector: <span class="hljs-string">'app-banner'</span>, <span class="hljs-keyword">template</span>: <span class="hljs-string">''</span>})</div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> BannerStubComponent {}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">@Component({standalone: <span class="hljs-keyword">true</span>, selector: <span class="hljs-string">'router-outlet'</span>, <span class="hljs-keyword">template</span>: <span class="hljs-string">''</span>})</div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> RouterOutletStubComponent {}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">@Component({standalone: <span class="hljs-keyword">true</span>, selector: <span class="hljs-string">'app-welcome'</span>, <span class="hljs-keyword">template</span>: <span class="hljs-string">''</span>})</div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> WelcomeStubComponent {}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">let comp: AppComponent;</div><div class="hljs-ln-line">let fixture: ComponentFixture&lt;AppComponent&gt;;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">describe(<span class="hljs-string">'AppComponent &amp; TestModule'</span>, () =&gt; {</div><div class="hljs-ln-line">  beforeEach(waitForAsync(() =&gt; {</div><div class="hljs-ln-line">    TestBed.configureTestingModule(</div><div class="hljs-ln-line">      <span class="hljs-keyword">Object</span>.assign({}, appConfig, {</div><div class="hljs-ln-line">        imports: [</div><div class="hljs-ln-line">          AppComponent,</div><div class="hljs-ln-line">          BannerStubComponent,</div><div class="hljs-ln-line">          RouterLink,</div><div class="hljs-ln-line">          RouterOutletStubComponent,</div><div class="hljs-ln-line">          WelcomeStubComponent,</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">        providers: [provideRouter([]), UserService],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    )</div><div class="hljs-ln-line">      .compileComponents()</div><div class="hljs-ln-line">      .<span class="hljs-keyword">then</span>(() =&gt; {</div><div class="hljs-ln-line">        fixture = TestBed.createComponent(AppComponent);</div><div class="hljs-ln-line">        comp = fixture.componentInstance;</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">  tests();</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">//////// Testing w/ NO_ERRORS_SCHEMA //////</div><div class="hljs-ln-line">describe(<span class="hljs-string">'AppComponent &amp; NO_ERRORS_SCHEMA'</span>, () =&gt; {</div><div class="hljs-ln-line">  beforeEach(waitForAsync(() =&gt; {</div><div class="hljs-ln-line">    TestBed.configureTestingModule(</div><div class="hljs-ln-line">      <span class="hljs-keyword">Object</span>.assign({}, appConfig, {</div><div class="hljs-ln-line">        imports: [</div><div class="hljs-ln-line">          AppComponent,</div><div class="hljs-ln-line">          BannerStubComponent,</div><div class="hljs-ln-line">          RouterLink,</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">        providers: [provideRouter([]), UserService],</div><div class="hljs-ln-line">        <span class="hljs-keyword">schemas</span>: [NO_ERRORS_SCHEMA],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    )</div><div class="hljs-ln-line">      .compileComponents()</div><div class="hljs-ln-line">      .<span class="hljs-keyword">then</span>(() =&gt; {</div><div class="hljs-ln-line">        fixture = TestBed.createComponent(AppComponent);</div><div class="hljs-ln-line">        comp = fixture.componentInstance;</div><div class="hljs-ln-line">      });</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">  tests();</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> tests() {</div><div class="hljs-ln-line">  let routerLinks: RouterLink[];</div><div class="hljs-ln-line">  let linkDes: DebugElement[];</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  beforeEach(() =&gt; {</div><div class="hljs-ln-line">    fixture.detectChanges(); // <span class="hljs-keyword">trigger</span> initial data binding</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    // find DebugElements <span class="hljs-keyword">with</span> an attached RouterLinkStubDirective</div><div class="hljs-ln-line">    linkDes = fixture.debugElement.queryAll(<span class="hljs-keyword">By</span>.directive(RouterLink));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    // <span class="hljs-keyword">get</span> attached link directive instances</div><div class="hljs-ln-line">    // <span class="hljs-keyword">using</span> <span class="hljs-keyword">each</span> DebugElement<span class="hljs-string">'s injector</span></div><div class="hljs-ln-line">    routerLinks = linkDes.map((de) =&gt; de.injector.get(RouterLink));</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it('can instantiate the component<span class="hljs-string">', () =&gt; {</span></div><div class="hljs-ln-line">    expect(comp).not.toBeNull();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it('can <span class="hljs-keyword">get</span> RouterLinks <span class="hljs-keyword">from</span> templat<span class="hljs-string">e', () =&gt; {</span></div><div class="hljs-ln-line">    expect(routerLinks.length).withContext('should have <span class="hljs-number">3</span> routerLinks<span class="hljs-string">').toBe(3);</span></div><div class="hljs-ln-line">    expect(routerLinks[0].href).toBe('/dashboard<span class="hljs-string">');</span></div><div class="hljs-ln-line">    expect(routerLinks[1].href).toBe('/heroes<span class="hljs-string">');</span></div><div class="hljs-ln-line">    expect(routerLinks[2].href).toBe('/about<span class="hljs-string">');</span></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  it('can click Heroes link <span class="hljs-keyword">in</span> templat<span class="hljs-string">e', fakeAsync(() =&gt; {</span></div><div class="hljs-ln-line">    const heroesLinkDe = linkDes[1]; // heroes link DebugElement</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    TestBed.inject(Router).resetConfig([{path: '**<span class="hljs-string">', children: []}]);</span></div><div class="hljs-ln-line">    heroesLinkDe.triggerEventHandler('click<span class="hljs-string">', {button: 0});</span></div><div class="hljs-ln-line">    tick();</div><div class="hljs-ln-line">    fixture.detectChanges();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    expect(TestBed.inject(Router).url).toBe('/heroes<span class="hljs-string">');</span></div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
  <h2 id="use-a-page-object">
    <a href="#use-a-page-object" class="docs-anchor" tabindex="-1" aria-label="Link to Use a <code>page</code> object" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="d9qje71zra5eyw9hom3ehkiki">使用 <code>page</code> 对象</a>
  </h2>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="8c4x7ggqu8w6ltj4fmea6is95"><code>HeroDetailComponent</code> 是带有标题、两个英雄字段和两个按钮的简单视图。</p>
<img alt="HeroDetailComponent in action" src="assets/images/guide/testing/hero-detail.component.png">

<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="4rge93bafozg97ktx4m3w76q">但即使是这么简单的表单，其模板中也涉及到不少复杂性。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/hero/hero-detail.component.html" header="app/hero/hero-detail.component.html">
    <div class="docs-code-header"><h3>app/hero/hero-detail.component.html</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="language-xml">@if (hero) {</span></div><div class="hljs-ln-line">  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></div><div class="hljs-ln-line">    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span></div><div class="hljs-ln-line">      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-template-variable">{{ <span class="hljs-name">hero.name</span> | titlecase }}</span><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span> Details</span></div><div class="hljs-ln-line">    <span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></div><div class="hljs-ln-line">    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>id: <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-template-variable">{{ <span class="hljs-name">hero.id</span> }}</span><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span></div><div class="hljs-ln-line">    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></div><div class="hljs-ln-line">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">"name"</span>&gt;</span>name: <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></div><div class="hljs-ln-line">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"name"</span> [(<span class="hljs-attr">ngModel</span>)]=<span class="hljs-string">"hero.name"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"name"</span> /&gt;</span></div><div class="hljs-ln-line">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></div><div class="hljs-ln-line">    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> (<span class="hljs-attr">click</span>)=<span class="hljs-string">"save()"</span>&gt;</span>Save<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></div><div class="hljs-ln-line">    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> (<span class="hljs-attr">click</span>)=<span class="hljs-string">"cancel()"</span>&gt;</span>Cancel<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></div><div class="hljs-ln-line">  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="cg10ynzbf8uf2rxb3o9lph6p1">这些供练习用的组件需要 ……</p>

  <ul class="docs-list">
    <li data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="eq1tj4793dhnlbpsa1wbsw5kz">等获取到英雄之后才能让元素出现在 DOM 中</li>
<li data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="5cu598a72n1z7fsn2tn8jit1l">一个对标题文本的引用</li>
<li data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="bd2zgtj8zktg78ituhv1p2rft">一个对 name 输入框的引用，以便对它进行探查和修改</li>
<li data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="uy3kwhnrvtt1fg1dqjsyeo2v">引用两个按钮，以便点击它们</li>
<li data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="bp3iz6dv31ps5x30zu471f1dc">为组件和路由器的方法安插间谍</li>

  </ul>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="bdv1cg0mw1m9xwdiukwh5wpfo">即使是像这样一个很小的表单，也能产生令人疯狂的错综复杂的条件设置和 CSS 元素选择。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="am5sj0d79q0n6r9agf082vr6k">通过一个 
<code>Page</code> 类控制复杂性，该类处理对组件属性的访问并封装设置它们的逻辑。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="67uuvaycjhu2omwzp1ew8ps1q">下面是一个供 <code>hero-detail.component.spec.ts</code> 使用的 <code>Page</code> 类</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/hero/hero-detail.component.spec.ts" visiblelines="256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,272,273,274,275,276,277,278,279,280,281,282" header="app/hero/hero-detail.component.spec.ts (Page)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="48d62vtsabck3zqpkjbxji9p8">app/hero/hero-detail.component.spec.ts（页面）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpClient</span>, <span class="hljs-title class_">HttpHandler</span>, provideHttpClient} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpTestingController</span>, provideHttpClientTesting} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, <span class="hljs-title class_">TestBed</span>, tick} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {provideRouter, <span class="hljs-title class_">Router</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">RouterTestingHarness</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {asyncData, click} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {sharedImports} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/shared'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroListComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-list.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Testing Vars //////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">harness</span>: <span class="hljs-title class_">RouterTestingHarness</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">page</span>: <span class="hljs-title class_">Page</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Tests //////</span></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'HeroDetailComponent'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with HeroModule setup'</span>, heroModuleSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when override its provided HeroDetailService'</span>, overrideSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with FormsModule setup'</span>, formsModuleSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with SharedModule setup'</span>, sharedModuleSetup);</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">///////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">const</span> testHero = <span class="hljs-title function_">getTestHeroes</span>()[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">overrideSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroDetailServiceSpy</span> {</div><div class="hljs-ln-line">    <span class="hljs-attr">testHero</span>: <span class="hljs-title class_">Hero</span> = {...testHero};</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">/* emit cloned test hero */</span></div><div class="hljs-ln-line">    getHero = jasmine</div><div class="hljs-ln-line">      .<span class="hljs-title function_">createSpy</span>(<span class="hljs-string">'getHero'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-property">and</span>.<span class="hljs-title function_">callFake</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, <span class="hljs-variable language_">this</span>.<span class="hljs-property">testHero</span>)));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">/* emit clone of test hero, with changes merged in */</span></div><div class="hljs-ln-line">    saveHero = jasmine</div><div class="hljs-ln-line">      .<span class="hljs-title function_">createSpy</span>(<span class="hljs-string">'saveHero'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-property">and</span>.<span class="hljs-title function_">callFake</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">testHero</span>, hero)));</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">HeroListComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroListComponent</span>},</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>},</div><div class="hljs-ln-line">          ]),</div><div class="hljs-ln-line">          <span class="hljs-title class_">HttpClient</span>,</div><div class="hljs-ln-line">          <span class="hljs-title class_">HttpHandler</span>,</div><div class="hljs-ln-line">          <span class="hljs-comment">// HeroDetailService at this level is IRRELEVANT!</span></div><div class="hljs-ln-line">          {<span class="hljs-attr">provide</span>: <span class="hljs-title class_">HeroDetailService</span>, <span class="hljs-attr">useValue</span>: {}},</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    )</div><div class="hljs-ln-line">      .<span class="hljs-title function_">overrideComponent</span>(<span class="hljs-title class_">HeroDetailComponent</span>, {</div><div class="hljs-ln-line">        <span class="hljs-attr">set</span>: {<span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">HeroDetailService</span>, <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">HeroDetailServiceSpy</span>}]},</div><div class="hljs-ln-line">      })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">hdsSpy</span>: <span class="hljs-title class_">HeroDetailServiceSpy</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">    component = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${testHero.id}</span>`</span>, <span class="hljs-title class_">HeroDetailComponent</span>);</div><div class="hljs-ln-line">    page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>();</div><div class="hljs-ln-line">    <span class="hljs-comment">// get the component's injected HeroDetailServiceSpy</span></div><div class="hljs-ln-line">    hdsSpy = harness.<span class="hljs-property">routeDebugElement</span>!.<span class="hljs-property">injector</span>.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">HeroDetailService</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should have called `getHero`'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">getHero</span>.<span class="hljs-property">calls</span>.<span class="hljs-title function_">count</span>())</div><div class="hljs-ln-line">      .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getHero called once'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'getHero called once'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display stub hero's name"</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should save stub hero change'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> origName = hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>;</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> newName = <span class="hljs-string">'New Name'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    page.<span class="hljs-property">nameInput</span>.<span class="hljs-property">value</span> = newName;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    page.<span class="hljs-property">nameInput</span>.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'input'</span>)); <span class="hljs-comment">// tell Angular</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(component.<span class="hljs-property">hero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'component hero has new name'</span>).<span class="hljs-title function_">toBe</span>(newName);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'service hero unchanged before save'</span>).<span class="hljs-title function_">toBe</span>(origName);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">saveHero</span>.<span class="hljs-property">calls</span>.<span class="hljs-title function_">count</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'saveHero called once'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// wait for async save to complete</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'service hero has new name after save'</span>).<span class="hljs-title function_">toBe</span>(newName);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes'</span>);</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////////////////////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {getTestHeroes} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/testing/test-hero.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">const</span> firstHero = <span class="hljs-title function_">getTestHeroes</span>()[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">heroModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">HeroListComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>},</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroListComponent</span>},</div><div class="hljs-ln-line">          ]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when navigate to existing hero'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">expectedHero</span>: <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      expectedHero = firstHero;</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display that hero's name"</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should navigate when click cancel'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">cancelBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${expectedHero.id}</span>`</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should save when click save but not navigate immediately'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>({<span class="hljs-attr">method</span>: <span class="hljs-string">'PUT'</span>, <span class="hljs-attr">url</span>: <span class="hljs-string">'api/heroes'</span>}));</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes/41'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should navigate when click save and save resolves'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// wait for async save to complete</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes/41'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should convert hero name to Title Case'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// get the name's input and display elements from the DOM</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">hostElement</span>: <span class="hljs-title class_">HTMLElement</span> = harness.<span class="hljs-property">routeNativeElement</span>!;</div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">nameInput</span>: <span class="hljs-title class_">HTMLInputElement</span> = hostElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'input'</span>)!;</div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">nameDisplay</span>: <span class="hljs-title class_">HTMLElement</span> = hostElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'span'</span>)!;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// simulate user entering a new name into the input box</span></div><div class="hljs-ln-line">      nameInput.<span class="hljs-property">value</span> = <span class="hljs-string">'quick BROWN  fOx'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// Dispatch a DOM event so that Angular learns of input value change.</span></div><div class="hljs-ln-line">      nameInput.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'input'</span>));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// Tell Angular to update the display binding through the title pipe</span></div><div class="hljs-ln-line">      harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(nameDisplay.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'Quick Brown  Fox'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when navigate to non-existent hero id'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(<span class="hljs-number">999</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should try to navigate back to hero list'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/////////////////////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">FormsModule</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/forms'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TitleCasePipe</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/title-case.pipe'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appConfig} <span class="hljs-keyword">from</span> <span class="hljs-string">'../app.config'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">formsModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">FormsModule</span>, <span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">TitleCasePipe</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}]),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display 1st hero's name"</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedHero = firstHero;</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">///////////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sharedModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, sharedImports],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display 1st hero's name"</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedHero = firstHero;</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/////////// Helpers /////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/** Create the HeroDetailComponent, initialize it, set test variables  */</span></div><div class="hljs-ln-line"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createComponent</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {</div><div class="hljs-ln-line">  harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">  component = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${id}</span>`</span>, <span class="hljs-title class_">HeroDetailComponent</span>);</div><div class="hljs-ln-line">  page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> request = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>(<span class="hljs-string">`api/heroes/?id=<span class="hljs-subst">${id}</span>`</span>);</div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> hero = <span class="hljs-title function_">getTestHeroes</span>().<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">h</span>) =&gt;</span> h.<span class="hljs-property">id</span> === <span class="hljs-title class_">Number</span>(id));</div><div class="hljs-ln-line">  request.<span class="hljs-title function_">flush</span>(hero ? [hero] : []);</div><div class="hljs-ln-line">  harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Page</span> {</div><div class="hljs-ln-line">  <span class="hljs-comment">// getter properties wait to query the DOM until called.</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">buttons</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">queryAll</span>&lt;<span class="hljs-title class_">HTMLButtonElement</span>&gt;(<span class="hljs-string">'button'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">saveBtn</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buttons</span>[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">cancelBtn</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buttons</span>[<span class="hljs-number">1</span>];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">nameDisplay</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>&lt;<span class="hljs-title class_">HTMLElement</span>&gt;(<span class="hljs-string">'span'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">nameInput</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>&lt;<span class="hljs-title class_">HTMLInputElement</span>&gt;(<span class="hljs-string">'input'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">//// query helpers ////</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> query&lt;T&gt;(<span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>): T {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelector</span>(selector)! <span class="hljs-keyword">as</span> T;</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> queryAll&lt;T&gt;(<span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>): T[] {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelectorAll</span>(selector) <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span> <span class="hljs-keyword">as</span> T[];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="36jp2xbsoqvhvygu6k3mx1u2">现在，用来操作和检查组件的重要钩子都被井然有序的组织起来了，可以通过 <code>page</code> 实例来使用它们。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="1vwsiylzx9skc4a4e226q177b"><code>createComponent</code> 方法创建一个 
<code>page</code> 对象，并在 
<code>hero</code> 到达后填补空缺。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/hero/hero-detail.component.spec.ts" visiblelines="245,246,247,248,249,250,251,252,253,254" header="app/hero/hero-detail.component.spec.ts (createComponent)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="6rsg2igpxuio6ari7zvhlnogj">app/hero/hero-detail.component.spec.ts（createComponent）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpClient</span>, <span class="hljs-title class_">HttpHandler</span>, provideHttpClient} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpTestingController</span>, provideHttpClientTesting} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, <span class="hljs-title class_">TestBed</span>, tick} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {provideRouter, <span class="hljs-title class_">Router</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">RouterTestingHarness</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {asyncData, click} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {sharedImports} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/shared'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroListComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-list.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Testing Vars //////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">harness</span>: <span class="hljs-title class_">RouterTestingHarness</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">page</span>: <span class="hljs-title class_">Page</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Tests //////</span></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'HeroDetailComponent'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with HeroModule setup'</span>, heroModuleSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when override its provided HeroDetailService'</span>, overrideSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with FormsModule setup'</span>, formsModuleSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with SharedModule setup'</span>, sharedModuleSetup);</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">///////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">const</span> testHero = <span class="hljs-title function_">getTestHeroes</span>()[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">overrideSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroDetailServiceSpy</span> {</div><div class="hljs-ln-line">    <span class="hljs-attr">testHero</span>: <span class="hljs-title class_">Hero</span> = {...testHero};</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">/* emit cloned test hero */</span></div><div class="hljs-ln-line">    getHero = jasmine</div><div class="hljs-ln-line">      .<span class="hljs-title function_">createSpy</span>(<span class="hljs-string">'getHero'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-property">and</span>.<span class="hljs-title function_">callFake</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, <span class="hljs-variable language_">this</span>.<span class="hljs-property">testHero</span>)));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">/* emit clone of test hero, with changes merged in */</span></div><div class="hljs-ln-line">    saveHero = jasmine</div><div class="hljs-ln-line">      .<span class="hljs-title function_">createSpy</span>(<span class="hljs-string">'saveHero'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-property">and</span>.<span class="hljs-title function_">callFake</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">testHero</span>, hero)));</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">HeroListComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroListComponent</span>},</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>},</div><div class="hljs-ln-line">          ]),</div><div class="hljs-ln-line">          <span class="hljs-title class_">HttpClient</span>,</div><div class="hljs-ln-line">          <span class="hljs-title class_">HttpHandler</span>,</div><div class="hljs-ln-line">          <span class="hljs-comment">// HeroDetailService at this level is IRRELEVANT!</span></div><div class="hljs-ln-line">          {<span class="hljs-attr">provide</span>: <span class="hljs-title class_">HeroDetailService</span>, <span class="hljs-attr">useValue</span>: {}},</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    )</div><div class="hljs-ln-line">      .<span class="hljs-title function_">overrideComponent</span>(<span class="hljs-title class_">HeroDetailComponent</span>, {</div><div class="hljs-ln-line">        <span class="hljs-attr">set</span>: {<span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">HeroDetailService</span>, <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">HeroDetailServiceSpy</span>}]},</div><div class="hljs-ln-line">      })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">hdsSpy</span>: <span class="hljs-title class_">HeroDetailServiceSpy</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">    component = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${testHero.id}</span>`</span>, <span class="hljs-title class_">HeroDetailComponent</span>);</div><div class="hljs-ln-line">    page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>();</div><div class="hljs-ln-line">    <span class="hljs-comment">// get the component's injected HeroDetailServiceSpy</span></div><div class="hljs-ln-line">    hdsSpy = harness.<span class="hljs-property">routeDebugElement</span>!.<span class="hljs-property">injector</span>.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">HeroDetailService</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should have called `getHero`'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">getHero</span>.<span class="hljs-property">calls</span>.<span class="hljs-title function_">count</span>())</div><div class="hljs-ln-line">      .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getHero called once'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'getHero called once'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display stub hero's name"</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should save stub hero change'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> origName = hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>;</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> newName = <span class="hljs-string">'New Name'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    page.<span class="hljs-property">nameInput</span>.<span class="hljs-property">value</span> = newName;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    page.<span class="hljs-property">nameInput</span>.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'input'</span>)); <span class="hljs-comment">// tell Angular</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(component.<span class="hljs-property">hero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'component hero has new name'</span>).<span class="hljs-title function_">toBe</span>(newName);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'service hero unchanged before save'</span>).<span class="hljs-title function_">toBe</span>(origName);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">saveHero</span>.<span class="hljs-property">calls</span>.<span class="hljs-title function_">count</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'saveHero called once'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// wait for async save to complete</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'service hero has new name after save'</span>).<span class="hljs-title function_">toBe</span>(newName);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes'</span>);</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////////////////////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {getTestHeroes} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/testing/test-hero.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">const</span> firstHero = <span class="hljs-title function_">getTestHeroes</span>()[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">heroModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">HeroListComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>},</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroListComponent</span>},</div><div class="hljs-ln-line">          ]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when navigate to existing hero'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">expectedHero</span>: <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      expectedHero = firstHero;</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display that hero's name"</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should navigate when click cancel'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">cancelBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${expectedHero.id}</span>`</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should save when click save but not navigate immediately'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>({<span class="hljs-attr">method</span>: <span class="hljs-string">'PUT'</span>, <span class="hljs-attr">url</span>: <span class="hljs-string">'api/heroes'</span>}));</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes/41'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should navigate when click save and save resolves'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// wait for async save to complete</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes/41'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should convert hero name to Title Case'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// get the name's input and display elements from the DOM</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">hostElement</span>: <span class="hljs-title class_">HTMLElement</span> = harness.<span class="hljs-property">routeNativeElement</span>!;</div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">nameInput</span>: <span class="hljs-title class_">HTMLInputElement</span> = hostElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'input'</span>)!;</div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">nameDisplay</span>: <span class="hljs-title class_">HTMLElement</span> = hostElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'span'</span>)!;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// simulate user entering a new name into the input box</span></div><div class="hljs-ln-line">      nameInput.<span class="hljs-property">value</span> = <span class="hljs-string">'quick BROWN  fOx'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// Dispatch a DOM event so that Angular learns of input value change.</span></div><div class="hljs-ln-line">      nameInput.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'input'</span>));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// Tell Angular to update the display binding through the title pipe</span></div><div class="hljs-ln-line">      harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(nameDisplay.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'Quick Brown  Fox'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when navigate to non-existent hero id'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(<span class="hljs-number">999</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should try to navigate back to hero list'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/////////////////////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">FormsModule</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/forms'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TitleCasePipe</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/title-case.pipe'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appConfig} <span class="hljs-keyword">from</span> <span class="hljs-string">'../app.config'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">formsModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">FormsModule</span>, <span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">TitleCasePipe</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}]),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display 1st hero's name"</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedHero = firstHero;</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">///////////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sharedModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, sharedImports],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display 1st hero's name"</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedHero = firstHero;</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/////////// Helpers /////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/** Create the HeroDetailComponent, initialize it, set test variables  */</span></div><div class="hljs-ln-line"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createComponent</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {</div><div class="hljs-ln-line">  harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">  component = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${id}</span>`</span>, <span class="hljs-title class_">HeroDetailComponent</span>);</div><div class="hljs-ln-line">  page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> request = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>(<span class="hljs-string">`api/heroes/?id=<span class="hljs-subst">${id}</span>`</span>);</div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> hero = <span class="hljs-title function_">getTestHeroes</span>().<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">h</span>) =&gt;</span> h.<span class="hljs-property">id</span> === <span class="hljs-title class_">Number</span>(id));</div><div class="hljs-ln-line">  request.<span class="hljs-title function_">flush</span>(hero ? [hero] : []);</div><div class="hljs-ln-line">  harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Page</span> {</div><div class="hljs-ln-line">  <span class="hljs-comment">// getter properties wait to query the DOM until called.</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">buttons</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">queryAll</span>&lt;<span class="hljs-title class_">HTMLButtonElement</span>&gt;(<span class="hljs-string">'button'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">saveBtn</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buttons</span>[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">cancelBtn</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buttons</span>[<span class="hljs-number">1</span>];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">nameDisplay</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>&lt;<span class="hljs-title class_">HTMLElement</span>&gt;(<span class="hljs-string">'span'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">nameInput</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>&lt;<span class="hljs-title class_">HTMLInputElement</span>&gt;(<span class="hljs-string">'input'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">//// query helpers ////</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> query&lt;T&gt;(<span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>): T {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelector</span>(selector)! <span class="hljs-keyword">as</span> T;</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> queryAll&lt;T&gt;(<span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>): T[] {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelectorAll</span>(selector) <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span> <span class="hljs-keyword">as</span> T[];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="akwr9l1qosfrfbwuaphrwh27b">还有更多的 <code>HeroDetailComponent</code> 测试可以证明这一点。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/hero/hero-detail.component.spec.ts" visiblelines="139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176" header="app/hero/hero-detail.component.spec.ts (selected tests)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="80rdj6kztasiy87ualgwxx5t8">app/hero/hero-detail.component.spec.ts（选定的测试）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpClient</span>, <span class="hljs-title class_">HttpHandler</span>, provideHttpClient} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpTestingController</span>, provideHttpClientTesting} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, <span class="hljs-title class_">TestBed</span>, tick} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {provideRouter, <span class="hljs-title class_">Router</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">RouterTestingHarness</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {asyncData, click} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {sharedImports} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/shared'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroListComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-list.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Testing Vars //////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">harness</span>: <span class="hljs-title class_">RouterTestingHarness</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">page</span>: <span class="hljs-title class_">Page</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Tests //////</span></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'HeroDetailComponent'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with HeroModule setup'</span>, heroModuleSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when override its provided HeroDetailService'</span>, overrideSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with FormsModule setup'</span>, formsModuleSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with SharedModule setup'</span>, sharedModuleSetup);</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">///////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">const</span> testHero = <span class="hljs-title function_">getTestHeroes</span>()[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">overrideSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroDetailServiceSpy</span> {</div><div class="hljs-ln-line">    <span class="hljs-attr">testHero</span>: <span class="hljs-title class_">Hero</span> = {...testHero};</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">/* emit cloned test hero */</span></div><div class="hljs-ln-line">    getHero = jasmine</div><div class="hljs-ln-line">      .<span class="hljs-title function_">createSpy</span>(<span class="hljs-string">'getHero'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-property">and</span>.<span class="hljs-title function_">callFake</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, <span class="hljs-variable language_">this</span>.<span class="hljs-property">testHero</span>)));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">/* emit clone of test hero, with changes merged in */</span></div><div class="hljs-ln-line">    saveHero = jasmine</div><div class="hljs-ln-line">      .<span class="hljs-title function_">createSpy</span>(<span class="hljs-string">'saveHero'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-property">and</span>.<span class="hljs-title function_">callFake</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">testHero</span>, hero)));</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">HeroListComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroListComponent</span>},</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>},</div><div class="hljs-ln-line">          ]),</div><div class="hljs-ln-line">          <span class="hljs-title class_">HttpClient</span>,</div><div class="hljs-ln-line">          <span class="hljs-title class_">HttpHandler</span>,</div><div class="hljs-ln-line">          <span class="hljs-comment">// HeroDetailService at this level is IRRELEVANT!</span></div><div class="hljs-ln-line">          {<span class="hljs-attr">provide</span>: <span class="hljs-title class_">HeroDetailService</span>, <span class="hljs-attr">useValue</span>: {}},</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    )</div><div class="hljs-ln-line">      .<span class="hljs-title function_">overrideComponent</span>(<span class="hljs-title class_">HeroDetailComponent</span>, {</div><div class="hljs-ln-line">        <span class="hljs-attr">set</span>: {<span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">HeroDetailService</span>, <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">HeroDetailServiceSpy</span>}]},</div><div class="hljs-ln-line">      })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">hdsSpy</span>: <span class="hljs-title class_">HeroDetailServiceSpy</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">    component = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${testHero.id}</span>`</span>, <span class="hljs-title class_">HeroDetailComponent</span>);</div><div class="hljs-ln-line">    page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>();</div><div class="hljs-ln-line">    <span class="hljs-comment">// get the component's injected HeroDetailServiceSpy</span></div><div class="hljs-ln-line">    hdsSpy = harness.<span class="hljs-property">routeDebugElement</span>!.<span class="hljs-property">injector</span>.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">HeroDetailService</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should have called `getHero`'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">getHero</span>.<span class="hljs-property">calls</span>.<span class="hljs-title function_">count</span>())</div><div class="hljs-ln-line">      .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getHero called once'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'getHero called once'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display stub hero's name"</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should save stub hero change'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> origName = hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>;</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> newName = <span class="hljs-string">'New Name'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    page.<span class="hljs-property">nameInput</span>.<span class="hljs-property">value</span> = newName;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    page.<span class="hljs-property">nameInput</span>.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'input'</span>)); <span class="hljs-comment">// tell Angular</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(component.<span class="hljs-property">hero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'component hero has new name'</span>).<span class="hljs-title function_">toBe</span>(newName);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'service hero unchanged before save'</span>).<span class="hljs-title function_">toBe</span>(origName);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">saveHero</span>.<span class="hljs-property">calls</span>.<span class="hljs-title function_">count</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'saveHero called once'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// wait for async save to complete</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'service hero has new name after save'</span>).<span class="hljs-title function_">toBe</span>(newName);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes'</span>);</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////////////////////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {getTestHeroes} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/testing/test-hero.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">const</span> firstHero = <span class="hljs-title function_">getTestHeroes</span>()[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">heroModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">HeroListComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>},</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroListComponent</span>},</div><div class="hljs-ln-line">          ]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when navigate to existing hero'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">expectedHero</span>: <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      expectedHero = firstHero;</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display that hero's name"</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should navigate when click cancel'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">cancelBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${expectedHero.id}</span>`</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should save when click save but not navigate immediately'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>({<span class="hljs-attr">method</span>: <span class="hljs-string">'PUT'</span>, <span class="hljs-attr">url</span>: <span class="hljs-string">'api/heroes'</span>}));</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes/41'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should navigate when click save and save resolves'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// wait for async save to complete</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes/41'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should convert hero name to Title Case'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// get the name's input and display elements from the DOM</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">hostElement</span>: <span class="hljs-title class_">HTMLElement</span> = harness.<span class="hljs-property">routeNativeElement</span>!;</div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">nameInput</span>: <span class="hljs-title class_">HTMLInputElement</span> = hostElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'input'</span>)!;</div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">nameDisplay</span>: <span class="hljs-title class_">HTMLElement</span> = hostElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'span'</span>)!;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// simulate user entering a new name into the input box</span></div><div class="hljs-ln-line">      nameInput.<span class="hljs-property">value</span> = <span class="hljs-string">'quick BROWN  fOx'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// Dispatch a DOM event so that Angular learns of input value change.</span></div><div class="hljs-ln-line">      nameInput.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'input'</span>));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// Tell Angular to update the display binding through the title pipe</span></div><div class="hljs-ln-line">      harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(nameDisplay.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'Quick Brown  Fox'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when navigate to non-existent hero id'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(<span class="hljs-number">999</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should try to navigate back to hero list'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/////////////////////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">FormsModule</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/forms'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TitleCasePipe</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/title-case.pipe'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appConfig} <span class="hljs-keyword">from</span> <span class="hljs-string">'../app.config'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">formsModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">FormsModule</span>, <span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">TitleCasePipe</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}]),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display 1st hero's name"</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedHero = firstHero;</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">///////////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sharedModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, sharedImports],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display 1st hero's name"</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedHero = firstHero;</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/////////// Helpers /////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/** Create the HeroDetailComponent, initialize it, set test variables  */</span></div><div class="hljs-ln-line"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createComponent</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {</div><div class="hljs-ln-line">  harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">  component = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${id}</span>`</span>, <span class="hljs-title class_">HeroDetailComponent</span>);</div><div class="hljs-ln-line">  page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> request = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>(<span class="hljs-string">`api/heroes/?id=<span class="hljs-subst">${id}</span>`</span>);</div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> hero = <span class="hljs-title function_">getTestHeroes</span>().<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">h</span>) =&gt;</span> h.<span class="hljs-property">id</span> === <span class="hljs-title class_">Number</span>(id));</div><div class="hljs-ln-line">  request.<span class="hljs-title function_">flush</span>(hero ? [hero] : []);</div><div class="hljs-ln-line">  harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Page</span> {</div><div class="hljs-ln-line">  <span class="hljs-comment">// getter properties wait to query the DOM until called.</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">buttons</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">queryAll</span>&lt;<span class="hljs-title class_">HTMLButtonElement</span>&gt;(<span class="hljs-string">'button'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">saveBtn</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buttons</span>[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">cancelBtn</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buttons</span>[<span class="hljs-number">1</span>];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">nameDisplay</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>&lt;<span class="hljs-title class_">HTMLElement</span>&gt;(<span class="hljs-string">'span'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">nameInput</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>&lt;<span class="hljs-title class_">HTMLInputElement</span>&gt;(<span class="hljs-string">'input'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">//// query helpers ////</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> query&lt;T&gt;(<span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>): T {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelector</span>(selector)! <span class="hljs-keyword">as</span> T;</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> queryAll&lt;T&gt;(<span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>): T[] {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelectorAll</span>(selector) <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span> <span class="hljs-keyword">as</span> T[];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
  <h2 id="calling-compilecomponents">
    <a href="#calling-compilecomponents" class="docs-anchor" tabindex="-1" aria-label="Link to Calling <code>compileComponents()</code>" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="56oq240vlwrcjj867ol39albx">调用 <code>compileComponents()</code></a>
  </h2>
  
    <div class="docs-alert docs-alert-helpful">
    <p data-ng_translator_product="100" data-ng_translator_ref_id="1ntnuuq7hs94miy2ahcy42t9"><strong>提示：</strong>如果你 
<em>仅</em> 运行 CLI 
<code>ng test</code> 命令的测试，可以忽略此部分，因为 CLI 会在运行测试前编译应用。</p>

    </div>
    <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="4spks1aa259148n67m7nne9k2">如果你在<strong>非 CLI 环境</strong>中运行测试，这些测试可能会报错，错误信息如下：</p>
<div class="docs-code shell">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line">Error: This test module uses the component BannerComponent</div><div class="hljs-ln-line">which is using a "templateUrl" or "styleUrls", but they were never compiled.</div><div class="hljs-ln-line">Please call "TestBed.compileComponents" before your test.</div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="aus0eq4ywpi2a5jmepvg9gysg">问题的根源在于这个测试中至少有一个组件引用了外部模板或外部 CSS 文件，就像下面这个版本的 <code>BannerComponent</code> 所示。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/banner/banner-external.component.ts" header="app/banner/banner-external.component.ts (external template &amp; css)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="6e1ragfk2ndwo12xcb9w9men8">app/banner/banner-external.component.ts（外部模板 &amp; css）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {Component} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">@Component({</div><div class="hljs-ln-line">  standalone: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">  selector: <span class="hljs-string">'app-banner'</span>,</div><div class="hljs-ln-line">  templateUrl: <span class="hljs-string">'./banner-external.component.html'</span>,</div><div class="hljs-ln-line">  styleUrls: [<span class="hljs-string">'./banner-external.component.css'</span>],</div><div class="hljs-ln-line">})</div><div class="hljs-ln-line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BannerComponent</span> {</div><div class="hljs-ln-line">  title = <span class="hljs-string">'Test Tour of Heroes'</span>;</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="ascy3vxjphyoz2461rvcwbj3g">当 
<code>TestBed</code> 尝试创建组件时，测试失败。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/banner/banner-external.component.spec.ts" visiblelines="10,11,12,13,14,15" header="app/banner/banner-external.component.spec.ts (setup that fails)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="6klzui0u0mbzsxhs8zy2w23cc">app/banner/banner-external.component.spec.ts（失败的设置）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {ComponentFixture, TestBed} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {BannerComponent} <span class="hljs-keyword">from</span> <span class="hljs-string">'./banner-external.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">describe(<span class="hljs-string">'BannerComponent (external files)'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">  let component: BannerComponent;</div><div class="hljs-ln-line">  let fixture: ComponentFixture&lt;BannerComponent&gt;;</div><div class="hljs-ln-line">  let h1: HTMLElement;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  describe(<span class="hljs-string">'setup that may fail'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    beforeEach(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> TestBed.configureTestingModule({</div><div class="hljs-ln-line">        imports: [BannerComponent],</div><div class="hljs-ln-line">      }); <span class="hljs-regexp">//</span> missing call to compileComponents()</div><div class="hljs-ln-line">      fixture = TestBed.createComponent(BannerComponent);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should create'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      expect(fixture.componentInstance).toBeDefined();</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  describe(<span class="hljs-string">'Two beforeEach'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    beforeEach(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> TestBed.configureTestingModule({</div><div class="hljs-ln-line">        imports: [BannerComponent],</div><div class="hljs-ln-line">      }).compileComponents(); <span class="hljs-regexp">//</span> compile template <span class="hljs-keyword">and</span> css</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-regexp">//</span> synchronous beforeEach</div><div class="hljs-ln-line">    beforeEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      fixture = TestBed.createComponent(BannerComponent);</div><div class="hljs-ln-line">      component = fixture.componentInstance; <span class="hljs-regexp">//</span> BannerComponent test instance</div><div class="hljs-ln-line">      h1 = fixture.nativeElement.querySelector(<span class="hljs-string">'h1'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    tests();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  describe(<span class="hljs-string">'One beforeEach'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    beforeEach(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> TestBed.configureTestingModule({</div><div class="hljs-ln-line">        imports: [BannerComponent],</div><div class="hljs-ln-line">      }).compileComponents();</div><div class="hljs-ln-line">      fixture = TestBed.createComponent(BannerComponent);</div><div class="hljs-ln-line">      component = fixture.componentInstance;</div><div class="hljs-ln-line">      h1 = fixture.nativeElement.querySelector(<span class="hljs-string">'h1'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    tests();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  function tests() {</div><div class="hljs-ln-line">    it(<span class="hljs-string">'no title in the DOM until manually call `detectChanges`'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      expect(h1.textContent).toEqual(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should display original title'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      fixture.detectChanges();</div><div class="hljs-ln-line">      expect(h1.textContent).toContain(component.title);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should display a different test title'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      component.title = <span class="hljs-string">'Test Title'</span>;</div><div class="hljs-ln-line">      fixture.detectChanges();</div><div class="hljs-ln-line">      expect(h1.textContent).toContain(<span class="hljs-string">'Test Title'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="6bd0gw5y38ppzkglz6bcyhpi9">回想一下，应用尚未编译。所以当你调用 
<code>createComponent()</code> 时，
<code>TestBed</code> 会隐式编译。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="4kwy38s3zrwla8s5sx3t4sp8r">当它的源码都在内存中的时候，这样做没问题。不过 <code>BannerComponent</code> 需要一些外部文件，编译时必须从文件系统中读取它，而这是一个天生的<em>异步</em>操作。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="44rvrz1do99vew2oj0c0xjdv6">如果允许 
<code>TestBed</code> 继续，测试将在编译器完成之前神秘地运行并失败。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="56ght0bl8zvthwq8ybbauz7te">这些错误信息告诉你要使用 <code>compileComponents()</code> 进行显式的编译。</p>

  <h3 id="compilecomponents-is-async">
    <a href="#compilecomponents-is-async" class="docs-anchor" tabindex="-1" aria-label="Link to <code>compileComponents()</code> is async" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="7dk7nawia0rg8fjkg3oh09chm"><code>compileComponents()</code> 是异步的</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="5gtaw6a789flsrbfamqxy3718">你必须在异步测试函数中调用 <code>compileComponents()</code>。</p>

    <div class="docs-alert docs-alert-critical">
    <p data-ng_translator_product="100" data-ng_translator_ref_id="dct6cudadli49ltd50p15jtlq"><strong>重要：</strong>如果你忽略了将测试函数设为异步（例如，忘记使用 
<code>waitForAsync()</code>，如所述），你将看到此错误信息</p>

    </div>
    <div class="docs-code shell">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line">Error: ViewDestroyedError: Attempt to use a destroyed view</div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="5ogf1axrgmc4dftw8mb1q70sf">典型的做法是把准备逻辑拆成两个独立的 <code>beforeEach()</code> 函数：</p>

  <div class="docs-table docs-scroll-track-transparent">
    <table>
      <thead>
        <tr>
<th align="left" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="dt2uvbdl3r7k4tmkiulzt8lb8">函数</th>
<th align="left" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="3prlgfrx5eo2xqncnnob4crxu">详情</th>
</tr>

      </thead>
      <tbody>
        <tr>
<td align="left" data-ng_translator_product="100" data-ng_translator_ref_id="du2k0ot8dd85yee4gr9zf42g4">异步 
<code>beforeEach()</code></td>
<td align="left" data-ng_translator_product="100" data-ng_translator_ref_id="c56u2iatdmxbl3gg1o92k37x5">编译组件</td>
</tr>
<tr>
<td align="left" data-ng_translator_product="100" data-ng_translator_ref_id="5g2ncw2j80y78up5ntt2dcgnn">同步 
<code>beforeEach()</code></td>
<td align="left" data-ng_translator_product="100" data-ng_translator_ref_id="3f2tdtttkscvy1a04iwgphg4w">执行剩余的设置</td>
</tr>

      </tbody>
    </table>
  </div>
  
  <h3 id="the-async-beforeeach">
    <a href="#the-async-beforeeach" class="docs-anchor" tabindex="-1" aria-label="Link to The async <code>beforeEach</code>" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="njhruait1bzaikt45w14e25n">异步的 <code>beforeEach</code></a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="6yipia3l0nnx2k5u5qld7sfo8">像下面这样编写第一个异步的 <code>beforeEach</code>。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/banner/banner-external.component.spec.ts" visiblelines="23,24,25,26,27" header="app/banner/banner-external.component.spec.ts (async beforeEach)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="6yiqa874bmacj1u0po0rqp979">app/banner/banner-external.component.spec.ts（异步 beforeEach）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {ComponentFixture, TestBed} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {BannerComponent} <span class="hljs-keyword">from</span> <span class="hljs-string">'./banner-external.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">describe(<span class="hljs-string">'BannerComponent (external files)'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">  let component: BannerComponent;</div><div class="hljs-ln-line">  let fixture: ComponentFixture&lt;BannerComponent&gt;;</div><div class="hljs-ln-line">  let h1: HTMLElement;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  describe(<span class="hljs-string">'setup that may fail'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    beforeEach(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> TestBed.configureTestingModule({</div><div class="hljs-ln-line">        imports: [BannerComponent],</div><div class="hljs-ln-line">      }); <span class="hljs-regexp">//</span> missing call to compileComponents()</div><div class="hljs-ln-line">      fixture = TestBed.createComponent(BannerComponent);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should create'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      expect(fixture.componentInstance).toBeDefined();</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  describe(<span class="hljs-string">'Two beforeEach'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    beforeEach(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> TestBed.configureTestingModule({</div><div class="hljs-ln-line">        imports: [BannerComponent],</div><div class="hljs-ln-line">      }).compileComponents(); <span class="hljs-regexp">//</span> compile template <span class="hljs-keyword">and</span> css</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-regexp">//</span> synchronous beforeEach</div><div class="hljs-ln-line">    beforeEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      fixture = TestBed.createComponent(BannerComponent);</div><div class="hljs-ln-line">      component = fixture.componentInstance; <span class="hljs-regexp">//</span> BannerComponent test instance</div><div class="hljs-ln-line">      h1 = fixture.nativeElement.querySelector(<span class="hljs-string">'h1'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    tests();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  describe(<span class="hljs-string">'One beforeEach'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    beforeEach(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> TestBed.configureTestingModule({</div><div class="hljs-ln-line">        imports: [BannerComponent],</div><div class="hljs-ln-line">      }).compileComponents();</div><div class="hljs-ln-line">      fixture = TestBed.createComponent(BannerComponent);</div><div class="hljs-ln-line">      component = fixture.componentInstance;</div><div class="hljs-ln-line">      h1 = fixture.nativeElement.querySelector(<span class="hljs-string">'h1'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    tests();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  function tests() {</div><div class="hljs-ln-line">    it(<span class="hljs-string">'no title in the DOM until manually call `detectChanges`'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      expect(h1.textContent).toEqual(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should display original title'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      fixture.detectChanges();</div><div class="hljs-ln-line">      expect(h1.textContent).toContain(component.title);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should display a different test title'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      component.title = <span class="hljs-string">'Test Title'</span>;</div><div class="hljs-ln-line">      fixture.detectChanges();</div><div class="hljs-ln-line">      expect(h1.textContent).toContain(<span class="hljs-string">'Test Title'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="br0674kkh8jvatcs9568u96sm"><code>TestBed.configureTestingModule()</code> 方法返回 
<code>TestBed</code> 类，因此你可以链式调用其他 
<code>TestBed</code> 静态方法，例如 
<code>compileComponents()</code>。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="74nyj1vf24c9jg62m1qdywmn4">在这个例子中，<code>BannerComponent</code> 是仅有的待编译组件。其它例子中可能会使用多个组件来配置测试模块，并且可能引入某些具有其它组件的应用模块。它们中的任何一个都可能需要外部文件。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="6h6g2w983h6bhw2jsuwwzdahm"><code>TestBed.compileComponents</code> 方法会异步编译测试模块中配置过的所有组件。</p>

    <div class="docs-alert docs-alert-important">
    <p data-ng_translator_product="100" data-ng_translator_ref_id="7cv68hifnb9kmsudh15mem46h"><strong>重要：</strong>在调用 
<code>compileComponents()</code> 之后不要重新配置 
<code>TestBed</code>。</p>

    </div>
    <p data-ng_translator_product="100" data-ng_translator_ref_id="732zra3bxvzfipqh1rcmt0v7p">调用 
<code>compileComponents()</code> 会关闭当前的 
<code>TestBed</code> 实例以进行进一步配置。 你不能再调用任何 
<code>TestBed</code> 配置方法，不能调用 
<code>configureTestingModule()</code> 及任何 
<code>override...</code> 方法。 如果你尝试，
<code>TestBed</code> 会抛出一个错误。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="d2ufugfuig078c4y2uihee773">确保 <code>compileComponents()</code> 是调用 <code>TestBed.createComponent()</code> 之前的最后一步。</p>

  <h3 id="the-synchronous-beforeeach">
    <a href="#the-synchronous-beforeeach" class="docs-anchor" tabindex="-1" aria-label="Link to The synchronous <code>beforeEach</code>" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="ckphykf0z3x2wguklmyepdlfj">同步的 <code>beforeEach</code></a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="ezsui7sbtsnoohc2x86089roz">第二个同步 <code>beforeEach()</code> 的例子包含剩下的准备步骤，包括创建组件和查询那些要检查的元素。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/banner/banner-external.component.spec.ts" visiblelines="30,31,32,33,34" header="app/banner/banner-external.component.spec.ts (synchronous beforeEach)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="cagv8q4e82cxvdmgdk85n0u59">app/banner/banner-external.component.spec.ts（同步 beforeEach）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {ComponentFixture, TestBed} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {BannerComponent} <span class="hljs-keyword">from</span> <span class="hljs-string">'./banner-external.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">describe(<span class="hljs-string">'BannerComponent (external files)'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">  let component: BannerComponent;</div><div class="hljs-ln-line">  let fixture: ComponentFixture&lt;BannerComponent&gt;;</div><div class="hljs-ln-line">  let h1: HTMLElement;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  describe(<span class="hljs-string">'setup that may fail'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    beforeEach(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> TestBed.configureTestingModule({</div><div class="hljs-ln-line">        imports: [BannerComponent],</div><div class="hljs-ln-line">      }); <span class="hljs-regexp">//</span> missing call to compileComponents()</div><div class="hljs-ln-line">      fixture = TestBed.createComponent(BannerComponent);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should create'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      expect(fixture.componentInstance).toBeDefined();</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  describe(<span class="hljs-string">'Two beforeEach'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    beforeEach(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> TestBed.configureTestingModule({</div><div class="hljs-ln-line">        imports: [BannerComponent],</div><div class="hljs-ln-line">      }).compileComponents(); <span class="hljs-regexp">//</span> compile template <span class="hljs-keyword">and</span> css</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-regexp">//</span> synchronous beforeEach</div><div class="hljs-ln-line">    beforeEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      fixture = TestBed.createComponent(BannerComponent);</div><div class="hljs-ln-line">      component = fixture.componentInstance; <span class="hljs-regexp">//</span> BannerComponent test instance</div><div class="hljs-ln-line">      h1 = fixture.nativeElement.querySelector(<span class="hljs-string">'h1'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    tests();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  describe(<span class="hljs-string">'One beforeEach'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    beforeEach(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> TestBed.configureTestingModule({</div><div class="hljs-ln-line">        imports: [BannerComponent],</div><div class="hljs-ln-line">      }).compileComponents();</div><div class="hljs-ln-line">      fixture = TestBed.createComponent(BannerComponent);</div><div class="hljs-ln-line">      component = fixture.componentInstance;</div><div class="hljs-ln-line">      h1 = fixture.nativeElement.querySelector(<span class="hljs-string">'h1'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    tests();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  function tests() {</div><div class="hljs-ln-line">    it(<span class="hljs-string">'no title in the DOM until manually call `detectChanges`'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      expect(h1.textContent).toEqual(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should display original title'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      fixture.detectChanges();</div><div class="hljs-ln-line">      expect(h1.textContent).toContain(component.title);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should display a different test title'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      component.title = <span class="hljs-string">'Test Title'</span>;</div><div class="hljs-ln-line">      fixture.detectChanges();</div><div class="hljs-ln-line">      expect(h1.textContent).toContain(<span class="hljs-string">'Test Title'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="dqlokmnx11k26sjpjw6hchxej">测试运行器（runner）会先等待第一个异步 <code>beforeEach</code> 函数执行完再调用第二个。</p>

  <h3 id="consolidated-setup">
    <a href="#consolidated-setup" class="docs-anchor" tabindex="-1" aria-label="Link to Consolidated setup" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="275hecw5dasswv084vnlw1hda">整合的准备代码</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="9l2iqffa5xlkod1ni7d8ytfo1">你可以把这两个 <code>beforeEach()</code> 函数重整成一个异步的 <code>beforeEach()</code>。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="2qvqxdxofpna2cl2aw95yhsi1"><code>compileComponents()</code> 方法返回一个 Promise，因此你可以在编译后通过将同步代码移动到 
<code>await</code> 关键字<em>之后</em>（Promise 已被求解）来执行同步设置任务。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/banner/banner-external.component.spec.ts" visiblelines="40,41,42,43,44,45,46,47" header="app/banner/banner-external.component.spec.ts (one beforeEach)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="5nf9v9rhc4k91sr3os5oa4iab">app/banner/banner-external.component.spec.ts（一个 beforeEach）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {ComponentFixture, TestBed} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {BannerComponent} <span class="hljs-keyword">from</span> <span class="hljs-string">'./banner-external.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">describe(<span class="hljs-string">'BannerComponent (external files)'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">  let component: BannerComponent;</div><div class="hljs-ln-line">  let fixture: ComponentFixture&lt;BannerComponent&gt;;</div><div class="hljs-ln-line">  let h1: HTMLElement;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  describe(<span class="hljs-string">'setup that may fail'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    beforeEach(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> TestBed.configureTestingModule({</div><div class="hljs-ln-line">        imports: [BannerComponent],</div><div class="hljs-ln-line">      }); <span class="hljs-regexp">//</span> missing call to compileComponents()</div><div class="hljs-ln-line">      fixture = TestBed.createComponent(BannerComponent);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should create'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      expect(fixture.componentInstance).toBeDefined();</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  describe(<span class="hljs-string">'Two beforeEach'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    beforeEach(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> TestBed.configureTestingModule({</div><div class="hljs-ln-line">        imports: [BannerComponent],</div><div class="hljs-ln-line">      }).compileComponents(); <span class="hljs-regexp">//</span> compile template <span class="hljs-keyword">and</span> css</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-regexp">//</span> synchronous beforeEach</div><div class="hljs-ln-line">    beforeEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      fixture = TestBed.createComponent(BannerComponent);</div><div class="hljs-ln-line">      component = fixture.componentInstance; <span class="hljs-regexp">//</span> BannerComponent test instance</div><div class="hljs-ln-line">      h1 = fixture.nativeElement.querySelector(<span class="hljs-string">'h1'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    tests();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  describe(<span class="hljs-string">'One beforeEach'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">    beforeEach(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> TestBed.configureTestingModule({</div><div class="hljs-ln-line">        imports: [BannerComponent],</div><div class="hljs-ln-line">      }).compileComponents();</div><div class="hljs-ln-line">      fixture = TestBed.createComponent(BannerComponent);</div><div class="hljs-ln-line">      component = fixture.componentInstance;</div><div class="hljs-ln-line">      h1 = fixture.nativeElement.querySelector(<span class="hljs-string">'h1'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    tests();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  function tests() {</div><div class="hljs-ln-line">    it(<span class="hljs-string">'no title in the DOM until manually call `detectChanges`'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      expect(h1.textContent).toEqual(<span class="hljs-string">''</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should display original title'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      fixture.detectChanges();</div><div class="hljs-ln-line">      expect(h1.textContent).toContain(component.title);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    it(<span class="hljs-string">'should display a different test title'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</div><div class="hljs-ln-line">      component.title = <span class="hljs-string">'Test Title'</span>;</div><div class="hljs-ln-line">      fixture.detectChanges();</div><div class="hljs-ln-line">      expect(h1.textContent).toContain(<span class="hljs-string">'Test Title'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
  <h3 id="compilecomponents-is-harmless">
    <a href="#compilecomponents-is-harmless" class="docs-anchor" tabindex="-1" aria-label="Link to <code>compileComponents()</code> is harmless" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="bq4x2wbiz3ms5wkidedg8n35r"><code>compileComponents()</code> 是无害的</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="9yiqkrnkkughrrs238uebn4e3">在不需要 <code>compileComponents()</code> 的时候调用它也不会有害处。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="1x6raz9ssnfk0j3sxcoq55xzt">虽然在运行 <code>ng test</code> 时永远都不需要调用 <code>compileComponents()</code>，但 CLI 生成的组件测试文件还是会调用它。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="9vrcabz52diuth4ewlrsby7em">但这篇指南中的这些测试只会在必要时才调用 <code>compileComponents</code>。</p>

  <h2 id="setup-with-module-imports">
    <a href="#setup-with-module-imports" class="docs-anchor" tabindex="-1" aria-label="Link to Setup with module imports" data-ng_translator_product="100" data-ng_translator_ref_id="3sb9tbb1jmqxi0sbrd1nwelbh">准备模块的 imports</a>
  </h2>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="5yj4pig6c3iql2s9krf4glahr">此前的组件测试程序使用了一些 <code>declarations</code> 来配置模块，就像这样：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/dashboard/dashboard-hero.component.spec.ts" visiblelines="32,33,34,35" header="app/dashboard/dashboard-hero.component.spec.ts (configure TestBed)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="6i9d5vke1101ezllbriwmibxz">app/dashboard/dashboard-hero.component.spec.ts（配置 TestBed）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">DebugElement</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">ComponentFixture</span>, <span class="hljs-title class_">TestBed</span>, waitForAsync} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">By</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/platform-browser'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {first} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {addMatchers, click} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appProviders} <span class="hljs-keyword">from</span> <span class="hljs-string">'../app.config'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">DashboardHeroComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./dashboard-hero.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">beforeEach</span>(addMatchers);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent class only'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'raises the selected event when clicked'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> comp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DashboardHeroComponent</span>();</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> <span class="hljs-attr">hero</span>: <span class="hljs-title class_">Hero</span> = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test'</span>};</div><div class="hljs-ln-line">    comp.<span class="hljs-property">hero</span> = hero;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">selectedHero: Hero</span>) =&gt;</span> <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(hero));</div><div class="hljs-ln-line">    comp.<span class="hljs-title function_">click</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent when tested directly'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">comp</span>: <span class="hljs-title class_">DashboardHeroComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">expectedHero</span>: <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">DashboardHeroComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroDe</span>: <span class="hljs-title class_">DebugElement</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: appProviders,</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>],</div><div class="hljs-ln-line">    })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">DashboardHeroComponent</span>);</div><div class="hljs-ln-line">    comp = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// find the hero's DebugElement and element</span></div><div class="hljs-ln-line">    heroDe = fixture.<span class="hljs-property">debugElement</span>.<span class="hljs-title function_">query</span>(<span class="hljs-title class_">By</span>.<span class="hljs-title function_">css</span>(<span class="hljs-string">'.hero'</span>));</div><div class="hljs-ln-line">    heroEl = heroDe.<span class="hljs-property">nativeElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// mock the hero supplied by the parent component</span></div><div class="hljs-ln-line">    expectedHero = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test Name'</span>};</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// simulate the parent setting the input property with that hero</span></div><div class="hljs-ln-line">    comp.<span class="hljs-property">hero</span> = expectedHero;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">// trigger initial data binding</span></div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display hero name in uppercase'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedPipedName = expectedHero.<span class="hljs-property">name</span>.<span class="hljs-title function_">toUpperCase</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(heroEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(expectedPipedName);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (triggerEventHandler)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    heroDe.<span class="hljs-title function_">triggerEventHandler</span>(<span class="hljs-string">'click'</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (element.click)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    heroEl.<span class="hljs-title function_">click</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (click helper with DebugElement)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroDe); <span class="hljs-comment">// click helper with DebugElement</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked (click helper with native element)'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">    comp.<span class="hljs-property">selected</span>.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">first</span>()).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> (selectedHero = hero));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroEl); <span class="hljs-comment">// click helper with native element</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(selectedHero).<span class="hljs-title function_">toBe</span>(expectedHero);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">//////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'DashboardHeroComponent when inside a test host'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">testHost</span>: <span class="hljs-title class_">TestHostComponent</span>;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">fixture</span>: <span class="hljs-title class_">ComponentFixture</span>&lt;<span class="hljs-title class_">TestHostComponent</span>&gt;;</div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">heroEl</span>: <span class="hljs-title class_">HTMLElement</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-title function_">waitForAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({</div><div class="hljs-ln-line">      <span class="hljs-attr">providers</span>: appProviders,</div><div class="hljs-ln-line">      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>, <span class="hljs-title class_">TestHostComponent</span>],</div><div class="hljs-ln-line">    })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// create TestHostComponent instead of DashboardHeroComponent</span></div><div class="hljs-ln-line">    fixture = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">TestHostComponent</span>);</div><div class="hljs-ln-line">    testHost = fixture.<span class="hljs-property">componentInstance</span>;</div><div class="hljs-ln-line">    heroEl = fixture.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.hero'</span>);</div><div class="hljs-ln-line">    fixture.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// trigger initial data binding</span></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should display hero name'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedPipedName = testHost.<span class="hljs-property">hero</span>.<span class="hljs-property">name</span>.<span class="hljs-title function_">toUpperCase</span>();</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(heroEl.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toContain</span>(expectedPipedName);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should raise selected event when clicked'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(heroEl);</div><div class="hljs-ln-line">    <span class="hljs-comment">// selected hero should be the same data bound hero</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(testHost.<span class="hljs-property">selectedHero</span>).<span class="hljs-title function_">toBe</span>(testHost.<span class="hljs-property">hero</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Test Host Component //////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Component</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-meta">@Component</span>({</div><div class="hljs-ln-line">  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DashboardHeroComponent</span>],</div><div class="hljs-ln-line">  <span class="hljs-attr">template</span>: <span class="hljs-string">` &lt;dashboard-hero [hero]="hero" (selected)="onSelected($event)"&gt; &lt;/dashboard-hero&gt;`</span>,</div><div class="hljs-ln-line">})</div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TestHostComponent</span> {</div><div class="hljs-ln-line">  <span class="hljs-attr">hero</span>: <span class="hljs-title class_">Hero</span> = {<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test Name'</span>};</div><div class="hljs-ln-line">  <span class="hljs-attr">selectedHero</span>: <span class="hljs-title class_">Hero</span> | <span class="hljs-literal">undefined</span>;</div><div class="hljs-ln-line">  <span class="hljs-title function_">onSelected</span>(<span class="hljs-params">hero: Hero</span>) {</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedHero</span> = hero;</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="c2peumleole4tzo3pimpkjfm9"><code>DashboardComponent</code> 非常简单。它不需要帮助。但是更加复杂的组件通常依赖其它组件、指令、管道和提供者，所以这些必须也被添加到测试模块中。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="7guaihkgdu4t15l55kcu2jw">幸运的是，
<code>TestBed.configureTestingModule</code> 参数与传递给 
<code>@NgModule</code> 装饰器的元数据相似，这意味着你也可以指定 
<code>providers</code> 和 
<code>imports</code>。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="aisvry9gudczwypvnzh6byu1n"><code>HeroDetailComponent</code> 尽管体积小且结构简单，但需要很多帮助。 除了默认测试模块 
<code>CommonModule</code> 提供的支持外，它还需要：</p>

  <ul class="docs-list">
    <li data-ng_translator_product="100" data-ng_translator_ref_id="bveskzoyphyolq0gn6jx9iq0c"><code>FormsModule</code> 中的 
<code>NgModel</code> 及其相关模块以启用双向数据绑定</li>
<li data-ng_translator_product="100" data-ng_translator_ref_id="99i3saefnoc91fc6safzv7dfz"><code>shared</code> 文件夹中的 
<code>TitleCasePipe</code></li>
<li data-ng_translator_product="100" data-ng_translator_ref_id="epcqqmd4fps64lqzarr97tmed">Router 服务</li>
<li data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="41hpllyksn3iof9rf1wi0wdd9">英雄数据访问这些服务</li>

  </ul>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="3rv6lwu7j7bkdaeckgqcmmx5g">一种方法是从各个部分配置测试模块，就像这样：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/hero/hero-detail.component.spec.ts" visiblelines="197,198,199,200,201,202,203,204,205,206,207,208" header="app/hero/hero-detail.component.spec.ts (FormsModule setup)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="amht9th16k1q2vmv9c8t2zhi">app/hero/hero-detail.component.spec.ts（FormsModule 设置）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpClient</span>, <span class="hljs-title class_">HttpHandler</span>, provideHttpClient} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpTestingController</span>, provideHttpClientTesting} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, <span class="hljs-title class_">TestBed</span>, tick} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {provideRouter, <span class="hljs-title class_">Router</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">RouterTestingHarness</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {asyncData, click} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {sharedImports} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/shared'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroListComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-list.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Testing Vars //////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">harness</span>: <span class="hljs-title class_">RouterTestingHarness</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">page</span>: <span class="hljs-title class_">Page</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Tests //////</span></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'HeroDetailComponent'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with HeroModule setup'</span>, heroModuleSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when override its provided HeroDetailService'</span>, overrideSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with FormsModule setup'</span>, formsModuleSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with SharedModule setup'</span>, sharedModuleSetup);</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">///////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">const</span> testHero = <span class="hljs-title function_">getTestHeroes</span>()[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">overrideSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroDetailServiceSpy</span> {</div><div class="hljs-ln-line">    <span class="hljs-attr">testHero</span>: <span class="hljs-title class_">Hero</span> = {...testHero};</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">/* emit cloned test hero */</span></div><div class="hljs-ln-line">    getHero = jasmine</div><div class="hljs-ln-line">      .<span class="hljs-title function_">createSpy</span>(<span class="hljs-string">'getHero'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-property">and</span>.<span class="hljs-title function_">callFake</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, <span class="hljs-variable language_">this</span>.<span class="hljs-property">testHero</span>)));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">/* emit clone of test hero, with changes merged in */</span></div><div class="hljs-ln-line">    saveHero = jasmine</div><div class="hljs-ln-line">      .<span class="hljs-title function_">createSpy</span>(<span class="hljs-string">'saveHero'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-property">and</span>.<span class="hljs-title function_">callFake</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">testHero</span>, hero)));</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">HeroListComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroListComponent</span>},</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>},</div><div class="hljs-ln-line">          ]),</div><div class="hljs-ln-line">          <span class="hljs-title class_">HttpClient</span>,</div><div class="hljs-ln-line">          <span class="hljs-title class_">HttpHandler</span>,</div><div class="hljs-ln-line">          <span class="hljs-comment">// HeroDetailService at this level is IRRELEVANT!</span></div><div class="hljs-ln-line">          {<span class="hljs-attr">provide</span>: <span class="hljs-title class_">HeroDetailService</span>, <span class="hljs-attr">useValue</span>: {}},</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    )</div><div class="hljs-ln-line">      .<span class="hljs-title function_">overrideComponent</span>(<span class="hljs-title class_">HeroDetailComponent</span>, {</div><div class="hljs-ln-line">        <span class="hljs-attr">set</span>: {<span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">HeroDetailService</span>, <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">HeroDetailServiceSpy</span>}]},</div><div class="hljs-ln-line">      })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">hdsSpy</span>: <span class="hljs-title class_">HeroDetailServiceSpy</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">    component = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${testHero.id}</span>`</span>, <span class="hljs-title class_">HeroDetailComponent</span>);</div><div class="hljs-ln-line">    page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>();</div><div class="hljs-ln-line">    <span class="hljs-comment">// get the component's injected HeroDetailServiceSpy</span></div><div class="hljs-ln-line">    hdsSpy = harness.<span class="hljs-property">routeDebugElement</span>!.<span class="hljs-property">injector</span>.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">HeroDetailService</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should have called `getHero`'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">getHero</span>.<span class="hljs-property">calls</span>.<span class="hljs-title function_">count</span>())</div><div class="hljs-ln-line">      .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getHero called once'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'getHero called once'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display stub hero's name"</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should save stub hero change'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> origName = hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>;</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> newName = <span class="hljs-string">'New Name'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    page.<span class="hljs-property">nameInput</span>.<span class="hljs-property">value</span> = newName;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    page.<span class="hljs-property">nameInput</span>.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'input'</span>)); <span class="hljs-comment">// tell Angular</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(component.<span class="hljs-property">hero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'component hero has new name'</span>).<span class="hljs-title function_">toBe</span>(newName);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'service hero unchanged before save'</span>).<span class="hljs-title function_">toBe</span>(origName);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">saveHero</span>.<span class="hljs-property">calls</span>.<span class="hljs-title function_">count</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'saveHero called once'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// wait for async save to complete</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'service hero has new name after save'</span>).<span class="hljs-title function_">toBe</span>(newName);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes'</span>);</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////////////////////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {getTestHeroes} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/testing/test-hero.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">const</span> firstHero = <span class="hljs-title function_">getTestHeroes</span>()[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">heroModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">HeroListComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>},</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroListComponent</span>},</div><div class="hljs-ln-line">          ]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when navigate to existing hero'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">expectedHero</span>: <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      expectedHero = firstHero;</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display that hero's name"</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should navigate when click cancel'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">cancelBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${expectedHero.id}</span>`</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should save when click save but not navigate immediately'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>({<span class="hljs-attr">method</span>: <span class="hljs-string">'PUT'</span>, <span class="hljs-attr">url</span>: <span class="hljs-string">'api/heroes'</span>}));</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes/41'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should navigate when click save and save resolves'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// wait for async save to complete</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes/41'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should convert hero name to Title Case'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// get the name's input and display elements from the DOM</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">hostElement</span>: <span class="hljs-title class_">HTMLElement</span> = harness.<span class="hljs-property">routeNativeElement</span>!;</div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">nameInput</span>: <span class="hljs-title class_">HTMLInputElement</span> = hostElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'input'</span>)!;</div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">nameDisplay</span>: <span class="hljs-title class_">HTMLElement</span> = hostElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'span'</span>)!;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// simulate user entering a new name into the input box</span></div><div class="hljs-ln-line">      nameInput.<span class="hljs-property">value</span> = <span class="hljs-string">'quick BROWN  fOx'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// Dispatch a DOM event so that Angular learns of input value change.</span></div><div class="hljs-ln-line">      nameInput.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'input'</span>));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// Tell Angular to update the display binding through the title pipe</span></div><div class="hljs-ln-line">      harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(nameDisplay.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'Quick Brown  Fox'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when navigate to non-existent hero id'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(<span class="hljs-number">999</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should try to navigate back to hero list'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/////////////////////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">FormsModule</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/forms'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TitleCasePipe</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/title-case.pipe'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appConfig} <span class="hljs-keyword">from</span> <span class="hljs-string">'../app.config'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">formsModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">FormsModule</span>, <span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">TitleCasePipe</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}]),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display 1st hero's name"</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedHero = firstHero;</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">///////////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sharedModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, sharedImports],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display 1st hero's name"</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedHero = firstHero;</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/////////// Helpers /////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/** Create the HeroDetailComponent, initialize it, set test variables  */</span></div><div class="hljs-ln-line"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createComponent</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {</div><div class="hljs-ln-line">  harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">  component = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${id}</span>`</span>, <span class="hljs-title class_">HeroDetailComponent</span>);</div><div class="hljs-ln-line">  page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> request = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>(<span class="hljs-string">`api/heroes/?id=<span class="hljs-subst">${id}</span>`</span>);</div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> hero = <span class="hljs-title function_">getTestHeroes</span>().<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">h</span>) =&gt;</span> h.<span class="hljs-property">id</span> === <span class="hljs-title class_">Number</span>(id));</div><div class="hljs-ln-line">  request.<span class="hljs-title function_">flush</span>(hero ? [hero] : []);</div><div class="hljs-ln-line">  harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Page</span> {</div><div class="hljs-ln-line">  <span class="hljs-comment">// getter properties wait to query the DOM until called.</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">buttons</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">queryAll</span>&lt;<span class="hljs-title class_">HTMLButtonElement</span>&gt;(<span class="hljs-string">'button'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">saveBtn</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buttons</span>[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">cancelBtn</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buttons</span>[<span class="hljs-number">1</span>];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">nameDisplay</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>&lt;<span class="hljs-title class_">HTMLElement</span>&gt;(<span class="hljs-string">'span'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">nameInput</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>&lt;<span class="hljs-title class_">HTMLInputElement</span>&gt;(<span class="hljs-string">'input'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">//// query helpers ////</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> query&lt;T&gt;(<span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>): T {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelector</span>(selector)! <span class="hljs-keyword">as</span> T;</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> queryAll&lt;T&gt;(<span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>): T[] {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelectorAll</span>(selector) <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span> <span class="hljs-keyword">as</span> T[];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
    <div class="docs-alert docs-alert-helpful">
    <p data-ng_translator_product="100" data-ng_translator_ref_id="k5nsyzl19c7j5743xayvey9s"><strong>提示：</strong>注意 
<code>beforeEach()</code> 是异步的，并调用 
<code>TestBed.compileComponents</code>，因为 
<code>HeroDetailComponent</code> 有一个外部模板和 css 文件。</p>

    </div>
    <p data-ng_translator_product="100" data-ng_translator_ref_id="atz4pqy66ghdofr497ftqbhsc">如 
<a href="#calling-compilecomponents">调用 <code>compileComponents()</code></a> 中所述，这些测试可以在非 CLI 环境中运行，在这种环境中 Angular 需要在浏览器中编译它们。</p>

  <h3 id="import-a-shared-module">
    <a href="#import-a-shared-module" class="docs-anchor" tabindex="-1" aria-label="Link to Import a shared module" data-ng_translator_product="100" data-ng_translator_ref_id="8j08sii3rhb6e3o6km7yvmgv6">导入共享模块</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_ref_id="8jpfjfli50yxr47hd0hn77px0">因为许多应用组件需要 
<code>FormsModule</code> 和 
<code>TitleCasePipe</code>，开发者创建了一个 
<code>SharedModule</code> 来组合这些和其他常用部分。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="2rpmit6om983te8fqk7gcx8bb">这些测试配置也可以使用 <code>SharedModule</code>，如下所示：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/hero/hero-detail.component.spec.ts" visiblelines="221,222,223,224,225,226,227,228,229,230,231,232" header="app/hero/hero-detail.component.spec.ts (SharedModule setup)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="4u7gta7iuncmqxraupf38s4n2">app/hero/hero-detail.component.spec.ts（SharedModule 设置）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpClient</span>, <span class="hljs-title class_">HttpHandler</span>, provideHttpClient} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpTestingController</span>, provideHttpClientTesting} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, <span class="hljs-title class_">TestBed</span>, tick} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {provideRouter, <span class="hljs-title class_">Router</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">RouterTestingHarness</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {asyncData, click} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {sharedImports} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/shared'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroListComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-list.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Testing Vars //////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">harness</span>: <span class="hljs-title class_">RouterTestingHarness</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">page</span>: <span class="hljs-title class_">Page</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Tests //////</span></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'HeroDetailComponent'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with HeroModule setup'</span>, heroModuleSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when override its provided HeroDetailService'</span>, overrideSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with FormsModule setup'</span>, formsModuleSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with SharedModule setup'</span>, sharedModuleSetup);</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">///////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">const</span> testHero = <span class="hljs-title function_">getTestHeroes</span>()[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">overrideSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroDetailServiceSpy</span> {</div><div class="hljs-ln-line">    <span class="hljs-attr">testHero</span>: <span class="hljs-title class_">Hero</span> = {...testHero};</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">/* emit cloned test hero */</span></div><div class="hljs-ln-line">    getHero = jasmine</div><div class="hljs-ln-line">      .<span class="hljs-title function_">createSpy</span>(<span class="hljs-string">'getHero'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-property">and</span>.<span class="hljs-title function_">callFake</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, <span class="hljs-variable language_">this</span>.<span class="hljs-property">testHero</span>)));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">/* emit clone of test hero, with changes merged in */</span></div><div class="hljs-ln-line">    saveHero = jasmine</div><div class="hljs-ln-line">      .<span class="hljs-title function_">createSpy</span>(<span class="hljs-string">'saveHero'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-property">and</span>.<span class="hljs-title function_">callFake</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">testHero</span>, hero)));</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">HeroListComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroListComponent</span>},</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>},</div><div class="hljs-ln-line">          ]),</div><div class="hljs-ln-line">          <span class="hljs-title class_">HttpClient</span>,</div><div class="hljs-ln-line">          <span class="hljs-title class_">HttpHandler</span>,</div><div class="hljs-ln-line">          <span class="hljs-comment">// HeroDetailService at this level is IRRELEVANT!</span></div><div class="hljs-ln-line">          {<span class="hljs-attr">provide</span>: <span class="hljs-title class_">HeroDetailService</span>, <span class="hljs-attr">useValue</span>: {}},</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    )</div><div class="hljs-ln-line">      .<span class="hljs-title function_">overrideComponent</span>(<span class="hljs-title class_">HeroDetailComponent</span>, {</div><div class="hljs-ln-line">        <span class="hljs-attr">set</span>: {<span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">HeroDetailService</span>, <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">HeroDetailServiceSpy</span>}]},</div><div class="hljs-ln-line">      })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">hdsSpy</span>: <span class="hljs-title class_">HeroDetailServiceSpy</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">    component = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${testHero.id}</span>`</span>, <span class="hljs-title class_">HeroDetailComponent</span>);</div><div class="hljs-ln-line">    page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>();</div><div class="hljs-ln-line">    <span class="hljs-comment">// get the component's injected HeroDetailServiceSpy</span></div><div class="hljs-ln-line">    hdsSpy = harness.<span class="hljs-property">routeDebugElement</span>!.<span class="hljs-property">injector</span>.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">HeroDetailService</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should have called `getHero`'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">getHero</span>.<span class="hljs-property">calls</span>.<span class="hljs-title function_">count</span>())</div><div class="hljs-ln-line">      .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getHero called once'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'getHero called once'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display stub hero's name"</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should save stub hero change'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> origName = hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>;</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> newName = <span class="hljs-string">'New Name'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    page.<span class="hljs-property">nameInput</span>.<span class="hljs-property">value</span> = newName;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    page.<span class="hljs-property">nameInput</span>.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'input'</span>)); <span class="hljs-comment">// tell Angular</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(component.<span class="hljs-property">hero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'component hero has new name'</span>).<span class="hljs-title function_">toBe</span>(newName);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'service hero unchanged before save'</span>).<span class="hljs-title function_">toBe</span>(origName);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">saveHero</span>.<span class="hljs-property">calls</span>.<span class="hljs-title function_">count</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'saveHero called once'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// wait for async save to complete</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'service hero has new name after save'</span>).<span class="hljs-title function_">toBe</span>(newName);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes'</span>);</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////////////////////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {getTestHeroes} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/testing/test-hero.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">const</span> firstHero = <span class="hljs-title function_">getTestHeroes</span>()[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">heroModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">HeroListComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>},</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroListComponent</span>},</div><div class="hljs-ln-line">          ]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when navigate to existing hero'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">expectedHero</span>: <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      expectedHero = firstHero;</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display that hero's name"</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should navigate when click cancel'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">cancelBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${expectedHero.id}</span>`</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should save when click save but not navigate immediately'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>({<span class="hljs-attr">method</span>: <span class="hljs-string">'PUT'</span>, <span class="hljs-attr">url</span>: <span class="hljs-string">'api/heroes'</span>}));</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes/41'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should navigate when click save and save resolves'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// wait for async save to complete</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes/41'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should convert hero name to Title Case'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// get the name's input and display elements from the DOM</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">hostElement</span>: <span class="hljs-title class_">HTMLElement</span> = harness.<span class="hljs-property">routeNativeElement</span>!;</div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">nameInput</span>: <span class="hljs-title class_">HTMLInputElement</span> = hostElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'input'</span>)!;</div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">nameDisplay</span>: <span class="hljs-title class_">HTMLElement</span> = hostElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'span'</span>)!;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// simulate user entering a new name into the input box</span></div><div class="hljs-ln-line">      nameInput.<span class="hljs-property">value</span> = <span class="hljs-string">'quick BROWN  fOx'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// Dispatch a DOM event so that Angular learns of input value change.</span></div><div class="hljs-ln-line">      nameInput.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'input'</span>));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// Tell Angular to update the display binding through the title pipe</span></div><div class="hljs-ln-line">      harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(nameDisplay.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'Quick Brown  Fox'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when navigate to non-existent hero id'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(<span class="hljs-number">999</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should try to navigate back to hero list'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/////////////////////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">FormsModule</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/forms'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TitleCasePipe</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/title-case.pipe'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appConfig} <span class="hljs-keyword">from</span> <span class="hljs-string">'../app.config'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">formsModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">FormsModule</span>, <span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">TitleCasePipe</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}]),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display 1st hero's name"</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedHero = firstHero;</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">///////////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sharedModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, sharedImports],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display 1st hero's name"</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedHero = firstHero;</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/////////// Helpers /////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/** Create the HeroDetailComponent, initialize it, set test variables  */</span></div><div class="hljs-ln-line"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createComponent</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {</div><div class="hljs-ln-line">  harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">  component = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${id}</span>`</span>, <span class="hljs-title class_">HeroDetailComponent</span>);</div><div class="hljs-ln-line">  page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> request = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>(<span class="hljs-string">`api/heroes/?id=<span class="hljs-subst">${id}</span>`</span>);</div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> hero = <span class="hljs-title function_">getTestHeroes</span>().<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">h</span>) =&gt;</span> h.<span class="hljs-property">id</span> === <span class="hljs-title class_">Number</span>(id));</div><div class="hljs-ln-line">  request.<span class="hljs-title function_">flush</span>(hero ? [hero] : []);</div><div class="hljs-ln-line">  harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Page</span> {</div><div class="hljs-ln-line">  <span class="hljs-comment">// getter properties wait to query the DOM until called.</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">buttons</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">queryAll</span>&lt;<span class="hljs-title class_">HTMLButtonElement</span>&gt;(<span class="hljs-string">'button'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">saveBtn</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buttons</span>[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">cancelBtn</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buttons</span>[<span class="hljs-number">1</span>];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">nameDisplay</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>&lt;<span class="hljs-title class_">HTMLElement</span>&gt;(<span class="hljs-string">'span'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">nameInput</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>&lt;<span class="hljs-title class_">HTMLInputElement</span>&gt;(<span class="hljs-string">'input'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">//// query helpers ////</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> query&lt;T&gt;(<span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>): T {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelector</span>(selector)! <span class="hljs-keyword">as</span> T;</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> queryAll&lt;T&gt;(<span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>): T[] {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelectorAll</span>(selector) <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span> <span class="hljs-keyword">as</span> T[];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="2bdmvq9zfnmqrl5ei9na1hidz">它的导入声明少一些，稍微干净一些，小一些，这个例子中未展示它。</p>

  <h3 id="import-a-feature-module">
    <a href="#import-a-feature-module" class="docs-anchor" tabindex="-1" aria-label="Link to Import a feature module" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="crgh806lzqxhf9p75u9dp6u8s">导入特性模块</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_ref_id="5azxrgntagu1hxczzsysr1qbz"><code>HeroDetailComponent</code> 是 
<code>HeroModule</code> 
<a href="guide/ngmodules/feature-modules">特性模块</a> 的一部分，该模块聚合了更多的相互依赖部分，包括 
<code>SharedModule</code>。尝试一个导入 
<code>HeroModule</code> 的测试配置，如下所示：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/hero/hero-detail.component.spec.ts" visiblelines="116,117,118,119,120,121,122,123,124,125,126,127,128,129,130" header="app/hero/hero-detail.component.spec.ts (HeroModule setup)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="7j2tfabsyf5ssasee0v1nhxil">app/hero/hero-detail.component.spec.ts（HeroModule 设置）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpClient</span>, <span class="hljs-title class_">HttpHandler</span>, provideHttpClient} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpTestingController</span>, provideHttpClientTesting} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, <span class="hljs-title class_">TestBed</span>, tick} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {provideRouter, <span class="hljs-title class_">Router</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">RouterTestingHarness</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {asyncData, click} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {sharedImports} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/shared'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroListComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-list.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Testing Vars //////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">harness</span>: <span class="hljs-title class_">RouterTestingHarness</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">page</span>: <span class="hljs-title class_">Page</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Tests //////</span></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'HeroDetailComponent'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with HeroModule setup'</span>, heroModuleSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when override its provided HeroDetailService'</span>, overrideSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with FormsModule setup'</span>, formsModuleSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with SharedModule setup'</span>, sharedModuleSetup);</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">///////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">const</span> testHero = <span class="hljs-title function_">getTestHeroes</span>()[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">overrideSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroDetailServiceSpy</span> {</div><div class="hljs-ln-line">    <span class="hljs-attr">testHero</span>: <span class="hljs-title class_">Hero</span> = {...testHero};</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">/* emit cloned test hero */</span></div><div class="hljs-ln-line">    getHero = jasmine</div><div class="hljs-ln-line">      .<span class="hljs-title function_">createSpy</span>(<span class="hljs-string">'getHero'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-property">and</span>.<span class="hljs-title function_">callFake</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, <span class="hljs-variable language_">this</span>.<span class="hljs-property">testHero</span>)));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">/* emit clone of test hero, with changes merged in */</span></div><div class="hljs-ln-line">    saveHero = jasmine</div><div class="hljs-ln-line">      .<span class="hljs-title function_">createSpy</span>(<span class="hljs-string">'saveHero'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-property">and</span>.<span class="hljs-title function_">callFake</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">testHero</span>, hero)));</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">HeroListComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroListComponent</span>},</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>},</div><div class="hljs-ln-line">          ]),</div><div class="hljs-ln-line">          <span class="hljs-title class_">HttpClient</span>,</div><div class="hljs-ln-line">          <span class="hljs-title class_">HttpHandler</span>,</div><div class="hljs-ln-line">          <span class="hljs-comment">// HeroDetailService at this level is IRRELEVANT!</span></div><div class="hljs-ln-line">          {<span class="hljs-attr">provide</span>: <span class="hljs-title class_">HeroDetailService</span>, <span class="hljs-attr">useValue</span>: {}},</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    )</div><div class="hljs-ln-line">      .<span class="hljs-title function_">overrideComponent</span>(<span class="hljs-title class_">HeroDetailComponent</span>, {</div><div class="hljs-ln-line">        <span class="hljs-attr">set</span>: {<span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">HeroDetailService</span>, <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">HeroDetailServiceSpy</span>}]},</div><div class="hljs-ln-line">      })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">hdsSpy</span>: <span class="hljs-title class_">HeroDetailServiceSpy</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">    component = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${testHero.id}</span>`</span>, <span class="hljs-title class_">HeroDetailComponent</span>);</div><div class="hljs-ln-line">    page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>();</div><div class="hljs-ln-line">    <span class="hljs-comment">// get the component's injected HeroDetailServiceSpy</span></div><div class="hljs-ln-line">    hdsSpy = harness.<span class="hljs-property">routeDebugElement</span>!.<span class="hljs-property">injector</span>.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">HeroDetailService</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should have called `getHero`'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">getHero</span>.<span class="hljs-property">calls</span>.<span class="hljs-title function_">count</span>())</div><div class="hljs-ln-line">      .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getHero called once'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'getHero called once'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display stub hero's name"</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should save stub hero change'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> origName = hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>;</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> newName = <span class="hljs-string">'New Name'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    page.<span class="hljs-property">nameInput</span>.<span class="hljs-property">value</span> = newName;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    page.<span class="hljs-property">nameInput</span>.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'input'</span>)); <span class="hljs-comment">// tell Angular</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(component.<span class="hljs-property">hero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'component hero has new name'</span>).<span class="hljs-title function_">toBe</span>(newName);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'service hero unchanged before save'</span>).<span class="hljs-title function_">toBe</span>(origName);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">saveHero</span>.<span class="hljs-property">calls</span>.<span class="hljs-title function_">count</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'saveHero called once'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// wait for async save to complete</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'service hero has new name after save'</span>).<span class="hljs-title function_">toBe</span>(newName);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes'</span>);</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////////////////////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {getTestHeroes} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/testing/test-hero.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">const</span> firstHero = <span class="hljs-title function_">getTestHeroes</span>()[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">heroModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">HeroListComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>},</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroListComponent</span>},</div><div class="hljs-ln-line">          ]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when navigate to existing hero'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">expectedHero</span>: <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      expectedHero = firstHero;</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display that hero's name"</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should navigate when click cancel'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">cancelBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${expectedHero.id}</span>`</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should save when click save but not navigate immediately'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>({<span class="hljs-attr">method</span>: <span class="hljs-string">'PUT'</span>, <span class="hljs-attr">url</span>: <span class="hljs-string">'api/heroes'</span>}));</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes/41'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should navigate when click save and save resolves'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// wait for async save to complete</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes/41'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should convert hero name to Title Case'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// get the name's input and display elements from the DOM</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">hostElement</span>: <span class="hljs-title class_">HTMLElement</span> = harness.<span class="hljs-property">routeNativeElement</span>!;</div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">nameInput</span>: <span class="hljs-title class_">HTMLInputElement</span> = hostElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'input'</span>)!;</div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">nameDisplay</span>: <span class="hljs-title class_">HTMLElement</span> = hostElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'span'</span>)!;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// simulate user entering a new name into the input box</span></div><div class="hljs-ln-line">      nameInput.<span class="hljs-property">value</span> = <span class="hljs-string">'quick BROWN  fOx'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// Dispatch a DOM event so that Angular learns of input value change.</span></div><div class="hljs-ln-line">      nameInput.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'input'</span>));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// Tell Angular to update the display binding through the title pipe</span></div><div class="hljs-ln-line">      harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(nameDisplay.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'Quick Brown  Fox'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when navigate to non-existent hero id'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(<span class="hljs-number">999</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should try to navigate back to hero list'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/////////////////////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">FormsModule</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/forms'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TitleCasePipe</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/title-case.pipe'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appConfig} <span class="hljs-keyword">from</span> <span class="hljs-string">'../app.config'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">formsModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">FormsModule</span>, <span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">TitleCasePipe</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}]),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display 1st hero's name"</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedHero = firstHero;</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">///////////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sharedModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, sharedImports],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display 1st hero's name"</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedHero = firstHero;</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/////////// Helpers /////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/** Create the HeroDetailComponent, initialize it, set test variables  */</span></div><div class="hljs-ln-line"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createComponent</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {</div><div class="hljs-ln-line">  harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">  component = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${id}</span>`</span>, <span class="hljs-title class_">HeroDetailComponent</span>);</div><div class="hljs-ln-line">  page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> request = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>(<span class="hljs-string">`api/heroes/?id=<span class="hljs-subst">${id}</span>`</span>);</div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> hero = <span class="hljs-title function_">getTestHeroes</span>().<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">h</span>) =&gt;</span> h.<span class="hljs-property">id</span> === <span class="hljs-title class_">Number</span>(id));</div><div class="hljs-ln-line">  request.<span class="hljs-title function_">flush</span>(hero ? [hero] : []);</div><div class="hljs-ln-line">  harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Page</span> {</div><div class="hljs-ln-line">  <span class="hljs-comment">// getter properties wait to query the DOM until called.</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">buttons</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">queryAll</span>&lt;<span class="hljs-title class_">HTMLButtonElement</span>&gt;(<span class="hljs-string">'button'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">saveBtn</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buttons</span>[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">cancelBtn</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buttons</span>[<span class="hljs-number">1</span>];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">nameDisplay</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>&lt;<span class="hljs-title class_">HTMLElement</span>&gt;(<span class="hljs-string">'span'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">nameInput</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>&lt;<span class="hljs-title class_">HTMLInputElement</span>&gt;(<span class="hljs-string">'input'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">//// query helpers ////</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> query&lt;T&gt;(<span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>): T {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelector</span>(selector)! <span class="hljs-keyword">as</span> T;</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> queryAll&lt;T&gt;(<span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>): T[] {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelectorAll</span>(selector) <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span> <span class="hljs-keyword">as</span> T[];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="f4imy8wqug3756anrcjy6w347">只有 
<code>providers</code> 中的<em>测试替身</em>仍然保留。 甚至连 
<code>HeroDetailComponent</code> 声明也消失了。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="1w157qkb750j8f479yxzsxt1x">事实上，如果你尝试声明它，Angular 会抛出一个错误，因为 
<code>HeroDetailComponent</code> 被同时声明在 
<code>HeroModule</code> 和由 
<code>TestBed</code> 创建的 
<code>DynamicTestModule</code> 中。</p>

    <div class="docs-alert docs-alert-helpful">
    <p data-ng_translator_product="100" data-ng_translator_ref_id="40lo7nr4vpdwiqfdrumdd2j4h"><strong>提示：</strong>当模块内有许多相互依赖时，导入组件的特性模块可能是配置测试的最佳方式，尤其是当该模块较小的时候，因为特性模块往往较小。</p>

    </div>
    
  <h2 id="override-component-providers">
    <a href="#override-component-providers" class="docs-anchor" tabindex="-1" aria-label="Link to Override component providers" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="78zumly5k3ex6me9sk4ig5504">重写组件的服务提供者</a>
  </h2>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="4b4rnelrl6pexirajky2zxe4a"><code>HeroDetailComponent</code> 提供自己的 <code>HeroDetailService</code> 服务。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/hero/hero-detail.component.ts" visiblelines="8,9,10,11,12,13,14,15,16,17,18,19,20,21,57" header="app/hero/hero-detail.component.ts (prototype)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="ed5cvgt1ouj1rowi5ym33qr3a">app/hero/hero-detail.component.ts（原型）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Component</span>, <span class="hljs-title class_">OnInit</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">ActivatedRoute</span>, <span class="hljs-title class_">Router</span>, <span class="hljs-title class_">RouterLink</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {sharedImports} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/shared'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-meta">@Component</span>({</div><div class="hljs-ln-line">  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">selector</span>: <span class="hljs-string">'app-hero-detail'</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">templateUrl</span>: <span class="hljs-string">'./hero-detail.component.html'</span>,</div><div class="hljs-ln-line">  <span class="hljs-attr">styleUrls</span>: [<span class="hljs-string">'./hero-detail.component.css'</span>],</div><div class="hljs-ln-line">  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">HeroDetailService</span>],</div><div class="hljs-ln-line">  <span class="hljs-attr">imports</span>: [sharedImports, <span class="hljs-title class_">RouterLink</span>],</div><div class="hljs-ln-line">})</div><div class="hljs-ln-line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroDetailComponent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OnInit</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span></div><div class="hljs-ln-line">    <span class="hljs-keyword">private</span> heroDetailService: HeroDetailService,</div><div class="hljs-ln-line">    <span class="hljs-keyword">private</span> route: ActivatedRoute,</div><div class="hljs-ln-line">    <span class="hljs-keyword">private</span> router: Router,</div><div class="hljs-ln-line">  ) {}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  hero!: <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">ngOnInit</span>(): <span class="hljs-built_in">void</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// get hero when `id` param changes</span></div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">route</span>.<span class="hljs-property">paramMap</span>.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">pmap</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getHero</span>(pmap.<span class="hljs-title function_">get</span>(<span class="hljs-string">'id'</span>)));</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> <span class="hljs-title function_">getHero</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>): <span class="hljs-built_in">void</span> {</div><div class="hljs-ln-line">    <span class="hljs-comment">// when no id or id===0, create new blank hero</span></div><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> (!id) {</div><div class="hljs-ln-line">      <span class="hljs-variable language_">this</span>.<span class="hljs-property">hero</span> = {<span class="hljs-attr">id</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">''</span>} <span class="hljs-keyword">as</span> <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line">      <span class="hljs-keyword">return</span>;</div><div class="hljs-ln-line">    }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">heroDetailService</span>.<span class="hljs-title function_">getHero</span>(id).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">hero</span>) =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-keyword">if</span> (hero) {</div><div class="hljs-ln-line">        <span class="hljs-variable language_">this</span>.<span class="hljs-property">hero</span> = hero;</div><div class="hljs-ln-line">      } <span class="hljs-keyword">else</span> {</div><div class="hljs-ln-line">        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">gotoList</span>(); <span class="hljs-comment">// id not found; navigate to list</span></div><div class="hljs-ln-line">      }</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">save</span>(): <span class="hljs-built_in">void</span> {</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">heroDetailService</span>.<span class="hljs-title function_">saveHero</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">hero</span>).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">gotoList</span>());</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">cancel</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">gotoList</span>();</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">gotoList</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">router</span>.<span class="hljs-title function_">navigate</span>([<span class="hljs-string">'../'</span>], {<span class="hljs-attr">relativeTo</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">route</span>});</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="eemr8nehlchf38p6rfzeve6an">不可能在 
<code>TestBed.configureTestingModule</code> 的 
<code>providers</code> 中为组件的 
<code>HeroDetailService</code> 设置测试桩。 那些是<em>测试模块</em>的提供者，不是组件的。 它们在<em>夹具级别</em>准备了依赖注入器。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="6ncr8lidy99tnie3p379jwr06">Angular 使用其
<em>自己的</em>注入器创建组件，该注入器是此夹具注入器的
<em>子</em>注入器。它使用子注入器注册组件的提供者（在这种情况下是 
<code>HeroDetailService</code>）。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="dmgnhcvhe1h6iwd6mqghrnm8v">测试没办法从测试夹具的注入器中获取子注入器中的服务，而 <code>TestBed.configureTestingModule</code> 也没法配置它们。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="21gy9bv0pdz1l0o7sr7qfpo63">Angular 始终都在创建真实 <code>HeroDetailService</code> 的实例。</p>

    <div class="docs-alert docs-alert-helpful">
    <p data-ng_translator_product="100" data-ng_translator_ref_id="d6gi07welxf3ocqrq4hio1aia"><strong>提示：</strong>如果 
<code>HeroDetailService</code> 自行发起 XHR 调用到远程服务器，这些测试可能会失败或超时。可能没有远程服务器可供调用。</p>

    </div>
    <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="71cj16a6q02kpbfq42aaug12b">幸运的是，<code>HeroDetailService</code> 将远程数据访问的责任交给了注入进来的 <code>HeroService</code>。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/hero/hero-detail.service.ts" visiblelines="7,8,9,24" header="app/hero/hero-detail.service.ts (prototype)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="nl4sm9fde92vn2ihudknx7s2">app/hero/hero-detail.service.ts（原型）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Injectable</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Observable</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {map} <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-meta">@Injectable</span>({<span class="hljs-attr">providedIn</span>: <span class="hljs-string">'root'</span>})</div><div class="hljs-ln-line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroDetailService</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> heroService: HeroService</span>) {}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">// Returns a clone which caller may modify safely</span></div><div class="hljs-ln-line">  <span class="hljs-title function_">getHero</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span> | <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Observable</span>&lt;<span class="hljs-title class_">Hero</span> | <span class="hljs-literal">null</span>&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> id === <span class="hljs-string">'string'</span>) {</div><div class="hljs-ln-line">      id = <span class="hljs-built_in">parseInt</span>(id, <span class="hljs-number">10</span>);</div><div class="hljs-ln-line">    }</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">heroService</span>.<span class="hljs-title function_">getHero</span>(id).<span class="hljs-title function_">pipe</span>(</div><div class="hljs-ln-line">      <span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">hero</span>) =&gt;</span> (hero ? <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, hero) : <span class="hljs-literal">null</span>)), <span class="hljs-comment">// clone or null</span></div><div class="hljs-ln-line">    );</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">saveHero</span>(<span class="hljs-params">hero: Hero</span>) {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">heroService</span>.<span class="hljs-title function_">updateHero</span>(hero);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="28l7s5dl4ltt8vyu0qn5a8uzg"><a href="#feature-module-import">前面的测试配置</a>使用 
<code>TestHeroService</code> 替换了真实的 
<code>HeroService</code>，该服务拦截服务器请求并伪造其响应。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="9ujlesnkhih21kzujt3906llq">如果你没有这么幸运怎么办？如果伪造 <code>HeroService</code> 很难怎么办？如果 <code>HeroDetailService</code> 自己发出服务器请求怎么办？</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="4gt02cye7uvpifgwh3w7b3or7"><code>TestBed.overrideComponent</code> 方法可以用易于管理的
<em>测试替身</em>替换组件的
<code>提供者</code>，如下设置变体所示：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/hero/hero-detail.component.spec.ts" visiblelines="46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66" header="app/hero/hero-detail.component.spec.ts (Override setup)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="1agzjnkdao4zso8j5d6tnyu3i">app/hero/hero-detail.component.spec.ts（覆盖设置）</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpClient</span>, <span class="hljs-title class_">HttpHandler</span>, provideHttpClient} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpTestingController</span>, provideHttpClientTesting} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, <span class="hljs-title class_">TestBed</span>, tick} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {provideRouter, <span class="hljs-title class_">Router</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">RouterTestingHarness</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {asyncData, click} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {sharedImports} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/shared'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroListComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-list.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Testing Vars //////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">harness</span>: <span class="hljs-title class_">RouterTestingHarness</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">page</span>: <span class="hljs-title class_">Page</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Tests //////</span></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'HeroDetailComponent'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with HeroModule setup'</span>, heroModuleSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when override its provided HeroDetailService'</span>, overrideSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with FormsModule setup'</span>, formsModuleSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with SharedModule setup'</span>, sharedModuleSetup);</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">///////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">const</span> testHero = <span class="hljs-title function_">getTestHeroes</span>()[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">overrideSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroDetailServiceSpy</span> {</div><div class="hljs-ln-line">    <span class="hljs-attr">testHero</span>: <span class="hljs-title class_">Hero</span> = {...testHero};</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">/* emit cloned test hero */</span></div><div class="hljs-ln-line">    getHero = jasmine</div><div class="hljs-ln-line">      .<span class="hljs-title function_">createSpy</span>(<span class="hljs-string">'getHero'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-property">and</span>.<span class="hljs-title function_">callFake</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, <span class="hljs-variable language_">this</span>.<span class="hljs-property">testHero</span>)));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">/* emit clone of test hero, with changes merged in */</span></div><div class="hljs-ln-line">    saveHero = jasmine</div><div class="hljs-ln-line">      .<span class="hljs-title function_">createSpy</span>(<span class="hljs-string">'saveHero'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-property">and</span>.<span class="hljs-title function_">callFake</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">testHero</span>, hero)));</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">HeroListComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroListComponent</span>},</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>},</div><div class="hljs-ln-line">          ]),</div><div class="hljs-ln-line">          <span class="hljs-title class_">HttpClient</span>,</div><div class="hljs-ln-line">          <span class="hljs-title class_">HttpHandler</span>,</div><div class="hljs-ln-line">          <span class="hljs-comment">// HeroDetailService at this level is IRRELEVANT!</span></div><div class="hljs-ln-line">          {<span class="hljs-attr">provide</span>: <span class="hljs-title class_">HeroDetailService</span>, <span class="hljs-attr">useValue</span>: {}},</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    )</div><div class="hljs-ln-line">      .<span class="hljs-title function_">overrideComponent</span>(<span class="hljs-title class_">HeroDetailComponent</span>, {</div><div class="hljs-ln-line">        <span class="hljs-attr">set</span>: {<span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">HeroDetailService</span>, <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">HeroDetailServiceSpy</span>}]},</div><div class="hljs-ln-line">      })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">hdsSpy</span>: <span class="hljs-title class_">HeroDetailServiceSpy</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">    component = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${testHero.id}</span>`</span>, <span class="hljs-title class_">HeroDetailComponent</span>);</div><div class="hljs-ln-line">    page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>();</div><div class="hljs-ln-line">    <span class="hljs-comment">// get the component's injected HeroDetailServiceSpy</span></div><div class="hljs-ln-line">    hdsSpy = harness.<span class="hljs-property">routeDebugElement</span>!.<span class="hljs-property">injector</span>.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">HeroDetailService</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should have called `getHero`'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">getHero</span>.<span class="hljs-property">calls</span>.<span class="hljs-title function_">count</span>())</div><div class="hljs-ln-line">      .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getHero called once'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'getHero called once'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display stub hero's name"</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should save stub hero change'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> origName = hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>;</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> newName = <span class="hljs-string">'New Name'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    page.<span class="hljs-property">nameInput</span>.<span class="hljs-property">value</span> = newName;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    page.<span class="hljs-property">nameInput</span>.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'input'</span>)); <span class="hljs-comment">// tell Angular</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(component.<span class="hljs-property">hero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'component hero has new name'</span>).<span class="hljs-title function_">toBe</span>(newName);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'service hero unchanged before save'</span>).<span class="hljs-title function_">toBe</span>(origName);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">saveHero</span>.<span class="hljs-property">calls</span>.<span class="hljs-title function_">count</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'saveHero called once'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// wait for async save to complete</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'service hero has new name after save'</span>).<span class="hljs-title function_">toBe</span>(newName);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes'</span>);</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////////////////////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {getTestHeroes} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/testing/test-hero.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">const</span> firstHero = <span class="hljs-title function_">getTestHeroes</span>()[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">heroModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">HeroListComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>},</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroListComponent</span>},</div><div class="hljs-ln-line">          ]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when navigate to existing hero'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">expectedHero</span>: <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      expectedHero = firstHero;</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display that hero's name"</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should navigate when click cancel'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">cancelBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${expectedHero.id}</span>`</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should save when click save but not navigate immediately'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>({<span class="hljs-attr">method</span>: <span class="hljs-string">'PUT'</span>, <span class="hljs-attr">url</span>: <span class="hljs-string">'api/heroes'</span>}));</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes/41'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should navigate when click save and save resolves'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// wait for async save to complete</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes/41'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should convert hero name to Title Case'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// get the name's input and display elements from the DOM</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">hostElement</span>: <span class="hljs-title class_">HTMLElement</span> = harness.<span class="hljs-property">routeNativeElement</span>!;</div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">nameInput</span>: <span class="hljs-title class_">HTMLInputElement</span> = hostElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'input'</span>)!;</div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">nameDisplay</span>: <span class="hljs-title class_">HTMLElement</span> = hostElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'span'</span>)!;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// simulate user entering a new name into the input box</span></div><div class="hljs-ln-line">      nameInput.<span class="hljs-property">value</span> = <span class="hljs-string">'quick BROWN  fOx'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// Dispatch a DOM event so that Angular learns of input value change.</span></div><div class="hljs-ln-line">      nameInput.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'input'</span>));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// Tell Angular to update the display binding through the title pipe</span></div><div class="hljs-ln-line">      harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(nameDisplay.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'Quick Brown  Fox'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when navigate to non-existent hero id'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(<span class="hljs-number">999</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should try to navigate back to hero list'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/////////////////////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">FormsModule</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/forms'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TitleCasePipe</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/title-case.pipe'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appConfig} <span class="hljs-keyword">from</span> <span class="hljs-string">'../app.config'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">formsModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">FormsModule</span>, <span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">TitleCasePipe</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}]),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display 1st hero's name"</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedHero = firstHero;</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">///////////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sharedModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, sharedImports],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display 1st hero's name"</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedHero = firstHero;</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/////////// Helpers /////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/** Create the HeroDetailComponent, initialize it, set test variables  */</span></div><div class="hljs-ln-line"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createComponent</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {</div><div class="hljs-ln-line">  harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">  component = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${id}</span>`</span>, <span class="hljs-title class_">HeroDetailComponent</span>);</div><div class="hljs-ln-line">  page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> request = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>(<span class="hljs-string">`api/heroes/?id=<span class="hljs-subst">${id}</span>`</span>);</div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> hero = <span class="hljs-title function_">getTestHeroes</span>().<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">h</span>) =&gt;</span> h.<span class="hljs-property">id</span> === <span class="hljs-title class_">Number</span>(id));</div><div class="hljs-ln-line">  request.<span class="hljs-title function_">flush</span>(hero ? [hero] : []);</div><div class="hljs-ln-line">  harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Page</span> {</div><div class="hljs-ln-line">  <span class="hljs-comment">// getter properties wait to query the DOM until called.</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">buttons</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">queryAll</span>&lt;<span class="hljs-title class_">HTMLButtonElement</span>&gt;(<span class="hljs-string">'button'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">saveBtn</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buttons</span>[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">cancelBtn</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buttons</span>[<span class="hljs-number">1</span>];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">nameDisplay</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>&lt;<span class="hljs-title class_">HTMLElement</span>&gt;(<span class="hljs-string">'span'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">nameInput</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>&lt;<span class="hljs-title class_">HTMLInputElement</span>&gt;(<span class="hljs-string">'input'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">//// query helpers ////</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> query&lt;T&gt;(<span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>): T {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelector</span>(selector)! <span class="hljs-keyword">as</span> T;</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> queryAll&lt;T&gt;(<span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>): T[] {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelectorAll</span>(selector) <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span> <span class="hljs-keyword">as</span> T[];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="2bvjforqxnxki53500zk0we3m">注意 
<code>TestBed.configureTestingModule</code> 不再提供一个假的 
<code>HeroService</code>，因为它 
<a href="#spy-stub">不再需要</a>。</p>

  <h3 id="the-overridecomponent-method">
    <a href="#the-overridecomponent-method" class="docs-anchor" tabindex="-1" aria-label="Link to The <code>overrideComponent</code> method" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="135z7jbukbsge8kx78q6zeoap"><code>overrideComponent</code> 方法</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="et5wd2qgx00ss4hvkklh1gdsm">注意这个 <code>overrideComponent</code> 方法。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/hero/hero-detail.component.spec.ts" visiblelines="62,63,64" header="app/hero/hero-detail.component.spec.ts (overrideComponent)">
    <div class="docs-code-header"><h3>app/hero/hero-detail.component.spec.ts (overrideComponent)</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpClient</span>, <span class="hljs-title class_">HttpHandler</span>, provideHttpClient} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpTestingController</span>, provideHttpClientTesting} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, <span class="hljs-title class_">TestBed</span>, tick} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {provideRouter, <span class="hljs-title class_">Router</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">RouterTestingHarness</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {asyncData, click} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {sharedImports} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/shared'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroListComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-list.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Testing Vars //////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">harness</span>: <span class="hljs-title class_">RouterTestingHarness</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">page</span>: <span class="hljs-title class_">Page</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Tests //////</span></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'HeroDetailComponent'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with HeroModule setup'</span>, heroModuleSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when override its provided HeroDetailService'</span>, overrideSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with FormsModule setup'</span>, formsModuleSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with SharedModule setup'</span>, sharedModuleSetup);</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">///////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">const</span> testHero = <span class="hljs-title function_">getTestHeroes</span>()[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">overrideSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroDetailServiceSpy</span> {</div><div class="hljs-ln-line">    <span class="hljs-attr">testHero</span>: <span class="hljs-title class_">Hero</span> = {...testHero};</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">/* emit cloned test hero */</span></div><div class="hljs-ln-line">    getHero = jasmine</div><div class="hljs-ln-line">      .<span class="hljs-title function_">createSpy</span>(<span class="hljs-string">'getHero'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-property">and</span>.<span class="hljs-title function_">callFake</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, <span class="hljs-variable language_">this</span>.<span class="hljs-property">testHero</span>)));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">/* emit clone of test hero, with changes merged in */</span></div><div class="hljs-ln-line">    saveHero = jasmine</div><div class="hljs-ln-line">      .<span class="hljs-title function_">createSpy</span>(<span class="hljs-string">'saveHero'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-property">and</span>.<span class="hljs-title function_">callFake</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">testHero</span>, hero)));</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">HeroListComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroListComponent</span>},</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>},</div><div class="hljs-ln-line">          ]),</div><div class="hljs-ln-line">          <span class="hljs-title class_">HttpClient</span>,</div><div class="hljs-ln-line">          <span class="hljs-title class_">HttpHandler</span>,</div><div class="hljs-ln-line">          <span class="hljs-comment">// HeroDetailService at this level is IRRELEVANT!</span></div><div class="hljs-ln-line">          {<span class="hljs-attr">provide</span>: <span class="hljs-title class_">HeroDetailService</span>, <span class="hljs-attr">useValue</span>: {}},</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    )</div><div class="hljs-ln-line">      .<span class="hljs-title function_">overrideComponent</span>(<span class="hljs-title class_">HeroDetailComponent</span>, {</div><div class="hljs-ln-line">        <span class="hljs-attr">set</span>: {<span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">HeroDetailService</span>, <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">HeroDetailServiceSpy</span>}]},</div><div class="hljs-ln-line">      })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">hdsSpy</span>: <span class="hljs-title class_">HeroDetailServiceSpy</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">    component = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${testHero.id}</span>`</span>, <span class="hljs-title class_">HeroDetailComponent</span>);</div><div class="hljs-ln-line">    page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>();</div><div class="hljs-ln-line">    <span class="hljs-comment">// get the component's injected HeroDetailServiceSpy</span></div><div class="hljs-ln-line">    hdsSpy = harness.<span class="hljs-property">routeDebugElement</span>!.<span class="hljs-property">injector</span>.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">HeroDetailService</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should have called `getHero`'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">getHero</span>.<span class="hljs-property">calls</span>.<span class="hljs-title function_">count</span>())</div><div class="hljs-ln-line">      .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getHero called once'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'getHero called once'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display stub hero's name"</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should save stub hero change'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> origName = hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>;</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> newName = <span class="hljs-string">'New Name'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    page.<span class="hljs-property">nameInput</span>.<span class="hljs-property">value</span> = newName;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    page.<span class="hljs-property">nameInput</span>.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'input'</span>)); <span class="hljs-comment">// tell Angular</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(component.<span class="hljs-property">hero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'component hero has new name'</span>).<span class="hljs-title function_">toBe</span>(newName);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'service hero unchanged before save'</span>).<span class="hljs-title function_">toBe</span>(origName);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">saveHero</span>.<span class="hljs-property">calls</span>.<span class="hljs-title function_">count</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'saveHero called once'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// wait for async save to complete</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'service hero has new name after save'</span>).<span class="hljs-title function_">toBe</span>(newName);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes'</span>);</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////////////////////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {getTestHeroes} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/testing/test-hero.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">const</span> firstHero = <span class="hljs-title function_">getTestHeroes</span>()[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">heroModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">HeroListComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>},</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroListComponent</span>},</div><div class="hljs-ln-line">          ]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when navigate to existing hero'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">expectedHero</span>: <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      expectedHero = firstHero;</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display that hero's name"</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should navigate when click cancel'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">cancelBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${expectedHero.id}</span>`</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should save when click save but not navigate immediately'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>({<span class="hljs-attr">method</span>: <span class="hljs-string">'PUT'</span>, <span class="hljs-attr">url</span>: <span class="hljs-string">'api/heroes'</span>}));</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes/41'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should navigate when click save and save resolves'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// wait for async save to complete</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes/41'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should convert hero name to Title Case'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// get the name's input and display elements from the DOM</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">hostElement</span>: <span class="hljs-title class_">HTMLElement</span> = harness.<span class="hljs-property">routeNativeElement</span>!;</div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">nameInput</span>: <span class="hljs-title class_">HTMLInputElement</span> = hostElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'input'</span>)!;</div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">nameDisplay</span>: <span class="hljs-title class_">HTMLElement</span> = hostElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'span'</span>)!;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// simulate user entering a new name into the input box</span></div><div class="hljs-ln-line">      nameInput.<span class="hljs-property">value</span> = <span class="hljs-string">'quick BROWN  fOx'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// Dispatch a DOM event so that Angular learns of input value change.</span></div><div class="hljs-ln-line">      nameInput.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'input'</span>));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// Tell Angular to update the display binding through the title pipe</span></div><div class="hljs-ln-line">      harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(nameDisplay.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'Quick Brown  Fox'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when navigate to non-existent hero id'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(<span class="hljs-number">999</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should try to navigate back to hero list'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/////////////////////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">FormsModule</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/forms'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TitleCasePipe</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/title-case.pipe'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appConfig} <span class="hljs-keyword">from</span> <span class="hljs-string">'../app.config'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">formsModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">FormsModule</span>, <span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">TitleCasePipe</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}]),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display 1st hero's name"</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedHero = firstHero;</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">///////////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sharedModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, sharedImports],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display 1st hero's name"</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedHero = firstHero;</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/////////// Helpers /////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/** Create the HeroDetailComponent, initialize it, set test variables  */</span></div><div class="hljs-ln-line"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createComponent</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {</div><div class="hljs-ln-line">  harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">  component = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${id}</span>`</span>, <span class="hljs-title class_">HeroDetailComponent</span>);</div><div class="hljs-ln-line">  page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> request = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>(<span class="hljs-string">`api/heroes/?id=<span class="hljs-subst">${id}</span>`</span>);</div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> hero = <span class="hljs-title function_">getTestHeroes</span>().<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">h</span>) =&gt;</span> h.<span class="hljs-property">id</span> === <span class="hljs-title class_">Number</span>(id));</div><div class="hljs-ln-line">  request.<span class="hljs-title function_">flush</span>(hero ? [hero] : []);</div><div class="hljs-ln-line">  harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Page</span> {</div><div class="hljs-ln-line">  <span class="hljs-comment">// getter properties wait to query the DOM until called.</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">buttons</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">queryAll</span>&lt;<span class="hljs-title class_">HTMLButtonElement</span>&gt;(<span class="hljs-string">'button'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">saveBtn</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buttons</span>[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">cancelBtn</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buttons</span>[<span class="hljs-number">1</span>];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">nameDisplay</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>&lt;<span class="hljs-title class_">HTMLElement</span>&gt;(<span class="hljs-string">'span'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">nameInput</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>&lt;<span class="hljs-title class_">HTMLInputElement</span>&gt;(<span class="hljs-string">'input'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">//// query helpers ////</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> query&lt;T&gt;(<span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>): T {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelector</span>(selector)! <span class="hljs-keyword">as</span> T;</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> queryAll&lt;T&gt;(<span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>): T[] {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelectorAll</span>(selector) <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span> <span class="hljs-keyword">as</span> T[];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="483medc643g3h52g78j9pzr21">它接受两个参数：要覆盖的组件类型（
<code>HeroDetailComponent</code>）和一个覆盖元数据对象。此 
<a href="guide/testing/utility-apis#metadata-override-object">覆盖元数据对象</a>定义如下：</p>
<div class="docs-code">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line">type <span class="hljs-title class_">MetadataOverride</span>&lt;T&gt; = {</div><div class="hljs-ln-line">  add?: <span class="hljs-title class_">Partial</span>&lt;T&gt;;</div><div class="hljs-ln-line">  remove?: <span class="hljs-title class_">Partial</span>&lt;T&gt;;</div><div class="hljs-ln-line">  set?: <span class="hljs-title class_">Partial</span>&lt;T&gt;;</div><div class="hljs-ln-line">};</div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="c1lh2e2kbgkh1fhsws08xvi60">元数据重载对象可以添加和删除元数据属性的项目，也可以彻底重设这些属性。这个例子重新设置了组件的 <code>providers</code> 元数据。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="3e6qthuzuhctt23ynn45tqbgk">类型参数 
<code>T</code> 是你会传递给 
<code>@Component</code> 装饰器的元数据类型：</p>
<div class="docs-code">
    
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line">selector?: string;</div><div class="hljs-ln-line">template?: string;</div><div class="hljs-ln-line">templateUrl?: string;</div><div class="hljs-ln-line">providers?: any[];</div><div class="hljs-ln-line">…</div></code>
    </pre>
  </div>
  <h3 id="provide-a-spy-stub-herodetailservicespy">
    <a href="#provide-a-spy-stub-herodetailservicespy" class="docs-anchor" tabindex="-1" aria-label="Link to Provide a <em>spy stub</em> (<code>HeroDetailServiceSpy</code>)" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="649ip5u8lygkqxsd5bpfr523h">提供 <em>间谍桩</em>（<code>HeroDetailServiceSpy</code>）</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="207r7ony5uvimd8yc5sm44ohp">这个例子把组件的 <code>providers</code> 数组完全替换成了一个包含 <code>HeroDetailServiceSpy</code> 的新数组。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="7rpbnoly7jvfddt2hioz38g4p"><code>HeroDetailServiceSpy</code> 是真实 
<code>HeroDetailService</code> 的测试桩版本，它伪造了该服务的所有必要特性。它既不注入也不委托给低级别的 
<code>HeroService</code>，因此不需要为其提供测试替身。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="de4tk14jnxgfkfy8c19l901jw">通过对该服务的方法进行刺探，<code>HeroDetailComponent</code> 的关联测试将会对 <code>HeroDetailService</code> 是否被调用过进行断言。因此，这个桩类会把它的方法实现为刺探方法：</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/hero/hero-detail.component.spec.ts" visiblelines="31,32,33,34,35,36,37,38,39,40,41,42,43,44" header="app/hero/hero-detail.component.spec.ts (HeroDetailServiceSpy)">
    <div class="docs-code-header"><h3>app/hero/hero-detail.component.spec.ts (HeroDetailServiceSpy)</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpClient</span>, <span class="hljs-title class_">HttpHandler</span>, provideHttpClient} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpTestingController</span>, provideHttpClientTesting} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, <span class="hljs-title class_">TestBed</span>, tick} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {provideRouter, <span class="hljs-title class_">Router</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">RouterTestingHarness</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {asyncData, click} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {sharedImports} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/shared'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroListComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-list.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Testing Vars //////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">harness</span>: <span class="hljs-title class_">RouterTestingHarness</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">page</span>: <span class="hljs-title class_">Page</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Tests //////</span></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'HeroDetailComponent'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with HeroModule setup'</span>, heroModuleSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when override its provided HeroDetailService'</span>, overrideSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with FormsModule setup'</span>, formsModuleSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with SharedModule setup'</span>, sharedModuleSetup);</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">///////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">const</span> testHero = <span class="hljs-title function_">getTestHeroes</span>()[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">overrideSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroDetailServiceSpy</span> {</div><div class="hljs-ln-line">    <span class="hljs-attr">testHero</span>: <span class="hljs-title class_">Hero</span> = {...testHero};</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">/* emit cloned test hero */</span></div><div class="hljs-ln-line">    getHero = jasmine</div><div class="hljs-ln-line">      .<span class="hljs-title function_">createSpy</span>(<span class="hljs-string">'getHero'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-property">and</span>.<span class="hljs-title function_">callFake</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, <span class="hljs-variable language_">this</span>.<span class="hljs-property">testHero</span>)));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">/* emit clone of test hero, with changes merged in */</span></div><div class="hljs-ln-line">    saveHero = jasmine</div><div class="hljs-ln-line">      .<span class="hljs-title function_">createSpy</span>(<span class="hljs-string">'saveHero'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-property">and</span>.<span class="hljs-title function_">callFake</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">testHero</span>, hero)));</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">HeroListComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroListComponent</span>},</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>},</div><div class="hljs-ln-line">          ]),</div><div class="hljs-ln-line">          <span class="hljs-title class_">HttpClient</span>,</div><div class="hljs-ln-line">          <span class="hljs-title class_">HttpHandler</span>,</div><div class="hljs-ln-line">          <span class="hljs-comment">// HeroDetailService at this level is IRRELEVANT!</span></div><div class="hljs-ln-line">          {<span class="hljs-attr">provide</span>: <span class="hljs-title class_">HeroDetailService</span>, <span class="hljs-attr">useValue</span>: {}},</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    )</div><div class="hljs-ln-line">      .<span class="hljs-title function_">overrideComponent</span>(<span class="hljs-title class_">HeroDetailComponent</span>, {</div><div class="hljs-ln-line">        <span class="hljs-attr">set</span>: {<span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">HeroDetailService</span>, <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">HeroDetailServiceSpy</span>}]},</div><div class="hljs-ln-line">      })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">hdsSpy</span>: <span class="hljs-title class_">HeroDetailServiceSpy</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">    component = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${testHero.id}</span>`</span>, <span class="hljs-title class_">HeroDetailComponent</span>);</div><div class="hljs-ln-line">    page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>();</div><div class="hljs-ln-line">    <span class="hljs-comment">// get the component's injected HeroDetailServiceSpy</span></div><div class="hljs-ln-line">    hdsSpy = harness.<span class="hljs-property">routeDebugElement</span>!.<span class="hljs-property">injector</span>.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">HeroDetailService</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should have called `getHero`'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">getHero</span>.<span class="hljs-property">calls</span>.<span class="hljs-title function_">count</span>())</div><div class="hljs-ln-line">      .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getHero called once'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'getHero called once'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display stub hero's name"</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should save stub hero change'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> origName = hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>;</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> newName = <span class="hljs-string">'New Name'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    page.<span class="hljs-property">nameInput</span>.<span class="hljs-property">value</span> = newName;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    page.<span class="hljs-property">nameInput</span>.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'input'</span>)); <span class="hljs-comment">// tell Angular</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(component.<span class="hljs-property">hero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'component hero has new name'</span>).<span class="hljs-title function_">toBe</span>(newName);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'service hero unchanged before save'</span>).<span class="hljs-title function_">toBe</span>(origName);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">saveHero</span>.<span class="hljs-property">calls</span>.<span class="hljs-title function_">count</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'saveHero called once'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// wait for async save to complete</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'service hero has new name after save'</span>).<span class="hljs-title function_">toBe</span>(newName);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes'</span>);</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////////////////////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {getTestHeroes} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/testing/test-hero.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">const</span> firstHero = <span class="hljs-title function_">getTestHeroes</span>()[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">heroModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">HeroListComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>},</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroListComponent</span>},</div><div class="hljs-ln-line">          ]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when navigate to existing hero'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">expectedHero</span>: <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      expectedHero = firstHero;</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display that hero's name"</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should navigate when click cancel'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">cancelBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${expectedHero.id}</span>`</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should save when click save but not navigate immediately'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>({<span class="hljs-attr">method</span>: <span class="hljs-string">'PUT'</span>, <span class="hljs-attr">url</span>: <span class="hljs-string">'api/heroes'</span>}));</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes/41'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should navigate when click save and save resolves'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// wait for async save to complete</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes/41'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should convert hero name to Title Case'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// get the name's input and display elements from the DOM</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">hostElement</span>: <span class="hljs-title class_">HTMLElement</span> = harness.<span class="hljs-property">routeNativeElement</span>!;</div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">nameInput</span>: <span class="hljs-title class_">HTMLInputElement</span> = hostElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'input'</span>)!;</div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">nameDisplay</span>: <span class="hljs-title class_">HTMLElement</span> = hostElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'span'</span>)!;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// simulate user entering a new name into the input box</span></div><div class="hljs-ln-line">      nameInput.<span class="hljs-property">value</span> = <span class="hljs-string">'quick BROWN  fOx'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// Dispatch a DOM event so that Angular learns of input value change.</span></div><div class="hljs-ln-line">      nameInput.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'input'</span>));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// Tell Angular to update the display binding through the title pipe</span></div><div class="hljs-ln-line">      harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(nameDisplay.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'Quick Brown  Fox'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when navigate to non-existent hero id'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(<span class="hljs-number">999</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should try to navigate back to hero list'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/////////////////////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">FormsModule</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/forms'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TitleCasePipe</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/title-case.pipe'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appConfig} <span class="hljs-keyword">from</span> <span class="hljs-string">'../app.config'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">formsModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">FormsModule</span>, <span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">TitleCasePipe</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}]),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display 1st hero's name"</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedHero = firstHero;</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">///////////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sharedModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, sharedImports],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display 1st hero's name"</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedHero = firstHero;</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/////////// Helpers /////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/** Create the HeroDetailComponent, initialize it, set test variables  */</span></div><div class="hljs-ln-line"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createComponent</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {</div><div class="hljs-ln-line">  harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">  component = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${id}</span>`</span>, <span class="hljs-title class_">HeroDetailComponent</span>);</div><div class="hljs-ln-line">  page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> request = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>(<span class="hljs-string">`api/heroes/?id=<span class="hljs-subst">${id}</span>`</span>);</div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> hero = <span class="hljs-title function_">getTestHeroes</span>().<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">h</span>) =&gt;</span> h.<span class="hljs-property">id</span> === <span class="hljs-title class_">Number</span>(id));</div><div class="hljs-ln-line">  request.<span class="hljs-title function_">flush</span>(hero ? [hero] : []);</div><div class="hljs-ln-line">  harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Page</span> {</div><div class="hljs-ln-line">  <span class="hljs-comment">// getter properties wait to query the DOM until called.</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">buttons</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">queryAll</span>&lt;<span class="hljs-title class_">HTMLButtonElement</span>&gt;(<span class="hljs-string">'button'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">saveBtn</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buttons</span>[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">cancelBtn</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buttons</span>[<span class="hljs-number">1</span>];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">nameDisplay</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>&lt;<span class="hljs-title class_">HTMLElement</span>&gt;(<span class="hljs-string">'span'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">nameInput</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>&lt;<span class="hljs-title class_">HTMLInputElement</span>&gt;(<span class="hljs-string">'input'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">//// query helpers ////</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> query&lt;T&gt;(<span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>): T {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelector</span>(selector)! <span class="hljs-keyword">as</span> T;</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> queryAll&lt;T&gt;(<span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>): T[] {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelectorAll</span>(selector) <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span> <span class="hljs-keyword">as</span> T[];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
  <h3 id="the-override-tests">
    <a href="#the-override-tests" class="docs-anchor" tabindex="-1" aria-label="Link to The override tests" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="9ffh9bs7hgbf7j9rxeup6cj2e">重写测试</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="e4l6c1scuxaozonp9wbjk4r5h">现在，测试程序可以通过操控这个 spy-stub 的 <code>testHero</code>，直接控制组件的英雄，并确认那个服务方法被调用过。</p>
<div class="docs-code" path="adev/src/content/examples/testing/src/app/hero/hero-detail.component.spec.ts" visiblelines="68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,272,273,274,275,276,277,278,279,280,281,282,283,284" header="app/hero/hero-detail.component.spec.ts (override tests)">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="7m0053m3k5eet93edw76ibqqo">app/hero/hero-detail.component.spec.ts (重写测试)</h3></div>
    <pre class="docs-mini-scroll-track">      <code><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpClient</span>, <span class="hljs-title class_">HttpHandler</span>, provideHttpClient} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpTestingController</span>, provideHttpClientTesting} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common/http/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {fakeAsync, <span class="hljs-title class_">TestBed</span>, tick} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {provideRouter, <span class="hljs-title class_">Router</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">RouterTestingHarness</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router/testing'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {asyncData, click} <span class="hljs-keyword">from</span> <span class="hljs-string">'../../testing'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Hero</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/hero'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {sharedImports} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/shared'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.component'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroDetailService</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-detail.service'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HeroListComponent</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./hero-list.component'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Testing Vars //////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">harness</span>: <span class="hljs-title class_">RouterTestingHarness</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">let</span> <span class="hljs-attr">page</span>: <span class="hljs-title class_">Page</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////// Tests //////</span></div><div class="hljs-ln-line"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'HeroDetailComponent'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with HeroModule setup'</span>, heroModuleSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when override its provided HeroDetailService'</span>, overrideSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with FormsModule setup'</span>, formsModuleSetup);</div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'with SharedModule setup'</span>, sharedModuleSetup);</div><div class="hljs-ln-line">});</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">///////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">const</span> testHero = <span class="hljs-title function_">getTestHeroes</span>()[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">overrideSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroDetailServiceSpy</span> {</div><div class="hljs-ln-line">    <span class="hljs-attr">testHero</span>: <span class="hljs-title class_">Hero</span> = {...testHero};</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">/* emit cloned test hero */</span></div><div class="hljs-ln-line">    getHero = jasmine</div><div class="hljs-ln-line">      .<span class="hljs-title function_">createSpy</span>(<span class="hljs-string">'getHero'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-property">and</span>.<span class="hljs-title function_">callFake</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, <span class="hljs-variable language_">this</span>.<span class="hljs-property">testHero</span>)));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-comment">/* emit clone of test hero, with changes merged in */</span></div><div class="hljs-ln-line">    saveHero = jasmine</div><div class="hljs-ln-line">      .<span class="hljs-title function_">createSpy</span>(<span class="hljs-string">'saveHero'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-property">and</span>.<span class="hljs-title function_">callFake</span>(<span class="hljs-function">(<span class="hljs-params">hero: Hero</span>) =&gt;</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">testHero</span>, hero)));</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">HeroListComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroListComponent</span>},</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>},</div><div class="hljs-ln-line">          ]),</div><div class="hljs-ln-line">          <span class="hljs-title class_">HttpClient</span>,</div><div class="hljs-ln-line">          <span class="hljs-title class_">HttpHandler</span>,</div><div class="hljs-ln-line">          <span class="hljs-comment">// HeroDetailService at this level is IRRELEVANT!</span></div><div class="hljs-ln-line">          {<span class="hljs-attr">provide</span>: <span class="hljs-title class_">HeroDetailService</span>, <span class="hljs-attr">useValue</span>: {}},</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    )</div><div class="hljs-ln-line">      .<span class="hljs-title function_">overrideComponent</span>(<span class="hljs-title class_">HeroDetailComponent</span>, {</div><div class="hljs-ln-line">        <span class="hljs-attr">set</span>: {<span class="hljs-attr">providers</span>: [{<span class="hljs-attr">provide</span>: <span class="hljs-title class_">HeroDetailService</span>, <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">HeroDetailServiceSpy</span>}]},</div><div class="hljs-ln-line">      })</div><div class="hljs-ln-line">      .<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">let</span> <span class="hljs-attr">hdsSpy</span>: <span class="hljs-title class_">HeroDetailServiceSpy</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">    component = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${testHero.id}</span>`</span>, <span class="hljs-title class_">HeroDetailComponent</span>);</div><div class="hljs-ln-line">    page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>();</div><div class="hljs-ln-line">    <span class="hljs-comment">// get the component's injected HeroDetailServiceSpy</span></div><div class="hljs-ln-line">    hdsSpy = harness.<span class="hljs-property">routeDebugElement</span>!.<span class="hljs-property">injector</span>.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">HeroDetailService</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should have called `getHero`'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">getHero</span>.<span class="hljs-property">calls</span>.<span class="hljs-title function_">count</span>())</div><div class="hljs-ln-line">      .<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'getHero called once'</span>)</div><div class="hljs-ln-line">      .<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'getHero called once'</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display stub hero's name"</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should save stub hero change'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> origName = hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>;</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> newName = <span class="hljs-string">'New Name'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    page.<span class="hljs-property">nameInput</span>.<span class="hljs-property">value</span> = newName;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    page.<span class="hljs-property">nameInput</span>.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'input'</span>)); <span class="hljs-comment">// tell Angular</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(component.<span class="hljs-property">hero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'component hero has new name'</span>).<span class="hljs-title function_">toBe</span>(newName);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'service hero unchanged before save'</span>).<span class="hljs-title function_">toBe</span>(origName);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">saveHero</span>.<span class="hljs-property">calls</span>.<span class="hljs-title function_">count</span>()).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'saveHero called once'</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>);</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// wait for async save to complete</span></div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(hdsSpy.<span class="hljs-property">testHero</span>.<span class="hljs-property">name</span>).<span class="hljs-title function_">withContext</span>(<span class="hljs-string">'service hero has new name after save'</span>).<span class="hljs-title function_">toBe</span>(newName);</div><div class="hljs-ln-line">    <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes'</span>);</div><div class="hljs-ln-line">  }));</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">////////////////////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {getTestHeroes} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/testing/test-hero.service'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">const</span> firstHero = <span class="hljs-title function_">getTestHeroes</span>()[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">heroModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">HeroListComponent</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>},</div><div class="hljs-ln-line">            {<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroListComponent</span>},</div><div class="hljs-ln-line">          ]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when navigate to existing hero'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-keyword">let</span> <span class="hljs-attr">expectedHero</span>: <span class="hljs-title class_">Hero</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      expectedHero = firstHero;</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display that hero's name"</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should navigate when click cancel'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">cancelBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${expectedHero.id}</span>`</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should save when click save but not navigate immediately'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>({<span class="hljs-attr">method</span>: <span class="hljs-string">'PUT'</span>, <span class="hljs-attr">url</span>: <span class="hljs-string">'api/heroes'</span>}));</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes/41'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should navigate when click save and save resolves'</span>, <span class="hljs-title function_">fakeAsync</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">click</span>(page.<span class="hljs-property">saveBtn</span>);</div><div class="hljs-ln-line">      <span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// wait for async save to complete</span></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes/41'</span>);</div><div class="hljs-ln-line">    }));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should convert hero name to Title Case'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-comment">// get the name's input and display elements from the DOM</span></div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">hostElement</span>: <span class="hljs-title class_">HTMLElement</span> = harness.<span class="hljs-property">routeNativeElement</span>!;</div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">nameInput</span>: <span class="hljs-title class_">HTMLInputElement</span> = hostElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'input'</span>)!;</div><div class="hljs-ln-line">      <span class="hljs-keyword">const</span> <span class="hljs-attr">nameDisplay</span>: <span class="hljs-title class_">HTMLElement</span> = hostElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'span'</span>)!;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// simulate user entering a new name into the input box</span></div><div class="hljs-ln-line">      nameInput.<span class="hljs-property">value</span> = <span class="hljs-string">'quick BROWN  fOx'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// Dispatch a DOM event so that Angular learns of input value change.</span></div><div class="hljs-ln-line">      nameInput.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'input'</span>));</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-comment">// Tell Angular to update the display binding through the title pipe</span></div><div class="hljs-ln-line">      harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(nameDisplay.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'Quick Brown  Fox'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">describe</span>(<span class="hljs-string">'when navigate to non-existent hero id'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">      <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(<span class="hljs-number">999</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should try to navigate back to hero list'</span>, <span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(<span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">Router</span>).<span class="hljs-property">url</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'/heroes'</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/////////////////////</span></div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">FormsModule</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/forms'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">TitleCasePipe</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared/title-case.pipe'</span>;</div><div class="hljs-ln-line"><span class="hljs-keyword">import</span> {appConfig} <span class="hljs-keyword">from</span> <span class="hljs-string">'../app.config'</span>;</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">formsModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">FormsModule</span>, <span class="hljs-title class_">HeroDetailComponent</span>, <span class="hljs-title class_">TitleCasePipe</span>],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}]),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display 1st hero's name"</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedHero = firstHero;</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">///////////////////////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sharedModuleSetup</span>(<span class="hljs-params"></span>) {</div><div class="hljs-ln-line">  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>(</div><div class="hljs-ln-line">      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, appConfig, {</div><div class="hljs-ln-line">        <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">HeroDetailComponent</span>, sharedImports],</div><div class="hljs-ln-line">        <span class="hljs-attr">providers</span>: [</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideRouter</span>([{<span class="hljs-attr">path</span>: <span class="hljs-string">'heroes/:id'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HeroDetailComponent</span>}]),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClient</span>(),</div><div class="hljs-ln-line">          <span class="hljs-title function_">provideHttpClientTesting</span>(),</div><div class="hljs-ln-line">        ],</div><div class="hljs-ln-line">      }),</div><div class="hljs-ln-line">    ).<span class="hljs-title function_">compileComponents</span>();</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should display 1st hero's name"</span>, <span class="hljs-keyword">async</span> () =&gt; {</div><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> expectedHero = firstHero;</div><div class="hljs-ln-line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">createComponent</span>(expectedHero.<span class="hljs-property">id</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</div><div class="hljs-ln-line">      <span class="hljs-title function_">expect</span>(page.<span class="hljs-property">nameDisplay</span>.<span class="hljs-property">textContent</span>).<span class="hljs-title function_">toBe</span>(expectedHero.<span class="hljs-property">name</span>);</div><div class="hljs-ln-line">    });</div><div class="hljs-ln-line">  });</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/////////// Helpers /////</span></div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-comment">/** Create the HeroDetailComponent, initialize it, set test variables  */</span></div><div class="hljs-ln-line"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createComponent</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {</div><div class="hljs-ln-line">  harness = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RouterTestingHarness</span>.<span class="hljs-title function_">create</span>();</div><div class="hljs-ln-line">  component = <span class="hljs-keyword">await</span> harness.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">`/heroes/<span class="hljs-subst">${id}</span>`</span>, <span class="hljs-title class_">HeroDetailComponent</span>);</div><div class="hljs-ln-line">  page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>();</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> request = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpTestingController</span>).<span class="hljs-title function_">expectOne</span>(<span class="hljs-string">`api/heroes/?id=<span class="hljs-subst">${id}</span>`</span>);</div><div class="hljs-ln-line">  <span class="hljs-keyword">const</span> hero = <span class="hljs-title function_">getTestHeroes</span>().<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">h</span>) =&gt;</span> h.<span class="hljs-property">id</span> === <span class="hljs-title class_">Number</span>(id));</div><div class="hljs-ln-line">  request.<span class="hljs-title function_">flush</span>(hero ? [hero] : []);</div><div class="hljs-ln-line">  harness.<span class="hljs-title function_">detectChanges</span>();</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Page</span> {</div><div class="hljs-ln-line">  <span class="hljs-comment">// getter properties wait to query the DOM until called.</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">buttons</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">queryAll</span>&lt;<span class="hljs-title class_">HTMLButtonElement</span>&gt;(<span class="hljs-string">'button'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">saveBtn</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buttons</span>[<span class="hljs-number">0</span>];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">cancelBtn</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buttons</span>[<span class="hljs-number">1</span>];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">nameDisplay</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>&lt;<span class="hljs-title class_">HTMLElement</span>&gt;(<span class="hljs-string">'span'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">  <span class="hljs-keyword">get</span> <span class="hljs-title function_">nameInput</span>() {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">query</span>&lt;<span class="hljs-title class_">HTMLInputElement</span>&gt;(<span class="hljs-string">'input'</span>);</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-comment">//// query helpers ////</span></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> query&lt;T&gt;(<span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>): T {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelector</span>(selector)! <span class="hljs-keyword">as</span> T;</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line"></div><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> queryAll&lt;T&gt;(<span class="hljs-attr">selector</span>: <span class="hljs-built_in">string</span>): T[] {</div><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> harness.<span class="hljs-property">routeNativeElement</span>!.<span class="hljs-title function_">querySelectorAll</span>(selector) <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span> <span class="hljs-keyword">as</span> T[];</div><div class="hljs-ln-line">  }</div><div class="hljs-ln-line">}</div><div class="hljs-ln-line"></div></code>
    </pre>
  </div>
  <h3 id="more-overrides">
    <a href="#more-overrides" class="docs-anchor" tabindex="-1" aria-label="Link to More overrides" data-ng_translator_product="100" data-ng_translator_ref_id="9mjbrzoai8owzny0n4irwd9ej">更多重写形式</a>
  </h3>
  <p data-ng_translator_product="100" data-ng_translator_ref_id="eu6l5zg1u6t3opid4n2mbb6hx">此 
<code>TestBed.overrideComponent</code> 方法可以多次调用，以覆盖相同或不同的组件。此 
<code>TestBed</code> 提供类似的 
<code>overrideDirective</code>、
<code>overrideModule</code> 和 
<code>overridePipe</code> 方法，用于深入挖掘并替换这些其他类的部分。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="cioq7okr6hzk3x17w9z7zhkax">自己探索这些选项和组合。</p>
