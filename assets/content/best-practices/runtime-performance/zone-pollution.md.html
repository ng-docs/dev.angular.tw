<header class="docs-header">
      <docs-breadcrumb></docs-breadcrumb>

      
  <!-- Page title -->
  <div class="docs-page-title">
    <h1 tabindex="-1">解決 Zone 汙染</h1>
    <a class="docs-github-links" target="_blank" href="https://github.com/angular/angular/edit/main/adev/src/content/best-practices/runtime-performance/zone-pollution.md" title="Edit this page" aria-label="Edit this page">
      <!-- Pencil -->
      <docs-icon role="presentation">edit</docs-icon>
    </a>
  </div>
    </header>
    <p><strong>Zone.js</strong> 是一種信令機制，Angular 使用它來檢測應用狀態可能何時已更改。它會捕獲非同步操作，如 <code>setTimeout</code>、網路請求和事件監聽器。Angular 基於來自 Zone.js 的訊號來排程變更檢測。</p>
<p>在某些情況下，排程的 <a href="https://developer.mozilla.org/docs/Web/API/HTML_DOM_API/Microtask_guide#tasks" target="_blank">任務</a> 或 <a href="https://developer.mozilla.org/docs/Web/API/HTML_DOM_API/Microtask_guide#microtasks" target="_blank">微任務</a> 不會對資料模型進行任何更改，這使得執行變更檢測變得不必要。常見的例子有：</p>

  <ul class="docs-list">
    <li><code>requestAnimationFrame</code>、<code>setTimeout</code> 或 <code>setInterval</code></li>
<li>由第三方函式庫進行的任務或微任務排程</li>

  </ul>
  <p>本節介紹如何識別此類別情況，以及如何在 Angular Zone 之外執行程式碼以避免不必要的變更檢測呼叫。</p>

  <h2 id="identifying-unnecessary-change-detection-calls">
    <a href="#identifying-unnecessary-change-detection-calls" class="docs-anchor" tabindex="-1" aria-label="Link to Identifying unnecessary change detection calls">識別不必要的變更檢測呼叫</a>
  </h2>
  <p>你可以使用 Angular DevTools 檢測不必要的變更檢測呼叫。它們通常在效能分析器的時序圖中顯示為連續的條形，其來源為 <code>setTimeout</code>、<code>setInterval</code>、<code>requestAnimationFrame</code> 或事件處理程式。當你的應用中對這些 API 的呼叫有限時，變更檢測呼叫通常是由第三方函式庫引起的。</p>
<img alt="Angular DevTools profiler preview showing Zone pollution" src="assets/images/best-practices/runtime-performance/zone-pollution.png">

<p>在上圖中，有一系列由與元素關聯的事件處理程式觸發的變更檢測呼叫。當使用第三方、非原生 Angular 元件時，這是一個常見的挑戰，因為這些元件不會改變 <code>NgZone</code> 的預設行為。</p>

  <h2 id="run-tasks-outside-ngzone">
    <a href="#run-tasks-outside-ngzone" class="docs-anchor" tabindex="-1" aria-label="Link to Run tasks outside <code>NgZone</code>">在 <code>NgZone</code> 外部執行任務</a>
  </h2>
  <p>在這種情況下，你可以指示 Angular 避免為使用 <a href="/api/core/NgZone">NgZone</a> 的給定程式碼片段排程的任務呼叫變更檢測。</p>
<div class="docs-code" header="Run outside of the Zone">
    <div class="docs-code-header"><h3>在 Zone 外部執行</h3></div>
    <pre class="docs-mini-scroll-track">      <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span role="presentation" class="shiki-ln-number">1</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> { Component, NgZone, OnInit } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> '@angular/core'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span><span role="presentation" class="shiki-ln-number">2</span><span class="line"></span><span role="presentation" class="shiki-ln-number">3</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Component</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span><span role="presentation" class="shiki-ln-number">4</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> AppComponent</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> OnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span role="presentation" class="shiki-ln-number">5</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">  private</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> ngZone</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> inject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(NgZone);</span></span><span role="presentation" class="shiki-ln-number">6</span><span class="line"></span><span role="presentation" class="shiki-ln-number">7</span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">  ngOnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span><span role="presentation" class="shiki-ln-number">8</span><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.ngZone.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">runOutsideAngular</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> setInterval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(pollForUpdates), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">500</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span><span role="presentation" class="shiki-ln-number">9</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  }</span></span><span role="presentation" class="shiki-ln-number">10</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre>
    </pre>
  </div><p>上面的程式碼片段指示 Angular 在 Angular Zone 之外呼叫 <code>setInterval</code>，並在 <code>pollForUpdates</code> 執行後跳過執行變更檢測。</p>
<p>當第三方函式庫的 API 在 Angular Zone 內被呼叫時，它們通常會觸發不必要的變更檢測週期。這種現象尤其會影響那些設定事件監聽器或啟動其他任務（如定時器、XHR 請求等）的函式庫。透過在 Angular Zone 之外呼叫函式庫 API 來避免這些額外的週期：</p>
<div class="docs-code" header="Move the plot initialization outside of the Zone">
    <div class="docs-code-header"><h3>將繪圖初始化移到 Zone 外部</h3></div>
    <pre class="docs-mini-scroll-track">      <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span role="presentation" class="shiki-ln-number">1</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> { Component, NgZone, OnInit } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> '@angular/core'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span><span role="presentation" class="shiki-ln-number">2</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">import</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Plotly </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> 'plotly.js-dist-min'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span><span role="presentation" class="shiki-ln-number">3</span><span class="line"></span><span role="presentation" class="shiki-ln-number">4</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Component</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span><span role="presentation" class="shiki-ln-number">5</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> AppComponent</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> OnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span role="presentation" class="shiki-ln-number">6</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">  private</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> ngZone</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> inject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(NgZone);</span></span><span role="presentation" class="shiki-ln-number">7</span><span class="line"></span><span role="presentation" class="shiki-ln-number">8</span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">  ngOnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span><span role="presentation" class="shiki-ln-number">9</span><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.ngZone.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">runOutsideAngular</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span role="presentation" class="shiki-ln-number">10</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      Plotly.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">newPlot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'chart'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, data);</span></span><span role="presentation" class="shiki-ln-number">11</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    });</span></span><span role="presentation" class="shiki-ln-number">12</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  }</span></span><span role="presentation" class="shiki-ln-number">13</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre>
    </pre>
  </div><p>在 <code>runOutsideAngular</code> 中執行 <code>Plotly.newPlot('chart', data);</code> 指示框架在執行由初始化邏輯排程的任務後不應執行變更檢測。</p>
<p>例如，如果 <code>Plotly.newPlot('chart', data)</code> 向 DOM 元素新增事件監聽器，則 Angular 在執行其處理程式後不會執行變更檢測。</p>
<p>但有時，你可能需要監聽由第三方 API 排程的事件。在這種情況下，重要的是要記住，如果初始化邏輯在那裡完成，這些事件監聽器也將在 Angular Zone 之外執行：</p>
<div class="docs-code" header="Check whether the handler is called outside of the Zone">
    <div class="docs-code-header"><h3>檢查處理程式是否在 Zone 外部被呼叫</h3></div>
    <pre class="docs-mini-scroll-track">      <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span role="presentation" class="shiki-ln-number">1</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> { Component, NgZone, OnInit, output } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> '@angular/core'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span><span role="presentation" class="shiki-ln-number">2</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">import</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Plotly </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> 'plotly.js-dist-min'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span><span role="presentation" class="shiki-ln-number">3</span><span class="line"></span><span role="presentation" class="shiki-ln-number">4</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Component</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span><span role="presentation" class="shiki-ln-number">5</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> AppComponent</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> OnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span role="presentation" class="shiki-ln-number">6</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">  private</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> ngZone</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> inject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(NgZone);</span></span><span role="presentation" class="shiki-ln-number">7</span><span class="line"></span><span role="presentation" class="shiki-ln-number">8</span><span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">  plotlyClick</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> output</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Plotly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">PlotMouseEvent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt;();</span></span><span role="presentation" class="shiki-ln-number">9</span><span class="line"></span><span role="presentation" class="shiki-ln-number">10</span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">  ngOnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span><span role="presentation" class="shiki-ln-number">11</span><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.ngZone.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">runOutsideAngular</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span role="presentation" class="shiki-ln-number">12</span><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">createPlotly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span><span role="presentation" class="shiki-ln-number">13</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    });</span></span><span role="presentation" class="shiki-ln-number">14</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  }</span></span><span role="presentation" class="shiki-ln-number">15</span><span class="line"></span><span role="presentation" class="shiki-ln-number">16</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">  private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> createPlotly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span><span role="presentation" class="shiki-ln-number">17</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> plotly</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Plotly.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">newPlot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'chart'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, data);</span></span><span role="presentation" class="shiki-ln-number">18</span><span class="line"></span><span role="presentation" class="shiki-ln-number">19</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    plotly.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'plotly_click'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">event</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Plotly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">PlotMouseEvent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span role="presentation" class="shiki-ln-number">20</span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">      // This handler will be called outside of the Angular zone because</span></span><span role="presentation" class="shiki-ln-number">21</span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">      // the initialization logic is also called outside of the zone. To check</span></span><span role="presentation" class="shiki-ln-number">22</span><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">      // whether we're in the Angular zone, we can call the following:</span></span><span role="presentation" class="shiki-ln-number">23</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(NgZone.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isInAngularZone</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">());</span></span><span role="presentation" class="shiki-ln-number">24</span><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.plotlyClick.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">emit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(event);</span></span><span role="presentation" class="shiki-ln-number">25</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    });</span></span><span role="presentation" class="shiki-ln-number">26</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  }</span></span><span role="presentation" class="shiki-ln-number">27</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre>
    </pre>
  </div><p>如果你需要向父元件排程事件並執行特定的檢視更新邏輯，你應該考慮重新進入 Angular Zone 以指示框架執行變更檢測或手動執行變更檢測：</p>
<div class="docs-code" header="Re-enter the Angular zone when dispatching event">
    <div class="docs-code-header"><h3>當排程事件時，重新進入 Angular Zone</h3></div>
    <pre class="docs-mini-scroll-track">      <pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e" tabindex="0"><code><span role="presentation" class="shiki-ln-number">1</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> { Component, NgZone, OnInit, output } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> '@angular/core'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span><span role="presentation" class="shiki-ln-number">2</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">import</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Plotly </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> 'plotly.js-dist-min'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span><span role="presentation" class="shiki-ln-number">3</span><span class="line"></span><span role="presentation" class="shiki-ln-number">4</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Component</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span><span role="presentation" class="shiki-ln-number">5</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> AppComponent</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> OnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span role="presentation" class="shiki-ln-number">6</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">  private</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> ngZone</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> inject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(NgZone);</span></span><span role="presentation" class="shiki-ln-number">7</span><span class="line"></span><span role="presentation" class="shiki-ln-number">8</span><span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">  plotlyClick</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> output</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">Plotly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">PlotMouseEvent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt;();</span></span><span role="presentation" class="shiki-ln-number">9</span><span class="line"></span><span role="presentation" class="shiki-ln-number">10</span><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">  ngOnInit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span><span role="presentation" class="shiki-ln-number">11</span><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.ngZone.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">runOutsideAngular</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span role="presentation" class="shiki-ln-number">12</span><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">createPlotly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span><span role="presentation" class="shiki-ln-number">13</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    });</span></span><span role="presentation" class="shiki-ln-number">14</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  }</span></span><span role="presentation" class="shiki-ln-number">15</span><span class="line"></span><span role="presentation" class="shiki-ln-number">16</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">  private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> createPlotly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span><span role="presentation" class="shiki-ln-number">17</span><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> plotly</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Plotly.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">newPlot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'chart'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, data);</span></span><span role="presentation" class="shiki-ln-number">18</span><span class="line"></span><span role="presentation" class="shiki-ln-number">19</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    plotly.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'plotly_click'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">event</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Plotly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">PlotMouseEvent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span role="presentation" class="shiki-ln-number">20</span><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.ngZone.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span><span role="presentation" class="shiki-ln-number">21</span><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.plotlyClick.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">emit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(event);</span></span><span role="presentation" class="shiki-ln-number">22</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">      });</span></span><span role="presentation" class="shiki-ln-number">23</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    });</span></span><span role="presentation" class="shiki-ln-number">24</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">  }</span></span><span role="presentation" class="shiki-ln-number">25</span><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre>
    </pre>
  </div><p>在 Angular Zone 之外排程事件的場景也可能出現。重要的是要記住，觸發變更檢測（例如，手動）可能會導致在 Angular Zone 之外建立/更新檢視。</p>
