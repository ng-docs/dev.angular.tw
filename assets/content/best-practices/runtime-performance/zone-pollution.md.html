<header class="docs-header">
      <docs-breadcrumb></docs-breadcrumb>

      
  <!-- Page title -->
  <div class="docs-page-title">
    <h1 tabindex="-1" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="9gjquylafri3fdypvcetqn4p6">解决区域（Zone）污染</h1>
    <a class="docs-github-links" target="_blank" href="https://github.com/angular/angular/edit/main/adev/src/content/best-practices/runtime-performance/zone-pollution.md" title="Edit this page" aria-label="Edit this page">
      <!-- Pencil -->
      <docs-icon role="presentation">edit</docs-icon>
    </a>
  </div>
    </header>
    <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="6nww2a4wkljfds3t7osnrbrne"><strong>Zone.js</strong>是一种信号机制，Angular 用它来检测应用程序状态何时可能已更改。它捕获异步操作，比如 <code>setTimeout</code>、网络请求和事件侦听器。Angular 会根据来自 Zone.js 的信号安排变更检测</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="8uwmcegq348np6iq8cfamybmi">在某些情况下，调度的
<a href="https://developer.mozilla.org/en-US/docs/Web/API/HTML_DOM_API/Microtask_guide#tasks" target="_blank">任务</a>或
<a href="https://developer.mozilla.org/en-US/docs/Web/API/HTML_DOM_API/Microtask_guide#microtasks" target="_blank">微任务</a>不会对数据模型进行任何更改，这使得运行变更检测变得不必要。常见的例子有：</p>

  <ul class="docs-list">
    <li data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="6c3f17kgk05kplih1tzehgsi9"><code>requestAnimationFrame</code> 、 <code>setTimeout</code> 或 <code>setInterval</code></li>
<li data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="dc5kiwqikk3hfo1mp1rfjlt0p">第三方库的任务或微任务调度</li>

  </ul>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="68934pw06e0w5vcyie166q92y">本节介绍如何识别此类条件，以及如何在 Angular 区域外运行代码以避免不必要的变更检测调用。</p>

  <h2 id="identifying-unnecessary-change-detection-calls">
    <a href="#identifying-unnecessary-change-detection-calls" class="docs-anchor" tabindex="-1" aria-label="Link to Identifying unnecessary change detection calls" data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="5arwhfhc29lmqdot3ggcqytxq">识别不必要的变更检测调用</a>
  </h2>
  <p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="5knipzjbvhxtu0yh1rd7yfkug">你可以用 Angular DevTools 检测不必要的变更检测调用。它们通常在分析器的时间线中显示为连续的条形，其源为 <code>setTimeout</code>、<code>setInterval</code>、<code>requestAnimationFrame</code> 或事件处理程序。当你在应用程序中对这些 API 的调用有限时，变更检测调用通常是由第三方库引起的。</p>
<img alt="Angular DevTools profiler preview showing Zone pollution" src="assets/images/best-practices/runtime-performance/zone-pollution.png">

<p data-ng_translator_product="100" data-ng_translator_ref_id="9nxrpxu3n7khziublmkyizgzn">在上图中，有一系列由与元素关联的事件处理器触发的变更检测调用。这在使用第三方、非原生 Angular 组件时是一个常见挑战，这些组件不会改变 
<code>NgZone</code> 的默认行为。</p>

  <h2 id="run-tasks-outside-ngzone">
    <a href="#run-tasks-outside-ngzone" class="docs-anchor" tabindex="-1" aria-label="Link to Run tasks outside <code>NgZone</code>" data-ng_translator_product="100" data-ng_translator_ref_id="babvzhv5w6bssqyvx8fqcku0c">在 
<code>NgZone</code> 之外运行任务</a>
  </h2>
  <p data-ng_translator_product="100" data-ng_translator_ref_id="dgescoqtc0f1wcxhoc4g9jqc">在这种情况下，你可以指示 Angular 避免为某段代码调度的任务调用变更检测，使用 
<a href="/api/core/NgZone">NgZone</a>。</p>
<div class="docs-code" header="Run outside of the Zone">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="519p0j8uqed2kus8jel86s514">在 Zone 之外运行</h3></div>
    <pre class="docs-mini-scroll-track">      <code><span role="presentation" class="hljs-ln-number">1</span><div class="hljs-ln-line"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Component</span>, <span class="hljs-title class_">NgZone</span>, <span class="hljs-title class_">OnInit</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><span role="presentation" class="hljs-ln-number">2</span><div class="hljs-ln-line"></div><span role="presentation" class="hljs-ln-number">3</span><div class="hljs-ln-line"><span class="hljs-meta">@Component</span>(...)</div><span role="presentation" class="hljs-ln-number">4</span><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AppComponent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OnInit</span> {</div><span role="presentation" class="hljs-ln-number">5</span><div class="hljs-ln-line">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> ngZone: NgZone</span>) {}</div><span role="presentation" class="hljs-ln-number">6</span><div class="hljs-ln-line">  <span class="hljs-title function_">ngOnInit</span>(<span class="hljs-params"></span>) {</div><span role="presentation" class="hljs-ln-number">7</span><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ngZone</span>.<span class="hljs-title function_">runOutsideAngular</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">setInterval</span>(pollForUpdates), <span class="hljs-number">500</span>);</div><span role="presentation" class="hljs-ln-number">8</span><div class="hljs-ln-line">  }</div><span role="presentation" class="hljs-ln-number">9</span><div class="hljs-ln-line">}</div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="cylwgikw7gm9i3magj944k49y">上面的代码段告诉 Angular 要在 Angular Zone 之外执行 <code>setInterval</code> 调用，并在 <code>pollForUpdates</code> 运行之后跳过运行变更检测。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="9s4da0b5fcc1v2ds2aadeuwly">第三方库通常在其 API 在 Angular 区域内被调用时触发不必要的变更检测周期。这种现象尤其影响那些设置事件监听器或启动其他任务（例如计时器、XHR 请求等）的库。通过在 Angular 区域外调用库 API 来避免这些额外的周期：</p>
<div class="docs-code" header="Move the plot initialization outside of the Zone">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="9sb5ro486khbvm7llnx4vzkxs">将绘图初始化移到 Zone 之外</h3></div>
    <pre class="docs-mini-scroll-track">      <code><span role="presentation" class="hljs-ln-number">1</span><div class="hljs-ln-line"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Component</span>, <span class="hljs-title class_">NgZone</span>, <span class="hljs-title class_">OnInit</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><span role="presentation" class="hljs-ln-number">2</span><div class="hljs-ln-line"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">Plotly</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'plotly.js-dist-min'</span>;</div><span role="presentation" class="hljs-ln-number">3</span><div class="hljs-ln-line"></div><span role="presentation" class="hljs-ln-number">4</span><div class="hljs-ln-line"><span class="hljs-meta">@Component</span>(...)</div><span role="presentation" class="hljs-ln-number">5</span><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AppComponent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OnInit</span> {</div><span role="presentation" class="hljs-ln-number">6</span><div class="hljs-ln-line"></div><span role="presentation" class="hljs-ln-number">7</span><div class="hljs-ln-line">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> ngZone: NgZone</span>) {}</div><span role="presentation" class="hljs-ln-number">8</span><div class="hljs-ln-line"></div><span role="presentation" class="hljs-ln-number">9</span><div class="hljs-ln-line">  <span class="hljs-title function_">ngOnInit</span>(<span class="hljs-params"></span>) {</div><span role="presentation" class="hljs-ln-number">10</span><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ngZone</span>.<span class="hljs-title function_">runOutsideAngular</span>(<span class="hljs-function">() =&gt;</span> {</div><span role="presentation" class="hljs-ln-number">11</span><div class="hljs-ln-line">      <span class="hljs-title class_">Plotly</span>.<span class="hljs-title function_">newPlot</span>(<span class="hljs-string">'chart'</span>, data);</div><span role="presentation" class="hljs-ln-number">12</span><div class="hljs-ln-line">    });</div><span role="presentation" class="hljs-ln-number">13</span><div class="hljs-ln-line">  }</div><span role="presentation" class="hljs-ln-number">14</span><div class="hljs-ln-line">}</div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="5cvhogxf5z8oif4ce6ds2m5e2">在 <code>runOutsideAngular</code> 中运行 <code>Plotly.newPlot('chart', data);</code> 会告诉框架它不应该在执行此初始化逻辑安排的这些任务之后执行变更检测。</p>
<p data-ng_translator_product="100" data-ng_translator_confirmed data-ng_translator_ref_id="5uxg4bpn3m37f1k7o6oxnscb9">比如，如果 <code>Plotly.newPlot('chart', data)</code> 将事件侦听器添加到 DOM 元素，则 Angular 将不会在执行其处理程序之后执行变更检测。</p>
<p data-ng_translator_product="100" data-ng_translator_ref_id="73l7dzewcyl9183hwsokail2j">但有时你可能需要监听第三方 API 分派的事件。在这种情况下，重要的是要记住，如果初始化逻辑是在 Zone 之外完成的，那么这些事件监听器也将在 Angular 区域外执行：</p>
<div class="docs-code" header="Check whether the handler is called outside of the Zone">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="ej6oq7zu34734tlq47mqwugcs">检查处理程序是否在 Zone 之外被调用</h3></div>
    <pre class="docs-mini-scroll-track">      <code><span role="presentation" class="hljs-ln-number">1</span><div class="hljs-ln-line"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Component</span>, <span class="hljs-title class_">NgZone</span>, <span class="hljs-title class_">OnInit</span>, output } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><span role="presentation" class="hljs-ln-number">2</span><div class="hljs-ln-line"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">Plotly</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'plotly.js-dist-min'</span>;</div><span role="presentation" class="hljs-ln-number">3</span><div class="hljs-ln-line"></div><span role="presentation" class="hljs-ln-number">4</span><div class="hljs-ln-line"><span class="hljs-meta">@Component</span>(...)</div><span role="presentation" class="hljs-ln-number">5</span><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AppComponent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OnInit</span> {</div><span role="presentation" class="hljs-ln-number">6</span><div class="hljs-ln-line">  plotlyClick = output&lt;<span class="hljs-title class_">Plotly</span>.<span class="hljs-property">PlotMouseEvent</span>&gt;();</div><span role="presentation" class="hljs-ln-number">7</span><div class="hljs-ln-line"></div><span role="presentation" class="hljs-ln-number">8</span><div class="hljs-ln-line">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> ngZone: NgZone</span>) {}</div><span role="presentation" class="hljs-ln-number">9</span><div class="hljs-ln-line"></div><span role="presentation" class="hljs-ln-number">10</span><div class="hljs-ln-line">  <span class="hljs-title function_">ngOnInit</span>(<span class="hljs-params"></span>) {</div><span role="presentation" class="hljs-ln-number">11</span><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ngZone</span>.<span class="hljs-title function_">runOutsideAngular</span>(<span class="hljs-function">() =&gt;</span> {</div><span role="presentation" class="hljs-ln-number">12</span><div class="hljs-ln-line">      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createPlotly</span>();</div><span role="presentation" class="hljs-ln-number">13</span><div class="hljs-ln-line">    });</div><span role="presentation" class="hljs-ln-number">14</span><div class="hljs-ln-line">  }</div><span role="presentation" class="hljs-ln-number">15</span><div class="hljs-ln-line"></div><span role="presentation" class="hljs-ln-number">16</span><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">createPlotly</span>(<span class="hljs-params"></span>) {</div><span role="presentation" class="hljs-ln-number">17</span><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> plotly = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Plotly</span>.<span class="hljs-title function_">newPlot</span>(<span class="hljs-string">'chart'</span>, data);</div><span role="presentation" class="hljs-ln-number">18</span><div class="hljs-ln-line"></div><span role="presentation" class="hljs-ln-number">19</span><div class="hljs-ln-line">    plotly.<span class="hljs-title function_">on</span>(<span class="hljs-string">'plotly_click'</span>, <span class="hljs-function">(<span class="hljs-params">event: Plotly.PlotMouseEvent</span>) =&gt;</span> {</div><span role="presentation" class="hljs-ln-number">20</span><div class="hljs-ln-line">      <span class="hljs-comment">// This handler will be called outside of the Angular zone because</span></div><span role="presentation" class="hljs-ln-number">21</span><div class="hljs-ln-line">      <span class="hljs-comment">// the initialization logic is also called outside of the zone. To check</span></div><span role="presentation" class="hljs-ln-number">22</span><div class="hljs-ln-line">      <span class="hljs-comment">// whether we're in the Angular zone, we can call the following:</span></div><span role="presentation" class="hljs-ln-number">23</span><div class="hljs-ln-line">      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">NgZone</span>.<span class="hljs-title function_">isInAngularZone</span>());</div><span role="presentation" class="hljs-ln-number">24</span><div class="hljs-ln-line">      <span class="hljs-variable language_">this</span>.<span class="hljs-property">plotlyClick</span>.<span class="hljs-title function_">emit</span>(event);</div><span role="presentation" class="hljs-ln-number">25</span><div class="hljs-ln-line">    });</div><span role="presentation" class="hljs-ln-number">26</span><div class="hljs-ln-line">  }</div><span role="presentation" class="hljs-ln-number">27</span><div class="hljs-ln-line">}</div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="d57nqlz2yc2hizl276hwd4654">如果需要分派事件到父组件并执行特定的视图更新逻辑，应考虑重新进入 Angular 区域以指示框架运行变更检测或手动运行变更检测：</p>
<div class="docs-code" header="Re-enter the Angular zone when dispatching event">
    <div class="docs-code-header"><h3 data-ng_translator_product="100" data-ng_translator_ref_id="2mf3hgvacddza4vm0plmn1xqh">分派事件时重新进入 Angular 区域</h3></div>
    <pre class="docs-mini-scroll-track">      <code><span role="presentation" class="hljs-ln-number">1</span><div class="hljs-ln-line"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Component</span>, <span class="hljs-title class_">NgZone</span>, <span class="hljs-title class_">OnInit</span>, output } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;</div><span role="presentation" class="hljs-ln-number">2</span><div class="hljs-ln-line"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">Plotly</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'plotly.js-dist-min'</span>;</div><span role="presentation" class="hljs-ln-number">3</span><div class="hljs-ln-line"></div><span role="presentation" class="hljs-ln-number">4</span><div class="hljs-ln-line"><span class="hljs-meta">@Component</span>(...)</div><span role="presentation" class="hljs-ln-number">5</span><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AppComponent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OnInit</span> {</div><span role="presentation" class="hljs-ln-number">6</span><div class="hljs-ln-line">  plotlyClick = output&lt;<span class="hljs-title class_">Plotly</span>.<span class="hljs-property">PlotMouseEvent</span>&gt;();</div><span role="presentation" class="hljs-ln-number">7</span><div class="hljs-ln-line"></div><span role="presentation" class="hljs-ln-number">8</span><div class="hljs-ln-line">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> ngZone: NgZone</span>) {}</div><span role="presentation" class="hljs-ln-number">9</span><div class="hljs-ln-line"></div><span role="presentation" class="hljs-ln-number">10</span><div class="hljs-ln-line">  <span class="hljs-title function_">ngOnInit</span>(<span class="hljs-params"></span>) {</div><span role="presentation" class="hljs-ln-number">11</span><div class="hljs-ln-line">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ngZone</span>.<span class="hljs-title function_">runOutsideAngular</span>(<span class="hljs-function">() =&gt;</span> {</div><span role="presentation" class="hljs-ln-number">12</span><div class="hljs-ln-line">      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createPlotly</span>();</div><span role="presentation" class="hljs-ln-number">13</span><div class="hljs-ln-line">    });</div><span role="presentation" class="hljs-ln-number">14</span><div class="hljs-ln-line">  }</div><span role="presentation" class="hljs-ln-number">15</span><div class="hljs-ln-line"></div><span role="presentation" class="hljs-ln-number">16</span><div class="hljs-ln-line">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">createPlotly</span>(<span class="hljs-params"></span>) {</div><span role="presentation" class="hljs-ln-number">17</span><div class="hljs-ln-line">    <span class="hljs-keyword">const</span> plotly = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Plotly</span>.<span class="hljs-title function_">newPlot</span>(<span class="hljs-string">'chart'</span>, data);</div><span role="presentation" class="hljs-ln-number">18</span><div class="hljs-ln-line"></div><span role="presentation" class="hljs-ln-number">19</span><div class="hljs-ln-line">    plotly.<span class="hljs-title function_">on</span>(<span class="hljs-string">'plotly_click'</span>, <span class="hljs-function">(<span class="hljs-params">event: Plotly.PlotMouseEvent</span>) =&gt;</span> {</div><span role="presentation" class="hljs-ln-number">20</span><div class="hljs-ln-line">      <span class="hljs-variable language_">this</span>.<span class="hljs-property">ngZone</span>.<span class="hljs-title function_">run</span>(<span class="hljs-function">() =&gt;</span> {</div><span role="presentation" class="hljs-ln-number">21</span><div class="hljs-ln-line">        <span class="hljs-variable language_">this</span>.<span class="hljs-property">plotlyClick</span>.<span class="hljs-title function_">emit</span>(event);</div><span role="presentation" class="hljs-ln-number">22</span><div class="hljs-ln-line">      });</div><span role="presentation" class="hljs-ln-number">23</span><div class="hljs-ln-line">    });</div><span role="presentation" class="hljs-ln-number">24</span><div class="hljs-ln-line">  }</div><span role="presentation" class="hljs-ln-number">25</span><div class="hljs-ln-line">}</div></code>
    </pre>
  </div><p data-ng_translator_product="100" data-ng_translator_ref_id="brdruxqkn2jol17io53y2cs0e">分派事件在 Angular 区域之外的情况也可能出现。重要的是要记住，触发变更检测（例如，手动触发）可能导致在 Angular 区域之外创建/更新视图。</p>
